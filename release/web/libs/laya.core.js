window.Laya=function(e){"use strict";class t{static regClass(e,r){t._classMap[e]=r}static getClass(e){return t._classMap[e]}static getInstance(e){var r=t.getClass(e);return r?new r:(console.warn("[error] Undefined class:",e),null)}}function dummy(){}t._classMap={};class r{}r.isAntialias=!0,r.useWebGL2=!0,r.FPS=60,r.useRetinalCanvas=!1,r.animationInterval=50,r.webGL2D_MeshAllocMaxMem=!0,r.defaultFontSize=12,r.defaultFont="Arial",r.isAlpha=!1,r.isDepth=!1,r.isfailIfMajorPerformanceCaveat=!1,r.powerPreference="default",r.premultipliedAlpha=!0,r.isStencil=!1,r.preserveDrawingBuffer=!1,r.printWebglOrder=!1,r.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},r.fixedFrames=!0,r.destroyResourceImmediatelyDefault=!0,r._enableWindowRAFFunction=!0;class i{}i.ENUM_TEXTALIGN_DEFAULT=0,i.ENUM_TEXTALIGN_CENTER=1,i.ENUM_TEXTALIGN_RIGHT=2,i.BYTES_PE=4,i.BYTES_PIDX=2,i.MAX_CLIP_SIZE=99999999;class s{}s.NOT_ACTIVE=1,s.ACTIVE_INHIERARCHY=2,s.AWAKED=4,s.NOT_READY=8,s.DISPLAY=16,s.HAS_ZORDER=32,s.HAS_MOUSE=64,s.DISPLAYED_INSTAGE=128,s.DRAWCALL_OPTIMIZE=256,s.PROCESS_COLLISIONS=512,s.PROCESS_TRIGGERS=1024,s.HAS_SCRIPT=2048,s.ESCAPE_DRAWING_TO_TEXTURE=4096,s.DISABLE_INNER_CLIPPING=8192,s.DISABLE_OUTER_CLIPPING=16384,s.DISABLE_VISIBILITY=32768,s.EDITING_NODE=65536,s.HIDE_BY_EDITOR=131072,s.LOCK_BY_EDITOR=262144;class a{}a.HideInHierarchy=1,a.HideInInspector=2,a.DontSave=4,a.HideAndDontSave=7;class n{}n.Loader=null,n.Context=null,n.Browser=null,n.Laya=null,n.loader=null,n.timer=null,n.systemTimer=null,n.physicsTimer=null,n.stage=null;class l{}l.version="3.1.4",l.isPlaying=!0,l.isPreview=!1,l.isConch=null!=window.conch;class o{static getPoolBySign(e){return o._poolDic[e]||(o._poolDic[e]=[])}static clearBySign(e){o._poolDic[e]&&(o._poolDic[e].length=0)}static recover(e,t){!1===t[o.POOLSIGN]&&(t[o.POOLSIGN]=!0,o.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&o.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=o._CLSID+"",o._CLSID++),t}static createByClass(e){return o.getItemByClass(o._getClassSign(e),e)}static getItemByClass(e,t){let r,i=o.getPoolBySign(e);return r=i.length?i.pop():new t,r[o.POOLSIGN]=!1,r}static getItemByCreateFun(e,t,r=null){var i=o.getPoolBySign(e),s=i.length?i.pop():t.call(r);return s[o.POOLSIGN]=!1,s}static getItem(e){var t=o.getPoolBySign(e),r=t.length?t.pop():null;return r&&(r[o.POOLSIGN]=!1),r}}o._CLSID=0,o.POOLSIGN="__InPool",o._poolDic={};var h=1;const _=180/Math.PI,u=Math.PI/180;class d{static toRadian(e){return e*u}static toAngle(e){return e*_}static toHexColor(e){if(e<0||isNaN(e))return null;for(var t=e.toString(16);t.length<6;)t="0"+t;return"#"+t}static fromStringColor(e){if(!e)return 0;if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),r=e.indexOf(")");if(-1==t||-1==r)return 0;let i=(e=e.substring(t+1,r)).split(","),s=i.length;for(let e=0;e<s;e++)i[e]=parseFloat(i[e]),isNaN(i[e])&&(i[e]=0);return 4==i.length?(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+Math.round(255*i[3]):(i[0]<<16)+(i[1]<<8)+i[2]}{"#"===e.charAt(0)&&(e=e.substring(1));let t=e.length;if(3===t||4===t){let r="";for(let i=0;i<t;i++)r+=e[i]+e[i];e=r}return parseInt(e,16)}}static getGID(){return h++}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var r=t.length;for(let i=0;i<r;i++)e[i]=t[i];return e}static transPointList(e,t,r){var i,s=e.length;for(i=0;i<s;i+=2)e[i]+=t,e[i+1]+=r}static parseInt(e,t=0){var r=parseInt(e,t);return isNaN(r)?0:r}static getBaseName(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.substring(t+1)),t=e.indexOf("?"),-1!=t&&(e=e.substring(0,t)),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let r=e.substring(t+1).toLowerCase(),i=r.indexOf("?");if(-1!=i&&(r=r.substring(0,i)),"ls"===r){let i=e.lastIndexOf(".",t-1);if(-1!=i){let s=e.substring(i+1,t+1)+r;if("lanit.ls"===s||"ltcb.ls"===s)return s}}return r}return""}static replaceFileExtension(e,t,r){if(!e)return e;let i=e.lastIndexOf(".");if(t.length>0&&!r&&(t="."+t),-1!=i){let r=e.indexOf("?",i);return-1!=r?e.substring(0,i)+t+e.substring(r):e.substring(0,i)+t}return e+t}}class c{get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}constructor(){this._hideFlags=0,this._status=0,this._enabled=!0,this._singleton=!0,this._id=d.getGID(),this._initialize()}_initialize(){this._extra={}}hasHideFlag(e){return!!(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw"reuse a destroyed component";this.owner=e,this._isScript()&&e._setBit(s.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t,r;if(e){if(0==this._status&&(this._status=1,(l.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,l.isPlaying||this.runInEditor)){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||n.stage._componentDriver).add(this),l.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,l.isPlaying||this.runInEditor)){((null===(r=this.owner._is3D&&this.owner._scene)||void 0===r?void 0:r._componentDriver)||n.stage._componentDriver).remove(this),n.stage.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(e){var t;if(e)(l.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),o.recoverByClass(this)));else if(this._setActive(!1),this._status=4,l.isPlaying||this.runInEditor){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||n.stage._componentDriver)._toDestroys.add(this)}}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class p{constructor(e=1,t=0,r=0,i=1,s=0,a=0,n=0){if(this._bTransform=!1,null!=p._createFun)return p._createFun(e,t,r,i,s,a,n);this.a=e,this.b=t,this.c=r,this.d=i,this.tx=s,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,s=this.c,a=this.tx;return this.a=i*t-this.b*r,this.b=i*r+this.b*t,this.c=s*t-this.d*r,this.d=s*r+this.d*t,this.tx=a*t-this.ty*r,this.ty=a*r+this.ty*t,this._bTransform=!0,this}skew(e,t){var r=Math.tan(e),i=Math.tan(t),s=this.a,a=this.b;return this.a+=i*this.c,this.b+=i*this.d,this.c+=r*s,this.d+=r*a,this}invertTransformPoint(e){var t=this.a,r=this.b,i=this.c,s=this.d,a=this.tx,n=t*s-r*i,l=s/n,o=-r/n,h=-i/n,_=t/n,u=(i*this.ty-s*a)/n,d=-(t*this.ty-r*a)/n;return e.setTo(l*e.x+h*e.y+u,o*e.x+_*e.y+d)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,r=this.c,i=this.d,s=this.tx,a=e*i-t*r;return this.a=i/a,this.b=-t/a,this.c=-r/a,this.d=e/a,this.tx=(r*this.ty-i*s)/a,this.ty=-(e*this.ty-t*s)/a,this}setTo(e,t,r,i,s,a){return this.a=e,this.b=t,this.c=r,this.d=i,this.tx=s,this.ty=a,this}concat(e){var t=this.a,r=this.c,i=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=r*e.a+this.d*e.c,this.d=r*e.b+this.d*e.d,this.tx=i*e.a+this.ty*e.c+e.tx,this.ty=i*e.b+this.ty*e.d+e.ty,this}static mul(e,t,r){var i=e.a,s=e.b,a=e.c,n=e.d,l=e.tx,o=e.ty,h=t.a,_=t.b,u=t.c,d=t.d,c=t.tx,p=t.ty;return 0!==_||0!==u?(r.a=i*h+s*u,r.b=i*_+s*d,r.c=a*h+n*u,r.d=a*_+n*d,r.tx=h*l+u*o+c,r.ty=_*l+d*o+p):(r.a=i*h,r.b=s*d,r.c=a*h,r.d=n*d,r.tx=h*l+c,r.ty=d*o+p),r}static mul16(e,t,r){var i=e.a,s=e.b,a=e.c,n=e.d,l=e.tx,o=e.ty,h=t.a,_=t.b,u=t.c,d=t.d,c=t.tx,p=t.ty;return 0!==_||0!==u?(r[0]=i*h+s*u,r[1]=i*_+s*d,r[4]=a*h+n*u,r[5]=a*_+n*d,r[12]=h*l+u*o+c,r[13]=_*l+d*o+p):(r[0]=i*h,r[1]=s*d,r[4]=a*h,r[5]=n*d,r[12]=h*l+c,r[13]=d*o+p),r}scaleEx(e,t){var r=this.a,i=this.b,s=this.c,a=this.d;0!==i||0!==s?(this.a=e*r,this.b=e*i,this.c=t*s,this.d=t*a):(this.a=e*r,this.b=0*a,this.c=0*r,this.d=t*a),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,s=this.b,a=this.c,n=this.d;0!==s||0!==a?(this.a=t*i+r*a,this.b=t*s+r*n,this.c=-r*i+t*a,this.d=-r*s+t*n):(this.a=t*i,this.b=r*n,this.c=-r*i,this.d=t*n),this._bTransform=!0}clone(){var e=p.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){o.recover("Matrix",this.identity())}static create(){return o.getItemByClass("Matrix",p)}}p.EMPTY=new p,p.TEMP=new p,p._createFun=null;class f{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return o.getItemByClass("Point",f)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){o.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}f.TEMP=new f,f.EMPTY=new f;class g{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.width=r,this.height=i}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(e,t,r,i){return this.x=e,this.y=t,this.width=r,this.height=i,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=g.TEMP&&this!=g.EMPTY&&o.recover("Rectangle",this.reset())}static create(){return o.getItemByClass("Rectangle",g)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t=null){return this.intersects(e)?(t||(t=new g),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}union(e,t=null){return t||(t=new g),this.clone(t),e.width<=0||e.height<=0?t:(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom),this)}clone(e=null){return e||(e=new g),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}_getBoundPoints(){var e=g._temB;return e.length=0,0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getBoundPointS(e,t,r,i,s){var a=g._temA;return a.length=0,0==r||0==i||(s&&(e*=s.width,t*=s.height,r*=s.width,i*=s.height),a.push(e,t,e+r,t,e,t+i,e+r,t+i)),a}static _getWrapRec(e,t=null){if(!e||e.length<1)return t?t.setTo(0,0,0,0):g.TEMP.setTo(0,0,0,0);t=t||g.create();var r,i,s,a,n,l=e.length,o=f.TEMP;for(s=n=-(i=a=99999),r=0;r<l;r+=2)o.x=e[r],o.y=e[r+1],i=i<o.x?i:o.x,a=a<o.y?a:o.y,s=s>o.x?s:o.x,n=n>o.y?n:o.y;return t.setTo(i,a,s-i,n-a)}isEmpty(){return this.width<=0||this.height<=0}}var m,T;g.EMPTY=new g,g.TEMP=new g,g._temB=[],g._temA=[],e.HDREncodeFormat=void 0,(m=e.HDREncodeFormat||(e.HDREncodeFormat={}))[m.NONE=0]="NONE",m[m.RGBM=1]="RGBM",m[m.RGBD=2]="RGBD",e.TextureFormat=void 0,(T=e.TextureFormat||(e.TextureFormat={}))[T.R8G8B8=0]="R8G8B8",T[T.R8G8B8A8=1]="R8G8B8A8",T[T.R5G6B5=16]="R5G6B5",T[T.Alpha8=2]="Alpha8",T[T.DXT1=3]="DXT1",T[T.DXT3=29]="DXT3",T[T.DXT5=4]="DXT5",T[T.ETC1RGB=5]="ETC1RGB",T[T.ETC2RGB=6]="ETC2RGB",T[T.ETC2RGBA=7]="ETC2RGBA",T[T.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",T[T.ETC2SRGB=28]="ETC2SRGB",T[T.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",T[T.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",T[T.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",T[T.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",T[T.R32G32B32A32=15]="R32G32B32A32",T[T.R32G32B32=30]="R32G32B32",T[T.R16G16B16A16=17]="R16G16B16A16",T[T.R16G16B16=31]="R16G16B16",T[T.ASTC4x4=18]="ASTC4x4",T[T.ASTC4x4SRGB=23]="ASTC4x4SRGB",T[T.ASTC6x6=19]="ASTC6x6",T[T.ASTC6x6SRGB=24]="ASTC6x6SRGB",T[T.ASTC8x8=20]="ASTC8x8",T[T.ASTC8x8SRGB=25]="ASTC8x8SRGB",T[T.ASTC10x10=21]="ASTC10x10",T[T.ASTC10x10SRGB=26]="ASTC10x10SRGB",T[T.ASTC12x12=22]="ASTC12x12",T[T.ASTC12x12SRGB=27]="ASTC12x12SRGB",T[T.KTXTEXTURE=-1]="KTXTEXTURE",T[T.PVRTEXTURE=-2]="PVRTEXTURE";class x{}class y{constructor(){this._flag=0,this._items=[]}add(e,t,r){let i=this._items,s=i.findIndex(((r,i,s)=>r==e&&s[i+1]==t));-1!=s?(i[s+2]=r,i[s+3]=1):i.push(e,t,r,1)}once(e,t,r){let i=this._items,s=i.findIndex(((r,i,s)=>r==e&&s[i+1]==t));-1!=s?(i[s+2]=r,i[s+3]=2):i.push(e,t,r,2)}remove(e,t){let r=this._items,i=r.findIndex(((r,i,s)=>r==e&&s[i+1]==t));-1!=i&&(0!=this._flag?(r[i+3]=0,this._flag=2):r.splice(i,4))}clear(){let e=this._items;0!=this._flag?(e.forEach(((e,t,r)=>{t%4==3&&(r[t]=0)})),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach(((t,r,i)=>{r%4==1&&i[r]==e&&(i[r+2]=0)})),this._flag=2;else{let r=t.length-4;for(;r>=0;)t[r+1]==e&&t.splice(r,4),r-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,r=t.length;for(let i=0;i<r;i+=4){if(0==t[i+3])continue;let r=t[i+2];try{null!=r?t[i].call(t[i+1],...r,...e):t[i].call(t[i+1],...e)}catch(e){console.error(e)}2==t[i+3]&&(t[i+3]=0,this._flag=2)}if(2==this._flag){let e=t.length,r=0;for(;r<e;)0!=t[r+3]?r+=4:(t.splice(r,4),e-=4)}this._flag=0}}class E{static isMouseEvent(e){return S.has(e)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new f}setTo(e,t,r){return this.type=e,this.currentTarget=t,this.target=r,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}E.EMPTY=new E,E.MOUSE_DOWN="mousedown",E.MOUSE_UP="mouseup",E.RIGHT_MOUSE_DOWN="rightmousedown",E.RIGHT_MOUSE_UP="rightmouseup",E.CLICK="click",E.RIGHT_CLICK="rightclick",E.MOUSE_MOVE="mousemove",E.MOUSE_OVER="mouseover",E.MOUSE_OUT="mouseout",E.MOUSE_WHEEL="mousewheel",E.ROLL_OVER="mouseover",E.ROLL_OUT="mouseout",E.DOUBLE_CLICK="doubleclick",E.MOUSE_DRAG="mousedrag",E.MOUSE_DRAG_END="mousedragend",E.DRAG_START="dragstart",E.DRAG_MOVE="dragmove",E.DRAG_END="dragend",E.KEY_DOWN="keydown",E.KEY_PRESS="keypress",E.KEY_UP="keyup",E.CHANGE="change",E.CHANGED="changed",E.WILL_RESIZE="willResize",E.RESIZE="resize",E.ADDED="added",E.REMOVED="removed",E.DISPLAY="display",E.UNDISPLAY="undisplay",E.ERROR="error",E.COMPLETE="complete",E.LOADED="loaded",E.READY="ready",E.PROGRESS="progress",E.INPUT="input",E.RENDER="render",E.OPEN="open",E.MESSAGE="message",E.CLOSE="close",E.FRAME="enterframe",E.ENTER="enter",E.SELECT="select",E.BLUR="blur",E.FOCUS="focus",E.VISIBILITY_CHANGE="visibilitychange",E.FOCUS_CHANGE="focuschange",E.PLAYED="played",E.PAUSED="paused",E.STOPPED="stopped",E.START="start",E.END="end",E.LINK="link",E.LABEL="label",E.FULL_SCREEN_CHANGE="fullscreenchange",E.DEVICE_LOST="devicelost",E.TRANSFORM_CHANGED="transformchanged",E.LAYERCHANGE="layerChange",E.staticMask="staticMask",E.TRIGGER_ENTER="triggerenter",E.TRIGGER_STAY="triggerstay",E.TRIGGER_EXIT="triggerexit",E.COLLISION_ENTER="collisionenter",E.COLLISION_STAY="collisionstay",E.COLLISION_EXIT="collisionexit",E.JOINT_BREAK="jointbreak",E._Add_Script="addscript";const S=new Set([E.MOUSE_DOWN,E.MOUSE_UP,E.MOUSE_MOVE,E.CLICK,E.DOUBLE_CLICK,E.RIGHT_CLICK,E.RIGHT_MOUSE_DOWN,E.RIGHT_MOUSE_UP,E.MOUSE_OVER,E.MOUSE_OUT,E.MOUSE_WHEEL,E.MOUSE_DRAG,E.MOUSE_DRAG_END]),b=[];class v{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let r=this._events&&this._events[e];if(!r)return!1;let i=r.count>0;if(Array.isArray(t))r.invoke(...t);else if(void 0!==t)r.invoke(t);else if(t===E.EMPTY){let t=b.length>0?b.pop():new E;r.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,b.push(t)}else r.invoke();return i}on(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let s=this._events[e];return s||(this.onStartListeningToType(e),this._events[e]=s=new y),s.add(r,t,i),this}once(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let s=this._events[e];return s||(this.onStartListeningToType(e),this._events[e]=s=new y),s.once(r,t,i),this}off(e,t,r){2==arguments.length&&(r=t,t=null);let i=this._events&&this._events[e];return i&&i.remove(r,t),this}offAll(e){if(null==e)this._events=null;else{let t=this._events&&this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var R,A,C=0,D=0,M=0;class w extends v{static get cpuMemory(){return w._cpuMemory}static get gpuMemory(){return w._gpuMemory}static _addCPUMemory(e){w._cpuMemory+=e}static _addGPUMemory(e){w._gpuMemory+=e}static _addMemory(e,t){w._cpuMemory+=e,w._gpuMemory+=t}static destroyUnusedResources(){D=0,M=0,n.loader.loading?n.timer.frameLoop(1,w,w._destroyUnusedResources):w._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&n.loader.loading)return;n.timer.clear(w,w._destroyUnusedResources);let t=0;for(let e in w._idResourcesMap){let r=w._idResourcesMap[e];r.lock||0!==r._referenceCount||(r.destroy(),t++)}w.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&M<5&&(M++,n.timer.frameLoop(1,w,w._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute=e}get referenceCount(){return this._referenceCount}constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++C,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(w._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,w._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,w._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,D>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}_recoverResource(){}_disposeResource(){}_activeResource(){}destroy(){this._destroyed||(this._destroyed=!0,this.lock=!1,D++,this._disposeResource(),D--,this.offAll(),delete w._idResourcesMap[this.id],this.url&&(w.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),n.loader.clearRes(this.url,this)))}}w._idResourcesMap={},w._cpuMemory=0,w._gpuMemory=0,w.DEBUG=!1;class I extends w{get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=x.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(t,i,s){super(),this._gammaSpace=!1,this._width=t,this._height=i,this._format=s,this.destroyedImmediately=r.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}class P{static getSystemEndian(){if(!P._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),P._sysEndian=256===new Int16Array(e)[0]?P.LITTLE_ENDIAN:P.BIG_ENDIAN}return P._sysEndian}constructor(e=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get endian(){return this._xd_?P.LITTLE_ENDIAN:P.BIG_ENDIAN}set endian(e){this._xd_=e===P.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(e,t){return this.readFloat32Array(e,t)}readFloat32Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Float32Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getUint8Array(e,t){return this.readUint8Array(e,t)}readUint8Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Uint8Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getInt16Array(e,t){return this.readInt16Array(e,t)}readInt16Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Int16Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getUInt8(e){return this._readUInt8(e)}_readUInt8(e){return this._d_.getUint8(e)}_getUint16(e){return this._readUint16(e)}_readUint16(e){return this._d_.getUint16(e,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new p(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(e){var t,r,i=this._pos_+e,s=String.fromCharCode,a=this._u8d_,n=[],l=0;for(n.length=1e3;this._pos_<i;)if((t=a[this._pos_++])<128)0!=t&&(n[l++]=s(t));else if(t<224)n[l++]=s((63&t)<<6|127&a[this._pos_++]);else if(t<240)r=a[this._pos_++],n[l++]=s((31&t)<<12|(127&r)<<6|127&a[this._pos_++]);else{const e=(15&t)<<18|(127&(r=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(e>=65536){const t=e-65536,r=55296|t>>10,i=56320|1023&t;n[l++]=s(r),n[l++]=s(i)}else n[l++]=s(e)}return n.length=l,n.join("")}getCustomString(e){return this.readCustomString(e)}readCustomString(e){for(var t,r="",i=0,s=String.fromCharCode,a=this._u8d_;e>0;)if((t=a[this._pos_])<128)r+=s(t),this._pos_++,e--;else for(i=t-128,this._pos_++,e-=i;i>0;)t=a[this._pos_++],r+=s(a[this._pos_++]<<8|t),i--;return r}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(e){for(var t=0,r=(e+="").length;t<r;t++){var i=e.charCodeAt(t);if(i<=127)this.writeByte(i);else if(i<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|i>>6,128|63&i],this._pos_),this._pos_+=2;else if(i>=55296&&i<=56319){t++;const r=e.charCodeAt(t);if(!Number.isNaN(r)&&r>=56320&&r<=57343){const e=64+(1023&i),t=1023&r,s=240|e>>8&63,a=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,l=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([s,a,n,l],this._pos_),this._pos_+=4}}else i<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|i>>12,128|i>>6&63,128|63&i],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var r=this.pos-t-2;this._d_.setUint16(t,r,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var r=this.pos-t-4;this._d_.setUint32(t,r,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(e=-1){if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw"readUTFBytes error - Out of bounds";return e=e>0?e:t,this._rUTF(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t=0,r=0){if(t<0||r<0)throw"writeArrayBuffer error - Out of bounds";0==r&&(r=e.byteLength-t),this._ensureWrite(this._pos_+r);var i=new Uint8Array(e);this._u8d_.set(i.subarray(t,t+r),this._pos_),this._pos_+=r}readArrayBuffer(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}}P.BIG_ENDIAN="bigEndian",P.LITTLE_ENDIAN="littleEndian",P._sysEndian=null;class B{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?(B._baseTable[0|e]=0,B._baseTable[256|e]=32768,B._shiftTable[0|e]=24,B._shiftTable[256|e]=24):t<-14?(B._baseTable[0|e]=1024>>-t-14,B._baseTable[256|e]=1024>>-t-14|32768,B._shiftTable[0|e]=-t-1,B._shiftTable[256|e]=-t-1):t<=15?(B._baseTable[0|e]=t+15<<10,B._baseTable[256|e]=t+15<<10|32768,B._shiftTable[0|e]=13,B._shiftTable[256|e]=13):t<128?(B._baseTable[0|e]=31744,B._baseTable[256|e]=64512,B._shiftTable[0|e]=24,B._shiftTable[256|e]=24):(B._baseTable[0|e]=31744,B._baseTable[256|e]=64512,B._shiftTable[0|e]=13,B._shiftTable[256|e]=13)}for(B._mantissaTable[0]=0,e=1;e<1024;++e){var r=e<<13;for(t=0;!(8388608&r);)t-=8388608,r<<=1;r&=-8388609,t+=947912704,B._mantissaTable[e]=r|t}for(e=1024;e<2048;++e)B._mantissaTable[e]=939524096+(e-1024<<13);for(B._exponentTable[0]=0,e=1;e<31;++e)B._exponentTable[e]=e<<23;for(B._exponentTable[31]=1199570944,B._exponentTable[32]=2147483648,e=33;e<63;++e)B._exponentTable[e]=2147483648+(e-32<<23);for(B._exponentTable[63]=3347054592,B._offsetTable[0]=0,e=1;e<64;++e)B._offsetTable[e]=32===e?0:1024}static roundToFloat16Bits(e){B._floatView[0]=e;var t=B._uint32View[0],r=t>>23&511;return B._baseTable[r]+((8388607&t)>>B._shiftTable[r])}static convertToNumber(e){var t=e>>10;return B._uint32View[0]=B._mantissaTable[B._offsetTable[t]+(1023&e)]+B._exponentTable[t],B._floatView[0]}}B._buffer=new ArrayBuffer(4),B._floatView=new Float32Array(B._buffer),B._uint32View=new Uint32Array(B._buffer),B._baseTable=new Uint32Array(512),B._shiftTable=new Uint32Array(512),B._mantissaTable=new Uint32Array(2048),B._exponentTable=new Uint32Array(64),B._offsetTable=new Uint32Array(64),e.FilterMode=void 0,(R=e.FilterMode||(e.FilterMode={}))[R.Point=0]="Point",R[R.Bilinear=1]="Bilinear",R[R.Trilinear=2]="Trilinear",e.RenderCapable=void 0,(A=e.RenderCapable||(e.RenderCapable={}))[A.Element_Index_Uint32=0]="Element_Index_Uint32",A[A.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",A[A.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",A[A.Texture_anisotropic=3]="Texture_anisotropic",A[A.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",A[A.RenderTextureFormat_R32G32B32A32=5]="RenderTextureFormat_R32G32B32A32",A[A.RenderTextureFormat_Depth=6]="RenderTextureFormat_Depth",A[A.RenderTextureFormat_ShadowMap=7]="RenderTextureFormat_ShadowMap",A[A.Vertex_VAO=8]="Vertex_VAO",A[A.DrawElement_Instance=9]="DrawElement_Instance",A[A.Shader_TextureLod=10]="Shader_TextureLod",A[A.COMPRESS_TEXTURE_S3TC=11]="COMPRESS_TEXTURE_S3TC",A[A.COMPRESS_TEXTURE_S3TC_SRGB=12]="COMPRESS_TEXTURE_S3TC_SRGB",A[A.COMPRESS_TEXTURE_PVRTC=13]="COMPRESS_TEXTURE_PVRTC",A[A.COMPRESS_TEXTURE_ETC1=14]="COMPRESS_TEXTURE_ETC1",A[A.COMPRESS_TEXTURE_ETC=15]="COMPRESS_TEXTURE_ETC",A[A.COMPRESS_TEXTURE_ASTC=16]="COMPRESS_TEXTURE_ASTC",A[A.Texture_SRGB=17]="Texture_SRGB",A[A.MSAA=18]="MSAA",A[A.UnifromBufferObject=19]="UnifromBufferObject",A[A.Texture3D=20]="Texture3D",A[A.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",A[A.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const L=827611204,F=861165636,O=877942852,N=894720068,U=131072;class G{constructor(e,t,r,i,s,a,n,l,o,h){this.width=e,this.height=t,this.mipmapCount=r,this.isCube=i,this.blockBytes=a,this.dataOffset=n,this.format=l,this.source=h,this.bpp=s,this.compressed=o}static getDDSTextureInfo(t){let r=new Int32Array(t,0,31),i=r[4],s=r[3],a=1;131072&r[2]&&(a=Math.max(1,r[7]));let n=r[21],l=!(4&~r[20]),o=!(64&~r[20]),h=(r[20]&U)===U,_=!(512&~r[28]),u=n===L||n===F||n===N||n===O,d=e.TextureFormat.DXT1,c=r[1]+4,p=1;switch(n){case L:d=e.TextureFormat.DXT1,p=8;break;case F:d=e.TextureFormat.DXT3,p=16;break;case O:case N:d=e.TextureFormat.DXT5,p=16;break;case 113:d=e.TextureFormat.R16G16B16A16,p=4;break;case 116:d=e.TextureFormat.R32G32B32A32,p=4;break;default:throw"Unsupported format "+(f=n,String.fromCharCode(255&f,f>>8&255,f>>16&255,f>>24&255))}var f;if(542327876!==r[0])throw"Invalid magic number in DDS header";if(!l&&!o&&!h)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let g=x.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||x.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(u&&!g)throw"Compressed textures are not supported on this platform.";return new G(i,s,a,_,0,p,c,d,u,t)}}var k;e.TextureDimension=void 0,(k=e.TextureDimension||(e.TextureDimension={}))[k.Tex2D=0]="Tex2D",k[k.Cube=1]="Cube",k[k.Tex3D=2]="Tex3D",k[k.Texture2DArray=3]="Texture2DArray",k[k.CubeArray=4]="CubeArray",k[k.Unkonw=5]="Unkonw",k[k.None=6]="None";const V=6408,W=6407,H=5121;class X{static getLayaFormat(t,r,i,s){if(0!=t){if(t==V&&32856==r&&i==H)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==V&&35907==r&&i==H)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==V&&34836==r&&5126==i)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==V&&34842==r&&5131==i)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==W&&34837==r&&5126==i)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==W&&34843==r&&5131==i)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==W&&35905==r&&i==H)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==W&&32849==r&&i==H)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(r){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return X.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(t,12,13*r),s=67305985==i.getUint32(0,!0),a=i.getUint32(1*r,s),n=i.getUint32(2*r,s),l=i.getUint32(3*r,s),o=i.getUint32(4*r,s);i.getUint32(5*r,s);let h=i.getUint32(6*r,s),_=i.getUint32(7*r,s);i.getUint32(8*r,s);let u=i.getUint32(9*r,s),d=i.getUint32(10*r,s),c=i.getUint32(11*r,s),p=i.getUint32(12*r,s),f=X.getLayaFormat(l,o,a,n),g=f.format,m=f.sRGB,T=e.TextureDimension.Tex2D;d>1&&u>1?T=e.TextureDimension.CubeArray:d>1&&u<=1?T=e.TextureDimension.Cube:d<=1&&u>1&&(T=e.TextureDimension.Texture2DArray);return new X(t,0==l,m,T,h,_,g,c||1,p,64)}constructor(e,t,r,i,s,a,n,l,o,h){this.source=e,this.compress=t,this.sRGB=r,this.dimension=i,this.width=s,this.height=a,this.format=n,this.mipmapCount=l,this.bytesOfKeyValueData=o,this.headerOffset=h}}class Y extends I{static __init__(){var t=new Uint8Array(4);if(t[0]=128,t[1]=128,t[2]=128,t[3]=255,Y.grayTexture=new Y(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Y.grayTexture.setPixelsData(t,!1,!1),Y.grayTexture.lock=!0,Y.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,t[3]=255,Y.whiteTexture=new Y(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Y.whiteTexture.setPixelsData(t,!1,!1),Y.whiteTexture.lock=!0,Y.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,t[3]=255,Y.blackTexture=new Y(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Y.blackTexture.setPixelsData(t,!1,!1),Y.blackTexture.lock=!0,Y.blackTexture.name="Default_Black",x.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(4);t[0]=14336,t[1]=14336,t[2]=15360,t[3]=15360,Y.normalTexture=new Y(1,1,e.TextureFormat.R16G16B16A16,!1,!1,!1),Y.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,t[3]=255,Y.normalTexture=new Y(1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),Y.normalTexture.setPixelsData(t,!1,!1);Y.normalTexture.lock=!0,Y.normalTexture.name="Default_Normal",Y.errorTexture=Y.whiteTexture}static _SimpleAnimatorTextureParse(t,r=null,i=null){var s,a,n=new P(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var l,o=n.readInt32(),h=n.readInt32();s=new Float32Array(o*o*4),a=new Float32Array(n.readArrayBuffer(4*h)),s.set(a,0),(l=new Y(o,o,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),l.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":o=n.readInt32(),h=n.readInt32();if(s=new Uint16Array(n.readArrayBuffer(2*h)),x.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(o*o*4)).set(s,0),(l=new Y(o,o,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),l.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),x.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(o*o*4);for(var _=0,u=s.length;_<u;_++)a[_]=B.convertToNumber(s[_]);(l=new Y(o,o,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),l.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return l}static _parseImage(t,r=null,i=null){let s=i?i[2]:e.TextureFormat.R8G8B8A8,a=!i||i[3],o=!!i&&i[4],h=!!i&&i[5],_=!!r&&r.premultiplyAlpha,u=new Y(t.width,t.height,s,a,o,h,_);return r?(u.setImageData(t,_,!1),u.setProperties(r)):u.setImageData(t,!1,!1),o&&(l.isConch&&t._nativeObj?u._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(n.Browser.canvas.size(t.width,t.height),n.Browser.canvas.clear(),n.Browser.context.drawImage(t,0,0,t.width,t.height),u._pixels=new Uint8Array(n.Browser.context.getImageData(0,0,t.width,t.height).data.buffer))),u}static _parseDDS(e,t=null,r=null){let i=G.getDDSTextureInfo(e),s=r[5],a=new Y(i.width,i.height,i.format,i.mipmapCount>1,!1,s);return a.setDDSData(i),t&&a.setProperties(t),a}static _parseKTX(e,t=null,r=null){let i=X.getKTXTextureInfo(e),s=new Y(i.width,i.height,i.format,i.mipmapCount>1,!1,i.sRGB);return s.setKTXData(i),t&&s.setProperties(t),s}static _parsePVR(e,t=null,r=null){throw"pvr !"}static load(e,t){n.loader.load(e,t,null,n.Loader.TEXTURE2D)}constructor(t,r,i,s=!0,a,n=!1,l=!1){super(t,r,i),this._canRead=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._texture=x.textureContext.createTextureInternal(this._dimension,t,r,i,s,n,l)}setImageData(e,t,r){let i=this._texture;x.textureContext.setTextureImageData(i,e,t,r)}setPixelsData(e,t,r){let i=this._texture;x.textureContext.setTexturePixelsData(i,e,t,r)}setSubPixelsData(e,t,r,i,s,a,n,l,o){let h=this._texture;x.textureContext.setTextureSubPixelsData(h,s,a,n,e,t,r,i,l,o)}setDDSData(e){let t=this._texture;x.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;x.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;x.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return Y.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}Y.TEXTURE2D="TEXTURE2D",Y.grayTexture=null,Y.whiteTexture=null,Y.blackTexture=null,Y.normalTexture=null,Y.errorTexture=null;class z extends w{constructor(){super()}}class j{static mat2MatArray(e,t){var r=e,i=t;return i[0]=r.a,i[1]=r.b,i[2]=j.EMPTYMAT4_ARRAY[2],i[3]=j.EMPTYMAT4_ARRAY[3],i[4]=r.c,i[5]=r.d,i[6]=j.EMPTYMAT4_ARRAY[6],i[7]=j.EMPTYMAT4_ARRAY[7],i[8]=j.EMPTYMAT4_ARRAY[8],i[9]=j.EMPTYMAT4_ARRAY[9],i[10]=j.EMPTYMAT4_ARRAY[10],i[11]=j.EMPTYMAT4_ARRAY[11],i[12]=r.tx,i[13]=r.ty,i[14]=j.EMPTYMAT4_ARRAY[14],i[15]=j.EMPTYMAT4_ARRAY[15],t}static restoreTempArray(){j.TEMPMAT4_ARRAY[0]=1,j.TEMPMAT4_ARRAY[1]=0,j.TEMPMAT4_ARRAY[4]=0,j.TEMPMAT4_ARRAY[5]=1,j.TEMPMAT4_ARRAY[12]=0,j.TEMPMAT4_ARRAY[13]=0}static clear(){j.worldScissorTest=!1,j.worldAlpha=1}}var q,K,$;j._MAXSIZE=99999999,j.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],j.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],j.worldMatrix4=j.TEMPMAT4_ARRAY,j.worldMatrix=new p,j.matWVP=null,j.worldAlpha=1,j.worldScissorTest=!1,j.width=0,j.height=0,j.InvertY=!1,e.RenderTargetFormat=void 0,(q=e.RenderTargetFormat||(e.RenderTargetFormat={}))[q.None=-1]="None",q[q.R8G8B8=0]="R8G8B8",q[q.R8G8B8A8=1]="R8G8B8A8",q[q.R16G16B16A16=17]="R16G16B16A16",q[q.R32G32B32=30]="R32G32B32",q[q.R32G32B32A32=15]="R32G32B32A32",q[q.R16G16B16=31]="R16G16B16",q[q.DEPTH_16=35]="DEPTH_16",q[q.STENCIL_8=36]="STENCIL_8",q[q.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",q[q.DEPTH_32=38]="DEPTH_32",q[q.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus",e.RenderClearFlag=void 0,(K=e.RenderClearFlag||(e.RenderClearFlag={}))[K.Nothing=0]="Nothing",K[K.Color=1]="Color",K[K.Depth=2]="Depth",K[K.Stencil=4]="Stencil";class Z{static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}constructor(e=1,t=1,r=1,i=1){this.r=e,this.g=t,this.b=r,this.a=i}equal(e){if(!e)return!1;const toFIxed=(e,t)=>{var r=1e-5;return-r<e-t&&e-t<r};return toFIxed(e.r,this.r)&&toFIxed(e.g,this.g)&&toFIxed(e.b,this.b)&&toFIxed(e.a,this.a)}toLinear(e){e.r=Z.gammaToLinearSpace(this.r),e.g=Z.gammaToLinearSpace(this.g),e.b=Z.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=Z.linearToGammaSpace(this.r),e.g=Z.linearToGammaSpace(this.g),e.b=Z.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,r,i){this.r=e,this.g=t,this.b=r,this.a=i}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var e=new Z;return this.cloneTo(e),e}}Z.RED=new Z(1,0,0,1),Z.GREEN=new Z(0,1,0,1),Z.BLUE=new Z(0,0,1,1),Z.CYAN=new Z(0,1,1,1),Z.YELLOW=new Z(1,.92,.016,1),Z.MAGENTA=new Z(1,0,1,1),Z.GRAY=new Z(.5,.5,.5,1),Z.WHITE=new Z(1,1,1,1),Z.BLACK=new Z(0,0,0,1),Z.CLEAR=new Z(0,0,0,0);class Q extends I{static get currentActive(){return Q._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Y.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,i=e.RenderTargetFormat.R8G8B8,s=e.RenderTargetFormat.DEPTH_16,a=!0){super(t,r,i),this._mgrKey=0,this._colorFormat=i,this._depthStencilFormat=s,0!=t&&0!=r&&a&&this._create(),this.lock=!0}get isCube(){return this._nativeObj.isCube}get samples(){return this._nativeObj.samples}get generateMipmap(){return this._nativeObj.generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._nativeObj=new window.conchRenderTexture2D(x.renderEngine._nativeObj,this.width,this.height,this._colorFormat,this.depthStencilFormat),this._texture=this._nativeObj._renderTarget._textures[0]}static pushRT(){throw new Error("Method not implemented.")}static popRT(){throw new Error("Method not implemented.")}start(){this._nativeObj.start()}end(){this._nativeObj.end()}restore(){this._nativeObj.restore()}clear(e=0,t=0,r=0,i=1){this._nativeObj.clear(e,t,r,i)}getData(e,t,r,i){return this._nativeObj.getData(e,t,r,i)}recycle(){}_disposeResource(){this._nativeObj._disposeResource()}}Q._clearColor=new Z(0,0,0,0),Q.rtStack=[],Q.defuv=[0,0,1,0,1,1,0,1],Q.flipyuv=[0,1,1,1,1,0,0,0];class J extends I{static get currentActive(){return J._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Y.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,i=e.RenderTargetFormat.R8G8B8,s=e.RenderTargetFormat.None){super(t,r,i),this._mgrKey=0,this._invertY=!1,this._colorFormat=i,this._depthStencilFormat=s,0!=t&&0!=r&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._renderTarget=x.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}static pushRT(){J.rtStack.push({rt:J._currentActive,w:j.width,h:j.height})}static popRT(){var e=J.rtStack.pop();e&&(J._currentActive!=e.rt&&(e.rt?(x.textureContext.bindRenderTarget(e.rt._renderTarget),j.InvertY=e.rt._invertY):(x.textureContext.bindoutScreenTarget(),j.InvertY=!1),J._currentActive=e.rt),x.renderEngine.viewport(0,0,e.w,e.h),x.renderEngine.scissor(0,0,e.w,e.h),j.width=e.w,j.height=e.h)}start(){x.textureContext.bindRenderTarget(this._renderTarget),this._lastRT=J._currentActive,J._currentActive=this,j.InvertY=this._invertY,x.renderEngine.viewport(0,0,this._width,this._height),x.renderEngine.scissor(0,0,this._width,this._height),this._lastWidth=j.width,this._lastHeight=j.height,j.width=this._width,j.height=this._height,z.activeShader=null}end(){x.textureContext.unbindRenderTarget(this._renderTarget),J._currentActive=null,j.InvertY=!1}restore(){this._lastRT!=J._currentActive&&(this._lastRT?(x.textureContext.bindRenderTarget(this._lastRT._renderTarget),j.InvertY=this._lastRT._invertY):(x.textureContext.unbindRenderTarget(this._renderTarget),j.InvertY=!1),J._currentActive=this._lastRT),x.renderEngine.viewport(0,0,this._lastWidth,this._lastHeight),x.renderEngine.scissor(0,0,this._lastWidth,this._lastHeight),j.width=this._lastWidth,j.height=this._lastHeight,z.activeShader=null}clear(t=0,r=0,i=0,s=1){J._clearColor.r=t,J._clearColor.g=r,J._clearColor.b=i,J._clearColor.a=s,x.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,J._clearColor,1)}getData(e,t,r,i){return x.textureContext.getRenderTextureData(this._renderTarget,e,t,r,i)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}J._clearColor=new Z(0,0,0,0),J._clearLinearColor=new Z,J.rtStack=[],J.defuv=[0,0,1,0,1,1,0,1],J.flipyuv=[0,1,1,1,1,0,0,0],window.conch&&!window.conchConfig.conchWebGL&&(J=Q);class ee{static getRT(t,r){return r|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new J(t,r,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}ee.dict={},e.BlendFactor=void 0,($=e.BlendFactor||(e.BlendFactor={}))[$.Zero=0]="Zero",$[$.One=1]="One",$[$.SourceColor=2]="SourceColor",$[$.OneMinusSourceColor=3]="OneMinusSourceColor",$[$.DestinationColor=4]="DestinationColor",$[$.OneMinusDestinationColor=5]="OneMinusDestinationColor",$[$.SourceAlpha=6]="SourceAlpha",$[$.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",$[$.DestinationAlpha=8]="DestinationAlpha",$[$.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",$[$.SourceAlphaSaturate=10]="SourceAlphaSaturate",$[$.BlendColor=11]="BlendColor",$[$.OneMinusBlendColor=12]="OneMinusBlendColor";class te{static __init__(){te.DepthTestCMD=x.renderEngine.createRenderStateComand(),te.DepthMaskCMD=x.renderEngine.createRenderStateComand(),te.DepthFuncCMD=x.renderEngine.createRenderStateComand(),te.StencilTestCMD=x.renderEngine.createRenderStateComand(),te.StencilMaskCMD=x.renderEngine.createRenderStateComand(),te.StencilFuncCMD=x.renderEngine.createRenderStateComand(),te.stencilOpCMD=x.renderEngine.createRenderStateComand(),te.BlendCMD=x.renderEngine.createRenderStateComand(),te.BlendEquationCMD=x.renderEngine.createRenderStateComand(),te.BlendEquationSeparateCMD=x.renderEngine.createRenderStateComand(),te.BlendFuncCMD=x.renderEngine.createRenderStateComand(),te.BlendFuncSeperateCMD=x.renderEngine.createRenderStateComand(),te.CullFaceCMD=x.renderEngine.createRenderStateComand(),te.FrontFaceCMD=x.renderEngine.createRenderStateComand()}static setDepthTest(e){x.renderEngine._GLRenderState.setDepthTest(e)}static setDepthMask(e){x.renderEngine._GLRenderState.setDepthMask(e)}static setDepthFunc(e){x.renderEngine._GLRenderState.setDepthFunc(e)}static setStencilTest(e){x.renderEngine._GLRenderState.setStencilTest(e)}static setStencilMask(e){x.renderEngine._GLRenderState.setStencilMask(e)}static setStencilFunc(e,t){x.renderEngine._GLRenderState.setStencilFunc(e,t)}static setstencilOp(e,t,r){x.renderEngine._GLRenderState.setstencilOp(e,t,r)}static setBlend(e){x.renderEngine._GLRenderState.setBlend(e)}static setBlendEquation(e){x.renderEngine._GLRenderState.setBlendEquation(e)}static setBlendEquationSeparate(e,t){x.renderEngine._GLRenderState.setBlendEquationSeparate(e,t)}static setBlendFunc(e,t){x.renderEngine._GLRenderState.setBlendFunc(e,t)}static setBlendFuncSeperate(e,t,r,i){x.renderEngine._GLRenderState.setBlendFuncSeperate(e,t,r,i)}static setCullFace(e){x.renderEngine._GLRenderState.setCullFace(e)}static setFrontFace(e){x.renderEngine._GLRenderState.setFrontFace(e)}}te.stencilFuncArray=new Array(2),te.blendEquationSeparateArray=new Array(2),te.blenfunArray=new Array(2),te.blendFuncSeperateArray=new Array(4),te.stencilOpArray=new Array(3);class re{static _init_(){re.fns=[re.BlendNormal,re.BlendAdd,re.BlendMultiply,re.BlendScreen,re.BlendOverlay,re.BlendLight,re.BlendMask,re.BlendDestinationOut,re.BlendAddOld,re.BlendSourceAlpha],re.targetFns=[re.BlendNormalTarget,re.BlendAddTarget,re.BlendMultiplyTarget,re.BlendScreenTarget,re.BlendOverlayTarget,re.BlendLightTarget,re.BlendMask,re.BlendDestinationOut,re.BlendAddTargetOld,re.BlendSourceAlpha]}static BlendNormal(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAdd(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiply(){te.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlay(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendNormalTarget(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAddTarget(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiplyTarget(){te.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlayTarget(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){te.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMask(){te.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.SourceAlpha)}static BlendDestinationOut(){te.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.Zero)}static BlendSourceAlpha(){te.setBlendFunc(e.BlendFactor.SourceAlpha,e.BlendFactor.OneMinusSourceAlpha)}}re.activeBlendFunction=null,re.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],re.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},re.NORMAL="normal",re.MASK="mask",re.LIGHTER="lighter";const ie=new g,se=new g;class ae extends w{static create(e,t,r,i,s,a=0,n=0,l=0,o=0){return ae._create(e,t,r,i,s,a,n,l,o)}static _create(e,t,r,i,s,a=0,n=0,l=0,o=0,h=null){var _,u=e instanceof ae,d=u?e.uv:ae.DEF_UV,c=u?e.bitmap:e;c.width&&t+i>c.width&&(i=c.width-t),c.height&&r+s>c.height&&(s=c.height-r),h?(_=h).setTo(c,null,l||i,o||s):_=new ae(c,null,l||i,o||s),_.width=i,_.height=s,_.offsetX=a,_.offsetY=n;var p=1/c.width,f=1/c.height;t*=p,r*=f,i*=p,s*=f;var g=_.uv[0],m=_.uv[1],T=_.uv[4],x=_.uv[5],y=T-g,E=x-m,S=function(e,t,r){for(var i=0;i<8;i+=2)r[i]+=e,r[i+1]+=t;return r}(d[0],d[1],[t,r,t+i,r,t+i,r+s,t,r+s]);_.uv=new Float32Array([g+S[0]*y,m+S[1]*E,T-(1-S[2])*y,m+S[3]*E,T-(1-S[4])*y,x-(1-S[5])*E,g+S[6]*y,x-(1-S[7])*E]);var b=e.scaleRate;return b&&1!=b?(_.sourceWidth/=b,_.sourceHeight/=b,_.width/=b,_.height/=b,_.scaleRate=b,_.offsetX/=b,_.offsetY/=b):_.scaleRate=1,_}static createFromTexture(e,t,r,i,s){var a=e.scaleRate;1!=a&&(t*=a,r*=a,i*=a,s*=a);var n=g.TEMP.setTo(t-e.offsetX,r-e.offsetY,i,s),l=n.intersection(ie.setTo(0,0,e.width,e.height),se);return l?ae.create(e,l.x,l.y,l.width,l.height,l.x-n.x,l.y-n.y,i,s):null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==ae.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==ae.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}constructor(e=null,t=null,r=0,i=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let s=e instanceof ae?e.bitmap:e;this.setTo(s,t,r,i)}_addReference(e=1){super._addReference(e),this._bitmap&&this._bitmap._addReference(e)}_removeReference(e=1){this._bitmap&&this._bitmap._removeReference(e),super._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,r=0,i=0){this.bitmap=e,this.sourceWidth=r,this.sourceHeight=i,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||ae.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():n.loader.load(e).then((e=>{let r=e.bitmap;this.bitmap=r,this.sourceWidth=this._w=r.width,this.sourceHeight=this._h=r.height,t&&t.run(),this.event(E.READY,this)}))}getTexturePixels(e,t,r,i){var s,a,l,o=this.bitmap,h=this._w,_=this._h,u=this.sourceWidth,d=this.sourceHeight,c=o.width,p=o.height,f=this.offsetX,g=this.offsetY;let m=r,T=i;if(e+r>h+f&&(m-=e+r-h-f),e+r>u&&(r-=e+r-u),t+i>_+g&&(T-=t+i-_-g),t+i>d&&(i-=t+i-d),r<=0||i<=0)return null;let x=f>e?f-e:0,y=g>t?g-t:0,E=e>f?e-f:0,S=t>g?t-g:0;m-=x,T-=y;var b=4*r,v=null;try{v=o.getPixels()}catch(e){}if(v){if(0==e&&0==t&&r==c&&i==p)return v;let n=this._uv.slice(),o=Math.round(n[0]*c),h=Math.round(n[1]*p);var R=new Uint8Array(r*i*4);for(s=4*o+4*E+(a=(h+S)*(b=4*c)),l=0;l<T;l++)R.set(v.slice(s,s+4*m),4*r*(l+y)+4*x),s+=b;return R}var A=new n.Context;A.size(r,i),A.asBitmap=!0;var C=null;if(0!=e||0!=t||r!=c||i!=p){var D=(C=this._uv.slice())[0],M=C[1],w=(C[2]-D)/h,I=(C[7]-M)/_;C=[D+E*w,M+S*I,D+(E+m)*w,M+S*I,D+(E+m)*w,M+(S+T)*I,D+E*w,M+(S+T)*I]}A._drawTextureM(this,x,y,m,T,null,1,C,4294967295),A._targets.start(),A.flush(),A._targets.end(),A._targets.restore();var P=A._targets.getData(0,0,r,i);for(A.destroy(),R=new Uint8Array(r*i*4),s=0,a=(i-1)*b,l=i-1;l>=0;l--)R.set(P.slice(a,a+b),s),s+=b,a-=b;return R}getPixels(e,t,r,i){return this.getTexturePixels(e,t,r,i)}recoverBitmap(e){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||n.loader.load(t).then((t=>{this.bitmap=t.bitmap,e&&e()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount)}getCachedClip(e,t,r,i){let s=`${e}_${t}_${r}_${i}`;this._clipCache||(this._clipCache=new Map);let a=this._clipCache.get(s);return a||(a=ae.createFromTexture(this,e,t,r,i),a&&(a._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(s,a),a)}}var ne,le,oe,he,_e;ae.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),ae.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),ae.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]),e.BlendEquationSeparate=void 0,(ne=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[ne.ADD=0]="ADD",ne[ne.SUBTRACT=1]="SUBTRACT",ne[ne.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",ne[ne.MIN=3]="MIN",ne[ne.MAX=4]="MAX",e.BlendType=void 0,(le=e.BlendType||(e.BlendType={}))[le.BLEND_DISABLE=0]="BLEND_DISABLE",le[le.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",le[le.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.CompareFunction=void 0,(oe=e.CompareFunction||(e.CompareFunction={}))[oe.Never=0]="Never",oe[oe.Less=1]="Less",oe[oe.Equal=2]="Equal",oe[oe.LessEqual=3]="LessEqual",oe[oe.Greater=4]="Greater",oe[oe.NotEqual=5]="NotEqual",oe[oe.GreaterEqual=6]="GreaterEqual",oe[oe.Always=7]="Always",oe[oe.Off=8]="Off",e.CullMode=void 0,(he=e.CullMode||(e.CullMode={}))[he.Off=0]="Off",he[he.Front=1]="Front",he[he.Back=2]="Back",e.StencilOperation=void 0,(_e=e.StencilOperation||(e.StencilOperation={}))[_e.Keep=0]="Keep",_e[_e.Zero=1]="Zero",_e[_e.Replace=2]="Replace",_e[_e.IncrementSaturate=3]="IncrementSaturate",_e[_e.DecrementSaturate=4]="DecrementSaturate",_e[_e.Invert=5]="Invert",_e[_e.IncrementWrap=6]="IncrementWrap",_e[_e.DecrementWrap=7]="DecrementWrap";class ue{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let r=e.substring(6);return ue.inst.UUID_to_URL_async(r).then((e=>(t&&t(e),e)))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,r,i){return r?`${d.replaceFileExtension(e,"")}@${r}.${i}`:e}}ue.inst=new ue;class de{static __init__(){de.rootPath=de.basePath=location&&null!=location.protocol&&""!=location.protocol?de.getPath(location.protocol+"//"+location.host+location.pathname):""}static initMiniGameExtensionOverrides(){l.isPreview||(de.overrideExtension(["rendertexture","videotexture"],"rt.json"),de.overrideExtension(["controller"],"controller.json"),de.overrideExtension(["mc"],"mc.bin"),de.overrideExtension(["mcc"],"mcc.json"),de.overrideExtension(["shader"],"shader.json"),de.overrideExtension(["scene3d","scene","taa","prefab"],"json"),de.overrideExtension(["fui"],"fui.json"),de.overrideExtension(["glsl"],"glsl.txt"),de.overrideExtension(["skel"],"skel.bin"))}constructor(e){this._url=de.formatURL(e),this._path=de.getPath(e)}get url(){return this._url}get path(){return this._path}static formatURL(e,t){if(!e)return t||de.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),r=ue.inst.UUID_to_URL(t);if(!r)return e;e=r}let r=e.charCodeAt(0);if(-1==e.indexOf(":")&&47!==r){null!=de.customFormat&&(e=de.customFormat(e));let i=de.version[e];if(null!=i){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+i+e.substring(t)}if(126===r)e=de.join(de.rootPath,e.substring(2));else{if(null==t){t=de.basePath;for(let r in de.basePaths)if(e.startsWith(r)){t=de.basePaths[r];break}}e=de.join(t,e)}}return e}static postFormatURL(e){if(de.hasExtOverrides){let t=d.getFileExtension(e),r=de.overrideFileExts[t];null!=r&&(e=d.replaceFileExtension(e,r))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),r=t.length,i=0;for(;i<r;)if("."!=t[i]){if(".."==t[i]){let e=i-1;if(e>=0&&".."!==t[e]){t.splice(e,2),r-=2,i--;continue}}i++}else t.splice(i,1),r--;return t.length=r,t.join("/")}static getResURLByUUID(e){return e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let r=t.charCodeAt(0);126!==r&&47!==r&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return de.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t){for(let r of e)de.overrideFileExts[r]=t;de.hasExtOverrides=!0}}de.version={},de.basePath="",de.basePaths={},de.rootPath="",de.overrideFileExts={},de.customFormat=function(e){return e};class ce{static splitToWords(e,t){for(var r,i,s=[],a=-1,n=0,l=e.length;n<l;n++)if(r=e.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(r)>=0){if(a>=0&&n-a>1&&(i=e.substr(a,n-a),s.push(i)),'"'==r||"'"==r){var o=e.indexOf(r,n+1);if(o<0)throw"Sharder err:"+e;s.push(e.substr(n+1,o-n-1)),n=o,a=-1;continue}"("==r&&t&&s.length>0&&(i=s[s.length-1]+";","vec4;main;".indexOf(i)<0&&(t.useFuns+=i)),a=-1}else a<0&&(a=n);return a<l&&l-a>1&&(i=e.substr(a,l-a),s.push(i)),s}constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,r,i=0;!((i=e.indexOf("#begin",i))<0);){for(r=i+5;!((r=e.indexOf("#end",r))<0)&&"i"===e.charAt(r+4);)r+=5;if(r<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",i);var s=ce.splitToWords(e.substr(i,t-i),null);"code"==s[1]?this.codes[s[2]]=e.substr(t+1,r-t-1):"function"==s[1]&&(t=e.indexOf("function",i),t+=8,this.funs[s[3]]=e.substr(t+1,r-t-1),this.funnames+=s[3]+";"),i=r+1}}getWith(e=null){var t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}getFunsScript(e){var t="";for(var r in this.funs)e.indexOf(r+";")>=0&&(t+=this.funs[r]);return t}}class pe{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++pe.__id)}_toscript(e,t,r){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var i=!!this.condition.call(e);if(2===this.conditionType&&(i=!i),!i&&pe.__noCompileEnable)return t}if(!this.noCompile&&pe.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(i,s,a){i._toscript(e,t,r)})),this.includefiles.length>0&&this.useFuns.length>0)for(var s,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=r&&(s=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=r,t[0]=s+t[0]);return t}}pe.__id=1,pe.__noCompileEnable=!0;const fe=new RegExp("\r","g"),ge=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),me={Back:e.CullMode.Back,Front:e.CullMode.Front,Off:e.CullMode.Off},Te={Disable:e.BlendType.BLEND_DISABLE,All:e.BlendType.BLEND_ENABLE_ALL,Seperate:e.BlendType.BLEND_ENABLE_SEPERATE},xe={Zero:e.BlendFactor.Zero,One:e.BlendFactor.One,SourceColor:e.BlendFactor.SourceColor,OneMinusSourceColor:e.BlendFactor.OneMinusSourceColor,DestinationColor:e.BlendFactor.DestinationColor,OneMinusDestinationColor:e.BlendFactor.OneMinusDestinationColor,SourceAlpha:e.BlendFactor.SourceAlpha,OneMinusSourceAlpha:e.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:e.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:e.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:e.BlendFactor.SourceAlphaSaturate,BlendColor:e.BlendFactor.BlendColor,OneMinusBlendColor:e.BlendFactor.OneMinusBlendColor},ye={Add:e.BlendEquationSeparate.ADD,Subtract:e.BlendEquationSeparate.SUBTRACT,Reverse_substract:e.BlendEquationSeparate.REVERSE_SUBTRACT,Min:e.BlendEquationSeparate.MIN,Max:e.BlendEquationSeparate.MAX},Ee={Never:e.CompareFunction.Never,Less:e.CompareFunction.Less,Equal:e.CompareFunction.Equal,LessEqual:e.CompareFunction.LessEqual,Greater:e.CompareFunction.Greater,NotEqual:e.CompareFunction.NotEqual,GreaterEqual:e.CompareFunction.GreaterEqual,Always:e.CompareFunction.Always,Off:e.CompareFunction.Off},Se={Keep:e.StencilOperation.Keep,Zero:e.StencilOperation.Zero,Replace:e.StencilOperation.Replace,IncrementSaturate:e.StencilOperation.IncrementSaturate,DecrementSaturate:e.StencilOperation.DecrementSaturate,Invert:e.StencilOperation.Invert,IncrementWrap:e.StencilOperation.IncrementWrap,DecrementWrap:e.StencilOperation.DecrementWrap};class be{static addInclude(e,t,r){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!r&&be.includes[e])return console.warn("shader include file already exists:"+e),be.includes[e];t=t.replace(fe,"");let i=new ce(t);return be.includes[e]=i,i}static compile(e,t,r){let i={vsNode:new pe([]),psNode:new pe([]),includeNames:new Set,defs:new Set},s=[];e=e.replace(fe,""),t=t.replace(fe,""),be._compileToTree(i.vsNode,e,i.defs,s,r),be._compileToTree(i.psNode,t,i.defs,s,r);for(let e of s)e.file?i.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return i}static compileAsync(e,t,r){let i={vsNode:new pe([]),psNode:new pe([]),includeNames:new Set,defs:new Set},s=[];return e=e.replace(fe,""),t=t.replace(fe,""),be._compileToTree(i.vsNode,e,i.defs,s,r),be._compileToTree(i.psNode,t,i.defs,s,r),this._loadIncludesDeep(i,s,0)}static _loadIncludesDeep(e,t,r){let i,s=t.length;for(let a=r;a<s;a++){let r=t[a];r.file?e.includeNames.add(r.name):(i||(i=[]),i.push(r))}return i?n.loader.load(i.map((e=>e.name))).then((r=>{let a=i.length;for(let s=0;s<a;s++){let a=i[s],n=r[s];if(n){e.includeNames.add(a.name);let r=n.getWith(a.codeName);a.node.condition?a.node.text=r:(be._compileToTree(a.node,r,e.defs,t,de.getPath(a.name)),a.node.text="")}else{let e=a.node.parent.childs;e.splice(e.indexOf(a.node),1)}}return t.length>s?be._loadIncludesDeep(e,t,s):e})):Promise.resolve(e)}static _compileToTree(e,t,r,i,s){let a,n,l,o,h,_,u,d,c,p,f=t.split("\n");for(d=0;d<f.length;d++)if(l=f[d],!(l.length<1)&&(_=l.indexOf("//"),0!==_))if(_>=0&&(l=l.substr(0,_)),(_=l.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&ce.splitToWords(l,n),n.text+="\n"+l;continue}a=new pe(t),a.text=l,a.noCompile=!0,t.length>0&&ce.splitToWords(l,a),a.setParent(e)}else{for(a=new pe(e.includefiles),a.text=l,a.noCompile=!0,o="#",p=_+1,c=l.length;p<c;p++){let e=l.charAt(p);if(" "===e||"\t"===e||"?"===e)break;o+=e}switch(a.name=o,o){case"#ifdef":case"#ifndef":for(a.src=l,a.noCompile=null!=l.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+l.substr(_+a.name.length)+"}"):(u=l.replace(/^\s*/,"").split(/\s+/),a.setCondition(u[1],"#ifdef"===o?be.IFDEF_YES:be.IFDEF_ELSE),a.text=a.text),a.setParent(e),e=a,u=l.substr(p).split(ge),p=0;p<u.length;p++)l=u[p],l.length&&r.add(l);break;case"#if":case"#elif":for(a.src=l,a.noCompile=!0,"#elif"==o&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(e),e=a,u=l.substr(p).split(ge),p=0;p<u.length;p++)l=u[p],l.length&&"defined"!=l&&r.add(l);break;case"#else":a.src=l,n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==be.IFDEF_YES?be.IFDEF_ELSE:be.IFDEF_YES),a.setParent(e),e=a;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(e);break;case"#include":u=ce.splitToWords(l,null);let t,d=u[1];d.startsWith(".")?d=de.join(s,d):d.startsWith("/")?d=de.formatURL(d.substring(1)):(t=be.includes[d],t||(d="internal/"+d)),t=be.includes[d],!t&&be.loadIncludeFileSync&&(be.loadIncludeFileSync(d),t=be.includes[d]);let c="with"==u[2]?u[3]:null;i.push({name:d,codeName:c,node:a,file:t}),a.setParent(e),(_=u[0].indexOf("?"))<0?(t&&(l=t.getWith(c),this._compileToTree(a,l,r,i,de.getPath(d))),a.text=""):(a.setCondition(u[0].substr(_+1),be.IFDEF_YES),t&&(a.text=t.getWith(c)));break;case"#import":u=ce.splitToWords(l,null),h=u[1],a.includefiles.push({node:a,file:be.includes[h],ofs:a.text.length});break;default:a.setParent(e)}}}static getRenderState(e,t){if(!e)return;t.cull=me[e.cull],t.blend=Te[e.blend],t.srcBlend=xe[e.srcBlend],t.dstBlend=xe[e.dstBlend],t.srcBlendRGB=xe[e.srcBlendRGB],t.dstBlendRGB=xe[e.dstBlendRGB],t.srcBlendAlpha=xe[e.srcBlendAlpha],t.dstBlendAlpha=xe[e.dstBlendAlpha],t.blendEquation=ye[e.blendEquation],t.blendEquationRGB=ye[e.blendEquationRGB],t.blendEquationAlpha=ye[e.blendEquationAlpha],t.depthTest=Ee[e.depthTest],t.depthWrite=e.depthWrite,t.stencilRef=e.stencilRef,t.stencilTest=Ee[e.stencilTest],t.stencilWrite=e.stencilWrite;let r=e.stencilOp,i=r?r[0]:null,s=r?r[1]:null,a=r?r[2]:null;t.stencilOp.x=Se[i],t.stencilOp.y=Se[s],t.stencilOp.z=Se[a]}}be.IFDEF_NO=0,be.IFDEF_YES=1,be.IFDEF_ELSE=2,be.IFDEF_PARENT=3,be.includes={};class ve{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1;i>=0;i--){var s=r[i]&t[i];0==s&&i==this._length-1?this._length--:r[i]=s}}add(e){var t=e._index,r=t+1,i=this._mask,s=this._length;if(s<r){for(i.length<r&&(i.length=r);s<t;s++)i[s]=0;i[t]=e._value,this._length=r}else i[t]|=e._value}remove(e){var t=e._index,r=this._mask,i=this._length-1;if(!(t>i)){var s=r[t]&~e._value;t==i&&0===s?this._length--:r[t]=s}}addDefineDatas(e){var t=e._mask,r=e._length,i=this._mask,s=this._length;if(s<r){i.length=r;for(var a=0;a<s;a++)i[a]|=t[a];for(;a<r;a++)i[a]=t[a];this._length=r}else for(a=0;a<r;a++)i[a]|=t[a]}removeDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1,s=Math.min(e._length,i);s>=0;s--){var a=r[s]&~t[s];s==i&&0===a?(i--,this._length--):r[s]=a}}has(e){var t=e._index;return!(t>=this._length)&&!!(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e,r=t._mask,i=this._mask,s=this._length;r.length=s;for(var a=0;a<s;a++)r[a]=i[a];t._length=s}clone(){var e=new ve;return this.cloneTo(e),e}destroy(){delete this._mask}}class Re{constructor(e,t){this._index=e,this._value=t}}Re._texGammaDefine={};class Ae{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(e,t,r,i){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,i)}setValue(e,t,r,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var s=e.getSubShaderAt(t);if(!s)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var a=s._passes[r];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var n=a._validDefine,l=0,o=i.length;l<o;l++){var h=i[l];if(!n.has(dt.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${e._name} subShaderIndex of ${t} passIndex of ${r}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=i}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var i=0,s=this._defineNames.length;i<s;i++)if(t[i]!==r[i])return!1;return!0}clone(){return new Ae(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class Ce{constructor(){this._allCompiled=!1,this._variants=[]}get allCompiled(){return this._allCompiled}get variantCount(){return this._variants.length}add(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}remove(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}contatins(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!0;return!1}getByIndex(e){return this._variants[e]}clear(){this._variants.length=0}compile(){if(!this._allCompiled){for(var e=this._variants,t=0,r=e.length;t<r;t++){var i=e[t];dt.compileShaderByDefineNames(i._shader._name,i._subShaderIndex,i._passIndex,i._defineNames,[])}this._allCompiled=!0}}}class De{constructor(){}static isZero(e){return Math.abs(e)<De.zeroTolerance}static nearEqual(e,t){return!!De.isZero(e-t)}static fastInvSqrt(e){return De.isZero(e)?e:1/Math.sqrt(e)}}De.zeroTolerance=1e-6,De.MaxValue=340282347e30,De.MinValue=-340282347e30,De.Deg2Rad=Math.PI/180;class Me{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){this.x=e,this.y=t}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t}static equals(e,t){return De.nearEqual(e.x,t.x)&&De.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){var t=e;t.x=this.x,t.y=this.y}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var r=e.x,i=e.y,s=r*r+i*i;s>0&&(s=1/Math.sqrt(s),t.x=r*s,t.y=i*s)}static scalarLength(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}clone(){var e=new Me;return this.cloneTo(e),e}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Me.rewriteNumProperty(this,"x",0),Me.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(e,t,r){Object.defineProperty(e,t,{get:function(){return this.elements[r]},set:function(e){this.elements[r]=e}})}}Me.ZERO=new Me(0,0),Me.ONE=new Me(1,1),Me.TempVector2=new Me;class we{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var e=new we;return this.cloneTo(e),e}static lerp(e,t,r,i){var s=e.x,a=e.y,n=e.z,l=e.w;i.x=s+r*(t.x-s),i.y=a+r*(t.y-a),i.z=n+r*(t.z-n),i.w=l+r*(t.w-l)}static transformByM4x4(e,t,r){var i=e.x,s=e.y,a=e.z,n=e.w,l=t.elements;r.x=i*l[0]+s*l[4]+a*l[8]+n*l[12],r.y=i*l[1]+s*l[5]+a*l[9]+n*l[13],r.z=i*l[2]+s*l[6]+a*l[10]+n*l[14],r.w=i*l[3]+s*l[7]+a*l[11]+n*l[15]}static equals(e,t){return De.nearEqual(Math.abs(e.x),Math.abs(t.x))&&De.nearEqual(Math.abs(e.y),Math.abs(t.y))&&De.nearEqual(Math.abs(e.z),Math.abs(t.z))&&De.nearEqual(Math.abs(e.w),Math.abs(t.w))}equal(e){return we.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.length();if(r>0){var i=1/r;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}static Clamp(e,t,r,i){var s=e.x,a=e.y,n=e.z,l=e.w,o=t.x,h=t.y,_=t.z,u=t.w,d=r.x,c=r.y,p=r.z,f=r.w;s=(s=s>d?d:s)<o?o:s,a=(a=a>c?c:a)<h?h:a,n=(n=n>p?p:n)<_?_:n,l=(l=l>f?f:l)<u?u:l,i.x=s,i.y=a,i.z=n,i.w=l}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return r*r+i*i+s*s+a*a}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return Math.sqrt(r*r+i*i+s*s+a*a)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Me.rewriteNumProperty(this,"x",0),Me.rewriteNumProperty(this,"y",1),Me.rewriteNumProperty(this,"z",2),Me.rewriteNumProperty(this,"w",3)}}we.ZERO=new we,we.ONE=new we(1,1,1,1),we.UnitX=new we(1,0,0,0),we.UnitY=new we(0,1,0,0),we.UnitZ=new we(0,0,1,0),we.UnitW=new we(0,0,0,1),we.tempVec4=new we(0,0,0,0);class Ie{static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return r*r+i*i+s*s}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return Math.sqrt(r*r+i*i+s*s)}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}static transformQuat(e,t,r){var i=e.x,s=e.y,a=e.z,n=t.x,l=t.y,o=t.z,h=t.w,_=h*i+l*a-o*s,u=h*s+o*i-n*a,d=h*a+n*s-l*i,c=-n*i-l*s-o*a;r.x=_*h+c*-n+u*-o-d*-l,r.y=u*h+c*-l+d*-n-_*-o,r.z=d*h+c*-o+_*-l-u*-n}static scalarLength(e){var t=e.x,r=e.y,i=e.z;return Math.sqrt(t*t+r*r+i*i)}static scalarLengthSquared(e){var t=e.x,r=e.y,i=e.z;return t*t+r*r+i*i}static normalize(e,t){var r=e.x,i=e.y,s=e.z,a=r*r+i*i+s*s;a>0&&(a=1/Math.sqrt(a),t.x=r*a,t.y=i*a,t.z=s*a)}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}static lerp(e,t,r,i){var s=e.x,a=e.y,n=e.z;i.x=s+r*(t.x-s),i.y=a+r*(t.y-a),i.z=n+r*(t.z-n)}static transformV3ToV3(e,t,r){var i=Ie._tempVector4;Ie.transformV3ToV4(e,t,i),r.x=i.x,r.y=i.y,r.z=i.z}static transformV3ToV4(e,t,r){var i=e.x,s=e.y,a=e.z,n=t.elements;r.x=i*n[0]+s*n[4]+a*n[8]+n[12],r.y=i*n[1]+s*n[5]+a*n[9]+n[13],r.z=i*n[2]+s*n[6]+a*n[10]+n[14],r.w=i*n[3]+s*n[7]+a*n[11]+n[15]}static TransformNormal(e,t,r){var i=e.x,s=e.y,a=e.z,n=t.elements;r.x=i*n[0]+s*n[4]+a*n[8],r.y=i*n[1]+s*n[5]+a*n[9],r.z=i*n[2]+s*n[6]+a*n[10]}static transformCoordinate(e,t,r){var i=e.x,s=e.y,a=e.z,n=t.elements,l=i*n[3]+s*n[7]+a*n[11]+n[15];r.x=(i*n[0]+s*n[4]+a*n[8]+n[12])/l,r.y=(i*n[1]+s*n[5]+a*n[9]+n[13])/l,r.z=(i*n[2]+s*n[6]+a*n[10]+n[14])/l}static Clamp(e,t,r,i){var s=e.x,a=e.y,n=e.z,l=t.x,o=t.y,h=t.z,_=r.x,u=r.y,d=r.z;s=(s=s>_?_:s)<l?l:s,a=(a=a>u?u:a)<o?o:a,n=(n=n>d?d:n)<h?h:n,i.x=s,i.y=a,i.z=n}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}static cross(e,t,r){var i=e.x,s=e.y,a=e.z,n=t.x,l=t.y,o=t.z;r.x=s*o-a*l,r.y=a*n-i*o,r.z=i*l-s*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return De.nearEqual(e.x,t.x)&&De.nearEqual(e.y,t.y)&&De.nearEqual(e.z,t.z)}constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}equal(e){return Ie.equals(this,e)}setValue(e,t,r){return this.x=e,this.y=t,this.z=r,this}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,r=this.z;var i=e*e+t*t+r*r;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=r*i),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var r=this.x,i=this.y,s=this.z,a=e.x,n=e.y,l=e.z;return t.x=i*l-s*n,t.y=s*a-r*l,t.z=r*n-i*a,t}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}clone(){var e=new Ie;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}Ie._tempVector4=new we,Ie._tempVector3=new Ie,Ie.ZERO=new Ie(0,0,0),Ie.ONE=new Ie(1,1,1),Ie.NegativeUnitX=new Ie(-1,0,0),Ie.UnitX=new Ie(1,0,0),Ie.UnitY=new Ie(0,1,0),Ie.UnitZ=new Ie(0,0,1),Ie.ForwardRH=new Ie(0,0,-1),Ie.ForwardLH=new Ie(0,0,1),Ie.Up=new Ie(0,1,0);const Pe=new Float32Array([1,0,0,0,1,0,0,0,1]),Be=new Ie,Le=new Ie,Fe=new Ie;class Oe{static createRotationQuaternion(e,t){var r=e.x,i=e.y,s=e.z,a=e.w,n=r*r,l=i*i,o=s*s,h=r*i,_=s*a,u=s*r,d=i*a,c=i*s,p=r*a,f=t.elements;f[0]=1-2*(l+o),f[1]=2*(h+_),f[2]=2*(u-d),f[3]=2*(h-_),f[4]=1-2*(o+n),f[5]=2*(c+p),f[6]=2*(u+d),f[7]=2*(c-p),f[8]=1-2*(l+n)}static createFromTranslation(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}static createFromRotation(e,t){var r=t.elements,i=Math.sin(e),s=Math.cos(e);r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}static createFromMatrix4x4(e,t){var r=e.elements,i=t.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[4],i[4]=r[5],i[5]=r[6],i[6]=r[8],i[7]=r[9],i[8]=r[10]}static multiply(e,t,r){var i=e.elements,s=t.elements,a=r.elements,n=i[0],l=i[1],o=i[2],h=i[3],_=i[4],u=i[5],d=i[6],c=i[7],p=i[8],f=s[0],g=s[1],m=s[2],T=s[3],x=s[4],y=s[5],E=s[6],S=s[7],b=s[8];a[0]=f*n+g*h+m*d,a[1]=f*l+g*_+m*S,a[2]=f*o+g*u+m*p,a[3]=T*n+x*h+y*d,a[4]=T*l+x*_+y*c,a[5]=T*o+x*u+y*p,a[6]=E*n+S*h+b*d,a[7]=E*l+S*_+b*c,a[8]=E*o+S*u+b*p}constructor(e=!0){e&&(this.elements=Pe.slice())}cloneByArray(e){this.elements.set(e)}determinant(){var e=this.elements,t=e[0],r=e[1],i=e[2],s=e[3],a=e[4],n=e[5],l=e[6],o=e[7],h=e[8];return t*(h*a-n*o)+r*(-h*s+n*l)+i*(o*s-a*l)}translate(e,t){var r=t.elements,i=this.elements,s=i[0],a=i[1],n=i[2],l=i[3],o=i[4],h=i[5],_=i[6],u=i[7],d=i[8],c=e.x,p=e.y;r[0]=s,r[1]=a,r[2]=n,r[3]=l,r[4]=o,r[5]=h,r[6]=c*s+p*l+_,r[7]=c*a+p*o+u,r[8]=c*n+p*h+d}rotate(e,t){var r=t.elements,i=this.elements,s=i[0],a=i[1],n=i[2],l=i[3],o=i[4],h=i[5],_=i[6],u=i[7],d=i[8],c=Math.sin(e),p=Math.cos(e);r[0]=p*s+c*l,r[1]=p*a+c*o,r[2]=p*n+c*h,r[3]=p*l-c*s,r[4]=p*o-c*a,r[5]=p*h-c*n,r[6]=_,r[7]=u,r[8]=d}scale(e,t){var r=t.elements,i=this.elements,s=e.x,a=e.y;r[0]=s*i[0],r[1]=s*i[1],r[2]=s*i[2],r[3]=a*i[3],r[4]=a*i[4],r[5]=a*i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8]}invert(e){var t=e.elements,r=this.elements,i=r[0],s=r[1],a=r[2],n=r[3],l=r[4],o=r[5],h=r[6],_=r[7],u=r[8],d=u*l-o*_,c=-u*n+o*h,p=_*n-l*h,f=i*d+s*c+a*p;f&&(f=1/f,t[0]=d*f,t[1]=(-u*s+a*_)*f,t[2]=(o*s-a*l)*f,t[3]=c*f,t[4]=(u*i-a*h)*f,t[5]=(-o*i+a*n)*f,t[6]=p*f,t[7]=(-_*i+s*h)*f,t[8]=(l*i-s*n)*f)}transpose(e){var t=e.elements,r=this.elements;if(e===this){var i=r[1],s=r[2],a=r[5];t[1]=r[3],t[2]=r[6],t[3]=i,t[5]=r[7],t[6]=s,t[7]=a}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}identity(){this.elements.set(Pe)}cloneTo(e){var t,r;(t=this.elements)!==(r=e.elements)&&r.set(t)}clone(){var e=new Oe(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,r,i){Ie.subtract(e,t,Be),Ie.normalize(Be,Be),Ie.cross(r,Be,Le),Ie.normalize(Le,Le),Ie.cross(Be,Le,Fe);var s=Be,a=Le,n=Fe,l=i.elements;l[0]=a.x,l[3]=a.y,l[6]=a.z,l[1]=n.x,l[4]=n.y,l[7]=n.z,l[2]=s.x,l[5]=s.y,l[8]=s.z}static forwardLookAt(e,t,r,i){var s=Le,a=Fe,n=Be;t.vsub(e,n).normalize(),r.cross(n,s).normalize(),n.cross(s,a);var l=i.elements;l[0]=s.x,l[1]=s.y,l[2]=s.z,l[3]=a.x,l[4]=a.y,l[5]=a.z,l[6]=n.x,l[7]=n.y,l[8]=n.z}}Oe.DEFAULT=new Oe,Oe.Temp=new Oe;const Ne=new Ie,Ue=new Ie,Ge=new Ie,ke=new Ie,Ve=new Oe;class We{static createFromYawPitchRoll(e,t,r,i){var s=.5*r,a=.5*t,n=.5*e,l=Math.sin(s),o=Math.cos(s),h=Math.sin(a),_=Math.cos(a),u=Math.sin(n),d=Math.cos(n);i.x=d*h*o+u*_*l,i.y=u*_*o-d*h*l,i.z=d*_*l-u*h*o,i.w=d*_*o+u*h*l}static multiply(e,t,r){var i=e.x,s=e.y,a=e.z,n=e.w,l=t.x,o=t.y,h=t.z,_=t.w,u=s*h-a*o,d=a*l-i*h,c=i*o-s*l,p=i*l+s*o+a*h;r.x=i*_+l*n+u,r.y=s*_+o*n+d,r.z=a*_+h*n+c,r.w=n*_-p}static rotationAxisAngle(e,t,r){const i=Ie._tempVector3;Ie.normalize(e,i),t*=.5;const s=Math.sin(t);r.x=i.x*s,r.y=i.y*s,r.z=i.z*s,r.w=Math.cos(t)}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,r){Ie.subtract(t,e,Ne),Ie.normalize(Ne,Ne),r.x=Math.asin(Ne.y),r.y=We.arcTanAngle(-Ne.z,-Ne.x)}static createFromAxisAngle(e,t,r){t*=.5;var i=Math.sin(t);r.x=i*e.x,r.y=i*e.y,r.z=i*e.z,r.w=Math.cos(t)}static createFromMatrix4x4(e,t){var r,i,s=e.elements,a=s[0]+s[5]+s[10];a>0?(r=Math.sqrt(a+1),t.w=.5*r,r=.5/r,t.x=(s[6]-s[9])*r,t.y=(s[8]-s[2])*r,t.z=(s[1]-s[4])*r):s[0]>=s[5]&&s[0]>=s[10]?(i=.5/(r=Math.sqrt(1+s[0]-s[5]-s[10])),t.x=.5*r,t.y=(s[1]+s[4])*i,t.z=(s[2]+s[8])*i,t.w=(s[6]-s[9])*i):s[5]>s[10]?(i=.5/(r=Math.sqrt(1+s[5]-s[0]-s[10])),t.x=(s[4]+s[1])*i,t.y=.5*r,t.z=(s[9]+s[6])*i,t.w=(s[8]-s[2])*i):(i=.5/(r=Math.sqrt(1+s[10]-s[0]-s[5])),t.x=(s[8]+s[2])*i,t.y=(s[9]+s[6])*i,t.z=.5*r,t.w=(s[1]-s[4])*i)}static slerp(e,t,r,i){var s,a,n,l,o,h=e.x,_=e.y,u=e.z,d=e.w,c=t.x,p=t.y,f=t.z,g=t.w;return(a=h*c+_*p+u*f+d*g)<0&&(a=-a,c=-c,p=-p,f=-f,g=-g),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),l=Math.sin((1-r)*s)/n,o=Math.sin(r*s)/n):(l=1-r,o=r),i.x=l*h+o*c,i.y=l*_+o*p,i.z=l*u+o*f,i.w=l*d+o*g,i}static lerp(e,t,r,i){var s=1-r;We.dot(e,t)>=0?(i.x=s*e.x+r*t.x,i.y=s*e.y+r*t.y,i.z=s*e.z+r*t.z,i.w=s*e.w+r*t.w):(i.x=s*e.x-r*t.x,i.y=s*e.y-r*t.y,i.z=s*e.z-r*t.z,i.w=s*e.w-r*t.w),i.normalize(i)}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}constructor(e=0,t=0,r=0,i=1){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}set(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*r,t.y=this.y*i+this.z*r,t.z=this.z*i-this.y*r,t.w=this.w*i-this.x*r}rotateY(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*r,t.y=this.y*i+this.w*r,t.z=this.z*i+this.x*r,t.w=this.w*i-this.y*r}rotateZ(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*r,t.y=this.y*i-this.x*r,t.z=this.z*i+this.w*r,t.w=this.w*i-this.z*r}getYawPitchRoll(e){Ie.transformQuat(Ie.ForwardRH,this,Ue),Ie.transformQuat(Ie.Up,this,Ge);var t=Ge;We.angleTo(Ie.ZERO,Ue,ke);var r=ke;r.x==Math.PI/2?(r.y=We.arcTanAngle(t.z,t.x),r.z=0):r.x==-Math.PI/2?(r.y=We.arcTanAngle(-t.z,-t.x),r.z=0):(qe.createRotationY(-r.y,qe.TEMPMatrix0),qe.createRotationX(-r.x,qe.TEMPMatrix1),Ie.transformCoordinate(Ge,qe.TEMPMatrix0,Ge),Ie.transformCoordinate(Ge,qe.TEMPMatrix1,Ge),r.z=We.arcTanAngle(t.y,-t.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var i=e;i.x=r.y,i.y=r.x,i.z=r.z}invert(e){var t=this.x,r=this.y,i=this.z,s=this.w,a=t*t+r*r+i*i+s*s,n=a?1/a:0;e.x=-t*n,e.y=-r*n,e.z=-i*n,e.w=s*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new We;return this.cloneTo(e),e}equals(e){return De.nearEqual(this.x,e.x)&&De.nearEqual(this.y,e.y)&&De.nearEqual(this.z,e.z)&&De.nearEqual(this.w,e.w)}static rotationLookAt(e,t,r){We.lookAt(Ie.ZERO,e,t,r)}static lookAt(e,t,r,i){Oe.lookAt(e,t,r,Ve),We.rotationMatrix(Ve,i)}static forwardLookAt(e,t,r,i){Oe.forwardLookAt(e,t,r,Ve),We.rotationMatrix(Ve,i)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var r=e.lengthSquared();De.isZero(r)||(r=1/r,t.x=-e.x*r,t.y=-e.y*r,t.z=-e.z*r,t.w=e.w*r)}static rotationMatrix(e,t){var r,i,s=e.elements,a=s[0],n=s[1],l=s[2],o=s[3],h=s[4],_=s[5],u=s[6],d=s[7],c=s[8],p=a+h+c;p>0?(r=Math.sqrt(p+1),t.w=.5*r,r=.5/r,t.x=(_-d)*r,t.y=(u-l)*r,t.z=(n-o)*r):a>=h&&a>=c?(i=.5/(r=Math.sqrt(1+a-h-c)),t.x=.5*r,t.y=(n+o)*i,t.z=(l+u)*i,t.w=(_-d)*i):h>c?(i=.5/(r=Math.sqrt(1+h-a-c)),t.x=(o+n)*i,t.y=.5*r,t.z=(d+_)*i,t.w=(u-l)*i):(i=.5/(r=Math.sqrt(1+c-a-h)),t.x=(u+l)*i,t.y=(d+_)*i,t.z=.5*r,t.w=(n-o)*i)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Me.rewriteNumProperty(this,"x",0),Me.rewriteNumProperty(this,"y",1),Me.rewriteNumProperty(this,"z",2),Me.rewriteNumProperty(this,"w",3)}}We.TEMP=new We,We.DEFAULT=new We,We.NAN=new We(NaN,NaN,NaN,NaN);const He=new Ie,Xe=new Ie,Ye=new Ie,ze=new Ie,je=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class qe{static createRotationX(e,t){var r=t.elements,i=Math.sin(e),s=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=s,r[6]=i,r[9]=-i}static createRotationY(e,t){var r=t.elements,i=Math.sin(e),s=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=s,r[2]=-i,r[8]=i}static createRotationZ(e,t){var r=t.elements,i=Math.sin(e),s=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=s,r[1]=i,r[4]=-i}static createRotationYawPitchRoll(e,t,r,i){We.createFromYawPitchRoll(e,t,r,We.TEMP),qe.createRotationQuaternion(We.TEMP,i)}static createRotationAxis(e,t,r){var i=e.x,s=e.y,a=e.z,n=Math.cos(t),l=Math.sin(t),o=i*i,h=s*s,_=a*a,u=i*s,d=i*a,c=s*a,p=r.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=o+n*(1-o),p[1]=u-n*u+l*a,p[2]=d-n*d-l*s,p[4]=u-n*u-l*a,p[5]=h+n*(1-h),p[6]=c-n*c+l*i,p[8]=d-n*d+l*s,p[9]=c-n*c-l*i,p[10]=_+n*(1-_)}static createRotationQuaternion(e,t){var r=t.elements,i=e.x,s=e.y,a=e.z,n=e.w,l=i*i,o=s*s,h=a*a,_=i*s,u=a*n,d=a*i,c=s*n,p=s*a,f=i*n;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(o+h),r[1]=2*(_+u),r[2]=2*(d-c),r[4]=2*(_-u),r[5]=1-2*(h+l),r[6]=2*(p+f),r[8]=2*(d+c),r[9]=2*(p-f),r[10]=1-2*(o+l)}static createTranslate(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}static createScaling(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(e,t,r){var i=t.elements,s=e.elements,a=r.elements,n=i[0],l=i[1],o=i[2],h=i[3],_=i[4],u=i[5],d=i[6],c=i[7],p=i[8],f=i[9],g=i[10],m=i[11],T=i[12],x=i[13],y=i[14],E=i[15],S=s[0],b=s[1],v=s[2],R=s[3],A=s[4],C=s[5],D=s[6],M=s[7],w=s[8],I=s[9],P=s[10],B=s[11],L=s[12],F=s[13],O=s[14],N=s[15];a[0]=n*S+l*A+o*w+h*L,a[1]=n*b+l*C+o*I+h*F,a[2]=n*v+l*D+o*P+h*O,a[3]=n*R+l*M+o*B+h*N,a[4]=_*S+u*A+d*w+c*L,a[5]=_*b+u*C+d*I+c*F,a[6]=_*v+u*D+d*P+c*O,a[7]=_*R+u*M+d*B+c*N,a[8]=p*S+f*A+g*w+m*L,a[9]=p*b+f*C+g*I+m*F,a[10]=p*v+f*D+g*P+m*O,a[11]=p*R+f*M+g*B+m*N,a[12]=T*S+x*A+y*w+E*L,a[13]=T*b+x*C+y*I+E*F,a[14]=T*v+x*D+y*P+E*O,a[15]=T*R+x*M+y*B+E*N}static createFromQuaternion(e,t){var r=t.elements,i=e.x,s=e.y,a=e.z,n=e.w,l=i+i,o=s+s,h=a+a,_=i*l,u=s*l,d=s*o,c=a*l,p=a*o,f=a*h,g=n*l,m=n*o,T=n*h;r[0]=1-d-f,r[1]=u+T,r[2]=c-m,r[3]=0,r[4]=u-T,r[5]=1-_-f,r[6]=p+g,r[7]=0,r[8]=c+m,r[9]=p-g,r[10]=1-_-d,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(e,t,r,i){var s=i.elements,a=t.x,n=t.y,l=t.z,o=t.w,h=a+a,_=n+n,u=l+l,d=a*h,c=a*_,p=a*u,f=n*_,g=n*u,m=l*u,T=o*h,x=o*_,y=o*u,E=r.x,S=r.y,b=r.z;s[0]=(1-(f+m))*E,s[1]=(c+y)*E,s[2]=(p-x)*E,s[3]=0,s[4]=(c-y)*S,s[5]=(1-(d+m))*S,s[6]=(g+T)*S,s[7]=0,s[8]=(p+x)*b,s[9]=(g-T)*b,s[10]=(1-(d+f))*b,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1}static createLookAt(e,t,r,i){var s=i.elements,a=He,n=Xe,l=Ye;Ie.subtract(e,t,l),Ie.normalize(l,l),Ie.cross(r,l,a),Ie.normalize(a,a),Ie.cross(l,a,n),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=a.x,s[4]=a.y,s[8]=a.z,s[1]=n.x,s[5]=n.y,s[9]=n.z,s[2]=l.x,s[6]=l.y,s[10]=l.z,s[12]=-Ie.dot(a,e),s[13]=-Ie.dot(n,e),s[14]=-Ie.dot(l,e)}static createPerspective(e,t,r,i,s){var a=1/Math.tan(.5*e),n=r/(a/t),l=r/a;qe.createPerspectiveOffCenter(-n,n,-l,l,r,i,s)}static createPerspectiveOffCenter(e,t,r,i,s,a,n){var l=n.elements,o=a/(a-s);l[1]=l[2]=l[3]=l[4]=l[6]=l[7]=l[12]=l[13]=l[15]=0,l[0]=2*s/(t-e),l[5]=2*s/(i-r),l[8]=(e+t)/(t-e),l[9]=(i+r)/(i-r),l[10]=-o,l[11]=-1,l[14]=-s*o}static createOrthoOffCenter(e,t,r,i,s,a,n){var l=n.elements,o=1/(a-s);l[1]=l[2]=l[3]=l[4]=l[6]=l[8]=l[7]=l[9]=l[11]=0,l[15]=1,l[0]=2/(t-e),l[5]=2/(i-r),l[10]=-o,l[12]=(e+t)/(e-t),l[13]=(i+r)/(r-i),l[14]=-s*o}constructor(e=1,t=0,r=0,i=0,s=0,a=1,n=0,l=0,o=0,h=0,_=1,u=0,d=0,c=0,p=0,f=1,g=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var m=this.elements=g||new Float32Array(16);m[0]=e,m[1]=t,m[2]=r,m[3]=i,m[4]=s,m[5]=a,m[6]=n,m[7]=l,m[8]=o,m[9]=h,m[10]=_,m[11]=u,m[12]=d,m[13]=c,m[14]=p,m[15]=f}}else this.elements=je.slice()}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}setRotation(e){var t=e.x,r=e.y,i=e.z,s=e.w,a=t*t,n=r*r,l=i*i,o=t*r,h=i*s,_=i*t,u=r*s,d=r*i,c=t*s,p=this.elements;p[0]=1-2*(n+l),p[1]=2*(o+h),p[2]=2*(_-u),p[4]=2*(o-h),p[5]=1-2*(l+a),p[6]=2*(d+c),p[8]=2*(_+u),p[9]=2*(d-c),p[10]=1-2*(n+a)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,r=e.elements;return De.nearEqual(t[0],r[0])&&De.nearEqual(t[1],r[1])&&De.nearEqual(t[2],r[2])&&De.nearEqual(t[3],r[3])&&De.nearEqual(t[4],r[4])&&De.nearEqual(t[5],r[5])&&De.nearEqual(t[6],r[6])&&De.nearEqual(t[7],r[7])&&De.nearEqual(t[8],r[8])&&De.nearEqual(t[9],r[9])&&De.nearEqual(t[10],r[10])&&De.nearEqual(t[11],r[11])&&De.nearEqual(t[12],r[12])&&De.nearEqual(t[13],r[13])&&De.nearEqual(t[14],r[14])&&De.nearEqual(t[15],r[15])}decomposeTransRotScale(e,t,r){var i=Ke;return this.decomposeTransRotMatScale(e,i,r)?(We.createFromMatrix4x4(i,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,r){var i=this.elements,s=e,a=t.elements,n=r;s.x=i[12],s.y=i[13],s.z=i[14];var l=i[0],o=i[1],h=i[2],_=i[4],u=i[5],d=i[6],c=i[8],p=i[9],f=i[10],g=n.x=Math.sqrt(l*l+o*o+h*h),m=n.y=Math.sqrt(_*_+u*u+d*d),T=n.z=Math.sqrt(c*c+p*p+f*f);if(De.isZero(g)||De.isZero(m)||De.isZero(T))return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,!1;var x=He;x.x=c/T,x.y=p/T,x.z=f/T;var y=Xe;y.x=l/g,y.y=o/g,y.z=h/g;var E=Ye;Ie.cross(x,y,E);var S=Xe;return Ie.cross(E,x,S),a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,a[0]=S.x,a[1]=S.y,a[2]=S.z,a[4]=E.x,a[5]=E.y,a[6]=E.z,a[8]=x.x,a[9]=x.y,a[10]=x.z,a[0]*l+a[1]*o+a[2]*h<0&&(n.x=-g),a[4]*_+a[5]*u+a[6]*d<0&&(n.y=-m),a[8]*c+a[9]*p+a[10]*f<0&&(n.z=-T),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>De.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],r=e[1],i=e[2],s=Math.sqrt(t*t+r*r+i*i);if(!s)return e[0]=0,e[1]=0,void(e[2]=0);1!=s&&(s=1/s,e[0]=t*s,e[1]=r*s,e[2]=i*s)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,r=e.elements,i=t[0],s=t[1],a=t[2],n=t[3],l=t[4],o=t[5],h=t[6],_=t[7],u=t[8],d=t[9],c=t[10],p=t[11],f=t[12],g=t[13],m=t[14],T=t[15],x=i*o-s*l,y=i*h-a*l,E=i*_-n*l,S=s*h-a*o,b=s*_-n*o,v=a*_-n*h,R=u*g-d*f,A=u*m-c*f,C=u*T-p*f,D=d*m-c*g,M=d*T-p*g,w=c*T-p*m,I=x*w-y*M+E*D+S*C-b*A+v*R;0!==Math.abs(I)&&(I=1/I,r[0]=(o*w-h*M+_*D)*I,r[1]=(a*M-s*w-n*D)*I,r[2]=(g*v-m*b+T*S)*I,r[3]=(c*b-d*v-p*S)*I,r[4]=(h*C-l*w-_*A)*I,r[5]=(i*w-a*C+n*A)*I,r[6]=(m*E-f*v-T*y)*I,r[7]=(u*v-c*E+p*y)*I,r[8]=(l*M-o*C+_*R)*I,r[9]=(s*C-i*M-n*R)*I,r[10]=(f*b-g*E+T*x)*I,r[11]=(d*E-u*b-p*x)*I,r[12]=(o*A-l*D-h*R)*I,r[13]=(i*D-s*A+a*R)*I,r[14]=(g*y-f*S-m*x)*I,r[15]=(u*S-d*y+c*x)*I)}static billboard(e,t,r,i,s){Ie.subtract(e,t,He);var a=Ie.scalarLengthSquared(He);De.isZero(a)?(Ie.scale(i,-1,Xe),Xe.cloneTo(He)):Ie.scale(He,1/Math.sqrt(a),He),Ie.cross(r,He,Ye),Ie.normalize(Ye,Ye),Ie.cross(He,Ye,ze);var n=Ye,l=ze,o=He,h=e,_=s.elements;_[0]=n.x,_[1]=n.y,_[2]=n.z,_[3]=0,_[4]=l.x,_[5]=l.y,_[6]=l.z,_[7]=0,_[8]=o.x,_[9]=o.y,_[10]=o.z,_[11]=0,_[12]=h.x,_[13]=h.y,_[14]=h.z,_[15]=1}identity(){this.elements.set(je)}isIdentity(){let e=this.elements,t=qe.DEFAULT.elements;for(let s=0,a=e.length;s<a;s++)if(r=e[s],i=t[s],!(Math.abs(r-i)<1e-7))return!1;var r,i;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new qe(null);return e.elements=this.elements.slice(),e}static translation(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(He,We.TEMP,Xe);var e=Xe,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}qe.TEMPMatrix0=new qe,qe.TEMPMatrix1=new qe,qe.DEFAULT=new qe,qe.DEFAULTINVERT=new qe(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),qe.ZERO=new qe(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Ke=new qe;class $e extends I{static get defaultTexture(){return this._defaultTexture}static __init__(){x.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new $e(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(t,r,i,s,a=!0,n,l=!1){super(t,r,s),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=l,this.depth=i;let o=x.textureContext;this._texture=o.createTexture3DInternal(this._dimension,t,r,i,s,a,l,!1)}setImageData(e,t,r){let i=this._texture;x.textureContext.setTexture3DImageData(i,e,this.depth,t,r)}setPixelsData(e,t,r){let i=this._texture;x.textureContext.setTexture3DPixelsData(i,e,this.depth,t,r)}setSubPixelsData(e,t,r,i,s,a,n,l,o,h,_){let u=this._texture;x.textureContext.setTexture3DSubPixelsData(u,n,l,o,e,t,r,i,s,a,h,_)}}var Ze,Qe,Je,et,tt;function ShaderDataDefaultValue(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return Me.ZERO;case e.ShaderDataType.Vector3:return Ie.ZERO;case e.ShaderDataType.Vector4:return we.ZERO;case e.ShaderDataType.Color:return Z.BLACK;case e.ShaderDataType.Matrix4x4:return qe.DEFAULT;case e.ShaderDataType.Matrix3x3:return Oe.DEFAULT;case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:return $e.defaultTexture;default:return null}}e.ShaderDataType=void 0,(Ze=e.ShaderDataType||(e.ShaderDataType={}))[Ze.Int=0]="Int",Ze[Ze.Bool=1]="Bool",Ze[Ze.Float=2]="Float",Ze[Ze.Vector2=3]="Vector2",Ze[Ze.Vector3=4]="Vector3",Ze[Ze.Vector4=5]="Vector4",Ze[Ze.Color=6]="Color",Ze[Ze.Matrix4x4=7]="Matrix4x4",Ze[Ze.Texture2D=8]="Texture2D",Ze[Ze.TextureCube=9]="TextureCube",Ze[Ze.Buffer=10]="Buffer",Ze[Ze.Matrix3x3=11]="Matrix3x3",Ze[Ze.Texture2DArray=12]="Texture2DArray",Ze[Ze.Texture3D=13]="Texture3D";class rt{get uniformBufferDatas(){return this._uniformBufferDatas}get uniformBuffersMap(){return this._uniformBuffersMap}constructor(e=null){this._ownerResource=null,this.applyUBO=!1,this._data=null,this._defineDatas=new ve,this._ownerResource=e,this._initData(),this._uniformBufferDatas=new Map,this._uniformBuffersMap=new Map}_addCheckUBO(e,t,r){this._uniformBufferDatas.set(e,{ubo:t,uboBuffer:r}),r._uniformParamsState.forEach(((e,r)=>{this.uniformBuffersMap.set(r,t)})),t.setDataByUniformBufferData(r)}_initData(){this._data={},this._gammaColorMap=new Map}getData(){return this._data}applyUBOData(){this._uniformBufferDatas.forEach(((e,t)=>{e.ubo.setDataByUniformBufferData(e.uboBuffer)})),this.applyUBO=!1}addDefine(e){this._defineDatas.add(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getInt(e))}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getNumber(e)),this.applyUBO=!0)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector2(e)),this.applyUBO=!0)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector3(e)),this.applyUBO=!0)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector(e)),this.applyUBO=!0)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,t){if(!t)return;if(this._data[e]){let r=this._gammaColorMap.get(e);t.cloneTo(r);let i=this._data[e];i.x=Z.gammaToLinearSpace(t.r),i.y=Z.gammaToLinearSpace(t.g),i.z=Z.gammaToLinearSpace(t.b),i.w=t.a}else{let r=new we;r.x=Z.gammaToLinearSpace(t.r),r.y=Z.gammaToLinearSpace(t.g),r.z=Z.gammaToLinearSpace(t.b),r.w=t.a,this._data[e]=r,this._gammaColorMap.set(e,t.clone())}let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getLinearColor(e)),this.applyUBO=!0)}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix4x4(e)),this.applyUBO=!0)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix3x3(e))}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t}setTexture(e,t){var r=this._data[e];if(t){let r=Re._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}setValueData(e,t){if(t instanceof Z)return void this.setColor(e,t);t&&t.clone?this._data[e]=t.clone():this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getValueData(e)),this.applyUBO=!0)}setUniformBuffer(e,t){this._data[e]=t}getUniformBuffer(e){return this._data[e]}setShaderData(t,r,i){switch(r){case e.ShaderDataType.Int:this.setInt(t,i);break;case e.ShaderDataType.Bool:this.setBool(t,i);break;case e.ShaderDataType.Float:this.setNumber(t,i);break;case e.ShaderDataType.Vector2:this.setVector2(t,i);break;case e.ShaderDataType.Vector3:this.setVector3(t,i);break;case e.ShaderDataType.Vector4:this.setVector(t,i);break;case e.ShaderDataType.Color:this.setColor(t,i);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,i);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,i);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:this.setTexture(t,i);break;case e.ShaderDataType.Buffer:this.setBuffer(t,i);break;default:throw new Error(`unkown shader data type: ${r}`)}}getShaderData(t,r){switch(r){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unkone shader data type."}}getValueData(e){return this._data[e]}cloneTo(e){var t=e,r=t._data;for(var i in this._data){var s=this._data[i];if(null!=s)if("number"==typeof s)r[i]=s;else if("number"==typeof s)r[i]=s;else if("boolean"==typeof s)r[i]=s;else if(s instanceof Me){var a=r[i]||(r[i]=new Me);s.cloneTo(a),r[i]=a}else if(s instanceof Ie){var n=r[i]||(r[i]=new Ie);s.cloneTo(n),r[i]=n}else if(s instanceof we){let t=this.getColor(parseInt(i));if(t){let r=t.clone();e.setColor(parseInt(i),r)}else{var l=r[i]||(r[i]=new we);s.cloneTo(l),r[i]=l}}else if(s instanceof Oe){let e=r[i]||(r[i]=new Oe);s.cloneTo(e),r[i]=e}else if(s instanceof qe){var o=r[i]||(r[i]=new qe);s.cloneTo(o),r[i]=o}else(s instanceof I||s instanceof w)&&(r[i]=s,s._addReference())}this._defineDatas.cloneTo(t._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())})),this._cloneUBO(t._uniformBufferDatas),t.applyUBO=!0}_cloneUBO(e){this._uniformBufferDatas.forEach(((t,r)=>{e.has(r)&&t.uboBuffer.cloneTo(e.get(r).uboBuffer)}))}clone(){var e=new rt;return this.cloneTo(e),e}reset(){for(var e in this._data){var t=this._data[e];t instanceof w&&t._removeReference()}this._data={},this._gammaColorMap.clear(),this._uniformBufferDatas.clear(),this.applyUBO=!1,this._uniformBuffersMap.clear(),this._defineDatas.clear()}destroy(){for(var e in this._defineDatas.destroy(),this._defineDatas=null,this._data){var t=this._data[e];t instanceof w&&t._removeReference()}this._data=null,this._gammaColorMap.clear(),this._gammaColorMap=null,delete this._uniformBufferDatas,delete this._uniformBuffersMap,this._uniformBufferDatas=null,this._uniformBuffersMap=null}}e.UniformBufferParamsType=void 0,(Qe=e.UniformBufferParamsType||(e.UniformBufferParamsType={}))[Qe.Number=0]="Number",Qe[Qe.Vector2=1]="Vector2",Qe[Qe.Vector3=2]="Vector3",Qe[Qe.Vector4=3]="Vector4",Qe[Qe.Matrix4x4=4]="Matrix4x4",Qe[Qe.Vector4Array=5]="Vector4Array",Qe[Qe.MatrixArray=6]="MatrixArray";class it{constructor(e){this._uniformParamsState=new Map(e),this._createBuffer(),this._updateFlag=new Me,this._resetUpdateFlag()}_createBuffer(){var e=0;this._layoutMap={};this._uniformParamsState.forEach(((t,r)=>{e+=this._addUniformParams(r,t,e)})),this._bytelength=4*Math.ceil(e/4)*4,this._buffer=new Float32Array(e)}_getArraySize(e){let t=e.indexOf("["),r=e.indexOf("]");if(-1!=t&&-1!=r&&t<r)return parseFloat(e.substring(t+1,r));throw e+" is illegal "}_addUniformParams(t,r,i){let s,a=0,n=0,l=i%4;switch(r){case e.UniformBufferParamsType.Number:a=1,n=1;break;case e.UniformBufferParamsType.Vector2:switch(a=2,l){case 0:case 2:n=2;break;case 1:case 3:i+=1,n=3}break;case e.UniformBufferParamsType.Vector3:switch(a=3,n=3,l){case 1:case 2:case 3:i+=4-l,n=4-l+3}break;case e.UniformBufferParamsType.Vector4:switch(a=4,l){case 0:n=4;break;case 1:i+=3,n=7;break;case 2:i+=2,n=6;break;case 3:i+=1,n=5}break;case e.UniformBufferParamsType.Matrix4x4:a=16,s=l?4-l:l,i+=s,n=a+s;break;case e.UniformBufferParamsType.Vector4Array:a=4*this._getArraySize(dt.propertyIDToName(t)),s=l?4-l:l,i+=s,n=a+s;break;case e.UniformBufferParamsType.MatrixArray:a=16*this._getArraySize(dt.propertyIDToName(t)),s=l?4-l:l,i+=s,n=a+s;break;default:throw"Unifrom Buffer Params Type is illegal "}const o=new Me(i,a);return this._layoutMap[t]=o,n}_getParamsInfo(e){return this._layoutMap[e]}_setUpdateFlag(e,t){e<this._updateFlag.x&&(this._updateFlag.x=e),t>this._updateFlag.y&&(this._updateFlag.y=t)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(e){return!!this._getParamsInfo(e)}_setData(t,r){switch(this._uniformParamsState.get(t)){case e.UniformBufferParamsType.Number:this.setNumberbyIndex(t,r);break;case e.UniformBufferParamsType.Vector2:this.setVector2byIndex(t,r);break;case e.UniformBufferParamsType.Vector3:this.setVector3byIndex(t,r);break;case e.UniformBufferParamsType.Vector4:this.setVector4byIndex(t,r);break;case e.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(t,r);break;case e.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(t,r);break;case e.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(t,r)}}getbyteLength(){return this._bytelength}setVector4Array(e,t){const r=dt.propertyNameToID(e);this.setVector4ArraybyIndex(r,t)}setVector4ArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,s=r.y/4;for(let e=0;e<s;e++){let r=t[e];this._buffer[i++]=r.x,this._buffer[i++]=r.y,this._buffer[i++]=r.z,this._buffer[i++]=r.w}this._setUpdateFlag(r.x,i)}setMatrixArray(e,t){const r=dt.propertyNameToID(e);this.setMatrixArraybyIndex(r,t)}setMatrixArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,s=r.y/4;for(let e=0;e<s;e++){let r=t[e];this._buffer.set(r.elements,i),i+=16}this._setUpdateFlag(r.x,i)}setNumber(e,t){const r=dt.propertyNameToID(e);this.setNumberbyIndex(r,t)}setNumberbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t,this._setUpdateFlag(r.x,i)}setVector2(e,t){const r=dt.propertyNameToID(e);this.setVector2byIndex(r,t)}setVector2byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._setUpdateFlag(r.x,i)}setVector3(e,t){const r=dt.propertyNameToID(e);this.setVector3byIndex(r,t)}setVector3byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._setUpdateFlag(r.x,i)}setVector4(e,t){const r=dt.propertyNameToID(e);this.setVector4byIndex(r,t)}setVector4byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._buffer[i++]=t.w,this._setUpdateFlag(r.x,i)}setColor(e,t){const r=dt.propertyNameToID(e);this.setColorbyIndex(r,t)}setColorbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=Z.gammaToLinearSpace(t.r),this._buffer[i++]=Z.gammaToLinearSpace(t.g),this._buffer[i++]=Z.gammaToLinearSpace(t.b),this._buffer[i++]=Z.gammaToLinearSpace(t.a),this._setUpdateFlag(r.x,i)}setMatrix(e,t){const r=dt.propertyNameToID(e);this.setMatrixbyIndex(r,t)}setMatrixbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer.set(t.elements,i),i+=16,this._setUpdateFlag(r.x,i)}clone(){let e=new it(this._uniformParamsState);return this.cloneTo(e),e}cloneTo(e){e._bytelength==this._bytelength&&(e._buffer=Float32Array.from(this._buffer),this._updateFlag.setValue(0,this._buffer.length))}}class st{}class at{constructor(e,t,r){this._validDefine=new ve,this._cacheShaderHierarchy=1,this._cacheSharders={},this._owner=e,this.name=t,this._VS=r.vsNode,this._PS=r.psNode,this._defs=r.defs;for(let e of r.defs)this._validDefine.add(dt.getDefineByName(e))}_resizeCacheShaderMap(e,t,r){var i=this._cacheShaderHierarchy-1;if(t==i)for(var s in e)for(var a=e[s],n=0,l=r-i;n<l;n++)n==l-1?e[0]=a:e=e[0==n?s:0]={};else for(var s in++t,e)this._resizeCacheShaderMap(e[s],t,r)}withCompile(e){var t,r=at._debugDefineString,i=at._debugDefineMask;e._intersectionDefineDatas(this._validDefine),dt.debugMode&&(t=e._length);var s=this._cacheSharders,a=e._length;a>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,a),this._cacheShaderHierarchy=a);for(var n=e._mask,l=e._length-1,o=this._cacheShaderHierarchy-1,h=0;h<o;h++){var _=l<h?0:n[h],u=s[_];u||(s[_]=u={}),s=u}var d=l<o?0:n[o],c=s[d];if(c)return c;var p=at._defineString;dt._getNamesByDefineData(e,p);let f=new st;if(f.is2D=!0,f.vs=this._VS,f.ps=this._PS,f.attributeMap=this._owner._attributeMap,f.uniformMap=this._owner._uniformMap,f.defineString=p,c=x.renderOBJCreate.createShaderInstance(f,this),s[d]=c,dt.debugMode){for(var g="",m="",T=(h=0,t);h<T;h++)m+=h==T-1?i[h]:i[h]+",";for(h=0,T=r.length;h<T;h++)g+=h==T-1?r[h]:r[h]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this.name+"  DefineMask:["+m+"] DefineNames:["+g+"]","color:green")}return c}}at._defineString=[],at._debugDefineString=[],at._debugDefineMask=[];class nt extends at{get renderState(){return this._renderState}constructor(e,t){super(e,null,t),this._tags={},this.statefirst=!1,this._renderState=x.renderOBJCreate.createRenderState(),this._renderState.setNull()}_addDebugShaderVariantCollection(e,t,r){var i=dt._debugShaderVariantInfo,s=this._owner,a=s._owner,n=e._mask;dt._getNamesByDefineData(e,t),r.length=n.length;for(var l=0,o=n.length;l<o;l++)r[l]=n[l];i?i.setValue(a,a._subShaders.indexOf(s),s._passes.indexOf(this),t):dt._debugShaderVariantInfo=i=new Ae(a,a._subShaders.indexOf(s),s._passes.indexOf(this),t),dt.debugShaderVariantCollection.add(i)}withCompile(e,t=!1){var r,i=nt._debugDefineStrings,s=nt._debugDefineMasks;e._intersectionDefineDatas(this._validDefine),dt.debugMode&&(r=e._length,this._addDebugShaderVariantCollection(e,i,s));var a=this._cacheSharders,n=e._length;n>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(a,0,n),this._cacheShaderHierarchy=n);for(var l=e._mask,o=e._length-1,h=this._cacheShaderHierarchy-1,_=0;_<h;_++){var u=o<_?0:l[_],d=a[u];d||(a[u]=d={}),a=d}var c=o<h?0:l[h],p=a[c];if(p)return p;let f=new st;f.is2D=t,f.vs=this._VS,f.ps=this._PS,f.attributeMap=this._owner._attributeMap,f.uniformMap=this._owner._uniformMap;var g=nt._defineStrings;if(dt._getNamesByDefineData(e,g),f.defineString=g,p=x.renderOBJCreate.createShaderInstance(f,this),a[c]=p,dt.debugMode){for(var m="",T="",y="",E="",S=(_=0,r);_<S;_++)y+=_==S-1?s[_]:s[_]+",";for(_=0,S=i.length;_<S;_++)dt._configDefineValues.has(dt.getDefineByName(i[_]))?T+=i[_]+",":m+=i[_]+",";if(this.nodeCommonMap)for(var b=0;b<this.nodeCommonMap.length;b++)E+=this.nodeCommonMap[b]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+y+"] DefineNames:["+m+"] Environment Macro DefineNames:["+T+"]Sprite CommonNode:["+E+"]","color:green")}return p}}nt._defineStrings=[],nt._debugDefineStrings=[],nt._debugDefineMasks=[];class lt{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(e,t,r){this._offset=e,this._elementFormat=t,this._elementUsage=r}}e.RenderParams=void 0,(Je=e.RenderParams||(e.RenderParams={}))[Je.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",Je[Je.Max_Uniform_Count=1]="Max_Uniform_Count",Je[Je.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",Je[Je.MAX_Texture_Size=3]="MAX_Texture_Size",Je[Je.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",Je[Je.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",Je[Je.FLOAT=6]="FLOAT",Je[Je.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",Je[Je.BYTE=8]="BYTE",Je[Je.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class ot{static __init__(){ot._elementInfos={single:[1,x.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,x.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,x.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,x.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,x.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,x.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,x.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,x.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,x.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,x.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,x.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,x.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,x.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,x.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,x.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,x.renderEngine.getParams(e.RenderParams.BYTE),1],ubyte4:[4,x.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(e){var t=ot._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}ot.Single="single",ot.Vector2="vector2",ot.Vector3="vector3",ot.Vector4="vector4",ot.Color="color",ot.Byte4="byte4",ot.Byte3="byte3",ot.Byte2="byte2",ot.ByteOne="byte",ot.Short2="short2",ot.Short4="short4",ot.NormalizedShort2="normalizedshort2",ot.NormalizedShort4="normalizedshort4",ot.HalfVector2="halfvector2",ot.HalfVector4="halfvector4",ot.NorByte4="nbyte4",ot.NorUByte4="ubyte4";class ht{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(e,t){this._id=++ht._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t,this._VAElements=[];var r=t.length;this._shaderValues={};for(var i=0;i<r;i++){var s=t[i],a=s._elementUsage;this._vertexElementsDic[a]=s;var n=new Int32Array(5),l=ot.getElementInfos(s._elementFormat);n[0]=l[0],n[1]=l[1],n[2]=l[2],n[3]=this._vertexStride,n[4]=s._offset,this._shaderValues[a]=n,this._VAElements.push({format:s._elementFormat,stride:s._offset,shaderLocation:a})}}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}ht._uniqueIDCounter=1;class _t{static __init__(){_t.instanceWorldMatrixDeclaration=new ht(64,[new lt(0,ot.Vector4,_t.MESH_WORLDMATRIX_ROW0),new lt(16,ot.Vector4,_t.MESH_WORLDMATRIX_ROW1),new lt(32,ot.Vector4,_t.MESH_WORLDMATRIX_ROW2),new lt(48,ot.Vector4,_t.MESH_WORLDMATRIX_ROW3)]),_t.instanceSimpleAnimatorDeclaration=new ht(16,[new lt(0,ot.Vector4,_t.MESH_SIMPLEANIMATOR)]),_t.instanceLightMapScaleOffsetDeclaration=new ht(16,[new lt(0,ot.Vector4,_t.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(e,t=!0){var r=_t._vertexDeclarationMap[e+(t?"_0":"_1")];if(!r){for(var i=e.split(","),s=0,a=[],n=0,l=i.length;n<l;n++){var o;switch(i[n]){case"POSITION":o=new lt(s,ot.Vector3,_t.MESH_POSITION0),s+=12;break;case"NORMAL":o=new lt(s,ot.Vector3,_t.MESH_NORMAL0),s+=12;break;case"COLOR":o=new lt(s,ot.Vector4,_t.MESH_COLOR0),s+=16;break;case"UV":o=new lt(s,ot.Vector2,_t.MESH_TEXTURECOORDINATE0),s+=8;break;case"UV1":o=new lt(s,ot.Vector2,_t.MESH_TEXTURECOORDINATE1),s+=8;break;case"BLENDWEIGHT":o=new lt(s,ot.Vector4,_t.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":t?(o=new lt(s,ot.Vector4,_t.MESH_BLENDINDICES0),s+=16):(o=new lt(s,ot.Byte4,_t.MESH_BLENDINDICES0),s+=4);break;case"TANGENT":o=new lt(s,ot.Vector4,_t.MESH_TANGENT0),s+=16;break;case"NORMAL_BYTE":o=new lt(s,ot.NorByte4,_t.MESH_NORMAL0),s+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(o)}r=new ht(s,a),_t._vertexDeclarationMap[e+(t?"_0":"_1")]=r}return r}}_t.MESH_POSITION0=0,_t.MESH_COLOR0=1,_t.MESH_TEXTURECOORDINATE0=2,_t.MESH_NORMAL0=3,_t.MESH_TANGENT0=4,_t.MESH_BLENDINDICES0=5,_t.MESH_BLENDWEIGHT0=6,_t.MESH_TEXTURECOORDINATE1=7,_t.MESH_WORLDMATRIX_ROW0=8,_t.MESH_WORLDMATRIX_ROW1=9,_t.MESH_WORLDMATRIX_ROW2=10,_t.MESH_WORLDMATRIX_ROW3=11,_t.MESH_SIMPLEANIMATOR=12,_t.MESH_LIGHTMAPSCALEOFFSET=13,_t.MESH_CUSTOME0=12,_t.MESH_CUSTOME1=13,_t.MESH_CUSTOME2=14,_t.MESH_CUSTOME3=15,_t._vertexDeclarationMap={};class ut{static regIncludeBindUnifrom(e,t,r){let i={},s=i[e]={};s.uniformMap=t,s.defaultValue=r,Object.assign(ut.IncludeUniformMap,i)}constructor(t=ut.DefaultAttributeMap,r={},i=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this._attributeMap=t,this._uniformMap=r,this._uniformDefaultValue=i,this._uniformTypeMap=new Map;for(const t in r)if("object"==typeof r[t]){let e=r[t],i=new Map;for(const t in e){let r=ShaderDataTypeToUniformBufferType(e[t]);i.set(t,r),this._uniformTypeMap.set(t,e[t])}let s=new Map;i.forEach(((e,t)=>{s.set(dt.propertyNameToID(t),e)}));let a=new it(s);this._uniformBufferDataMap.set(t,a)}else{let i=r[t];if(this._uniformTypeMap.set(t,i),i==e.ShaderDataType.Texture2D||i==e.ShaderDataType.TextureCube||i==e.ShaderDataType.Texture3D||i==e.ShaderDataType.Texture2DArray){let e=dt.getDefineByName(`Gamma_${t}`),r=dt.propertyNameToID(t);Re._texGammaDefine[r]=e}}}setFlag(e,t){t?this._flags[e]=t:delete this._flags[e]}getFlag(e){return this._flags[e]}addShaderPass(e,t,r="Forward"){return this._addShaderPass(be.compile(e,t),r)}_addShaderPass(e,t="Forward"){var r=new nt(this,e);return r._pipelineMode=t,this._passes.push(r),this._addIncludeUniform(e.includeNames),r}_addIncludeUniform(e){for(let r of e)if(ut.IncludeUniformMap[r]){let e=ut.IncludeUniformMap[r],i=e.uniformMap,s=e.defaultValue;for(var t in i)this._uniformTypeMap.has(t)||(this._uniformTypeMap.set(t,i[t]),this._uniformMap[t]=i[t]);for(var t in s)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=s[t])}}}function ShaderDataTypeToUniformBufferType(t){switch(t){case e.ShaderDataType.Float:return e.UniformBufferParamsType.Number;case e.ShaderDataType.Vector2:return e.UniformBufferParamsType.Vector2;case e.ShaderDataType.Vector3:return e.UniformBufferParamsType.Vector3;case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return e.UniformBufferParamsType.Vector4;case e.ShaderDataType.Matrix4x4:return e.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}ut.IncludeUniformMap={},ut.DefaultAttributeMap={a_Position:[_t.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[_t.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[_t.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[_t.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[_t.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[_t.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[_t.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[_t.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[_t.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[_t.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector4],a_LightmapScaleOffset:[_t.MESH_LIGHTMAPSCALEOFFSET,e.ShaderDataType.Vector4]},e.ShaderFeatureType=void 0,(et=e.ShaderFeatureType||(e.ShaderFeatureType={}))[et.DEFAULT=0]="DEFAULT",et[et.D3=1]="D3",et[et.D2=2]="D2",et[et.PostProcess=3]="PostProcess",et[et.Sky=4]="Sky",et[et.Effect=5]="Effect";class dt{static init(){dt.debugShaderVariantCollection=new Ce}static _getNamesByDefineData(e,t){var r=dt._maskMap,i=e._mask;t.length=0;for(var s=0,a=e._length;s<a;s++)for(var n=r[s],l=i[s],o=0;o<32;o++){var h=1<<o;if(l>0&&h>l)break;l&h&&t.push(n[h])}}static getDefineByName(e){var t=dt._defineMap[e];if(!t){var r=dt._maskMap,i=dt._defineCounter,s=Math.floor(i/32),a=1<<i%32;t=new Re(s,a),dt._defineMap[e]=t,s==r.length&&(r.length++,r[s]={}),r[s][a]=e,dt._defineCounter++}return t}static propertyNameToID(e){return x.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return x.renderEngine.propertyIDToName(e)}static addInclude(e,t){be.addInclude(e,t)}static compileShaderByDefineNames(e,t,r,i,s){var a=dt.find(e);if(a){var n=a.getSubShaderAt(t);if(n){var l=n._passes[r];if(l.nodeCommonMap=s,l){var o=dt._compileDefineDatas;dt._configDefineValues.cloneTo(o);for(var h=0,_=i.length;h<_;h++)o.add(dt.getDefineByName(i[h]));l.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}static add(e,t=!1,r=!1){return dt._preCompileShader[e]=new dt(e,t,r)}static find(e){return dt._preCompileShader[e]}static parse(e,t){var r;e.name||console.warn("shader name is empty",e),e.uniformMap||console.warn(`${e.name}: uniformMap is empty`);let i=dt.add(e.name,e.enableInstancing,e.supportReflectionProbe);i._surportVolumetricGI=e.surportVolumetricGI;let s=new ut(e.attributeMap?e.attributeMap:ut.DefaultAttributeMap,e.uniformMap,e.defaultValue);i.addSubShader(s);let a=e.shaderPass;for(var n in a){let i=a[n];if(!i.VS){console.warn(`${e.name}: VS of pass ${n} is empty`);continue}if(!i.FS){console.warn(`${e.name}: FS of pass ${n} is empty`);continue}let l=s._addShaderPass(be.compile(i.VS,i.FS,t),i.pipeline);l.statefirst=null!==(r=i.statefirst)&&void 0!==r&&r,be.getRenderState(i.renderState,l.renderState)}return i}get name(){return this._name}constructor(e,t,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=e,this._enableInstancing=t,this._supportReflectionProbe=r}addSubShader(e){this._subShaders.push(e),e._owner=this}getSubShaderAt(e){return this._subShaders[e]}}dt._configDefineValues=new ve,dt._compileDefineDatas=new ve,dt.PERIOD_CUSTOM=0,dt.PERIOD_MATERIAL=1,dt.PERIOD_SPRITE=2,dt.PERIOD_CAMERA=3,dt.PERIOD_SCENE=4,dt._propertyNameMap={},dt._propertyNameCounter=0,dt._defineCounter=0,dt._defineMap={},dt._preCompileShader={},dt._maskMap=[],dt.debugMode=!1;class ct{static __init__(){ct.TEXTURE2D=dt.getDefineByName("TEXTURE2D"),ct.PRIMITIVE=dt.getDefineByName("PRIMITIVE"),ct.FILTERGLOW=dt.getDefineByName("GLOW_FILTER"),ct.FILTERBLUR=dt.getDefineByName("BLUR_FILTER"),ct.FILTERCOLOR=dt.getDefineByName("COLOR_FILTER"),ct.COLORADD=dt.getDefineByName("COLOR_ADD"),ct.WORLDMAT=dt.getDefineByName("WORLDMAT"),ct.FILLTEXTURE=dt.getDefineByName("FILLTEXTURE"),ct.MVP3D=dt.getDefineByName("MVP3D"),ct.GAMMASPACE=dt.getDefineByName("GAMMASPACE"),ct.INVERTY=dt.getDefineByName("INVERTY"),ct.GAMMATEXTURE=dt.getDefineByName("GAMMATEXTURE"),ct.TEXTURESHADER=dt.getDefineByName("TEXTUREVS"),ct.PRIMITIVESHADER=dt.getDefineByName("PRIMITIVEMESH"),ct.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){ct.UNIFORM_MMAT=dt.propertyNameToID("u_mmat"),ct.UNIFORM_CLIPMATDIR=dt.propertyNameToID("u_clipMatDir"),ct.UNIFORM_CLIPMATPOS=dt.propertyNameToID("u_clipMatPos"),ct.UNIFORM_MMAT2=dt.propertyNameToID("u_mmat2"),ct.UNIFORM_SIZE=dt.propertyNameToID("u_size"),ct.UNIFORM_CLIPOFF=dt.propertyNameToID("u_clipOff"),ct.UNIFORM_MVPMatrix=dt.propertyNameToID("u_MvpMatrix"),ct.UNIFORM_SPRITETEXTURE=dt.propertyNameToID("u_spriteTexture"),ct.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=dt.propertyNameToID("u_strength_sig2_2sig2_gauss1"),ct.UNIFORM_BLURINFO=dt.propertyNameToID("u_blurInfo"),ct.UNIFORM_COLORALPHA=dt.propertyNameToID("u_colorAlpha"),ct.UNIFORM_COLORMAT=dt.propertyNameToID("u_colorMat"),ct.UNIFORM_COLOR=dt.propertyNameToID("u_color"),ct.UNIFORM_BLURINFO1=dt.propertyNameToID("u_blurInfo1"),ct.UNIFORM_BLURINFO2=dt.propertyNameToID("u_blurInfo2"),ct.UNIFORM_COLORADD=dt.propertyNameToID("u_colorAdd"),ct.UNIFORM_TEXRANGE=dt.propertyNameToID("u_TexRange");const t=x.renderOBJCreate.createGlobalUniformMap("Sprite2D");t.addShaderUniform(ct.UNIFORM_MMAT,"u_mmat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ct.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector2),t.addShaderUniform(ct.UNIFORM_MMAT2,"u_mmat2",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ct.UNIFORM_SIZE,"u_size",e.ShaderDataType.Vector2),t.addShaderUniform(ct.UNIFORM_CLIPOFF,"u_clipOff",e.ShaderDataType.Vector2),t.addShaderUniform(ct.UNIFORM_MVPMatrix,"u_MvpMatrix",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ct.UNIFORM_SPRITETEXTURE,"u_spriteTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(ct.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_BLURINFO,"u_blurInfo",e.ShaderDataType.Vector2),t.addShaderUniform(ct.UNIFORM_COLORALPHA,"u_colorAlpha",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_COLORMAT,"u_colorMat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ct.UNIFORM_COLOR,"u_color",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_BLURINFO1,"u_blurInfo1",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_BLURINFO2,"u_blurInfo2",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_COLORADD,"u_colorAdd",e.ShaderDataType.Vector4),t.addShaderUniform(ct.UNIFORM_TEXRANGE,"u_TexRange",e.ShaderDataType.Vector4)}}class pt{}pt.loopStTm=0,pt.loopCount=0,e.WrapMode=void 0,(tt=e.WrapMode||(e.WrapMode={}))[tt.Repeat=0]="Repeat",tt[tt.Clamp=1]="Clamp",tt[tt.Mirrored=2]="Mirrored";class ft{constructor(e=0,t=0,r=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=r,this._init(e,t)}addRect(e,t,r,i){return!!this._get(t,r,i)&&(this._fill(i.x,i.y,t,r,e),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(e,t,r){if(e>this._width||t>this._height)return!1;for(var i=-1,s=-1,a=this._width,n=this._height,l=this._cells,o=0;o<n;o++)if(!(this._rowInfo[o]<e))for(var h=0;h<a;){var _=3*(o*a+h);if(0!=l[_]||l[_+1]<e||l[_+2]<t)h+=l[_+1];else{i=h,s=o;for(var u=0;u<e;u++)if(l[3*u+_+2]<t){i=-1;break}if(!(i<0))return r.x=i,r.y=s,!0;h+=l[_+1]}}return!1}_fill(e,t,r,i,s){var a=this._width,n=this._height;this._check(e+r<=a&&t+i<=n);for(var l=t;l<i+t;++l){this._check(this._rowInfo[l]>=r),this._rowInfo[l]-=r;for(var o=0;o<r;o++){var h=3*(e+l*a+o);this._check(0==this._cells[h]),this._cells[h]=s,this._cells[h+1]=r,this._cells[h+2]=i}}if(e>0)for(l=0;l<i;++l){var _=0;for(o=e-1;o>=0&&0==this._cells[3*((t+l)*a+o)];--o,++_);for(o=_;o>0;--o)this._cells[3*((t+l)*a+e-o)+1]=o,this._check(o>0)}if(t>0)for(o=e;o<e+r;++o){for(_=0,l=t-1;l>=0&&0==this._cells[3*(o+l*a)];--l,_++);for(l=_;l>0;--l)this._cells[3*(o+(t-l)*a)+2]=l,this._check(l>0)}this._used+=r*i/(this._width*this._height)}_check(e){0==e&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var r=0;r<this._width;r++){var i=3*(t*this._width+r);this._cells[i]=0,this._cells[i+1]=this._width-r,this._cells[i+2]=this._width-t}}}class gt{static parse(e){if(e===xt)return mt;let t=gt._cache[e];return t||(t=gt._cache[e]=new gt(e)),xt=e,mt=t,t}constructor(e){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(e||"14px Arial")}setFont(e){this._font=e;var t=e.split(" "),r=t.length;if(r<2)1==r&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{var i=-1;for(let s=0;s<r;s++)if(t[s].indexOf("px")>0||t[s].indexOf("pt")>0){i=s,this._size=parseInt(t[s]),this._size<=0&&(console.debug("font parse error:"+e),this._size=14);break}var s=i+1,a=t[s];for(s++;s<r;s++)a+=" "+t[s];this._family=a.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}gt._cache={};var mt,Tt,xt="";class yt{constructor(){this.pagecharsCtx=null,window.conch&&!window.conchConfig.conchWebGL?this._nativeObj=new window._conchWordText:(this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1)}setText(e){this.text=e,this._nativeObj?this._nativeObj._text=e:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let e=this.pageChars;if(e.length>0){for(var t in e){let r=e[t];if(!r)continue;let i=r.tex;1==r.words.length&&i&&i.ri&&i.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(e){this._splitRender=e,this._nativeObj&&(this._nativeObj.splitRender=e)}}class Et{constructor(){this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var e=pt.loopCount;this.touchTick!=e&&this.tex.touchRect(this,e),this.touchTick=e}}class St{constructor(){this.fontsz=16}getWidth(e,t){return 0}scale(e,t){}get canvasWidth(){return 0}set canvasWidth(e){}getCharBmp(e,t,r,i,s,a,n,l,o,h,_=null){return null}}class bt{static __init__(){var e;let t=window.Laya||n.Laya;if(bt._window)return bt._window;let i,s=bt._window=window,a=bt._document=s.document,l=bt.userAgent=s.navigator.userAgent,o=s.navigator.maxTouchPoints||0,h=s.navigator.platform;window.conch&&"conchUseWXAdapter"in bt.window&&(i=["wxMiniGame","MiniAdpter","wx"]),"my"in bt.window&&(l.indexOf("TB/")>-1||l.indexOf("Taobao/")>-1||l.indexOf("TM/")>-1?i=["tbMiniGame","TBMiniAdapter","my"]:l.indexOf("AlipayMiniGame")>-1&&(i=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==l.indexOf("OPPO")&&l.indexOf("MiniGame")>-1||-1!=l.indexOf("runtime")||-1!=l.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in bt.window&&(i="tt"in bt.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in bt.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in bt.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in bt.window&&(i=["hwMiniGame","HWMiniAdapter",null]),l.indexOf("SwanGame")>-1&&(i=["bdMiniGame","BMiniAdapter",null]),l.indexOf("QuickGame")>-1&&(i=["miMiniGame","KGMiniAdapter","qg"]),l.indexOf("OPPO")>-1&&l.indexOf("MiniGame")>-1&&(i=["qgMiniGame","QGMiniAdapter","qg"],r.fixedFrames=!1),l.indexOf("VVGame")>-1&&(i=["vvMiniGame","VVMiniAdapter","qg"],r.fixedFrames=!1),null!=i&&(bt.window[i[0]](t,t),t[i[1]].enable(),bt.miniGameContext=bt.window[i[2]]),s.trace=console.log,s.requestAnimationFrame=s.requestAnimationFrame||s.webkitRequestAnimationFrame||s.mozRequestAnimationFrame||s.oRequestAnimationFrame||s.msRequestAnimationFrame||function(e){return s.setTimeout(e,1e3/60)};var _=a.body.style;_.margin=0,_.overflow="hidden",_["-webkit-user-select"]="none",_["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var u=a.getElementsByTagName("meta");let d,c={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const e of u)if("viewport"==e.name){d=e;break}if(d){let e=(d.content||"").split(",");for(let t of e){let e=t.split("=");c[e[0].trim()]||(c[e[0]]=e[1])}}else d=a.createElement("meta"),d.name="viewport",null===(e=a.getElementsByTagName("head")[0])||void 0===e||e.appendChild(d);return d.content=Object.keys(c).map((e=>e+"="+c[e])),bt.onMobile=!!window.conch||l.indexOf("Mobile")>-1,bt.onIOS=!!l.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),bt.onIPhone=l.indexOf("iPhone")>-1,bt.onMac=l.indexOf("Mac OS X")>-1,bt.onIPad=l.indexOf("iPad")>-1||"MacIntel"===h&&o>1,bt.onAndroid=l.indexOf("Android")>-1||l.indexOf("Adr")>-1,bt.onWP=l.indexOf("Windows Phone")>-1,bt.onQQBrowser=l.indexOf("QQBrowser")>-1,bt.onMQQBrowser=l.indexOf("MQQBrowser")>-1||l.indexOf("Mobile")>-1&&l.indexOf("QQ")>-1,bt.onIE=!!s.ActiveXObject||"ActiveXObject"in s,bt.onWeiXin=l.indexOf("MicroMessenger")>-1,bt.onSafari=l.indexOf("Safari")>-1&&-1===l.indexOf("Chrome"),bt.onChrome=l.indexOf("Chrome")>-1,bt.onPC=!bt.onMobile,bt.onFirefox=l.indexOf("Firefox")>-1,bt.onEdge=l.indexOf("Edge")>-1||l.indexOf("Edg")>-1,bt.onMiniGame=l.indexOf("MiniGame")>-1,bt.onBDMiniGame=l.indexOf("SwanGame")>-1,bt.onLayaRuntime=!!window.conch,l.indexOf("OPPO")>-1&&l.indexOf("MiniGame")>-1?(bt.onQGMiniGame=!0,bt.onMiniGame=!1):"qq"in bt.window&&l.indexOf("MiniGame")>-1?(bt.onQQMiniGame=!0,bt.onMiniGame=!1):"bl"in bt.window&&l.indexOf("MiniGame")>-1?(bt.onBLMiniGame=!0,bt.onMiniGame=!1):"tt"in bt.window&&l.indexOf("MiniGame")>-1&&(bt.onTTMiniGame=!0,bt.onMiniGame=!1),bt.onHWMiniGame="hbs"in bt.window,bt.onVVMiniGame=l.indexOf("VVGame")>-1,bt.onKGMiniGame=l.indexOf("QuickGame")>-1,l.indexOf("AlipayMiniGame")>-1&&(bt.onAlipayMiniGame=!0,bt.onMiniGame=!1),(l.indexOf("TB/")>-1||l.indexOf("Taobao/")>-1||l.indexOf("TM/")>-1)&&(bt.onTBMiniGame=!0),(bt.onAndroid||bt.onIOS)&&(!h||-1==h.indexOf("Win")&&-1==h.indexOf("Mac"))?bt.onAndroid?bt.platform=bt.PLATFORM_ANDROID:bt.platform=bt.PLATFORM_IOS:bt.platform=bt.PLATFORM_PC,s}static get _isMiniGame(){return bt.onMiniGame||bt.onBDMiniGame||bt.onQGMiniGame||bt.onKGMiniGame||bt.onVVMiniGame||bt.onAlipayMiniGame||bt.onQQMiniGame||bt.onBLMiniGame||bt.onTTMiniGame||bt.onHWMiniGame||bt.onTBMiniGame||bt.window&&bt.window.isWXMiMi}static createElement(e){return bt.__init__(),bt._document.createElement(e)}static getElementById(e){return bt.__init__(),bt._document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return Date.now()}static get clientWidth(){return bt.__init__(),bt._clientWidth||bt._window.innerWidth||bt._document.body.clientWidth}static set clientWidth(e){bt._clientWidth=e}static get clientHeight(){return bt.__init__(),bt._clientHeight||bt._window.innerHeight||bt._document.body.clientHeight||bt._document.documentElement.clientHeight}static set clientHeight(e){bt._clientHeight=e}static get width(){return bt.__init__(),(n.stage&&n.stage.canvasRotation?bt.clientHeight:bt.clientWidth)*bt.pixelRatio}static get height(){return bt.__init__(),(n.stage&&n.stage.canvasRotation?bt.clientWidth:bt.clientHeight)*bt.pixelRatio}static get pixelRatio(){return bt._pixelRatio<0&&(bt.__init__(),bt.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?bt._pixelRatio=2:(bt._pixelRatio=bt._window.devicePixelRatio||1,bt._pixelRatio<1&&(bt._pixelRatio=1))),bt._pixelRatio}static get container(){return bt._container||(bt.__init__(),bt._container=bt.createElement("div"),bt._container.id="layaContainer",bt._document.body.appendChild(bt._container)),bt._container}static set container(e){bt._container=e}static get window(){return bt._window||bt.__init__()}static get document(){return bt.__init__(),bt._document}static getQueryString(e){if(bt.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),r=window.location.search.substring(1).match(t);return null!=r?unescape(r[2]):null}static getSafariToolbarOffset(){return(bt.window.__innerHeight||bt.document.body.clientHeight||bt.document.documentElement.clientHeight)-bt.window.innerHeight}static loadLib(e){return new Promise(((t,r)=>{let i=bt.document.createElement("script");i.onload=function(){t()},i.onerror=function(){r(`load ${e} failed`)},i.src=e,bt.document.body.appendChild(i)}))}}bt.PLATFORM_PC=0,bt.PLATFORM_ANDROID=1,bt.PLATFORM_IOS=2,bt._pixelRatio=-1,bt.mainCanvas=null,bt.hanzi=new RegExp("^[一-龥]$"),bt.fontMap={},bt.measureText=function(e,t){let r=bt.hanzi.test(e);if(r&&bt.fontMap[t])return bt.fontMap[t];let i=bt.context;i.font=t;let s=i.measureText(e);return r&&(bt.fontMap[t]=s),s};class vt extends St{constructor(e,t,r=!0,i=!0,s=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=e,this.maxTexH=t,this.scaleFontSize=r,this.supportImageData=i,this.showDbgInfo=s,vt.canvas||(vt.canvas=bt.createElement("canvas"),vt.canvas.width=1024,vt.canvas.height=512,vt.canvas.style.left="-10000px",vt.canvas.style.position="absolute",window.document.body.appendChild(vt.canvas),this.ctx=vt.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return vt.canvas.width}set canvasWidth(e){vt.canvas.width!=e&&(vt.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}scale(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}getCharBmp(e,t,r,i,s,a,n,l,o,h,_=null){if(!this.supportImageData)return this.getCharCanvas(e,t,r,i,s,a,n,l,o,h);var u=this.ctx,d=this.fontsz;u.font!=t&&(u.font=t,u._lastFont=t),a.width=u.measureText(e).width;var c=a.width*this.lastScaleX,p=a.height*this.lastScaleY;c+=(n+o)*this.lastScaleX,p+=(l+h)*this.lastScaleY,c=Math.ceil(c),p=Math.ceil(p);var f=(c=Math.min(c,vt.canvas.width))+2*r+1,g=(p=Math.min(p,vt.canvas.height))+2*r+1;_&&(f=Math.max(f,_[0]+_[2]+1),g=Math.max(g,_[1]+_[3]+1)),u.clearRect(0,0,f/this.lastScaleX+1,g/this.lastScaleY+1),u.save(),u.textBaseline="middle",r>0&&(u.lineJoin="round",u.strokeStyle=s,u.lineWidth=r,u.strokeText(e,n,l+d/2)),i&&(u.fillStyle=i,u.fillText(e,n,l+d/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(1,1,c-2,p-2),u.strokeStyle="#00ff00",u.strokeRect(n,l,a.width,a.height)),_&&(_[2]<=0&&(_[2]=Math.ceil(-_[2]+(a.width+2*r)*this.lastScaleX)),_[2]<=0&&(_[2]=1));var m=_?u.getImageData(_[0],_[1],_[2],_[3]+1):u.getImageData(0,0,c,p+1);return u.restore(),a.bmpWidth=m.width,a.bmpHeight=m.height,m}getCharCanvas(e,t,r,i,s,a,n,l,o,h){var _=this.ctx;_.font!=t&&(_.font=t,_._lastFont=t),a.width=_.measureText(e).width;var u=a.width*this.lastScaleX,d=a.height*this.lastScaleY;u+=(n+o)*this.lastScaleX,d+=(l+h)*this.lastScaleY+1,u=Math.min(u,this.maxTexW),d=Math.min(d,this.maxTexH),vt.canvas.width=Math.min(u+1,this.maxTexW),vt.canvas.height=Math.min(d+1,this.maxTexH),_.clearRect(0,0,u+1+r,d+1+r),_.setTransform(1,0,0,1,0,0),_.save(),_.font=t,this.scaleFontSize&&_.scale(this.lastScaleX,this.lastScaleY),_.translate(n,l),_.textAlign="left";var c=this.fontsz;return _.textBaseline="middle",r>0?(_.strokeStyle=s,_.fillStyle=i,_.lineWidth=r,_.fillAndStrokeText?_.fillAndStrokeText(e,0,c/2):(_.strokeText(e,0,c/2),_.fillText(e,0,c/2))):i&&(_.fillStyle=i,_.fillText(e,0,c/2)),this.showDbgInfo&&(_.strokeStyle="#ff0000",_.strokeRect(0,0,u,d),_.strokeStyle="#00ff00",_.strokeRect(0,0,a.width,a.height)),_.restore(),a.bmpWidth=vt.canvas.width,a.bmpHeight=vt.canvas.height,vt.canvas}}vt.canvas=null;class Rt{constructor(){this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new f,this.textureMem=0;var e=!1,t=n.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(n.Browser.onMiniGame||n.Browser.onTTMiniGame||n.Browser.onBLMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onTBMiniGame)&&!e&&(Rt.isWan1Wan=!0),this.charRender=new vt(2048,2048,Rt.scaleFontWithCtx,!Rt.isWan1Wan,!1),Rt.textRenderInst=this,n.Laya.textRender=this,Rt.atlasWidth2=Rt.atlasWidth*Rt.atlasWidth}setFont(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),r=t>>24,i=t>>16&255,s=t>>8&255,a=255&t,n=e._size/Rt.standardFontSize;this.fontSizeOffX=Math.ceil(r*n),this.fontSizeOffY=Math.ceil(i*n),this.fontSizeW=Math.ceil(s*n),this.fontSizeH=Math.ceil(a*n),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}getNextChar(e){var t=e.length,r=this._curStrPos;if(!e.substring)return null;if(r>=t)return null;for(var i=r,s=0;i<t;i++){var a=e.charCodeAt(i);if(a>>>11==27){if(1==s)break;s=1,i++}else if(65038===a||65039===a);else if(8205==a)s=2;else if(0==s)s=1;else if(1==s)break}return this._curStrPos=i,e.substring(r,i)}filltext(e,t,r,s,a,n,l,o,h){if(!(t.length<=0)){var _=gt.parse(a),u=0;switch(h){case"center":u=i.ENUM_TEXTALIGN_CENTER;break;case"right":u=i.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,r,s,_,n,l,o,u)}}_fast_filltext(e,t,r,s,a,n,l,o,h){if(!t||t.length>=1){if(o<0&&(o=0),this.setFont(a),this.fontScaleX=this.fontScaleY=1,Rt.scaleFontWithCtx){let t=e.getMatScaleX(),r=e.getMatScaleY();if(t<1e-4||r<.1)return;t>1&&(this.fontScaleX=Math.min(Rt.maxFontScale,t)),r>1&&(this.fontScaleY=Math.min(Rt.maxFontScale,r))}a._italic&&(e._italicDeg=13);var _=t,u=t instanceof yt,d=t&&t.toString(),c=u?_.pageChars:[],p=0;switch(u?(d=_.text,(p=_.width)<0&&(p=_.width=this.charRender.getWidth(this.fontStr,d))):p=d?this.charRender.getWidth(this.fontStr,d):0,h){case i.ENUM_TEXTALIGN_CENTER:r-=p/2;break;case i.ENUM_TEXTALIGN_RIGHT:r-=p}u&&(this.hasFreedText(c)||_.pagecharsCtx!=e)&&(c=_.pageChars=[]);var f=null,g=this.renderPerChar=!u||Rt.forceSplitRender||u&&_.splitRender;if(!c||c.length<1){if(u&&(_.scalex=this.fontScaleX,_.scaley=this.fontScaleY),g){var m,T=0;for(this._curStrPos=0;(m=this.getNextChar(d))&&(f=this.getCharRenderInfo(m,a,n,l,o,!1));)if(f.isSpace);else{var x=c[f.tex.id];if(x)x=x.words;else{var y={texgen:f.tex.genID,tex:f.tex,words:new Array};c[f.tex.id]=y,x=y.words}x.push({ri:f,x:T,y:0,w:f.bmpWidth/this.fontScaleX,h:f.bmpHeight/this.fontScaleY}),T+=f.width}}else{var E=a._size/3|0,S=Rt.noAtlas||(p+E+E)*this.fontScaleX>Rt.atlasWidth;f=this.getCharRenderInfo(d,a,n,l,o,S),c[0]={texgen:f.tex.genID,tex:f.tex,words:[{ri:f,x:0,y:0,w:f.bmpWidth/this.fontScaleX,h:f.bmpHeight/this.fontScaleY}]}}u&&(_.pagecharsCtx=e)}this._drawResortedWords(e,r,s,c),e._italicDeg=0}}_drawResortedWords(e,t,r,i){var s=!!e._charSubmitCache&&e._charSubmitCache._enable,a=e._curMat;for(var n in i){var l=i[n];if(l){var o=l.words,h=o.length;if(!(h<=0))for(var _=i[n].tex,u=0;u<h;u++){var d=o[u],c=d.ri;if(c.isSpace)continue;c.touch(),e.drawTexAlign=!0;let i=_;e._inner_drawTexture(i.texture,i.id,t+d.x-c.orix,r+d.y-c.oriy,d.w,d.h,a,c.uv,1,s,4294967295),e.touches&&e.touches.push(c)}}}}hasFreedText(e){for(let i in e){var t=e[i];if(t){var r=t.tex;if(r.destroyed||r.genID!=t.texgen)return!0}}return!1}getCharRenderInfo(e,t,r,i,s,a=!1){var n=this.mapFont[t._family];null==n&&(this.mapFont[t._family]=n=this.fontID++);var l=e+"_"+n+"_"+t._size+"_"+r;s>0&&(l+="_"+i+s),t._bold&&(l+="P"),1==this.fontScaleX&&1==this.fontScaleY||(l+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var o,h,_=0,u=this.textAtlases.length;if(!a)for(_=0;_<u;_++)if(o=(h=this.textAtlases[_]).charMaps[l])return o.touch(),o;o=new Et,this.charRender.scale(this.fontScaleX,this.fontScaleY),o.char=e,o.height=t._size;var d=t._size/3|0,c=null;s||(s=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*s)*this.fontScaleX);if(p>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,p+2*d)),a){if(this.charRender.fontsz=t._size,c=this.charRender.getCharBmp(e,this.fontStr,s,r,i,o,d,d,d,d,null)){var f=Ct.getTextTexture(c.width,c.height);f.addChar(c,0,0,o.uv),o.tex=f,o.orix=d,o.oriy=d,f.ri=o,this.isoTextures.push(f)}}else{var g=e.length,m=1*s,T=Math.ceil((this.fontSizeW+2*m)*this.fontScaleX),x=Math.ceil((this.fontSizeH+2*m)*this.fontScaleY);Rt.imgdtRect[0]=(d-this.fontSizeOffX-m)*this.fontScaleX|0,Rt.imgdtRect[1]=(d-this.fontSizeOffY-m)*this.fontScaleY|0,this.renderPerChar||1==g?(Rt.imgdtRect[2]=Math.max(p,T),Rt.imgdtRect[3]=Math.max(p,x)):(Rt.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,Rt.imgdtRect[3]=x),this.charRender.fontsz=t._size,(c=this.charRender.getCharBmp(e,this.fontStr,s,r,i,o,d,d,d,d,Rt.imgdtRect))&&(h=this.addBmpData(c,o),Rt.isWan1Wan?(o.orix=d,o.oriy=d):(o.orix=this.fontSizeOffX+m,o.oriy=this.fontSizeOffY+m),h.charMaps[l]=o)}return o}addBmpData(e,t){for(var r,i=e.width,s=e.height,a=this.textAtlases.length,n=!1,l=0;l<a&&!(n=(r=this.textAtlases[l]).getAEmpty(i,s,this.tmpAtlasPos));l++);if(!n){if(r=new At,this.textAtlases.push(r),!(n=r.getAEmpty(i,s,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return n&&(r.texture.addChar(e,this.tmpAtlasPos.x,this.tmpAtlasPos.y,t.uv),t.tex=r.texture),r}GC(){for(var e=0,t=this.textAtlases.length,r=Rt.destroyAtlasDt,i=0,s=pt.loopCount,a=-1,n=0,l=null,o=null;e<t;e++){if(l=(o=this.textAtlases[e]).texture){l.curUsedCovRate,i+=l.curUsedCovRateAtlas;var h=o.usedRate-l.curUsedCovRateAtlas;n<h&&(n=h,a=e)}s-o.texture.lastTouchTm>r&&(Rt.showLog&&console.log(o.texture.id),o.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,a=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)s-(l=this.isoTextures[e]).lastTouchTm>Rt.destroyUnusedTextureDt&&(l.ri.deleted=!0,l.ri.tex=null,l.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var _=this.textAtlases.length>1&&this.textAtlases.length-i>=2;(Rt.atlasWidth*Rt.atlasWidth*4*this.textAtlases.length>Rt.cleanMem||_||Rt.simClean)&&(Rt.simClean=!1,Rt.showLog&&console.log("清理使用率低的贴图。总使用率:",i,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((o=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1)),Ct.clean()}cleanAtlases(){}getCharBmp(e){}checkBmpLine(e,t,r,i){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var s=e.width*t+r,a=r;a<i;a++)if(0!=this.bmpData32[s++])return!0;return!1}updateBbx(e,t,r=!1){var i=e.width,s=e.height,a=0,n=t[1],l=0,o=n;if(this.checkBmpLine(e,n,0,i))for(;;){if((o=(n+l)/2|0)+1>=n){t[1]=o;break}this.checkBmpLine(e,o,0,i)?n=o:l=o}if(t[3]>s)t[3]=s;else if(o=n=t[3],l=s,this.checkBmpLine(e,n,0,i))for(;;){if((o=(n+l)/2|0)-1<=n){t[3]=o;break}this.checkBmpLine(e,o,0,i)?n=o:l=o}if(!r){var h=t[0],_=i*t[1];for(o=t[1];o<t[3];o++){for(a=0;a<h;a++)if(0!=this.bmpData32[_+a]){h=a;break}_+=i}t[0]=h;var u=t[2];for(_=i*t[1],o=t[1];o<t[3];o++){for(a=u;a<i;a++)if(0!=this.bmpData32[_+a]){u=a;break}_+=i}t[2]=u}}getFontSizeInfo(e){var t=this.fontSizeInfo[e];if(null!=t)return t;var r="bold "+Rt.standardFontSize+"px "+e;if(Rt.isWan1Wan){this.fontSizeW=1.5*this.charRender.getWidth(r,"有"),this.fontSizeH=1.5*Rt.standardFontSize;var i=this.fontSizeW<<8|this.fontSizeH;return this.fontSizeInfo[e]=i,i}Rt.pixelBBX[0]=Rt.standardFontSize/2,Rt.pixelBBX[1]=Rt.standardFontSize/2,Rt.pixelBBX[2]=Rt.standardFontSize,Rt.pixelBBX[3]=Rt.standardFontSize;this.charRender.scale(1,1),Rt.tmpRI.height=Rt.standardFontSize,this.charRender.fontsz=Rt.standardFontSize;var s=this.charRender.getCharBmp("g",r,0,"red",null,Rt.tmpRI,16,16,16,16);this.bmpData32=new Uint32Array(s.data.buffer),this.updateBbx(s,Rt.pixelBBX,!1),s=this.charRender.getCharBmp("有",r,0,"red",null,Rt.tmpRI,16,16,16,16),this.bmpData32=new Uint32Array(s.data.buffer),Rt.pixelBBX[2]<16+Rt.tmpRI.width&&(Rt.pixelBBX[2]=16+Rt.tmpRI.width),this.updateBbx(s,Rt.pixelBBX,!1);var a=Math.max(16-Rt.pixelBBX[0],0)<<24|Math.max(16-Rt.pixelBBX[1],0)<<16|Rt.pixelBBX[2]-Rt.pixelBBX[0]<<8|Rt.pixelBBX[3]-Rt.pixelBBX[1];return this.fontSizeInfo[e]=a,a}printDbgInfo(){for(var e in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+Rt.atlasWidth+"x"+Rt.atlasWidth," 用canvas:",Rt.isWan1Wan),console.log("图集占用空间:"+Rt.atlasWidth*Rt.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var t=this.getFontSizeInfo(e),r=t>>24,i=t>>16&255,s=t>>8&255,a=255&t;console.log("    "+e," off:",r,i," size:",s,a)}var n=0;console.log("缓存数据:");var l=0,o=0;this.textAtlases.forEach((function(e){var t=e.texture.id,r=pt.loopCount-e.texture.lastTouchTm,i=r>0?r+"帧以前":"当前帧";for(var s in l+=e.texture.curUsedCovRate,o+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+i+")--:"),e.charMaps){var a=e.charMaps[s];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",pt.loopCount-a.touchTick,"位置:",a.uv[0]*Rt.atlasWidth|0,a.uv[1]*Rt.atlasWidth|0,"字符:",a.char,"key:",s),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(e){console.log("    size:",e._texW,e._texH,"touch间隔:",pt.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",n,"总使用率:",l,"总当前图集使用率:",o)}showAtlas(e,t,r,i,s,a){if(!this.textAtlases[e])return console.log("没有这个图集"),null;var l=new Li,o=this.textAtlases[e].texture,h={width:Rt.atlasWidth,height:Rt.atlasWidth,sourceWidth:Rt.atlasWidth,sourceHeight:Rt.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:ae.DEF_UV};return l.size=function(e,r){return this.width=e,this.height=r,l.graphics.clear(),l.graphics.drawRect(0,0,l.width,l.height,t),l.graphics.drawTexture(h,0,0,l.width,l.height),this},l.graphics.drawRect(0,0,s,a,t),l.graphics.drawTexture(h,0,0,s,a),l.pos(r,i),n.stage.addChild(l),l}filltext_native(e,t,r,s,a,n,l,o,h){if(!(t&&t.length<=0)){var _=gt.parse(a),u=0;switch(h){case"center":u=i.ENUM_TEXTALIGN_CENTER;break;case"right":u=i.ENUM_TEXTALIGN_RIGHT}return this._fast_filltext(e,t,r,s,_,n,l,o,u)}}}Rt.useOldCharBook=!1,Rt.atlasWidth=1024,Rt.noAtlas=!1,Rt.forceSplitRender=!1,Rt.forceWholeRender=!1,Rt.scaleFontWithCtx=!0,Rt.maxFontScale=4,Rt.standardFontSize=32,Rt.destroyAtlasDt=10,Rt.checkCleanTextureDt=2e3,Rt.destroyUnusedTextureDt=3e3,Rt.cleanMem=104857600,Rt.isWan1Wan=!1,Rt.showLog=!1,Rt.debugUV=!1,Rt.tmpRI=new Et,Rt.pixelBBX=[0,0,0,0],Rt.imgdtRect=[0,0,0,0],Rt.simClean=!1;class At{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=Rt.atlasWidth,this.texture=Ct.getTextTexture(this.texWidth,this.texHeight),this.texWidth/At.atlasGridW>256&&(At.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new ft(this.texWidth/At.atlasGridW,this.texHeight/At.atlasGridW,this.texture.id)}setProtecteDist(e){}getAEmpty(e,t,r){var i=this.atlasgrid.addRect(1,Math.ceil(e/At.atlasGridW),Math.ceil(t/At.atlasGridW),r);return i&&(r.x*=At.atlasGridW,r.y*=At.atlasGridW),i}get usedRate(){return this.atlasgrid._used}destroy(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}printDebugInfo(){}}At.atlasGridW=16;class Ct extends w{get gammaCorrection(){return this.bitmap._glTexture.gammaCorrection}constructor(e,t){super(),this._texW=0,this._texH=0,this._discardTm=0,this.genID=0,this.bitmap={id:0,_glTexture:null},this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this._texW=e||Rt.atlasWidth,this._texH=t||Rt.atlasWidth,this.bitmap.id=this.id,this.lock=!0,this._render2DContext=x.render2DContext}recreateResource(){if(!this._source){var t=this._source=new Y(this._texW,this._texH,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0);t.setPixelsData(null,!0,!1),t.lock=!0,this.bitmap._glTexture=t,this._source.filterMode=e.FilterMode.Bilinear,this._source.wrapModeU=e.WrapMode.Clamp,this._source.wrapModeV=e.WrapMode.Clamp,Rt.debugUV&&this.fillWhite()}}addChar(e,t,r,i=null){if(Rt.isWan1Wan)return this.addCharCanvas(e,t,r,i);var s,a,n,l,o=e.data;return e.data instanceof Uint8ClampedArray&&(o=new Uint8Array(o.buffer)),!this._source&&this.recreateResource(),x.textureContext.setTextureSubPixelsData(this._source._texture,o,0,!1,t,r,e.width,e.height,!0,!1),s=t/this._texW,a=r/this._texH,n=(t+e.width)/this._texW,l=(r+e.height)/this._texH,(i=i||new Array(8))[0]=s,i[1]=a,i[2]=n,i[3]=a,i[4]=n,i[5]=l,i[6]=s,i[7]=l,i}addCharCanvas(e,t,r,i=null){var s,a,n,o;return!this._source&&this.recreateResource(),x.textureContext.setTextureSubImageData(this._source._texture,e,t,r,!0,!1),l.isConch?(s=t/this._texW,a=r/this._texH,n=(t+e.width)/this._texW,o=(r+e.height)/this._texH):(s=(t+1)/this._texW,a=(r+1)/this._texH,n=(t+e.width-1)/this._texW,o=(r+e.height-1)/this._texH),(i=i||new Array(8))[0]=s,i[1]=a,i[2]=n,i[3]=a,i[4]=n,i[5]=o,i[6]=s,i[7]=o,i}fillWhite(){!this._source&&this.recreateResource();var e=new Uint8Array(this._texW*this._texH*4);e.fill(255),x.textureContext.setTextureImageData(this._source._getSource(),e,!0,!1)}discard(){n.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(e,t){return new Ct(e,t)}_disposeResource(){this._source&&this._source.destroy(),this._source=null}static clean(){var e=pt.loopStTm;if(0===Ct.cleanTm&&(Ct.cleanTm=e),e-Ct.cleanTm>=Rt.checkCleanTextureDt){for(var t=0;t<Ct.poolLen;t++){var r=Ct.pool[t];e-r._discardTm>=Rt.destroyUnusedTextureDt&&(r.destroy(),Ct.pool[t]=Ct.pool[Ct.poolLen-1],Ct.poolLen--,t--)}Ct.cleanTm=e}}touchRect(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var r=Rt.atlasWidth*Rt.atlasWidth,i=At.atlasGridW*At.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/r,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/At.atlasGridW)*Math.ceil(e.bmpHeight/At.atlasGridW)/(r/i)}get texture(){return this}_getSource(){return this._source._getSource()}drawOnScreen(e,t){}}Ct.pool=new Array(10),Ct.poolLen=0,Ct.cleanTm=0,e.RenderSpriteData=void 0,(Tt=e.RenderSpriteData||(e.RenderSpriteData={}))[Tt.Zero=0]="Zero",Tt[Tt.Texture2D=1]="Texture2D",Tt[Tt.Primitive=2]="Primitive";class Dt{static _initone(e,t){Dt._typeClass[e]=t,Dt._cache[e]=[],Dt._cache[e]._length=0,Dt.globalShaderData=new rt}static create(e){var t=Dt._cache[e]?Dt._cache[e]:[];return t._length?t[--t._length]:new Dt._typeClass[e]}set size(e){this.defines.setVector2(ct.UNIFORM_SIZE,e)}get size(){return this.defines.getVector2(ct.UNIFORM_SIZE)}set mmat(e){this.defines.setMatrix4x4(ct.UNIFORM_MMAT,e)}get mmat(){return this.defines.getMatrix4x4(ct.UNIFORM_MMAT)}set u_MvpMatrix(e){this.defines.setMatrix4x4(ct.UNIFORM_MVPMatrix,e)}get u_MvpMatrix(){return this.defines.getMatrix4x4(ct.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(e){this._textureHost=e,this.defines.setTexture(ct.UNIFORM_SPRITETEXTURE,e)}set color(e){e&&this.defines.setVector(ct.UNIFORM_COLOR,e)}get color(){return this.defines.getVector(ct.UNIFORM_COLOR)}set colorAdd(e){this.defines.setVector(ct.UNIFORM_COLORADD,e)}get colorAdd(){return this.defines.getVector(ct.UNIFORM_COLORADD)}set clipMatDir(e){this.defines.setVector(ct.UNIFORM_CLIPMATDIR,e)}get clipMatDir(){return this.defines.getVector(ct.UNIFORM_CLIPMATDIR)}set clipMatPos(e){this.defines.setVector2(ct.UNIFORM_CLIPMATPOS,e)}get clipMatPos(){return this.defines.getVector2(ct.UNIFORM_CLIPMATPOS)}set clipOff(e){this.defines.setVector2(ct.UNIFORM_CLIPOFF,e)}get clipOff(){return this.defines.getVector2(ct.UNIFORM_CLIPOFF)}constructor(t){this.defines=new rt,this.alpha=1,this.ALPHA=1,this.mainID=e.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this._size=new Me,this._mmat=new qe,this._clipMatDir=new we(i.MAX_CLIP_SIZE,0,0,i.MAX_CLIP_SIZE),this._clipMatpos=new Me,this._clipOff=new Me,this.mainID=t,this.textureHost=null,this.texture=null,this.clipMatDir=this._clipMatDir,this.clipMatPos=this._clipMatpos,this.clipOff=this._clipOff,this._cacheID=t,this._inClassCache=Dt._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=Dt._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}updateShaderData(){var t=j;j.worldMatrix4===j.TEMPMAT4_ARRAY||this.defines.addDefine(ct.WORLDMAT),this._mmat.cloneByArray(t.worldMatrix4),this.mmat=this._mmat,j.matWVP&&(this.defines.addDefine(ct.MVP3D),this.u_MvpMatrix=j.matWVP);let r=!J.currentActive||1!=J.currentActive._texture.gammaCorrection,i=!1;this.textureHost&&(this.textureHost instanceof J?i=1!=this.textureHost.gammaCorrection:this.textureHost instanceof ae&&this.textureHost.bitmap?i=1!=this.textureHost.bitmap.gammaCorrection:this.textureHost instanceof Ct&&this.textureHost.bitmap&&(i=1!=this.textureHost.gammaCorrection)),i?this.defines.addDefine(ct.GAMMATEXTURE):this.defines.removeDefine(ct.GAMMATEXTURE),r?this.defines.addDefine(ct.GAMMASPACE):this.defines.removeDefine(ct.GAMMASPACE),j.InvertY?this.defines.addDefine(ct.INVERTY):this.defines.removeDefine(ct.INVERTY),this.mainID==e.RenderSpriteData.Texture2D&&this.defines.addDefine(ct.TEXTURESHADER),this.mainID==e.RenderSpriteData.Primitive&&this.defines.addDefine(ct.PRIMITIVESHADER)}upload(e=null){if(this._size.setValue(j.width,j.height),this.size=this._size,this.updateShaderData(),e){for(var t,r=0,i=(s=e._shader._subShaders[0]._passes).length;r<i&&"Forward"!=(t=s[r])._pipelineMode;r++);Dt._compileDefine,this.defines._defineDatas.cloneTo(Dt._compileDefine),Dt._compileDefine.addDefineDatas(e._defineDatas),Dt._compileDefine.addDefineDatas(Dt.globalShaderData._defineDatas),(a=t.withCompile(Dt._compileDefine,!0)).bind(),a.uploadUniforms(a._sprite2DUniformParamsMap,this.defines,!0),a.uploadUniforms(a._sceneUniformParamsMap,Dt.globalShaderData,!0),a.uploadUniforms(a._materialUniformParamsMap,e.shaderData,!0)}else{var s,a;if((s=this._defaultShader._subShaders[0]._passes).length>=1)(a=(t=s[0]).withCompile(this.defines._defineDatas,!0)).bind(),a.uploadUniforms(a._sprite2DUniformParamsMap,this.defines,!0)}}setFilters(e){if(this.filters=e,e)for(var t,r=e.length,i=0;i<r;i++)(t=e[i])&&(this.defines.addDefine(t.typeDefine),t.action.setValue(this))}clear(){this.clipOff.x=0,this.clipOff=this.clipOff}release(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1,this.clipOff.x=0,this.clipOff=this.clipOff,this.texture=null,this.textureHost=null)}}Dt._cache=[],Dt._typeClass=[],Dt.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Dt._compileDefine=new ve;class Mt{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}copyFrom(e){this.other=e.other,this.blendShader=e.blendShader,this.submitType=e.submitType}copyFrom2(e,t,r){this.other=r,this.submitType=t}equal3_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal4_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal_3(e){return this.submitType===e.submitType&&this.blendShader===e.blendShader}equal(e){return this.other===e.other&&this.submitType===e.submitType&&this.blendShader===e.blendShader}}class wt{constructor(){this._ref=1,this._key=new Mt}renderSubmit(){return this.fun.apply(this._this,this.args),1}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=wt.POOL;e[e._length++]=this,this.args=null,this.fun=null,this._this=null}}static create(e,t,r){var i=wt.POOL._length?wt.POOL[--wt.POOL._length]:new wt;return i.fun=t,i.args=e,i._this=r,i._ref=1,i._key.clear(),i}}wt.POOL=[],wt.POOL._length=0;class It{constructor(){}get type(){return-1}}It.BLUR=16,It.COLOR=32,It.GLOW=8,It._filter=function(t,r,i,s){var a=r,n=this._next;if(n){var l=t.filters,o=l.length;if(1==o&&l[0].type==It.COLOR)return r.save(),r.setColorFilter(l[0]),n._fun.call(n,t,r,i,s),void r.restore();var h,_=Dt.create(e.RenderSpriteData.Texture2D),u=f.TEMP,d=a._curMat,c=p.create();d.copyTo(c);var m=0,T=0,x=null,y=t._cacheStyle.filterCache||null;if(y&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(m=50,T=25),(h=t.getBounds()).width<=0||h.height<=0)return;h.width+=m+8,h.height+=m+8,h.x-=t.pivotX+4,h.y-=t.pivotY+4,u.x=h.x*c.a+h.y*c.c,u.y=h.y*c.d+h.x*c.b,h.x=u.x,h.y=u.y,u.x=h.width*c.a+h.height*c.c,u.y=h.height*c.d+h.width*c.b,h.width=u.x,h.height=u.y}else{t._isHaveGlowFilter()&&(m=50,T=25),(h=new g).copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var E=h.x,S=h.y;if(h.width+=m+8,h.height+=m+8,h.width=Math.ceil(h.width),h.height=Math.ceil(h.height),u.x=h.x*c.a+h.y*c.c,u.y=h.y*c.d+h.x*c.b,h.x=u.x,h.y=u.y,u.x=h.width*c.a+h.height*c.c,u.y=h.height*c.d+h.width*c.b,h.width=u.x,h.height=u.y,h.width<=0||h.height<=0)return;y&&ee.releaseRT(y),x=ee.getRT(h.width,h.height);var b=y=ee.getRT(h.width,h.height);t._getCacheStyle().filterCache=y,a.pushRT(),a.useRT(x);var v=t.x-E+T,R=t.y-S+T;n._fun.call(n,t,r,v,R),a.useRT(b);for(var A=0;A<o;A++){0!=A&&(a.useRT(x),a.drawTarget(b,0,0,h.width,h.height,p.TEMP.identity(),_,null,re.TOINT.overlay),a.useRT(b));var C=l[A];switch(C.type){case It.BLUR:case It.GLOW:C._glRender&&C._glRender.render(x,r,h.width,h.height,C);break;case It.COLOR:a.setColorFilter(C),a.drawTarget(x,0,0,h.width,h.height,p.EMPTY.identity(),Dt.create(e.RenderSpriteData.Texture2D)),a.setColorFilter(null)}}a.popRT()}if(i=i-T-t.x,s=s-T-t.y,u.setTo(i,s),c.transformPoint(u),i=u.x+h.x,s=u.y+h.y,a._drawRenderTexture(y,i,s,h.width,h.height,p.TEMP.identity(),1,J.defuv),x){var D=wt.create([x],(function(e){e.destroy()}),this);x=null,r.addRenderObject(D)}c.destroy()}};const Pt={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class Bt{constructor(e){if(this.arrColor=[],null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let t;"string"==typeof e?(t=d.fromStringColor(e),this.strColor=e):(t=e,this.strColor=d.toHexColor(t)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&t)>>>24)/255,((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255],this.numColor=(4278190080&t)>>>24|(16711680&t)>>8|(65280&t)<<8|(255&t)<<24):(this.arrColor=[((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255,1],this.numColor=4278190080|(16711680&t)>>16|65280&t|(255&t)<<16)}static _initDefault(){for(var e in Bt._DEFAULT={},Pt)Bt._SAVE[e]=Bt._DEFAULT[e]=new Bt(Pt[e]);return Bt._DEFAULT}static _initSaveMap(){Bt._SAVE_SIZE=0,Bt._SAVE=Object.assign({},Bt._DEFAULT)}static create(e){let t=e+"",r=Bt._SAVE[t];return null!=r?r:(Bt._SAVE_SIZE>500&&Bt._initSaveMap(),Bt._SAVE_SIZE++,Bt._SAVE[t]=new Bt(e))}}Bt._SAVE={},Bt._SAVE_SIZE=0,Bt._DEFAULT=Bt._initDefault();const Lt=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],Ft=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],Ot=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class Nt extends It{constructor(e=null){super(),e||(e=this._copyMatrix(Ot)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(e)}gray(){return this.setByMatrix(Ft)}color(e=0,t=0,r=0,i=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,r,0,1,0,0,0,i,0])}setColor(e){var t=Bt.create(e).arrColor,r=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(r)}setByMatrix(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,r=0,i=0;i<20;i++)i%5!=4?this._mat[t++]=e[i]:this._alpha[r++]=e[i];return this}get type(){return It.COLOR}get typeDefine(){return ct.FILTERCOLOR}adjustColor(e,t,r,i){return this.adjustHue(i),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(r),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,r=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?Lt[e]:Lt[e|0]*(1-t)+Lt[1+(e|0)]*t)+127)/127,i=.5*(127-t);return this._multiplyMatrix([r,0,0,0,i,0,r,0,0,i,0,0,r,0,i,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),r=1-t,i=.3086*r,s=.6094*r,a=.082*r;return this._multiplyMatrix([i+t,s,a,0,0,i,s+t,a,0,0,i,s,a+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),r=Math.sin(e),i=.213,s=.715,a=.072;return this._multiplyMatrix([i+t*(1-i)+r*-i,s+t*-s+r*-s,a+t*-a+r*(1-a),0,0,i+t*-i+.143*r,s+t*(1-s)+.14*r,a+t*-a+-.283*r,0,0,i+t*-i+-.787*r,s+t*-s+r*s,a+t*(1-a)+r*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(Ot))}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var r=0;r<5;r++){for(var i=0;i<5;i++)t[i]=this._matrix[i+5*r];for(i=0;i<5;i++){for(var s=0,a=0;a<5;a++)s+=e[i+5*a]*t[a];this._matrix[i+5*r]=s}}return this.setByMatrix(this._matrix)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}_fixMatrix(e=null){return null==e?Ot:(e.length<25?e=e.slice(0,e.length).concat(Ot.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_copyMatrix(e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t];return this._matrix}onAfterDeserialize(){let e=Bt.create(this._color||"#FFFFFF").arrColor;this.color(e[0],e[1],e[2],e[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class Ut{static multiply(e,t,r){return(e.x-r.x)*(t.y-r.y)-(t.x-r.x)*(e.y-r.y)}static dis(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}static _getPoints(e,t=!1,r=null){for(Ut._mPointList||(Ut._mPointList=[]);Ut._mPointList.length<e;)Ut._mPointList.push(new f);return r||(r=[]),r.length=0,t?Ut.getFrom(r,Ut._mPointList,e):Ut.getFromR(r,Ut._mPointList,e),r}static getFrom(e,t,r){var i;for(i=0;i<r;i++)e.push(t[i]);return e}static getFromR(e,t,r){var i;for(i=0;i<r;i++)e.push(t.pop());return e}static pListToPointList(e,t=!1){var r,i=e.length/2,s=Ut._getPoints(i,t,Ut._tempPointList);for(r=0;r<i;r++)s[r].setTo(e[r+r],e[r+r+1]);return s}static pointListToPlist(e){var t,r,i=e.length,s=Ut._temPList;for(s.length=0,t=0;t<i;t++)r=e[t],s.push(r.x,r.y);return s}static scanPList(e){return d.copyArray(e,Ut.pointListToPlist(Ut.scan(Ut.pListToPointList(e,!0))))}static scan(e){var t,r,i,s,a,n=0,l=e.length,o={};for((s=Ut._temArr).length=0,t=(l=e.length)-1;t>=0;t--)(a=(i=e[t]).x+"_"+i.y)in o||(o[a]=!0,s.push(i));for(l=s.length,d.copyArray(e,s),t=1;t<l;t++)(e[t].y<e[n].y||e[t].y==e[n].y&&e[t].x<e[n].x)&&(n=t);for(i=e[0],e[0]=e[n],e[n]=i,t=1;t<l-1;t++){for(n=t,r=t+1;r<l;r++)(Ut.multiply(e[r],e[n],e[0])>0||0==Ut.multiply(e[r],e[n],e[0])&&Ut.dis(e[0],e[r])<Ut.dis(e[0],e[n]))&&(n=r);i=e[t],e[t]=e[n],e[n]=i}if((s=Ut._temArr).length=0,e.length<3)return d.copyArray(s,e);for(s.push(e[0],e[1],e[2]),t=3;t<l;t++){for(;s.length>=2&&Ut.multiply(e[t],s[s.length-1],s[s.length-2])>=0;)s.pop();e[t]&&s.push(e[t])}return s}}Ut._tempPointList=[],Ut._temPList=[],Ut._temArr=[];class Gt{}var kt,Vt,Wt,Ht;Gt.ALPHA=1,Gt.TRANSFORM=2,Gt.BLEND=4,Gt.CANVAS=8,Gt.FILTERS=16,Gt.MASK=32,Gt.CLIP=64,Gt.STYLE=128,Gt.TEXTURE=256,Gt.GRAPHICS=512,Gt.LAYAGL3D=1024,Gt.CUSTOM=2048,Gt.ONECHILD=4096,Gt.HITAREA=8192,Gt.CHILDS=16384,Gt.REPAINT_NONE=0,Gt.REPAINT_NODE=1,Gt.REPAINT_CACHE=2,Gt.REPAINT_ALL=3,e.RenderStatisticsInfo=void 0,(kt=e.RenderStatisticsInfo||(e.RenderStatisticsInfo={}))[kt.DrawCall=0]="DrawCall",kt[kt.InstanceDrawCall=1]="InstanceDrawCall",kt[kt.Triangle=2]="Triangle",kt[kt.UniformUpload=3]="UniformUpload",kt[kt.GPUMemory=4]="GPUMemory",kt[kt.TextureMemeory=5]="TextureMemeory",kt[kt.RenderTextureMemory=6]="RenderTextureMemory",kt[kt.BufferMemory=7]="BufferMemory";class Xt{static show(e,t,r){Xt.checkUI()&&(this.hide(),Xt._show=!0,Xt._currentShowArray=r||Xt.AllShow,Xt._statUI.show(e,t,Xt._currentShowArray),n.systemTimer.frameLoop(1,null,Xt.loop))}static showToggle(e,t,r){Xt.checkUI()&&(this.hide(),Xt._show=!0,Xt._currentToggleArray=r,Xt._statUI.showToggle(e,t,r),n.systemTimer.frameLoop(1,null,Xt.loop))}static checkUI(){if(!Xt._statUI){let e=t.getClass("StatUI");if(!e)return console.error("StatUI not found"),!1;Xt._statUI=new e}return!0}static hide(){Xt._show&&(Xt._show=!1,Xt._currentShowArray=null,Xt._currentToggleArray=null,n.systemTimer.clear(null,Xt.loop),Xt._statUI&&Xt._statUI.hide())}static loop(){Xt._count++;let e=bt.now();if(e-Xt._timer<1e3)return;let t=Xt._count;if(Xt.FPS=Math.round(1e3*t/(e-Xt._timer)),Xt._show){Xt.updateEngineData();let e=Xt.FPS>0?Math.floor(1e3/Xt.FPS).toString():" ";Xt._fpsStr=Xt.FPS+(Xt.renderSlow?" slow":"")+" "+e+"ms",Xt._statUI.update(),Xt.clear()}Xt._count=0,Xt._timer=e}static updateEngineData(){Xt.trianglesFaces=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.Triangle),Xt.drawCall=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.DrawCall),Xt.instanceDrawCall=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall),Xt.gpuMemory=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.GPUMemory),Xt.textureMemory=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory),Xt.renderTextureMemory=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory),Xt.bufferMemory=x.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.BufferMemory)}static clear(){Xt._currentShowArray&&(Xt._currentShowArray.forEach((e=>{"average"==e.mode&&(Xt[e.value]=0)})),x.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.Triangle),x.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.DrawCall),x.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall))}static render(e,t,r){Xt._show&&Xt._statUI.render(e,t,r)}}Xt.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},Xt.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},Xt.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},Xt.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},Xt.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},Xt.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},Xt.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},Xt.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},Xt.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},Xt.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},Xt.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},Xt.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},Xt.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},Xt.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},Xt.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},Xt.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},Xt.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},Xt.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},Xt.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},Xt.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},Xt.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},Xt.AllShow=[Xt.FPSStatUIParams,Xt.NodeStatUIParams,Xt.Sprite3DStatUIParams,Xt.DrawCall,Xt.TriangleFace,Xt.RenderNode,Xt.SkinRenderNode,Xt.ParticleRenderNode,Xt.FrustumCulling,Xt.OpaqueDrawCall,Xt.TransDrawCall,Xt.DepthCastDrawCall,Xt.InstanceDrawCall,Xt.CMDDrawCall,Xt.BlitDrawCall,Xt.GPUMemory,Xt.TextureMemeory,Xt.RenderTextureMemory,Xt.BufferMemory,Xt.uploadUniformNum],Xt.memoryShow=[Xt.GPUMemory,Xt.TextureMemeory,Xt.RenderTextureMemory,Xt.BufferMemory],Xt.renderShow=[Xt.DrawCall,Xt.TriangleFace,Xt.OpaqueDrawCall,Xt.TransDrawCall,Xt.DepthCastDrawCall,Xt.InstanceDrawCall,Xt.CMDDrawCall,Xt.BlitDrawCall],Xt.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},Xt.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},Xt.toogle_Light={title:"Light",value:"enableLight",color:"white"},Xt.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},Xt.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},Xt.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},Xt.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},Xt.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},Xt.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},Xt.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},Xt.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},Xt.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},Xt.AllToggle=[Xt.toogle_Shadow,Xt.toogle_Light,Xt.toogle_MulLight,Xt.toogle_Postprocess,Xt.toogle_AnimatorUpdate,Xt.toogle_PhysicsUpdate,Xt.toogle_Opaque,Xt.toogle_Transparent,Xt.toogle_CameraCMD,Xt.toogle_Skin,Xt.toogle_Particle,Xt.toogle_msaa],Xt.RenderModeToggle=[Xt.toogle_Shadow,Xt.toogle_Light,Xt.toogle_MulLight,Xt.toogle_Postprocess,Xt.toogle_AnimatorUpdate,Xt.toogle_PhysicsUpdate],Xt.RenderFuncToggle=[Xt.toogle_Opaque,Xt.toogle_Transparent,Xt.toogle_CameraCMD,Xt.toogle_Skin,Xt.toogle_Particle,Xt.toogle_msaa],Xt.FPS=0,Xt.loopCount=0,Xt.spriteRenderUseCacheCount=0,Xt.canvasNormal=0,Xt.canvasBitmap=0,Xt.canvasReCache=0,Xt.renderSlow=!1,Xt._timer=0,Xt._count=0,Xt._fpsStr="",Xt.spriteCount=0,Xt.sprite3DCount=0,Xt.drawCall=0,Xt.trianglesFaces=0,Xt.renderNode=0,Xt.skinRenderNode=0,Xt.particleRenderNode=0,Xt.frustumCulling=0,Xt.uniformUpload=0,Xt.opaqueDrawCall=0,Xt.transDrawCall=0,Xt.depthCastDrawCall=0,Xt.instanceDrawCall=0,Xt.cmdDrawCall=0,Xt.blitDrawCall=0,Xt.textureMemory=0,Xt.renderTextureMemory=0,Xt.bufferMemory=0,Xt.uploadUniform=0,Xt.enableShadow=!0,Xt.enableMulLight=!0,Xt.enableLight=!0,Xt.enableCameraCMD=!0,Xt.enablePostprocess=!0,Xt.enableSkin=!0,Xt.enableTransparent=!0,Xt.enableParticle=!0,Xt.enableAnimatorUpdate=!0,Xt.enablePhysicsUpdate=!0,Xt.enablemsaa=!0,Xt.enableOpaque=!0,window.Stat=Xt;class Yt{static __init__(){var t=Yt.RENDERBASE=new Yt(-1);t.shaderValue=new Dt(e.RenderSpriteData.Zero),t.shaderValue.ALPHA=1,t._ref=4294967295}constructor(e=Yt.TYPE_2D){this.clipInfoID=-1,this._mesh=null,this._blendFn=null,this._id=0,this._renderType=0,this._parent=null,this._key=new Mt,this._startIdx=0,this._numEle=0,this._ref=1,this.shaderValue=null,this._renderType=e,this._id=++Yt.ID}getID(){return this._id}getRenderType(){return this._renderType}toString(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key}renderSubmit(){return 1}releaseRender(){}}Yt.TYPE_2D=1e4,Yt.TYPE_CANVAS=10003,Yt.TYPE_CMDSETRT=10004,Yt.TYPE_CUSTOM=10005,Yt.TYPE_BLURRT=10006,Yt.TYPE_CMDDESTORYPRERT=10007,Yt.TYPE_DISABLESTENCIL=10008,Yt.TYPE_OTHERIBVB=10009,Yt.TYPE_PRIMITIVE=10010,Yt.TYPE_RT=10011,Yt.TYPE_BLUR_RT=10012,Yt.TYPE_TARGET=10013,Yt.TYPE_CHANGE_VALUE=10014,Yt.TYPE_SHAPE=10015,Yt.TYPE_TEXTURE=10016,Yt.TYPE_FILLTEXTURE=10017,Yt.KEY_ONCE=-1,Yt.KEY_FILLRECT=1,Yt.KEY_DRAWTEXTURE=2,Yt.KEY_VG=3,Yt.KEY_TRIANGLES=4,Yt.ID=1,Yt.preRender=null,e.BufferTargetType=void 0,(Vt=e.BufferTargetType||(e.BufferTargetType={}))[Vt.ARRAY_BUFFER=0]="ARRAY_BUFFER",Vt[Vt.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Vt[Vt.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Vt[Vt.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Vt[Vt.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Vt[Vt.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",Vt[Vt.PIXEL_PACK_BUFFER=6]="PIXEL_PACK_BUFFER",Vt[Vt.PIXEL_UNPACK_BUFFER=7]="PIXEL_UNPACK_BUFFER",e.BufferUsage=void 0,(Wt=e.BufferUsage||(e.BufferUsage={}))[Wt.Static=0]="Static",Wt[Wt.Dynamic=1]="Dynamic",Wt[Wt.Stream=2]="Stream";class zt{static getVertexLayoutByPool(e){let t=zt._pool;for(var r in t){let i=t[r];if(i.deepthEqaul(e))return i}return new zt(e)}constructor(e){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let t=0;t<e.length;t++){let r=[],i=e[t].vertexDeclaration.vertexStride,s=e[t].vertexDeclaration._VAElements;for(let e=0;e<s.length;e++)r.push({format:s[e].format,stride:s[e].stride,shaderLocation:s[e].shaderLocation});this.attributeByteSize.push(i),this.VAElements.push(r),this.instanceMode.push(e[t].instanceBuffer)}this.id=zt.IPoint,zt._pool[zt.IPoint++]=this}deepthEqaul(e){if(e.length!=this.VAElements.length)return!1;for(var t=0;t<e.length;t++){let s=e[t]._vertexDeclaration._VAElements,a=this.VAElements[t];if(s.length!=a.length)return!1;for(var r=0,i=s.length;r<i;r++){let e=s[r],t=a[r];if(e.format!=t.format||e.stride!=t.stride||e.shaderLocation!=t.shaderLocation)return!1}}return!0}}zt.IPoint=0,zt._pool={};class jt{constructor(){this._nativeVertexArrayObject=x.renderEngine.createVertexState()}applyVertexBuffers(){this._nativeVertexArrayObject&&this._nativeVertexArrayObject.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._nativeVertexArrayObject&&this._nativeVertexArrayObject.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this.vertexlayout=zt.getVertexLayoutByPool(e),this._vertexBuffers=e,this._bindedIndexBuffer=t,this._nativeVertexArrayObject&&(t&&t.unbind(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t.unbind())}bind(){this._nativeVertexArrayObject&&(this._nativeVertexArrayObject.bindVertexArray(),jt._curBindedBufferState=this)}unBind(){if(this._nativeVertexArrayObject){if(jt._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._nativeVertexArrayObject.unbindVertexArray(),jt._curBindedBufferState=null}}isbind(){return jt._curBindedBufferState==this}static clearbindBufferState(){x.renderEngine.unbindVertexState(),jt._curBindedBufferState=null}destroy(){this._nativeVertexArrayObject&&(this._nativeVertexArrayObject.destroy(),this._nativeVertexArrayObject=null)}}e.IndexFormat=void 0,(Ht=e.IndexFormat||(e.IndexFormat={}))[Ht.UInt8=0]="UInt8",Ht[Ht.UInt16=1]="UInt16",Ht[Ht.UInt32=2]="UInt32";class qt{get bufferUsage(){return this._bufferUsage}constructor(e,t){this._byteLength=0,this._glBuffer=x.renderEngine.createBuffer(e,t),this._bufferType=e,this._bufferUsage=t}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}class Kt extends qt{constructor(t,r){super(t,r),this._indexType=e.IndexFormat.UInt16}_setIndexData(e,t){var r=jt._curBindedBufferState;r?r._bindedIndexBuffer===this?this._glBuffer.setDataLength(0):(r.unBind(),this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t),r.bind()):(this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t))}}class $t{get bufferLength(){return this.constBuffer._buffer.byteLength}set byteLength(e){this.setByteLength(e)}setByteLength(e){this.constBuffer._byteLength!==e&&(e<=this._bufferSize||this._resizeBuffer(2*e+256,!0),this.constBuffer._byteLength=e)}needSize(e){var t=this.constBuffer._byteLength;if(e){var r=this.constBuffer._byteLength+e;r<=this._bufferSize||this._resizeBuffer(r<<1,!0),this.constBuffer._byteLength=r}return t}constructor(e){this._maxsize=0,this._upload=!0,this._uploadSize=0,this._bufferSize=0,this._u8Array=null,this.constBuffer=e}getFloat32Array(){return this._floatArray32||(this._floatArray32=new Float32Array(this.constBuffer._buffer.buffer)),this._floatArray32}_bufferData(){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),pt.loopCount%30==0){if(this.constBuffer._buffer.byteLength>this._maxsize+64){this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse();let e=this.constBuffer._buffer.buffer;this._bufferSize%4==0&&(this._floatArray32=new Float32Array(e)),this._bufferSize%4==0&&(this._uint32Array=new Uint32Array(e)),this._uint16Array=new Uint16Array(e)}this._maxsize=this.constBuffer._byteLength}this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),this.constBuffer._glBuffer.setData(new Uint8Array(this.constBuffer._buffer.buffer,0,this.constBuffer._byteLength),0),this.constBuffer.unbind()}_bufferSubData(e=0,t=0,r=0){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),pt.loopCount%30==0&&(this.constBuffer._buffer.byteLength>this._maxsize+64&&(this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse()),this._maxsize=this.constBuffer._byteLength),this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),t||r){var i=this.constBuffer._buffer.buffer.slice(t,r);this.constBuffer._glBuffer.setData(i,e)}else this.constBuffer._glBuffer.setData(this.constBuffer._buffer.buffer,e)}_checkArrayUse(){}_bind_upload(){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferData(),!0)}_bind_subUpload(e=0,t=0,r=0){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferSubData(e,t,r),!0)}_resizeBuffer(e,t){var r=this.constBuffer._buffer;if(r&&e<=r.byteLength)return this;if(this._u8Array,t&&r&&r.byteLength>0){var i=new Uint8Array(r.buffer),s=new Uint8Array(e);s.set(i,0),r=this.constBuffer._buffer=s,this._u8Array=new Uint8Array(this.constBuffer._buffer.buffer)}else{var a=new ArrayBuffer(e);r=this.constBuffer._buffer=new Uint8Array(a),this._u8Array=new Uint8Array(r.buffer)}return r=this.constBuffer._buffer.buffer,e%4==0&&(this._floatArray32=new Float32Array(r)),e%4==0&&(this._uint32Array=new Uint32Array(r)),this._uint16Array=new Uint16Array(r),this._checkArrayUse(),this._upload=!0,this._bufferSize=r.byteLength,this}append(e){var t,r;this._upload=!0,t=e.byteLength,e instanceof Uint8Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint8Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Uint16Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Float32Array&&(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Float32Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)),r.set(e,0),this.constBuffer._byteLength+=t,this._checkArrayUse()}appendU16Array(e,t){this._resizeBuffer(this.constBuffer._byteLength+2*t,!0);var r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength,t);if(6==t)r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5];else if(t>=100)r.set(new Uint16Array(e.buffer,0,t));else for(var i=0;i<t;i++)r[i]=e[i];this.constBuffer._byteLength+=2*t,this._checkArrayUse()}getBuffer(){return this.constBuffer._buffer.buffer}setNeedUpload(){this._upload=!0}subUpload(e=0,t=0,r=0){var i=this._bind_subUpload();return this.constBuffer.unbind(),z.activeShader=null,i}_disposeResource(){this._upload=!0,this._uploadSize=0,this._floatArray32=null,this._uint32Array=null,this._u8Array=null}clear(){this.constBuffer._byteLength=0,this._upload=!0}}$t.FLOAT32=4,$t.SHORT=2;class Zt extends Kt{constructor(t=e.BufferUsage.Static){super(e.BufferTargetType.ELEMENT_ARRAY_BUFFER,t),this.buffer2D=new $t(this),this._bufferUsage=t,this._buffer=new Uint8Array(8)}_bindForVAO(){this._glBuffer.bindBuffer()}destory(){this._uint16Array=null,this._buffer=null}disposeResource(){this.buffer2D._disposeResource()}}Zt.create=function(t=e.BufferUsage.Static){return new Zt(t)};class Qt extends qt{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}}class Jt extends Qt{get vertexStride(){return this._vertexStride}constructor(t,r){super(e.BufferTargetType.ARRAY_BUFFER,r),this.buffer2D=new $t(this),this._vertexStride=t,this._bufferUsage=r}getFloat32Array(){return this.buffer2D._floatArray32}get _floatArray32(){return this.buffer2D._floatArray32}get _uint32Array(){return this.buffer2D._uint32Array}appendArray(e){var t=this._byteLength>>2;this.buffer2D.setByteLength(this._byteLength+4*e.length),this.getFloat32Array().set(e,t),this.buffer2D._upload=!0}deleteBuffer(){this.buffer2D._disposeResource()}_bindForVAO(){this._glBuffer.bindBuffer()}destroy(){super.destroy(),this._byteLength=0,this.buffer2D._upload=!0,this._buffer=null}}Jt.create=function(t,r=e.BufferUsage.Dynamic){return new Jt(t,r)};class er{constructor(t,i,s){this._stride=0,this.vertNum=0,this.indexNum=0,this._applied=!1,this._quadNum=0,this.canReuse=!1,this._stride=t,this._vb=new Jt(t,e.BufferUsage.Dynamic),i?this._vb.buffer2D._resizeBuffer(i,!1):r.webGL2D_MeshAllocMaxMem&&this._vb.buffer2D._resizeBuffer(65536*t,!1),this._ib=new Zt,s&&this._ib.buffer2D._resizeBuffer(s,!1)}createQuadIB(e){this._quadNum=e,this._ib.buffer2D._resizeBuffer(6*e*2,!1),this._ib.buffer2D.byteLength=this._ib.buffer2D.bufferLength;for(var t=this._ib.buffer2D._uint16Array,r=0,i=0,s=0;s<e;s++)t[r++]=i,t[r++]=i+2,t[r++]=i+1,t[r++]=i,t[r++]=i+3,t[r++]=i+2,i+=4;this._ib.buffer2D.setNeedUpload()}setAttributes(e){if(this._attribInfo=e,this._attribInfo.length%3!=0)throw"Mesh2D setAttributes error!"}configVAO(){this._applied||(this._applied=!0,this._vao||(this._vao=new jt),this._vao.applyState([this._vb],this._ib))}useMesh(){(this._vao&&!this._vao.isbind()||this._ib.buffer2D._upload||this._vb.buffer2D._upload)&&jt._curBindedBufferState&&jt._curBindedBufferState.unBind(),this._applied||this.configVAO(),this._ib.buffer2D._bind_upload(),this._vb.buffer2D._bind_upload(),this._vao.bind()}releaseMesh(){}destroy(){}clearVB(){this._vb.buffer2D.clear()}}er._gvaoid=0;class tr extends er{static __int__(){tr._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(tr.const_stride,4,4),this.canReuse=!0,this.setAttributes(tr._fixattriInfo),tr._fixib?(this._ib=tr._fixib,this._quadNum=tr._maxIB):(this.createQuadIB(tr._maxIB),tr._fixib=this._ib),tr.VertexDeclarition||(tr.VertexDeclarition=new ht(24,[new lt(0,ot.Vector4,0),new lt(16,ot.Byte4,1),new lt(20,ot.Byte4,2)])),this._vb.vertexDeclaration=tr.VertexDeclarition}static getAMesh(e){var t=null;return t=tr._POOL.length?tr._POOL.pop():new tr,e&&t._vb.buffer2D._resizeBuffer(65536*tr.const_stride,!1),t}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,tr._POOL.push(this)}destroy(){this._vb.destroy(),this._vb.deleteBuffer()}addQuad(e,t,r,i){var s=this._vb,a=s._byteLength>>2;s.buffer2D.setByteLength(a+tr.const_stride<<2);var n=s._floatArray32||s.getFloat32Array(),l=s._uint32Array,o=a,h=i?255:0;n[o++]=e[0],n[o++]=e[1],n[o++]=t[0],n[o++]=t[1],l[o++]=r,l[o++]=h,n[o++]=e[2],n[o++]=e[3],n[o++]=t[2],n[o++]=t[3],l[o++]=r,l[o++]=h,n[o++]=e[4],n[o++]=e[5],n[o++]=t[4],n[o++]=t[5],l[o++]=r,l[o++]=h,n[o++]=e[6],n[o++]=e[7],n[o++]=t[6],n[o++]=t[7],l[o++]=r,l[o++]=h,s.buffer2D._upload=!0}}tr.const_stride=24,tr._maxIB=16384,tr._POOL=[];class rr extends er{static __init__(){rr._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(rr.const_stride,4,4),this.canReuse=!0,this.setAttributes(rr._fixattriInfo),rr.VertexDeclarition||(rr.VertexDeclarition=new ht(24,[new lt(0,ot.Vector4,0),new lt(16,ot.Byte4,1),new lt(20,ot.Byte4,2)])),this._vb.vertexDeclaration=rr.VertexDeclarition}static getAMesh(e){var t;return t=rr._POOL.length?rr._POOL.pop():new rr,e&&t._vb.buffer2D._resizeBuffer(65536*rr.const_stride,!1),t}addData(e,t,r,i,s){var a=this._vb,n=this._ib,l=e.length>>1,o=a.buffer2D.needSize(l*rr.const_stride)>>2,h=a._floatArray32||a.getFloat32Array(),_=a._uint32Array,u=0,d=i.a,c=i.b,p=i.c,f=i.d,g=i.tx,m=i.ty,T=0;for(T=0;T<l;T++){var x=e[u],y=e[u+1];h[o]=x*d+y*p+g,h[o+1]=x*c+y*f+m,h[o+2]=t[u],h[o+3]=t[u+1],_[o+4]=s,_[o+5]=255,o+=6,u+=2}a.buffer2D.setNeedUpload();var E=this.vertNum,S=r.length,b=n.buffer2D.needSize(r.byteLength),v=n.buffer2D._uint16Array,R=b>>1;if(E>0){var A=R+S,C=0;for(T=R;T<A;T++,C++)v[T]=r[C]+E}else v.set(r,R);n.buffer2D.setNeedUpload(),this.vertNum+=l,this.indexNum+=r.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,rr._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}rr.const_stride=24,rr._POOL=[];class ir extends er{static __init__(){ir._fixattriInfo=[5126,2,0,5121,4,8]}constructor(){super(ir.const_stride,4,4),this.canReuse=!0,this.setAttributes(ir._fixattriInfo),ir.vertexDeclaration||(ir.vertexDeclaration=new ht(12,[new lt(0,ot.Vector2,0),new lt(8,ot.Byte4,1)])),this._vb.vertexDeclaration=ir.vertexDeclaration}static getAMesh(e){var t;return t=ir._POOL.length?ir._POOL.pop():new ir,e&&t._vb.buffer2D._resizeBuffer(65536*ir.const_stride,!1),t}addVertAndIBToMesh(e,t,r,i){for(var s=this._vb.buffer2D.needSize(t.length/2*ir.const_stride)>>2,a=this._vb._floatArray32||this._vb.getFloat32Array(),n=this._vb._uint32Array,l=0,o=t.length/2,h=0;h<o;h++)a[s++]=t[l],a[s++]=t[l+1],l+=2,n[s++]=r;this._vb.buffer2D.setNeedUpload(),this._ib.buffer2D.append(new Uint16Array(i)),this._ib.buffer2D.setNeedUpload(),this.vertNum+=o,this.indexNum+=i.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,ir._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}ir.const_stride=12,ir._POOL=[],ir.vertexDeclaration=null;class sr{constructor(e,t){this._context=e,this._nativeObj=new window._conchWebGLCacheAsNormalCanvas(e._nativeObj,0)}startRec(){this._nativeObj.startRec()}endRec(){this._nativeObj.endRec()}isCacheValid(){return this._nativeObj.isCacheValid()}isTextNeedRestore(){return this._nativeObj.isTextNeedRestore()}get context(){return this._context}}class ar{constructor(e,t){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new p,this.oldTx=0,this.oldTy=0,this.invMat=new p,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e)),e._incache=!0,this.touches.length=0,e.touches=this.touches,e._globalClipMatrix.copyTo(this.cachedClipInfo),this.submits.length=0,this.submitStartPos=e._submits._length;for(var t=0,r=this.meshlist.length;t<r;t++){var i=this.meshlist[t];i.canReuse?i.releaseMesh():i.destroy()}this.meshlist.length=0,this._mesh=tr.getAMesh(!1),this._pathMesh=ir.getAMesh(!1),this._triangleMesh=rr.getAMesh(!1),this.meshlist.push(this._mesh),this.meshlist.push(this._pathMesh),this.meshlist.push(this._triangleMesh),e._curSubmit=Yt.RENDERBASE,this._oldMesh=e._mesh,this._oldPathMesh=e._pathMesh,this._oldTriMesh=e._triangleMesh,this._oldMeshList=e.meshlist,e._mesh=this._mesh,e._pathMesh=this._pathMesh,e._triangleMesh=this._triangleMesh,e.meshlist=this.meshlist,this.oldTx=e._curMat.tx,this.oldTy=e._curMat.ty,e._curMat.tx=0,e._curMat.ty=0,e._curMat.copyTo(this.invMat),this.invMat.invert()}endRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e));var t=e._submits;this.submitEndPos=t._length;for(var r=this.submitEndPos-this.submitStartPos,i=0;i<r;i++)this.submits.push(t[this.submitStartPos+i]);t._length-=r,e._mesh=this._oldMesh,e._pathMesh=this._oldPathMesh,e._triangleMesh=this._oldTriMesh,e.meshlist=this._oldMeshList,e._curSubmit=Yt.RENDERBASE,e._curMat.tx=this.oldTx,e._curMat.ty=this.oldTy,e.touches=null,e._incache=!1}isCacheValid(){var e=this.context._globalClipMatrix;return e.a==this.cachedClipInfo.a&&e.b==this.cachedClipInfo.b&&e.c==this.cachedClipInfo.c&&e.d==this.cachedClipInfo.d&&e.tx==this.cachedClipInfo.tx&&e.ty==this.cachedClipInfo.ty}isTextNeedRestore(){var e=!1,t=this.touches;if(t)for(var r=0;r<t.length;r++)if(t[r].deleted){e=!0;break}return e}flushsubmit(){var e=Yt.RENDERBASE;this.submits.forEach((function(t){t!=Yt.RENDERBASE&&(Yt.preRender=e,e=t,t.renderSubmit())}))}releaseMem(){}}ar.matI=new p,window.conch&&!window.conchConfig.conchWebGL&&(ar=sr);class nr{static __init__(){nr.map[Gt.ALPHA|Gt.TRANSFORM|Gt.GRAPHICS]=nr.alpha_transform_drawLayaGL,nr.map[Gt.ALPHA|Gt.GRAPHICS]=nr.alpha_drawLayaGL,nr.map[Gt.TRANSFORM|Gt.GRAPHICS]=nr.transform_drawLayaGL,nr.map[Gt.TRANSFORM|Gt.CHILDS]=nr.transform_drawNodes,nr.map[Gt.ALPHA|Gt.TRANSFORM|Gt.TEXTURE]=nr.alpha_transform_drawTexture,nr.map[Gt.ALPHA|Gt.TEXTURE]=nr.alpha_drawTexture,nr.map[Gt.TRANSFORM|Gt.TEXTURE]=nr.transform_drawTexture,nr.map[Gt.GRAPHICS|Gt.CHILDS]=nr.drawLayaGL_drawNodes}static transform_drawTexture(e,t,r,i){e._style;var a=e.texture;t.saveTransform(nr.curMat),t.transformByMatrix(e.transform,r,i);var n=e._isWidthSet?e._width:a.sourceWidth,l=e._isHeightSet?e._height:a.sourceHeight,o=n/a.sourceWidth,h=l/a.sourceHeight;if(n=a.width*o,l=a.height*h,n<=0||l<=0)return null;var _=-e.pivotX+a.offsetX*o,u=-e.pivotY+a.offsetY*h;e._getBit(s.HIDE_BY_EDITOR)||t.drawTexture(a,_,u,n,l),t.restoreTransform(nr.curMat)}static alpha_drawTexture(e,t,r,i){var a,n=e._style,l=e.texture;if((a=n.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=a;var h=e._isWidthSet?e._width:l.sourceWidth,_=e._isHeightSet?e._height:l.sourceHeight,u=h/l.sourceWidth,d=_/l.sourceHeight;if(h=l.width*u,_=l.height*d,h<=0||_<=0)return null;var c=r-n.pivotX+l.offsetX*u,p=i-n.pivotY+l.offsetY*d;e._getBit(s.HIDE_BY_EDITOR)||t.drawTexture(l,c,p,h,_),t.globalAlpha=o}}static alpha_transform_drawTexture(e,t,r,i){var a,n=e._style,l=e.texture;if((a=n.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=a,t.saveTransform(nr.curMat),t.transformByMatrix(e.transform,r,i);var h=e._isWidthSet?e._width:l.sourceWidth,_=e._isHeightSet?e._height:l.sourceHeight,u=h/l.sourceWidth,d=_/l.sourceHeight;if(h=l.width*u,_=l.height*d,h<=0||_<=0)return null;var c=-n.pivotX+l.offsetX*u,p=-n.pivotY+l.offsetY*d;e._getBit(s.HIDE_BY_EDITOR)||t.drawTexture(l,c,p,h,_),t.restoreTransform(nr.curMat),t.globalAlpha=o}}static alpha_transform_drawLayaGL(e,t,r,i){var a,n=e._style;if((a=n.alpha)>.01||e._needRepaint()){var l=t.globalAlpha;t.globalAlpha*=a,t.saveTransform(nr.curMat),t.transformByMatrix(e.transform,r,i),e._getBit(s.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-n.pivotX,-n.pivotY),t.restoreTransform(nr.curMat),t.globalAlpha=l}}static alpha_drawLayaGL(e,t,r,i){var a,n=e._style;if((a=n.alpha)>.01||e._needRepaint()){var l=t.globalAlpha;t.globalAlpha*=a,e._getBit(s.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r-n.pivotX,i-n.pivotY),t.globalAlpha=l}}static transform_drawLayaGL(e,t,r,i){var a=e._style;t.saveTransform(nr.curMat),t.transformByMatrix(e.transform,r,i),e._getBit(s.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-a.pivotX,-a.pivotY),t.restoreTransform(nr.curMat)}static transform_drawNodes(e,t,r,i){var a=e._getBit(s.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let n=t._drawingToTexture;var l=e._style;t.saveTransform(nr.curMat),t.transformByMatrix(e.transform,r,i),r=-l.pivotX,i=-l.pivotY;var o=e._children,h=o.length;let _,u,d,c,p,f,g;l.viewport&&(_=l.viewport,u=_.x,d=_.y,c=_.right,p=_.bottom);for(let e=0;e<h;++e){let a,l=o[e];a=n?l._visible&&!l._getBit(s.ESCAPE_DRAWING_TO_TEXTURE):l._visible||l._getBit(s.DISABLE_VISIBILITY),_&&((f=l._x)>=c||f+l.width<=u||(g=l._y)>=p||g+l.height<=d)&&(a=!1),a&&l.render(t,r,i)}t.restoreTransform(nr.curMat),a&&t.drawCallOptimize(!1)}static drawLayaGL_drawNodes(e,t,r,i){var a=e._getBit(s.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let n=t._drawingToTexture;var l=e._style;r-=l.pivotX,i-=l.pivotY,e._getBit(s.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r,i);var o=e._children,h=o.length;let _,u,d,c,p,f,g;l.viewport&&(_=l.viewport,u=_.x,d=_.y,c=_.right,p=_.bottom);for(let e=0;e<h;++e){let a,l=o[e];a=n?l._visible&&!l._getBit(s.ESCAPE_DRAWING_TO_TEXTURE):l._visible||l._getBit(s.DISABLE_VISIBILITY),_&&((f=l._x)>=c||f+l.width<=u||(g=l._y)>=p||g+l.height<=d)&&(a=!1),a&&l.render(t,r,i)}a&&t.drawCallOptimize(!1)}}nr.map=[],nr.curMat=new p;class lr{constructor(){}get type(){return-1}}lr.BLUR=16,lr.COLOR=32,lr.GLOW=8,lr._filter=function(t,r,i,s){var a=r,n=this._next;if(n){var l=t.filters,o=l.length;if(1==o&&l[0].type==lr.COLOR)return r.save(),r.setColorFilter(l[0]),n._fun.call(n,t,r,i,s),void r.restore();var h,_=Dt.create(e.RenderSpriteData.Texture2D),u=f.TEMP,d=a._curMat,c=p.create();d.copyTo(c);var m=0,T=0,y=null,E=t._cacheStyle.filterCache||null;if(E&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(m=50,T=25),(h=t.getBounds()).width<=0||h.height<=0)return;h.width+=m+8,h.height+=m+8,h.x-=t.pivotX+4,h.y-=t.pivotY+4,u.x=h.x*c.a+h.y*c.c,u.y=h.y*c.d+h.x*c.b,h.x=u.x,h.y=u.y,u.x=h.width*c.a+h.height*c.c,u.y=h.height*c.d+h.width*c.b,h.width=u.x,h.height=u.y}else{t._isHaveGlowFilter()&&(m=50,T=25),(h=new g).copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var S=h.x,b=h.y;if(h.width+=m+8,h.height+=m+8,u.x=h.x*c.a+h.y*c.c,u.y=h.y*c.d+h.x*c.b,h.x=u.x,h.y=u.y,u.x=h.width*c.a+h.height*c.c,u.y=h.height*c.d+h.width*c.b,h.width=u.x,h.height=u.y,h.width<=0||h.height<=0)return;E&&E.destroy(),y=new window.conchRenderTexture2D(x.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);var v=E=new window.conchRenderTexture2D(x.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);t._getCacheStyle().filterCache=E,a.pushRT(),a.useRT(y);var R=t.x-S+T,A=t.y-b+T;n._fun.call(n,t,r,R,A),a.useRT(v);for(var C=0;C<o;C++){0!=C&&(a.useRT(y),a.drawTarget(v,0,0,h.width,h.height,p.TEMP.identity(),_,null,re.TOINT.overlay),a.useRT(v));var D=l[C];switch(D.type){case lr.BLUR:a.drawTargetBlurFilter(y,0,0,h.width,h.height,D.strength);break;case lr.GLOW:D._glRender&&D._glRender.render(y,r,h.width,h.height,D);break;case lr.COLOR:a.setColorFilter(D),a.drawTarget(y,0,0,h.width,h.height,p.EMPTY.identity(),Dt.create(e.RenderSpriteData.Texture2D)),a.setColorFilter(null)}}a.popRT()}i=i-T-t.x,s=s-T-t.y,u.setTo(i,s),c.transformPoint(u),i=u.x+h.x,s=u.y+h.y,a.drawFilter(E,y,i,s,h.width,h.height),c.destroy()}};class or{static __init__(){var e,t,r;for(nr.__init__(),r=new or(69905,null),t=or.renders.length=2*Gt.CHILDS,e=0;e<t;e++)or.renders[e]=r;or.renders[0]=new or(0,null)}static _initRenderFun(e,t,r,i){var s=e._renderType;(or.renders[s]=or._getTypeRender(s))._fun(e,t,r,i)}static _getTypeRender(e){if(nr.map[e]&&l.isPlaying)return new or(e,null);for(var t=null,r=Gt.CHILDS;r>0;)r&e&&(t=new or(r,t)),r>>=1;return t}constructor(e,t){if(nr.map[e]&&l.isPlaying)return this._fun=nr.map[e],void(this._next=or.NORENDER);switch(this._next=t||or.NORENDER,e){case 0:return void(this._fun=this._no);case Gt.ALPHA:return void(this._fun=this._alpha);case Gt.TRANSFORM:return void(this._fun=this._transform);case Gt.BLEND:return void(this._fun=this._blend);case Gt.CANVAS:return void(this._fun=this._canvas);case Gt.MASK:return void(l.isConch&&!window.conchConfig.conchWebGL?this._fun=this._maskNative:this._fun=this._mask);case Gt.CLIP:return void(this._fun=this._clip);case Gt.STYLE:return void(this._fun=this._style);case Gt.GRAPHICS:return void(this._fun=this._graphics);case Gt.CHILDS:return void(this._fun=this._children);case Gt.CUSTOM:return void(this._fun=this._custom);case Gt.TEXTURE:return void(this._fun=this._texture);case Gt.FILTERS:return void(l.isConch&&!window.conchConfig.conchWebGL?this._fun=lr._filter:this._fun=It._filter);case Gt.HITAREA:return void(this._fun=this._hitarea);case 69905:return void(this._fun=or._initRenderFun)}this.onCreate(e)}onCreate(e){}_style(e,t,r,i){}_no(e,t,r,i){}_custom(e,t,r,i){e.customRender(t,r,i),this._next._fun.call(this._next,e,t,0,0)}_clip(e,t,r,i){let a=this._next;if(a==or.NORENDER)return;if(e._getBit(s.DISABLE_INNER_CLIPPING)&&!t._drawingToTexture)return void a._fun.call(a,e,t,r,i);let n=e._style.scrollRect,l=n.width,o=n.height;0===l&&(l=.001),0===o&&(o=.001),t.save(),t.clipRect(r,i,l,o),a._fun.call(a,e,t,r-n.x,i-n.y),t.restore()}_texture(e,t,r,i){if(!e._getBit(s.HIDE_BY_EDITOR)){var a=e.texture;if(a._getSource()){var n=e._isWidthSet?e._width:a.sourceWidth,l=e._isHeightSet?e._height:a.sourceHeight,o=n/a.sourceWidth,h=l/a.sourceHeight;if(n=a.width*o,l=a.height*h,n>0&&l>0){let s=r-e.pivotX+a.offsetX*o,_=i-e.pivotY+a.offsetY*h;t.material=e.graphics.material,t.drawTexture(a,s,_,n,l,4294967295),t.material=null}}}var _=this._next;_!=or.NORENDER&&_._fun.call(_,e,t,r,i)}_graphics(e,t,r,i){if(!e._getBit(s.HIDE_BY_EDITOR)){var a=e._style,n=e._graphics;n&&n._render(e,t,r-a.pivotX,i-a.pivotY)}var l=this._next;l!=or.NORENDER&&l._fun.call(l,e,t,r,i)}_hitarea(e,t,r,i){if(!t._drawingToTexture&&e.hitArea){var s=e._style,a=e.hitArea._hit,n=t.globalAlpha;t.globalAlpha*=.5,a&&a._render(e,t,r-s.pivotX,i-s.pivotY),(a=e.hitArea._unHit)&&a._render(e,t,r-s.pivotX,i-s.pivotY),t.globalAlpha=n}var l=this._next;l!=or.NORENDER&&l._fun.call(l,e,t,r,i)}_alpha(e,t,r,i){var s;if((s=e._style.alpha)>.01||e._needRepaint()){var a=t.globalAlpha;t.globalAlpha*=s;var n=this._next;n._fun.call(n,e,t,r,i),t.globalAlpha=a}}_transform(e,t,r,i){var s=e.transform,a=this._next;s&&a!=or.NORENDER?(t.save(),t.transform(s.a,s.b,s.c,s.d,s.tx+r,s.ty+i),a._fun.call(a,e,t,0,0),t.restore()):a!=or.NORENDER&&a._fun.call(a,e,t,r,i)}_children(e,t,r,i){let a=e._style,n=e._children,l=n.length;r-=e.pivotX,i-=e.pivotY;let o,h,_,u,d,c,p,f=e._getBit(s.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),g=t._drawingToTexture;a.viewport&&(o=a.viewport,h=o.x,_=o.y,u=o.right,d=o.bottom);for(let a=0;a<l;++a){let l,f=n[a];l=g?f._visible&&!f._getBit(s.ESCAPE_DRAWING_TO_TEXTURE):f._visible||f._getBit(s.DISABLE_VISIBILITY),l&&(o&&((c=f._x)>=u||c+f.width<=h||(p=f._y)>=d||p+f.height<=_)?l=!1:e._cacheStyle.mask!=f||f._getBit(s.DISABLE_VISIBILITY)||(l=!1)),l&&(f._getBit(s.DISABLE_OUTER_CLIPPING)&&t.clipRect(0,0,1,1,!0),f.render(t,r,i))}f&&t.drawCallOptimize(!1)}_canvas(e,t,r,i){var a=e._cacheStyle,l=this._next;if(!a.enableCanvasRender||!t._drawingToTexture&&a.mask&&a.mask._getBit(s.DISABLE_VISIBILITY))l._fun.call(l,e,t,r,i);else{"bitmap"===a.cacheAs?Xt.canvasBitmap++:Xt.canvasNormal++;var o=!1,h=!1;if(a.canvas){var _=a.canvas;h=_.isTextNeedRestore&&_.isTextNeedRestore(),o=_.isCacheValid&&!_.isCacheValid()}if(e._needRepaint()||!a.canvas||h||o||n.stage.isGlobalRepaint())if("normal"===a.cacheAs){if(t._targets)return void l._fun.call(l,e,t,r,i);this._canvas_webgl_normal_repaint(e,t)}else this._canvas_repaint(e,t,r,i);var u=a.cacheRect;t.material=e.graphics.material,t.drawCanvas(a.canvas,r+u.x,i+u.y,u.width,u.height),t.material=null}}_canvas_repaint(e,t,r,i){var s,a,n,l,o,h,_,u,d,c=e._cacheStyle,p=this._next,f=c.canvas,g=c.cacheAs;if(_=(d=c._calculateCacheRect(e,g,r,i)).x,u=d.y,o=(l=c.cacheRect).width*_,h=l.height*u,a=l.x,n=l.y,"bitmap"===g&&(o>2048||h>2048))return console.warn("cache bitmap size larger than 2048, cache ignored"),c.releaseContext(),void p._fun.call(p,e,t,r,i);if(f||(c.createContext(),f=c.canvas),(s=f.context).sprite=e,(f.width!=o||f.height!=h)&&f.size(o,h),"bitmap"===g?s.asBitmap=!0:"normal"===g&&(s.asBitmap=!1),s.clear(),1!=_||1!=u){var m=s;m.save(),m.scale(_,u),p._fun.call(p,e,s,-a,-n),m.restore(),e._applyFilters()}else m=s,p._fun.call(p,e,s,-a,-n),e._applyFilters();c.staticCache&&(c.reCache=!1),Xt.canvasReCache++}_canvas_webgl_normal_repaint(e,t){var r=e._cacheStyle,i=this._next,s=r.canvas,a=r.cacheAs;r._calculateCacheRect(e,a,0,0),s||(s=new ar(t,e),r.canvas=s);var n=s.context;s.startRec(),i._fun.call(i,e,n,e.pivotX,e.pivotY),e._applyFilters(),Xt.canvasReCache++,s.endRec()}_blend(e,t,r,i){var s=e._style,a=this._next;s.blendMode?(t.save(),t.globalCompositeOperation=s.blendMode,a._fun.call(a,e,t,r,i),t.restore()):a._fun.call(a,e,t,r,i)}_mask(t,r,i,a){let n=this._next,l=t.mask;if(!l||l._getBit(s.DISABLE_VISIBILITY)&&!r._drawingToTexture)n._fun.call(n,t,r,i,a);else{r.save();let s=r.globalCompositeOperation,o=new g;o.copyFrom(l.getBounds());let h=o.width=Math.round(o.width),_=o.height=Math.round(o.height);if(o.x=Math.round(o.x),o.y=Math.round(o.y),h>0&&_>0){let u=ee.getRT(h,_);r.breakNextMerge(),r.pushRT(),r.addRenderObject(wt.create([r,u,h,_],or.tmpTarget,this)),l.render(r,-o.x,-o.y),r.breakNextMerge(),r.popRT(),r.save();let d=.1;r.clipRect(i+o.x-t.getStyle().pivotX+d,a+o.y-t.getStyle().pivotY+d,h-2*d,_-2*d),n._fun.call(n,t,r,i,a),r.restore(),s=r.globalCompositeOperation,r.addRenderObject(wt.create(["mask"],or.setBlendMode,this));let c=Dt.create(e.RenderSpriteData.Texture2D),f=ae.INV_UV;r.drawTarget(u,i+o.x-t.getStyle().pivotX,a+o.y-t.getStyle().pivotY,h,_,p.TEMP.identity(),c,f,6),r.addRenderObject(wt.create([u],or.recycleTarget,this))}r.addRenderObject(wt.create([s],or.setBlendMode,this)),r.restore()}}_maskNative(e,t,r,i){var s=this._next,a=e.mask;if(a){t.save(),t.globalCompositeOperation;var n=new g;n.copyFrom(a.getBounds());let l=n.width=Math.round(n.width),o=n.height=Math.round(n.height);if(n.x=Math.round(n.x),n.y=Math.round(n.y),l>0&&o>0){let h=t.drawMask(l,o);a.render(t,-n.x,-n.y);let _=.1;t.drawMasked(r+n.x-e.getStyle().pivotX+_,i+n.y-e.getStyle().pivotY+_,l-2*_,o-2*_),s._fun.call(s,e,t,r,i),t.drawMaskComposite(h,r+n.x-e.getStyle().pivotX,i+n.y-e.getStyle().pivotY,l,o)}t.restore()}else s._fun.call(s,e,t,r,i)}static tmpTarget(e,t,r,i){t.start(),t.clear(0,0,0,0)}static recycleTarget(e){ee.releaseRT(e)}static setBlendMode(e){re.targetFns[re.TOINT[e]]()}}or.renders=[],or.NORENDER=new or(0,null);class hr{constructor(){this._controlPoints=[new f,new f,new f],this._calFun=this.getPoint2}_switchPoint(e,t){var r=this._controlPoints.shift();r.setTo(e,t),this._controlPoints.push(r)}getPoint2(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],s=this._controlPoints[2],a=Math.pow(1-e,2)*r.x+2*e*(1-e)*i.x+Math.pow(e,2)*s.x,n=Math.pow(1-e,2)*r.y+2*e*(1-e)*i.y+Math.pow(e,2)*s.y;t.push(a,n)}getPoint3(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],s=this._controlPoints[2],a=this._controlPoints[3],n=Math.pow(1-e,3)*r.x+3*i.x*e*(1-e)*(1-e)+3*s.x*e*e*(1-e)+a.x*Math.pow(e,3),l=Math.pow(1-e,3)*r.y+3*i.y*e*(1-e)*(1-e)+3*s.y*e*e*(1-e)+a.y*Math.pow(e,3);t.push(n,l)}insertPoints(e,t){var r,i;for(i=1/(e=e>0?e:5),r=0;r<=1;r+=i)this._calFun(r,t)}getBezierPoints(e,t=5,r=2){var i,s;if((s=e.length)<2*(r+1))return[];var a=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(f.create());for(i=0;i<2*r;i+=2)this._switchPoint(e[i],e[i+1]);for(i=2*r;i<s;i+=2)this._switchPoint(e[i],e[i+1]),i/2%r==0&&this.insertPoints(t,a);return a}}var _r;hr.I=new hr,e.RenderStateType=void 0,(_r=e.RenderStateType||(e.RenderStateType={}))[_r.DepthTest=0]="DepthTest",_r[_r.DepthMask=1]="DepthMask",_r[_r.DepthFunc=2]="DepthFunc",_r[_r.StencilTest=3]="StencilTest",_r[_r.StencilMask=4]="StencilMask",_r[_r.StencilFunc=5]="StencilFunc",_r[_r.StencilOp=6]="StencilOp",_r[_r.BlendType=7]="BlendType",_r[_r.BlendEquation=8]="BlendEquation",_r[_r.BlendEquationSeparate=9]="BlendEquationSeparate",_r[_r.BlendFunc=10]="BlendFunc",_r[_r.BlendFuncSeperate=11]="BlendFuncSeperate",_r[_r.CullFace=12]="CullFace",_r[_r.FrontFace=13]="FrontFace";class ur{static create(e){if(e){var t=e instanceof Bt?e:Bt.create(e);return t._drawStyle||(t._drawStyle=new ur(e))}return ur.DEFAULT}constructor(e){this.setValue(e)}setValue(e){this._color=e?e instanceof Bt?e:Bt.create(e):Bt.create("#000000")}reset(){this._color=Bt.create("#000000")}toInt(){return this._color.numColor}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof Bt&&this._color.numColor===e.numColor}toColorStr(){return this._color.strColor}}ur.DEFAULT=new ur("#000000");class dr{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new cr,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new cr,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new cr,this.paths.push(this._curPath)):(this._curPath=new cr,this.paths.push(this._curPath));var r=this._curPath;r.path=e.slice(),r.convex=t}reset(){this.paths.length=0}}class cr{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class pr{static _createArray(){var e=[];return e._length=0,e}static _init(){var e=pr._namemap={};return e[pr.TYPE_ALPHA]="ALPHA",e[pr.TYPE_FILESTYLE]="fillStyle",e[pr.TYPE_FONT]="font",e[pr.TYPE_LINEWIDTH]="lineWidth",e[pr.TYPE_STROKESTYLE]="strokeStyle",e[pr.TYPE_ENABLEMERGE]="_mergeID",e[pr.TYPE_MARK]=e[pr.TYPE_TRANSFORM]=e[pr.TYPE_TRANSLATE]=[],e[pr.TYPE_TEXTBASELINE]="textBaseline",e[pr.TYPE_TEXTALIGN]="textAlign",e[pr.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[pr.TYPE_SHADER]="shader",e[pr.TYPE_FILTERS]="filters",e[pr.TYPE_COLORFILTER]="_colorFiler",e}constructor(){}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,pr.POOL[pr.POOL._length++]=this,this._newSubmit&&(e._curSubmit=Yt.RENDERBASE)}static save(e,t,r,i){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var s=pr.POOL,a=s._length>0?s[--s._length]:new pr;a._value=r[a._valueName=pr._namemap[t]],a._dataObj=r,a._newSubmit=i;var n=e._save;n[n._length++]=a}}}pr.TYPE_ALPHA=1,pr.TYPE_FILESTYLE=2,pr.TYPE_FONT=8,pr.TYPE_LINEWIDTH=256,pr.TYPE_STROKESTYLE=512,pr.TYPE_MARK=1024,pr.TYPE_TRANSFORM=2048,pr.TYPE_TRANSLATE=4096,pr.TYPE_ENABLEMERGE=8192,pr.TYPE_TEXTBASELINE=16384,pr.TYPE_TEXTALIGN=32768,pr.TYPE_GLOBALCOMPOSITEOPERATION=65536,pr.TYPE_CLIPRECT=131072,pr.TYPE_CLIPRECT_STENCIL=262144,pr.TYPE_IBVB=524288,pr.TYPE_SHADER=1048576,pr.TYPE_FILTERS=2097152,pr.TYPE_FILTERS_TYPE=4194304,pr.TYPE_COLORFILTER=8388608,pr.POOL=pr._createArray(),pr._namemap=pr._init();class fr{constructor(){this._globalClipMatrix=new p,this._clipInfoID=-1,this._clipRect=new g,this.incache=!1}isSaveMark(){return!1}restore(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,fr.POOL[fr.POOL._length++]=this,e._clipInCache=this.incache}static save(e){if((e._saveMark._saveuse&pr.TYPE_CLIPRECT)!=pr.TYPE_CLIPRECT){e._saveMark._saveuse|=pr.TYPE_CLIPRECT;var t=fr.POOL,r=t._length>0?t[--t._length]:new fr;e._globalClipMatrix.copyTo(r._globalClipMatrix),e._clipRect.clone(r._clipRect),r._clipInfoID=e._clipInfoID,r.incache=e._clipInCache;var i=e._save;i[i._length++]=r}}}fr.POOL=pr._createArray();class gr{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,gr.POOL[gr.POOL._length++]=this}static Create(e){var t=gr.POOL,r=t._length>0?t[--t._length]:new gr;return r._saveuse=0,r._preSaveMark=e._saveMark,e._saveMark=r,r}}gr.POOL=pr._createArray();class mr{constructor(){this._matrix=new p}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,mr.POOL[mr.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&pr.TYPE_TRANSFORM)!==pr.TYPE_TRANSFORM){t._saveuse|=pr.TYPE_TRANSFORM;var r=mr.POOL,i=r._length>0?r[--r._length]:new mr;i._savematrix=e._curMat,e._curMat=e._curMat.copyTo(i._matrix);var s=e._save;s[s._length++]=i}}}mr.POOL=pr._createArray();class Tr{constructor(){this._mat=new p}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),Tr.POOL[Tr.POOL._length++]=this}static save(e){var t=Tr.POOL,r=t._length>0?t[--t._length]:new Tr;e._curMat.copyTo(r._mat);var i=e._save;i[i._length++]=r}}Tr.POOL=pr._createArray();class xr{constructor(){this.ALPHA=1,this.shaderType=0,this.fillStyle=ur.DEFAULT,this.strokeStyle=ur.DEFAULT,this.material=null}destroy(){this.filters=null}static __init__(){dt.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value)\r\n{\r\n    return pow((value + 0.055) / 1.055, vec3(2.4));\r\n}\r\n\r\nvec4 gammaToLinear(in vec4 value)\r\n{\r\n    return vec4(gammaToLinear(value.rgb), value.a);\r\n}\r\n\r\nvec3 linearToGamma(in vec3 value)\r\n{\r\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\r\n\r\n    // return pow(value, vec3(1.0 / 2.2));\r\n    // return pow(value, vec3(0.455));\r\n}\r\n\r\nvec4 linearToGamma(in vec4 value)\r\n{\r\n    return vec4(linearToGamma(value.rgb), value.a);\r\n}\r\n\r\nvec4 sampleTexture(sampler2D spriteTexture, vec2 uv)\r\n{\r\n    vec4 color = texture2D(spriteTexture, uv);\r\n#ifndef GAMMATEXTURE\r\n    //是linear数据\r\n    #ifdef GAMMASPACE\r\n        color.xyz = linearToGamma(color.xyz);    \r\n    #endif\r\n#else\r\n    //gamma数据\r\n    #ifndef GAMMASPACE\r\n        color.xyz = gammaToLinear(color.xyz);\r\n    #endif\r\n#endif\r\n    return color;\r\n}\r\n\r\n#if defined(PRIMITIVEMESH)\r\n    varying vec4 v_color;\r\n    varying vec2 v_cliped;\r\n  \r\n\r\n    vec4 getGlColor(vec4 color){\r\n        #ifdef GAMMASPACE\r\n            return color;\r\n        #else\r\n            return gammaToLinear(color);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n    varying vec2 v_cliped;\r\n    varying vec4 v_texcoordAlpha;\r\n    varying vec4 v_color;\r\n    varying float v_useTex;\r\n    \r\n    //uniform\r\n    uniform sampler2D u_spriteTexture;\r\n\r\n    #ifdef BLUR_FILTER\r\n        uniform vec4 u_strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\r\n        uniform vec2 u_blurInfo;\r\n        #define PI 3.141593\r\n    #endif\r\n\r\n    #ifdef COLOR_FILTER\r\n        uniform vec4 u_colorAlpha;\r\n        uniform mat4 u_colorMat;\r\n    #endif\r\n\r\n    #ifdef GLOW_FILTER\r\n        uniform vec4 u_color;\r\n        uniform vec4 u_blurInfo1;\r\n        uniform vec4 u_blurInfo2;\r\n    #endif\r\n\r\n    #ifdef COLOR_ADD\r\n        uniform vec4 u_colorAdd;\r\n    #endif\r\n\r\n    #ifdef FILLTEXTURE\r\n        uniform vec4 u_TexRange; // startu,startv,urange, vrange\r\n    #endif\r\n\r\n\r\n    #ifdef BLUR_FILTER\r\n        float getGaussian(float x, float y)\r\n        {\r\n            return u_strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / u_strength_sig2_2sig2_gauss1.z);\r\n        }\r\n\r\n        vec4 blur()\r\n        {\r\n            const float blurw = 9.0;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 halfsz = vec2(blurw, blurw) / 2.0 / u_blurInfo;\r\n            vec2 startpos = v_texcoordAlpha.xy - halfsz;\r\n            vec2 ctexcoord = startpos;\r\n            vec2 step = 1.0 / u_blurInfo; //每个像素\r\n\r\n            for (float y = 0.0; y <= blurw; ++y)\r\n            {\r\n                ctexcoord.x = startpos.x;\r\n                for (float x = 0.0; x <= blurw; ++x)\r\n                {\r\n                    // TODO 纹理坐标的固定偏移应该在vs中处理\r\n                    vec4Color += sampleTexture(u_spriteTexture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0);\r\n                    ctexcoord.x += step.x;\r\n                }\r\n                ctexcoord.y += step.y;\r\n            }\r\n            // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\r\n            return vec4Color;\r\n        }\r\n    #endif\r\n\r\n    vec4 getSpriteTextureColor(){\r\n        #ifdef FILLTEXTURE\r\n            return sampleTexture(u_spriteTexture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\r\n        #else\r\n            return sampleTexture(u_spriteTexture, v_texcoordAlpha.xy);\r\n        #endif\r\n    }\r\n\r\n    void setglColor(in vec4 color){\r\n        if (v_useTex <= 0.)\r\n            color = vec4(1., 1., 1., 1.);\r\n\r\n        color.a *= v_color.w;\r\n        // color.rgb*=v_color.w;\r\n        vec4 transColor = v_color;\r\n        #ifndef GAMMASPACE\r\n            transColor = gammaToLinear(v_color);\r\n        #endif\r\n        color.rgb *= transColor.rgb;\r\n        gl_FragColor = color;\r\n\r\n        #ifdef COLOR_ADD\r\n            gl_FragColor = vec4(u_colorAdd.rgb, u_colorAdd.a * gl_FragColor.a);\r\n            gl_FragColor.xyz *= u_colorAdd.a;\r\n        #endif\r\n\r\n        #ifdef BLUR_FILTER\r\n            gl_FragColor = blur();\r\n            gl_FragColor.w *= v_color.w;\r\n        #endif\r\n\r\n        #ifdef COLOR_FILTER\r\n            mat4 alphaMat = u_colorMat;\r\n\r\n            alphaMat[0][3] *= gl_FragColor.a;\r\n            alphaMat[1][3] *= gl_FragColor.a;\r\n            alphaMat[2][3] *= gl_FragColor.a;\r\n\r\n            gl_FragColor = gl_FragColor * alphaMat;\r\n            gl_FragColor += u_colorAlpha / 255.0 * gl_FragColor.a;\r\n        #endif\r\n\r\n        #ifdef GLOW_FILTER\r\n            const float c_IterationTime = 10.0;\r\n            float floatIterationTotalTime = c_IterationTime * c_IterationTime;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 vec2FilterDir = vec2(-(u_blurInfo1.z) / u_blurInfo2.x, -(u_blurInfo1.w) / u_blurInfo2.y);\r\n            vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\r\n            float maxNum = u_blurInfo1.x * u_blurInfo1.y;\r\n            vec2 vec2Off = vec2(0.0, 0.0);\r\n            float floatOff = c_IterationTime / 2.0;\r\n            for (float i = 0.0; i <= c_IterationTime; ++i)\r\n            {\r\n                for (float j = 0.0; j <= c_IterationTime; ++j)\r\n                {\r\n                    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\r\n                    vec4Color += sampleTexture(u_spriteTexture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off) / floatIterationTotalTime;\r\n                }\r\n            }\r\n            gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\r\n            gl_FragColor.rgb *= gl_FragColor.a;\r\n        #endif\r\n    }\r\n#endif\r\n\r\n\r\n\r\nvoid clip(){\r\n    if(v_cliped.x<0.) discard;\r\n    if(v_cliped.x>1.) discard;\r\n    if(v_cliped.y<0.) discard;\r\n    if(v_cliped.y>1.) discard;\r\n}"),dt.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\r\n#if defined(PRIMITIVEMESH)\r\n    // attribute vec4 a_position;\r\n    // attribute vec4 a_attribColor;\r\n    #ifdef WORLDMAT\r\n        uniform mat4 u_mmat;\r\n    #endif//WORLDMAT\r\n\r\n    varying vec4 v_color;\r\n    varying vec2 v_cliped;\r\n\r\n    uniform vec4 u_clipMatDir;\r\n    uniform vec2 u_clipMatPos;\r\n    uniform vec2 u_size;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n        float clipw = length(u_clipMatDir.xy);\r\n        float cliph = length(u_clipMatDir.zw);\r\n        vec2 clippos = a_position.xy - u_clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\r\n            info.cliped =vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n        info.color = a_attribColor/255.;\r\n    }\r\n\r\n    void getPosition(inout vec4 pos){\r\n        #ifdef WORLDMAT\r\n            vec4 pos = u_mmat*vec4(a_position.xy,0.,1.);\r\n            pos = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\r\n        #else\r\n            pos = vec4((a_position.x/u_size.x-0.5)*2.0,(0.5-a_position.y/u_size.y)*2.0,a_position.z,1.0);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n\t//texture和fillrect使用的。\r\n    // attribute vec4 a_posuv;\r\n    // attribute vec4 a_attribColor;\r\n    // attribute vec4 a_attribFlags;\r\n\r\n    uniform vec4 u_clipMatDir;\r\n    uniform vec2 u_clipMatPos;\t\t// 这个是全局的，不用再应用矩阵了。\r\n\r\n    uniform vec2 u_size;\r\n    uniform vec2 u_clipOff;\t\t\t// 使用要把clip偏移。cacheas normal用. 只用了[0]\r\n    #ifdef WORLDMAT\r\n        uniform mat4 u_mmat;\r\n    #endif\r\n\r\n    #ifdef MVP3D\r\n        uniform mat4 u_MvpMatrix;\r\n    #endif\r\n\r\n    varying vec2 v_cliped;\r\n    varying vec4 v_texcoordAlpha;\r\n    varying vec4 v_color;\r\n    varying float v_useTex;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n       \t//texcoordAlpha\r\n        info.texcoordAlpha.xy = a_posuv.zw;\r\n        //color\r\n        info.color = a_attribColor/255.0;\r\n\t    info.color.xyz*= info.color.w;//反正后面也要预乘\r\n        //useTex\r\n        info.useTex = a_attribFlags.r/255.0;\r\n\r\n        //clip\r\n    \tfloat clipw = length(u_clipMatDir.xy);\r\n    \tfloat cliph = length(u_clipMatDir.zw);\r\n\t    vec2 clpos = u_clipMatPos.xy;\r\n        #ifdef WORLDMAT\r\n            // 如果有mmat，需要修改clipMatPos,因为 这是cacheas normal （如果不是就错了）， clipMatPos被去掉了偏移\r\n            if(u_clipOff[0]>0.0){\r\n                clpos.x+=u_mmat[3].x;\t//tx\t最简单处理\r\n                clpos.y+=u_mmat[3].y;\t//ty\r\n            }\r\n        #endif\r\n        vec2 clippos = a_posuv.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\r\n            info.cliped = vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n    }\r\n\r\n    void getPosition(inout vec4 glPosition){\r\n        vec4 pos = vec4(a_posuv.xy,0.,1.);\r\n        #ifdef WORLDMAT\r\n            pos= u_mmat * pos;\r\n        #endif\r\n            vec4 pos1 = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\r\n        #ifdef MVP3D\r\n            glPosition = u_MvpMatrix * pos1;\r\n        #else\r\n            glPosition = pos1;\r\n        #endif\r\n        \r\n        #ifdef INVERTY\r\n            glPosition.y = -glPosition.y;\r\n        #endif\r\n    }\r\n\r\n#endif'),dt.addInclude("Sprite2DShaderInfo.glsl","\r\n#if defined(PRIMITIVEMESH)\r\n    struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n    };\r\n#elif defined(TEXTUREVS)\r\n   struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n        vec4 texcoordAlpha;\r\n        float useTex;\r\n    };\r\n#endif"),xr.textureShader=dt.add("Sprite2DTexture",!1,!1),xr.textureShader.shaderType=e.ShaderFeatureType.D2;let t=new ut(xr.textureAttribute,{},{});xr.textureShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME TextureVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\nvoid main() {\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\r\n\tv_cliped = info.cliped;\r\n\tv_texcoordAlpha = info.texcoordAlpha;\r\n\tv_useTex = info.useTex;\r\n\tv_color = info.color;\r\n\r\n\tvec4 pos;\r\n\tgetPosition(pos);\r\n\tgl_Position = pos;\r\n\r\n}\r\n','#define SHADER_NAME TextureFS2D\r\n//texture和fillrect使用的。\r\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main()\r\n{\r\n    clip();\r\n    vec4 color = getSpriteTextureColor();\r\n    setglColor(color);\r\n}\r\n'),xr.primitiveShader=dt.add("Sprite2DPrimitive",!1,!1),xr.primitiveShader.shaderType=e.ShaderFeatureType.D2,t=new ut(xr.primitiveAttribute,{},{}),xr.primitiveShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME PrimitiveVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\n\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\n\r\nvoid main(){\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\t\r\n\t//Update \r\n\tv_color = info.color;\r\n\tv_cliped = info.cliped;\r\n\t\r\n\tvec4 pos;\r\n\t\r\n\tgetPosition(pos);\r\n\tgl_Position = pos;\r\n}','#define SHADER_NAME PrimitiveFS2D\r\nprecision mediump float;\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main(){\r\n\tclip();\r\n\tgl_FragColor = getGlColor(v_color);\r\n\tgl_FragColor.rgb*=gl_FragColor.a;\r\n}')}}xr.primitiveAttribute={a_position:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4]},xr.textureAttribute={a_posuv:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4],a_attribFlags:[2,e.ShaderDataType.Vector4]};class yr{constructor(){this.ib=Zt.create(e.BufferUsage.Dynamic),this.vb=Jt.create(8)}static getInstance(){return yr.instance=yr.instance||new yr}addSkinMesh(e){e.getData2(this.vb,this.ib,this.vb._byteLength/32)}reset(){this.vb.buffer2D.clear(),this.ib.buffer2D.clear()}}const Er=15*Math.PI/180;class Sr{static _checkMinAngle(e,t,r,i,s,a){const n=r-e,l=i-t,o=s-r,h=a-i,_=(n*o+l*h)/(Math.sqrt(n*n+l*l)*Math.sqrt(o*o+h*h)),u=Math.acos(Math.abs(_));return Math.abs(u)<Er}static createLine2(e,t,r,i,s,a){if(e.length<4)return null;let n=i;var l=Sr.tempData.length>e.length+2?Sr.tempData:new Array(e.length+2);l[0]=e[0],l[1]=e[1];var o=2,h=0,_=e.length;for(h=2;h<_;h+=2)Math.abs(e[h]-e[h-2])+Math.abs(e[h+1]-e[h-1])>.01&&(l[o++]=e[h],l[o++]=e[h+1]);let u=Math.abs(e[0]-l[o-2])+Math.abs(e[1]-l[o-1]);a&&u>0&&(u>1e-13?(l[o++]=e[0],l[o++]=e[1]):(l[o-2]=e[0],l[o-1]=e[1]));var d=s;_=o/2;var c,p,f,g,m,T,x=r/2;for(c=l[0],p=l[1],f=l[2],g=l[3],this.vec2=this.getNormal(c,p,f,g,x,this.vec2),d.push(c-this.vec2.x,p-this.vec2.y,c+this.vec2.x,p+this.vec2.y),h=1;h<_-1;h++)c=l[2*(h-1)],p=l[2*(h-1)+1],f=l[2*h],g=l[2*h+1],m=l[2*(h+1)],T=l[2*(h+1)+1],t.push(i+0,i+1,i+3,i+3,i+2,i+0),i+=2,i+=this._setMiddleVertexs(c,p,f,g,m,T,x,d,this.vec2,t,i);if(c=l[o-4],p=l[o-3],f=l[o-2],g=l[o-1],this.vec2=this.getNormal(c,p,f,g,x,this.vec2),d.push(f-this.vec2.x,g-this.vec2.y,f+this.vec2.x,g+this.vec2.y),t.push(i+0,i+1,i+3,i+3,i+2,i+0),f==l[0]&&g==l[1]){m=l[2],T=l[3];let e=d.length/2;i+=4;let r=Sr.tempIndexs;r[0]=n+e-2,r[1]=n+e-1,r[2]=n,r[3]=n+1,this._setMiddleVertexs(c,p,f,g,m,T,x,d,this.vec2,t,i,r)}return d}static _setMiddleVertexs(e,t,r,i,s,a,n,l,o,h,_,u=null){this.getNormal(e,t,r,i,n,o);let d=o.x,c=o.y;this.getNormal(r,i,s,a,n,o);let p=o.x,f=o.y;if(this._checkMinAngle(e,t,r,i,s,a))return u?h.push(u[0],u[1],u[3],u[3],u[2],u[0]):(l.push(r-d,i-c,r+d,i+c),l.push(r-p,i-f,r+p,i+f),h.push(_+0,_+1,_+3,_+3,_+2,_+0)),2;let g=-c+t-(-c+i),m=-d+r-(-d+e),T=(-d+e)*(-c+i)-(-d+r)*(-c+t),x=-f+a-(-f+i),y=-p+r-(-p+s),E=(-p+s)*(-f+i)-(-p+r)*(-f+a),S=g*y-x*m;if(S=g*y-x*m,Math.abs(S)<.1)return S+=10.1,l.push(r-d,i-c,r+d,i+c),0;let b=(m*E-y*T)/S,v=(x*T-g*E)/S;return u?S>0?(l.push(b,v,r,i),h.push(u[0],_+0,u[2]),h.push(u[2],_+1,u[0])):(l.push(r-(b-r),i-(v-i),r,i),h.push(u[1],_+0,u[3]),h.push(u[3],_+1,u[1])):(l.push(r-d,i-c,r+d,i+c),S>0?(l.push(b,v,r,i),h.push(_+0,_+2,_+4),h.push(_+4,_+3,_+0)):(l.push(r-(b-r),i-(v-i),r,i),h.push(_+1,_+2,_+5),h.push(_+5,_+3,_+1)),l.push(r-p,i-f,r+p,i+f)),4}static getNormal(e,t,r,i,s,a){a||(a=new Me);let n=i-t,l=e-r,o=Math.sqrt(n*n+l*l);return a.x=n/o*s,a.y=l/o*s,a}static createLineTriangle(e,t,r,i,s,a,n){var l=e.slice(),o=l.length,h=l[0],_=l[1],u=l[2],d=(l[2],0),c=0,p=0,f=0,g=o/2;if(!(g<=1)&&2!=g){for(var m=new Array(4*g),T=0,x=0,y=0;y<g-1;y++)h=l[x++],_=l[x++],u=l[x++],f=l[x++]-_,0!=(p=u-h)&&0!=f&&(d=Math.sqrt(p*p+f*f))>.001&&(m[c=4*T]=h,m[c+1]=_,m[c+2]=p/d,m[c+3]=f/d,T++);for(i?(h=l[o-2],_=l[o-1],u=l[0],f=l[1]-_,0!=(p=u-h)&&0!=f&&(d=Math.sqrt(p*p+f*f))>.001&&(m[c=4*T]=h,m[c+1]=_,m[c+2]=p/d,m[c+3]=f/d,T++)):(m[c=4*T]=h,m[c+1]=_,m[c+2]=p/d,m[c+3]=f/d,T++),x=0,y=0;y<g;y++)h=l[x],_=l[x+1],u=l[x+2],l[x+3]}}}Sr.tempData=new Array(256),Sr.tempIndexs=new Array(4);class br{constructor(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class vr{static earcut(e,t,r){r=r||2;var i,s,a,n,l,o,h,_=t&&t.length,u=_?t[0]*r:e.length,d=vr.linkedList(e,0,u,r,!0),c=[];if(!d)return c;if(_&&(d=vr.eliminateHoles(e,t,d,r)),e.length>80*r){i=a=e[0],s=n=e[1];for(var p=r;p<u;p+=r)(l=e[p])<i&&(i=l),(o=e[p+1])<s&&(s=o),l>a&&(a=l),o>n&&(n=o);h=0!==(h=Math.max(a-i,n-s))?1/h:0}return vr.earcutLinked(d,c,r,i,s,h),c}static linkedList(e,t,r,i,s){var a,n;if(s===vr.signedArea(e,t,r,i)>0)for(a=t;a<r;a+=i)n=vr.insertNode(a,e[a],e[a+1],n);else for(a=r-i;a>=t;a-=i)n=vr.insertNode(a,e[a],e[a+1],n);return n&&vr.equals(n,n.next)&&(vr.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!vr.equals(i,i.next)&&0!==vr.area(i.prev,i,i.next))i=i.next;else{if(vr.removeNode(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}static earcutLinked(e,t,r,i,s,a,n=null){if(e){!n&&a&&vr.indexCurve(e,i,s,a);for(var l,o,h=e;e.prev!==e.next;)if(l=e.prev,o=e.next,a?vr.isEarHashed(e,i,s,a):vr.isEar(e))t.push(l.i/r),t.push(e.i/r),t.push(o.i/r),vr.removeNode(e),e=o.next,h=o.next;else if((e=o)===h){n?1===n?(e=vr.cureLocalIntersections(e,t,r),vr.earcutLinked(e,t,r,i,s,a,2)):2===n&&vr.splitEarcut(e,t,r,i,s,a):vr.earcutLinked(vr.filterPoints(e,null),t,r,i,s,a,1);break}}}static isEar(e){var t=e.prev,r=e,i=e.next;if(vr.area(t,r,i)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(vr.pointInTriangle(t.x,t.y,r.x,r.y,i.x,i.y,s.x,s.y)&&vr.area(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}static isEarHashed(e,t,r,i){var s=e.prev,a=e,n=e.next;if(vr.area(s,a,n)>=0)return!1;for(var l=s.x<a.x?s.x<n.x?s.x:n.x:a.x<n.x?a.x:n.x,o=s.y<a.y?s.y<n.y?s.y:n.y:a.y<n.y?a.y:n.y,h=s.x>a.x?s.x>n.x?s.x:n.x:a.x>n.x?a.x:n.x,_=s.y>a.y?s.y>n.y?s.y:n.y:a.y>n.y?a.y:n.y,u=vr.zOrder(l,o,t,r,i),d=vr.zOrder(h,_,t,r,i),c=e.nextZ;c&&c.z<=d;){if(c!==e.prev&&c!==e.next&&vr.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,c.x,c.y)&&vr.area(c.prev,c,c.next)>=0)return!1;c=c.nextZ}for(c=e.prevZ;c&&c.z>=u;){if(c!==e.prev&&c!==e.next&&vr.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,c.x,c.y)&&vr.area(c.prev,c,c.next)>=0)return!1;c=c.prevZ}return!0}static cureLocalIntersections(e,t,r){var i=e;do{var s=i.prev,a=i.next.next;!vr.equals(s,a)&&vr.intersects(s,i,i.next,a)&&vr.locallyInside(s,a)&&vr.locallyInside(a,s)&&(t.push(s.i/r),t.push(i.i/r),t.push(a.i/r),vr.removeNode(i),vr.removeNode(i.next),i=e=a),i=i.next}while(i!==e);return i}static splitEarcut(e,t,r,i,s,a){var n=e;do{for(var l=n.next.next;l!==n.prev;){if(n.i!==l.i&&vr.isValidDiagonal(n,l)){var o=vr.splitPolygon(n,l);return n=vr.filterPoints(n,n.next),o=vr.filterPoints(o,o.next),vr.earcutLinked(n,t,r,i,s,a),void vr.earcutLinked(o,t,r,i,s,a)}l=l.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,r,i){var s,a,n,l,o,h=[];for(s=0,a=t.length;s<a;s++)n=t[s]*i,l=s<a-1?t[s+1]*i:e.length,(o=vr.linkedList(e,n,l,i,!1))===o.next&&(o.steiner=!0),h.push(vr.getLeftmost(o));for(h.sort(vr.compareX),s=0;s<h.length;s++)vr.eliminateHole(h[s],r),r=vr.filterPoints(r,r.next);return r}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=vr.findHoleBridge(e,t)){var r=vr.splitPolygon(t,e);vr.filterPoints(r,r.next)}}static findHoleBridge(e,t){var r,i=t,s=e.x,a=e.y,n=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var l=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(l<=s&&l>n){if(n=l,l===s){if(a===i.y)return i;if(a===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(s===n)return r.prev;var o,h=r,_=r.x,u=r.y,d=1/0;for(i=r.next;i!==h;)s>=i.x&&i.x>=_&&s!==i.x&&vr.pointInTriangle(a<u?s:n,a,_,u,a<u?n:s,a,i.x,i.y)&&((o=Math.abs(a-i.y)/(s-i.x))<d||o===d&&i.x>r.x)&&vr.locallyInside(i,e)&&(r=i,d=o),i=i.next;return r}static indexCurve(e,t,r,i){var s=e;do{null===s.z&&(s.z=vr.zOrder(s.x,s.y,t,r,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,vr.sortLinked(s)}static sortLinked(e){var t,r,i,s,a,n,l,o,h=1;do{for(r=e,e=null,a=null,n=0;r;){for(n++,i=r,l=0,t=0;t<h&&(l++,i=i.nextZ);t++);for(o=h;l>0||o>0&&i;)0!==l&&(0===o||!i||r.z<=i.z)?(s=r,r=r.nextZ,l--):(s=i,i=i.nextZ,o--),a?a.nextZ=s:e=s,s.prevZ=a,a=s;r=i}a.nextZ=null,h*=2}while(n>1);return e}static zOrder(e,t,r,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}static pointInTriangle(e,t,r,i,s,a,n,l){return(s-n)*(t-l)-(e-n)*(a-l)>=0&&(e-n)*(i-l)-(r-n)*(t-l)>=0&&(r-n)*(a-l)-(s-n)*(i-l)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!vr.intersectsPolygon(e,t)&&vr.locallyInside(e,t)&&vr.locallyInside(t,e)&&vr.middleInside(e,t)}static area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,r,i){return!!(vr.equals(e,t)&&vr.equals(r,i)||vr.equals(e,i)&&vr.equals(r,t))||vr.area(e,t,r)>0!=vr.area(e,t,i)>0&&vr.area(r,i,e)>0!=vr.area(r,i,t)>0}static intersectsPolygon(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&vr.intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}static locallyInside(e,t){return vr.area(e.prev,e,e.next)<0?vr.area(e,t,e.next)>=0&&vr.area(e,e.prev,t)>=0:vr.area(e,t,e.prev)<0||vr.area(e,e.next,t)<0}static middleInside(e,t){var r=e,i=!1,s=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&s<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}static splitPolygon(e,t){var r=new br(e.i,e.x,e.y),i=new br(t.i,t.x,t.y),s=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=s,s.prev=r,i.next=r,r.prev=i,a.next=i,i.prev=a,i}static insertNode(e,t,r,i){var s=new br(e,t,r);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,r,i){for(var s=0,a=t,n=r-i;a<r;a+=i)s+=(e[n]-e[a])*(e[a+1]+e[n+1]),n=a;return s}}var Rr,Ar;e.MeshTopology=void 0,(Rr=e.MeshTopology||(e.MeshTopology={}))[Rr.Points=0]="Points",Rr[Rr.Lines=1]="Lines",Rr[Rr.LineLoop=2]="LineLoop",Rr[Rr.LineStrip=3]="LineStrip",Rr[Rr.Triangles=4]="Triangles",Rr[Rr.TriangleStrip=5]="TriangleStrip",Rr[Rr.TriangleFan=6]="TriangleFan";class Cr extends Yt{constructor(e=Yt.TYPE_2D){super(e)}renderSubmit(){if(0===this._numEle||!this._mesh||0==this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t._getSource();if(!r)return 1;this.shaderValue.texture=r}return this._mesh.useMesh(),this.shaderValue.upload(this.material),re.activeBlendFunction!==this._blendFn&&(te.setBlend(!0),this._blendFn(),re.activeBlendFunction=this._blendFn),x.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}releaseRender(){Yt.RENDERBASE!=this&&--this._ref<1&&(Cr.POOL[Cr._poolSize++]=this,this.shaderValue.release(),this.shaderValue=null,this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}static create(e,t,r){var s=Cr._poolSize?Cr.POOL[--Cr._poolSize]:new Cr;s._ref=1,s._mesh=t,s._key.clear(),s._startIdx=t.indexNum*i.BYTES_PIDX,s._numEle=0;var a=e._nBlendType;s._blendFn=e._targets?re.targetFns[a]:re.fns[a],s.shaderValue=r,s.material=e.material;var n=e._shader2D.filters;return n&&s.shaderValue.setFilters(n),s}static createShape(e,t,r,i){var s=Cr._poolSize?Cr.POOL[--Cr._poolSize]:new Cr;s._mesh=t,s._numEle=r,s._startIdx=2*t.indexNum,s._ref=1,s.shaderValue=i;var a=e._nBlendType;return s._key.blendShader=a,s.material=e.material,s._blendFn=e._targets?re.targetFns[a]:re.fns[a],s}}Cr._poolSize=0,Cr.POOL=[];class Dr extends Yt{static create(e,t,r){var i=Dr.POOL._length?Dr.POOL[--Dr.POOL._length]:new Dr;i.canv=e,i._ref=1,i._numEle=0;var s=i.shaderValue;return s.alpha=t,s.defines.clearDefine(),r&&r.length&&s.setFilters(r),i}constructor(){super(Yt.TYPE_2D),this._matrix=new p,this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.shaderValue=new Dt(e.RenderSpriteData.Zero)}renderSubmit(){var e=j.worldAlpha,t=j.worldMatrix4,r=j.worldMatrix,i=j.worldFilters,s=j.worldShaderDefines,a=this.shaderValue,n=this._matrix,l=this._matrix4,o=p.TEMP;return p.mul(n,r,o),l[0]=o.a,l[1]=o.b,l[4]=o.c,l[5]=o.d,l[12]=o.tx,l[13]=o.ty,j.worldMatrix=o.clone(),j.worldMatrix4=l,j.worldAlpha=j.worldAlpha*a.alpha,a.filters&&a.filters.length&&(j.worldFilters=a.filters,j.worldShaderDefines=a.defines),this.canv.flushsubmit(),j.worldAlpha=e,j.worldMatrix4=t,j.worldMatrix.destroy(),j.worldMatrix=r,j.worldFilters=i,j.worldShaderDefines=s,1}releaseRender(){if(--this._ref<1){var e=Dr.POOL;this._mesh=null,e[e._length++]=this}}getRenderType(){return Yt.TYPE_CANVAS}}Dr.POOL=[],Dr.POOL._length=0;class Mr{constructor(){this.blendType=0,this._ref=1,this._key=new Mt}renderSubmit(){this._mesh.useMesh();var t=this.srcRT;return t&&(this.shaderValue.textureHost=t,this.shaderValue.upload(),this.blend(),x.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx)),1}blend(){re.activeBlendFunction!==re.fns[this.blendType]&&(te.setBlend(!0),re.fns[this.blendType](),re.activeBlendFunction=re.fns[this.blendType])}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=Mr.POOL;e[e._length++]=this}}static create(e,t,r,s){var a=Mr.POOL._length?Mr.POOL[--Mr.POOL._length]:new Mr;if(a._mesh=t,a.srcRT=s,a._startIdx=t.indexNum*i.BYTES_PIDX,a._ref=1,a._key.clear(),a._numEle=0,a.blendType=e._nBlendType,a._key.blendShader=a.blendType,a.shaderValue=r,e._colorFiler){var n=e._colorFiler;r.defines.addDefine(n.typeDefine),qe.TEMPMatrix0.cloneByArray(n._mat),r.colorMat=qe.TEMPMatrix0,we.tempVec4.setValue(n._alpha[0],n._alpha[1],n._alpha[2],n._alpha[3]),r.colorAlpha=we.tempVec4}return a}}Mr.POOL=[],Mr.POOL._length=0;class wr extends Yt{constructor(e=Yt.TYPE_2D){super(e)}releaseRender(){--this._ref<1&&(wr.POOL[wr._poolSize++]=this,this.shaderValue.release(),this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}renderSubmit(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t?t._getSource():null;if(!r)return 1}return this._mesh.useMesh(),this.shaderValue.updateShaderData(),Yt.preRender,Yt.preRender._key,re.activeBlendFunction!==this._blendFn&&(te.setBlend(!0),this._blendFn(),re.activeBlendFunction=this._blendFn),this.shaderValue.texture=r,this.shaderValue.upload(this.material),x.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}static create(e,t,r){var s=wr._poolSize?wr.POOL[--wr._poolSize]:new wr(Yt.TYPE_TEXTURE);s._mesh=t,s._key.clear(),s._key.submitType=Yt.KEY_DRAWTEXTURE,s._ref=1,s._startIdx=t.indexNum*i.BYTES_PIDX,s._numEle=0;var a=e._nBlendType;if(s._key.blendShader=a,s._blendFn=e._targets?re.targetFns[a]:re.fns[a],s.shaderValue=r,s.material=e.material,e._colorFiler){var n=e._colorFiler;r.defines.addDefine(n.typeDefine),qe.TEMPMatrix0.cloneByArray(n._mat),r.colorMat=qe.TEMPMatrix0,we.tempVec4.setValue(n._alpha[0],n._alpha[1],n._alpha[2],n._alpha[3]),r.colorAlpha=we.tempVec4}return s}}wr._poolSize=0,wr.POOL=[];class Ir{constructor(){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new p,this._enable=!1}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(e,t,r,i,s,a){this._ndata>0&&(this._tex!=t||this._imgId!=r||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=r,this._colorFiler=e._colorFiler,this._data[this._ndata]=i,this._data[this._ndata+1]=s,this._data[this._ndata+2]=a,this._ndata+=3}getPos(){return 0==Ir.__nPosPool?new Array(8):Ir.__posPool[--Ir.__nPosPool]}enable(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}submit(t){var r=this._ndata;if(r){var i=t._mesh,s=t._colorFiler;t._colorFiler=this._colorFiler;var a=wr.create(t,i,Dt.create(e.RenderSpriteData.Texture2D));t._submits[t._submits._length++]=t._curSubmit=a,a.shaderValue.textureHost=this._tex,a._key.other=this._imgId,t._colorFiler=s,t._copyClipInfo(a,this._clipMatrix),a.clipInfoID=this._clipid;for(var n=0;n<r;n+=3)i.addQuad(this._data[n],this._data[n+1],this._data[n+2],!0),Ir.__posPool[Ir.__nPosPool++]=this._data[n];r/=3,a._numEle+=6*r,i.indexNum+=6*r,i.vertNum+=4*r,t._drawCount+=r,this._ndata=0,pt.loopCount%100==0&&(this._data.length=0)}}}Ir.__posPool=[],Ir.__nPosPool=0;class Pr{static setResolution(e,t){Pr.customResolution=!0,Pr._resoluWidth=e,Pr._resoluHeight=t}}Pr.enableDynamicBatch=!0,Pr.enableStaticBatch=!0,Pr.enableUniformBufferObject=!0,Pr.pixelRatio=1,Pr.customResolution=!1,Pr.defaultCacheRTMemory=256,Pr.defaultPhysicsMemory=16,Pr.enableMultiLight=!0,Pr.maxLightCount=32,Pr.lightClusterCount=new Ie(12,12,12),Pr.maxMorphTargetCount=32,Pr.useBVHCull=!1,Pr.BVH_max_SpatialCount=7,Pr.BVH_limit_size=32,Pr.BVH_Min_Build_nums=10,Pr._resoluWidth=-1,Pr._resoluHeight=-1,Pr.debugFrustumCulling=!1,r.isStencil=!0;class Br extends I{static get currentActive(){return Br._currentActive}static configRenderContextInstance(e){Br._configInstance=e}static createFromPool(e,t,r,i,s=!1,a=1,n=!1,l=!1){s=s&&!(e&e-1)&&!(t&t-1);let o=Br._pool.length;for(let h=0;h<o;h++){let _=Br._pool[h];if(_.width==e&&_.height==t&&_.colorFormat==r&&_.depthStencilFormat==i&&_._generateMipmap==s&&_.multiSamples==a&&_.generateDepthTexture==n&&_._gammaSpace==l){_._inPool=!1;let e=Br._pool[o-1];return Br._pool[h]=e,Br._pool.length-=1,Br._poolMemory-=_._renderTarget.gpuMemory/1024/1024,_}}let h=new Br(e,t,r,i,s,a,n,l);return h.lock=!0,h}static recoverToPool(e){e._inPool||e.destroyed||(Br._pool.push(e),Br._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(Br._poolMemory<Pr.defaultCacheRTMemory)){for(var e in Br._pool)Br._pool[e].destroy();Br._pool=[],Br._poolMemory=0}}static get bindCanvasRender(){return Br._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){t&&!this._depthStencilTexture&&(this._depthStencilTexture=new I(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=x.textureContext.createRenderTextureInternal(e.TextureDimension.Tex2D,this.width,this.height,this.depthStencilFormat,!1,!1),x.textureContext.setupRendertargetTextureAttachment(this._renderTarget,this._depthStencilTexture._texture)),this._generateDepthTexture=t}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(t,r,i,s,a=!1,n=1,l=!1,o=!1){super(t,r,i),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=o,this._depthStencilFormat=null==s?e.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._createRenderTarget()}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=x.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,r,i,s,a=!1,n=1,l=!1,o=!1){this._width=t,this._height=r,this._format=i,this._gammaSpace=o,this._depthStencilFormat=null==s?e.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._disposeResource(),this._createRenderTarget()}_start(){Br._configInstance.invertY=this._isCameraTarget,Br._currentActive!=this&&(Br._currentActive&&Br._currentActive._end(),Br._currentActive=this,x.textureContext.bindRenderTarget(this._renderTarget))}_end(){Br._currentActive=null,x.textureContext.unbindRenderTarget(this._renderTarget),this._isCameraTarget&&(Br._configInstance.invertY=!1)}getData(e,t,r,i,s){return x.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,r,i,s),s}_disposeResource(){var e;Br._currentActive==this&&this._end(),this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}Br._currentActive=null,Br._configInstance={},Br._pool=[],Br._poolMemory=0,function(e){e[e.SIZE=0]="SIZE",e[e.CLEAR=1]="CLEAR",e[e.SAVE=2]="SAVE",e[e.TRANSFORM=3]="TRANSFORM",e[e.ALPHA=4]="ALPHA",e[e.RESTORE=5]="RESTORE",e[e.FILL_STYLE=6]="FILL_STYLE",e[e.FILL_RECT=7]="FILL_RECT",e[e.STROKE_STYLE=8]="STROKE_STYLE",e[e.LINE_WIDTH=9]="LINE_WIDTH",e[e.STROKE_RECT=10]="STROKE_RECT",e[e.FILL_WORD_TEXT=11]="FILL_WORD_TEXT",e[e.DRAW_TEXTURE_SIZE_GRID=12]="DRAW_TEXTURE_SIZE_GRID",e[e.DRAW_TEXTURE=13]="DRAW_TEXTURE",e[e.CLIP_RECT=14]="CLIP_RECT",e[e.DRAW_LINE=15]="DRAW_LINE",e[e.DRAW_LINES=16]="DRAW_LINES",e[e.SCALE=17]="SCALE",e[e.TRANSLATE=18]="TRANSLATE",e[e.ROTATE=19]="ROTATE",e[e.DRAW_CIRCLE=20]="DRAW_CIRCLE",e[e.DRAW_PIE=21]="DRAW_PIE",e[e.DRAW_POLY=22]="DRAW_POLY",e[e.DRAW_CURVES=23]="DRAW_CURVES",e[e.BEGIN_PATH=24]="BEGIN_PATH",e[e.MOVE_TO=25]="MOVE_TO",e[e.LINE_TO=26]="LINE_TO",e[e.ARC_TO=27]="ARC_TO",e[e.CLOSE_PATH=28]="CLOSE_PATH",e[e.FILL=29]="FILL",e[e.STROKE=30]="STROKE",e[e.SET_AS_BITMAP=31]="SET_AS_BITMAP",e[e.DRAW_MASKED=32]="DRAW_MASKED",e[e.DRAW_TRANGLES=33]="DRAW_TRANGLES",e[e.SET_GLOBAL_COMPOSITE_OPERTAION=34]="SET_GLOBAL_COMPOSITE_OPERTAION",e[e.FILL_WORDS=35]="FILL_WORDS",e[e.FILL_TEXTURE=36]="FILL_TEXTURE"}(Ar||(Ar={}));class Lr{static __init__(){}constructor(){this._byteLen=0,this.sprite=null,this._renderObject3DList=[],this._tmpMatrix=new p,this._nativeObj=new window._conchContext(x.renderEngine._nativeObj),this._byteLen=524288,this._tempRenderTexture2D=new Q(0,0,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None,!1),this._init(!1)}_init(e){this._buffer=new ArrayBuffer(this._byteLen),this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._byteArray=new Uint8Array(this._buffer);var t=window.webglPlus.createArrayBufferRef(this._buffer,Lr.ARRAY_BUFFER_TYPE_CMD,e,Lr.ARRAY_BUFFER_REF_REFERENCE);this._nativeObj.setSharedCommandBuffer(t),this._idata[0]=1}_need(e){if(!(this._byteLen-(this._idata[0]<<2)>=e)&&(this._nativeObj.flushCommand(),e>this._byteLen))throw"too big"}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,i){}set isMain(e){this._nativeObj.flushCommand(),this._nativeObj.isMain=e}get isMain(){return this._nativeObj.flushCommand(),this._nativeObj.isMain}set _targets(e){e&&(this._nativeObj.flushCommand(),this._nativeObj._target=e._nativeObj)}get _targets(){this._nativeObj.flushCommand();let e=this._nativeObj._target;return e?(this._tempRenderTexture2D.width=this._nativeObj.width,this._tempRenderTexture2D.height=this._nativeObj.height,this._tempRenderTexture2D._nativeObj=e,this._tempRenderTexture2D._renderTarget=e._renderTarget,this._tempRenderTexture2D._texture=e._renderTarget._textures[0],this._tempRenderTexture2D):null}alpha(e){this.globalAlpha*=e}flush(){jt._curBindedBufferState&&jt._curBindedBufferState.unBind(),this._nativeObj.flushCommand(),this._nativeObj.flush()}clear(){this.add_i(Ar.CLEAR),this._nativeObj.flushCommand(),this._renderObject3DList.length=0}destroy(e=!1){this._nativeObj.flushCommand(),this._tempRenderTexture2D._nativeObj&&(this._tempRenderTexture2D._nativeObj._deleteRT=e),this._nativeObj.destroy(e)}static set2DRenderConfig(){if(!Lr.const2DRenderCMD){const t=Lr.const2DRenderCMD=x.renderEngine.createRenderStateComand();t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),re.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front)}Lr.const2DRenderCMD.applyCMD(),Br.currentActive&&Br.currentActive._end(),window.set2DRenderConfig(),jt._curBindedBufferState&&jt._curBindedBufferState.unBind()}set globalCompositeOperation(e){this.add_i_String(Ar.SET_GLOBAL_COMPOSITE_OPERTAION,e)}get globalCompositeOperation(){return this._nativeObj.flushCommand(),this._nativeObj.globalCompositeOperation}set fillStyle(e){var t=Bt.create(e);this.add_ii(Ar.FILL_STYLE,t.numColor)}get fillStyle(){return this._nativeObj.flushCommand(),this._nativeObj.fillStyle}set globalAlpha(e){this.add_if(Ar.ALPHA,e)}get globalAlpha(){return this._nativeObj.flushCommand(),this._nativeObj.globalAlpha}save(){this.add_i(Ar.SAVE)}restore(){this.add_i(Ar.RESTORE)}saveTransform(e){this.add_i(Ar.SAVE)}transformByMatrix(e,t,r){this.add_iffffff(Ar.TRANSFORM,e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}restoreTransform(e){this.add_i(Ar.RESTORE)}clipRect(e,t,r,i){this.add_iffff(Ar.CLIP_RECT,e,t,r,i)}transform(e,t,r,i,s,a){this.add_iffffff(Ar.TRANSFORM,e,t,r,i,s,a)}scale(e,t){this.add_iff(Ar.SCALE,e,t)}drawTexture(e,t,r,i,s,a=4294967295){this.checkTexture(e)&&this.add_iiffffffffffffi(Ar.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i,s,e.uv[0],e.uv[1],e.uv[2],e.uv[3],e.uv[4],e.uv[5],e.uv[6],e.uv[7],a)}drawTextureWithTransform(e,t,r,i,s,a,n,l,o,h,_,u=4294967295){if(this.checkTexture(e)){this.save(),this.alpha(o);var d=_||e.uv;a?(this.add_iffffff(Ar.TRANSFORM,a.a,a.b,a.c,a.d,a.tx+n,a.ty+l),this.add_iiffffffffffffi(Ar.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i||e.width,s||e.height,d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],u)):this.add_iiffffffffffffi(Ar.DRAW_TEXTURE,e.bitmap._texture.id,t+n,r+l,i||e.width,s||e.height,d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],u),this.restore()}}drawTextureWithSizeGrid(e,t,r,i,s,a,n,l,o){if(this.checkTexture(e)){var h=e.uv;e.bitmap.width,e.bitmap.height;var _=a[0],u=a[3],d=a[1],c=a[2],p=a[4];this.add_iiffffffffiffffffffffi(Ar.DRAW_TEXTURE_SIZE_GRID,e.bitmap._texture.id,t,r,i,s,_,d,c,u,p?1:0,n,l,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],o)}}_drawTextureM(e,t,r,i,s,a,n,l,o){if(this.checkTexture(e)){this.save(),this.alpha(n),a&&this.add_iffffff(Ar.TRANSFORM,a.a,a.b,a.c,a.d,a.tx,a.ty);var h=l||e.uv;this.add_iiffffffffffffi(Ar.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i||e.width,s||e.height,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],o),this.restore()}}translate(e,t){this.add_iff(Ar.TRANSLATE,e,t)}_transform(e,t,r){this.add_iff(Ar.TRANSLATE,t,r),this.add_iffffff(Ar.TRANSFORM,e.a,e.b,e.c,e.d,e.tx,e.ty),this.add_iff(Ar.TRANSLATE,-t,-r)}_rotate(e,t,r){this.add_iff(Ar.TRANSLATE,t,r),this.add_if(Ar.ROTATE,e),this.add_iff(Ar.TRANSLATE,-t,-r)}_scale(e,t,r,i){this.add_iff(Ar.TRANSLATE,r,i),this.add_iff(Ar.SCALE,e,t),this.add_iff(Ar.TRANSLATE,-r,-i)}_drawLine(e,t,r,i,s,a,n,l,o){var h=Bt.create(n);this.add_iffffffif(Ar.DRAW_LINE,e,t,r,i,s,a,h.numColor,l)}_drawLines(e,t,r,i,s,a){var n=Bt.create(i);this.add_iffif_ab(Ar.DRAW_LINES,e,t,n.numColor,s,new Float32Array(r))}_drawCircle(e,t,r,i,s,a,n){var l=Bt.create(i),o=Bt.create(s);this.add_ifffiiiif(Ar.DRAW_CIRCLE,e,t,r,i?1:0,l.numColor,s?1:0,o.numColor,a)}_drawPie(e,t,r,i,s,a,n,l,o){var h=Bt.create(a),_=Bt.create(n);this.add_ifffffiiiif(Ar.DRAW_PIE,e,t,r,i,s,a?1:0,h.numColor,n?1:0,_.numColor,l)}_drawPoly(e,t,r,i,s,a,n,l){var o=Bt.create(i),h=Bt.create(s);this.add_iffiiiifi_ab(Ar.DRAW_POLY,e,t,i?1:0,o.numColor,s?1:0,h.numColor,a,n?1:0,new Float32Array(r))}fillRect(e,t,r,i,s){if(null!=s){var a=Bt.create(s);this.add_ii(Ar.FILL_STYLE,a.numColor)}this.add_i(Ar.SAVE),this.add_iffff(Ar.FILL_RECT,e,t,r,i),this.add_i(Ar.RESTORE)}fillTexture(e,t,r,i,s,a,n,l){if(this.checkTexture(e)){var o=0;switch(a){case"repeat":o=0;break;case"repeat-x":o=1;break;case"repeat-y":o=2;break;case"no-repeat":o=3}this.add_iiffffiffi(Ar.FILL_TEXTURE,e.bitmap._texture.id,t,r,i,s,o,n.x,n.y,l)}}drawRect(e,t,r,i,s,a,n){if(null!=s){var l=Bt.create(s);this.add_i(Ar.SAVE),this.add_ii(Ar.FILL_STYLE,l.numColor),this.add_iffff(Ar.FILL_RECT,e,t,r,i),this.add_i(Ar.RESTORE)}if(null!=a){var o=Bt.create(a);this.add_i(Ar.SAVE),this.add_ii(Ar.STROKE_STYLE,o.numColor),this.add_if(Ar.LINE_WIDTH,n),this.add_iffff(Ar.STROKE_RECT,e,t,r,i),this.add_i(Ar.RESTORE)}}_drawPath(e,t,r,i,s){this.add_ii(Ar.BEGIN_PATH,0);for(var a=0,n=r.length;a<n;a++){var l=r[a];switch(l[0]){case"moveTo":this.add_iff(Ar.MOVE_TO,e+l[1],t+l[2]);break;case"lineTo":this.add_iff(Ar.LINE_TO,e+l[1],t+l[2]);break;case"arcTo":this.add_ifffff(Ar.ARC_TO,e+l[1],t+l[2],e+l[3],t+l[4],l[5]);break;case"closePath":this.add_i(Ar.CLOSE_PATH)}}if(null!=i){var o=Bt.create(i.fillStyle);this.add_ii(Ar.FILL_STYLE,o.numColor),this.add_i(Ar.FILL)}if(null!=s){var h=Bt.create(s.strokeStyle);this.add_ii(Ar.STROKE_STYLE,h.numColor),this.add_if(Ar.LINE_WIDTH,s.lineWidth||1),this.add_i(Ar.STROKE)}}drawCurves(e,t,r,i,s){var a=Bt.create(i);this.add_iffif_ab(Ar.DRAW_CURVES,e,t,a.numColor,s,new Float32Array(r))}drawCanvas(e,t,r,i,s){e&&(this._nativeObj.flushCommand(),e instanceof sr?this._nativeObj.drawCanvasNormal(e._nativeObj,t,r,i,s):this._nativeObj.drawCanvasBitmap(e.context._nativeObj,t,r,i,s))}fillText(e,t,r,s,a,n,l=0,o=""){var h=0;switch(n){case"center":h=i.ENUM_TEXTALIGN_CENTER;break;case"right":h=i.ENUM_TEXTALIGN_RIGHT}var _=Bt.create(a),u=Bt.create(o);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,_.numColor,u.numColor,h,t,r,l,e,s):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,_.numColor,u.numColor,l,h,s)}drawText(e,t,r,s,a,n){var l=0;switch(n){case"center":l=i.ENUM_TEXTALIGN_CENTER;break;case"right":l=i.ENUM_TEXTALIGN_RIGHT}var o=Bt.create(a),h=Bt.create(null);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,o.numColor,h.numColor,l,t,r,0,e,s):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,o.numColor,h.numColor,0,l,s)}strokeWord(e,t,r,s,a,n,l){var o=0;switch(l){case"center":o=i.ENUM_TEXTALIGN_CENTER;break;case"right":o=i.ENUM_TEXTALIGN_RIGHT}var h=Bt.create(a),_=Bt.create(null);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,h.numColor,_.numColor,o,t,r,n,e,s):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,_.numColor,n,o,s)}fillBorderText(e,t,r,s,a,n,l,o){var h=0;switch(o){case"center":h=i.ENUM_TEXTALIGN_CENTER;break;case"right":h=i.ENUM_TEXTALIGN_RIGHT}var _=Bt.create(a),u=Bt.create(n);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,_.numColor,u.numColor,h,t,r,l,e,s):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,_.numColor,u.numColor,l,h,s)}filltext11(e,t,r,s,a,n,l,o){var h=0;switch(o){case"center":h=i.ENUM_TEXTALIGN_CENTER;break;case"right":h=i.ENUM_TEXTALIGN_RIGHT}var _=Bt.create(a),u=Bt.create(n);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,_.numColor,u.numColor,h,t,r,l,e,s):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,_.numColor,u.numColor,l,h,s)}_fast_filltext(e,t,r,i,s,a,n,l,o=0){var h=Bt.create(s),_=Bt.create(a);"string"==typeof e?this.add_iiiifff_String_String(Ar.FILL_WORDS,h.numColor,_.numColor,l,t,r,n,e,i._font):this.add_iiffiifi_String(Ar.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,_.numColor,n,l,i._font)}drawTriangles(e,t,r,i,s,a,n,l,o,h=4294967295){if(this.checkTexture(e)){var _=n||this._tmpMatrix;null!=o?(this.add_i(Ar.SAVE),this.add_i_String(Ar.SET_GLOBAL_COMPOSITE_OPERTAION,o),this.add_iiifffffffff_ab_ab_ab(Ar.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,l,_.a,_.b,_.c,_.d,_.tx,_.ty,i instanceof Array?Float32Array.from(i):i,s instanceof Array?Float32Array.from(s):s,a instanceof Array?Uint16Array.from(a):a),this.add_i(Ar.RESTORE)):this.add_iiifffffffff_ab_ab_ab(Ar.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,l,_.a,_.b,_.c,_.d,_.tx,_.ty,i instanceof Array?Float32Array.from(i):i,s instanceof Array?Float32Array.from(s):s,a instanceof Array?Uint16Array.from(a):a)}}drawMask(e,t){return this._nativeObj.flushCommand(),this._nativeObj.drawMask(e,t)}drawMasked(e,t,r,i){this.add_iffff(Ar.DRAW_MASKED,e,t,r,i)}drawMaskComposite(e,t,r,i,s){this._nativeObj.flushCommand(),this._nativeObj.drawMaskComposite(e,t,r,i,s)}set asBitmap(e){this.add_ii(Ar.SET_AS_BITMAP,e?1:0)}size(e,t){this.add_iii(Ar.SIZE,e,t)}setColorFilter(e){this._nativeObj.flushCommand(),e?this._nativeObj.setColorFilter(!0,e._alpha,e._mat):this._nativeObj.setColorFilter(!1,null,null)}drawTarget(e,t,r,i,s,a,n,l=null,o=-1){return this._nativeObj.flushCommand(),this._nativeObj.drawTarget(e,t,r,i,s,a.a,a.b,a.c,a.d,a.tx,a.ty,o)}drawTargetBlurFilter(e,t,r,i,s,a){this._nativeObj.flushCommand(),this._nativeObj.drawTargetBlurFilter(e,t,r,i,s,a)}get _curMat(){this._nativeObj.flushCommand();var e=this._nativeObj._curMat,t=p.create();return t.a=e[0],t.b=e[1],t.c=e[2],t.d=e[3],t.tx=e[4],t.ty=e[5],t}addRenderObject3D(e){this._renderObject3DList.push(e._nativeObj),this._nativeObj.flushCommand(),this._nativeObj.addRenderObject3D(e._nativeObj)}pushRT(){this._nativeObj.flushCommand(),this._nativeObj.pushRT()}popRT(){this._nativeObj.flushCommand(),this._nativeObj.popRT()}useRT(e){this._nativeObj.flushCommand(),this._nativeObj.useRT(e)}drawFilter(e,t,r,i,s,a){this._nativeObj.flushCommand(),this._nativeObj.drawFilter(e,t,r,i,s,a)}checkTexture(e){var t=this.sprite;return!!e._getSource((function(){t&&t.repaint()}))}add_i(e){this._need(4),this._idata[this._idata[0]++]=e}add_ii(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._idata[r++]=t,this._idata[0]=r}add_if(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._fdata[r++]=t,this._idata[0]=r}add_iff(e,t,r){this._need(12);var i=this._idata[0];this._idata[i++]=e,this._fdata[i++]=t,this._fdata[i++]=r,this._idata[0]=i}add_iffif(e,t,r,i,s){this._need(20);var a=this._idata[0],n=this._fdata;this._idata[a++]=e,n[a++]=t,n[a++]=r,this._idata[a++]=i,n[a++]=s,this._idata[0]=a}add_iffff(e,t,r,i,s){this._need(20);var a=this._idata[0],n=this._fdata;this._idata[a++]=e,n[a++]=t,n[a++]=r,n[a++]=i,n[a++]=s,this._idata[0]=a}add_iii(e,t,r){this._need(12);var i=this._idata,s=this._idata[0];i[s++]=e,i[s++]=t,i[s++]=r,this._idata[0]=s}add_iiffff(e,t,r,i,s,a){this._need(24);var n=this._idata[0],l=this._fdata;this._idata[n++]=e,this._idata[n++]=t,l[n++]=r,l[n++]=i,l[n++]=s,l[n++]=a,this._idata[0]=n}add_ifffff(e,t,r,i,s,a){this._need(24);var n=this._idata[0],l=this._fdata;this._idata[n++]=e,l[n++]=t,l[n++]=r,l[n++]=i,l[n++]=s,l[n++]=a,this._idata[0]=n}add_iffffff(e,t,r,i,s,a,n){this._need(28);var l=this._idata[0],o=this._fdata;this._idata[l++]=e,o[l++]=t,o[l++]=r,o[l++]=i,o[l++]=s,o[l++]=a,o[l++]=n,this._idata[0]=l}add_ifffiiiif(e,t,r,i,s,a,n,l,o){this._need(36);var h=this._idata,_=h[0],u=this._fdata;h[_++]=e,u[_++]=t,u[_++]=r,u[_++]=i,h[_++]=s,h[_++]=a,h[_++]=n,h[_++]=l,u[_++]=o,h[0]=_}add_ifffffiiiif(e,t,r,i,s,a,n,l,o,h,_){this._need(44);var u=this._idata,d=u[0],c=this._fdata;u[d++]=e,c[d++]=t,c[d++]=r,c[d++]=i,c[d++]=s,c[d++]=a,u[d++]=n,u[d++]=l,u[d++]=o,u[d++]=h,c[d++]=_,u[0]=d}add_iffffffif(e,t,r,i,s,a,n,l,o){this._need(36);var h=this._idata,_=h[0],u=this._fdata;h[_++]=e,u[_++]=t,u[_++]=r,u[_++]=i,u[_++]=s,u[_++]=a,u[_++]=n,h[_++]=l,u[_++]=o,h[0]=_}add_String(e){var t=e.byteLength;if(this._need(t+4),this._idata[this._idata[0]++]=t,0!=t){var r=new Uint8Array(e);this._byteArray.set(r,4*this._idata[0]),this._idata[0]+=t/4}}add_iffiiiifi(e,t,r,i,s,a,n,l,o){this._need(45);var h=this._idata[0],_=this._fdata;this._idata[h++]=e,_[h++]=t,_[h++]=r,this._idata[h++]=i,this._idata[h++]=s,this._idata[h++]=a,this._idata[h++]=n,_[h++]=l,this._idata[h++]=o,this._idata[0]=h}add_iiffiifi(e,t,r,i,s,a,n,l){this._need(32);var o=this._idata[0],h=this._fdata;this._idata[o++]=e,this._idata[o++]=t,h[o++]=r,h[o++]=i,this._idata[o++]=s,this._idata[o++]=a,h[o++]=n,this._idata[o++]=l,this._idata[0]=o}add_i_String(e,t){var r=window.conch.strTobufer(t);this._need(4+r.byteLength+4),this.add_i(e),this.add_String(r)}add_iiiifff(e,t,r,i,s,a,n){this._need(28);var l=this._idata[0],o=this._fdata;this._idata[l++]=e,this._idata[l++]=t,this._idata[l++]=r,this._idata[l++]=i,o[l++]=s,o[l++]=a,o[l++]=n,this._idata[0]=l}add_iiffiifi_String(e,t,r,i,s,a,n,l,o){var h=window.conch.strTobufer(o);this._need(32+h.byteLength+4),this.add_iiffiifi(e,t,r,i,s,a,n,l),this.add_String(h)}add_iiiifff_String_String(e,t,r,i,s,a,n,l,o){var h=window.conch.strTobufer(l),_=window.conch.strTobufer(o);this._need(28+(h.byteLength+4)+(_.byteLength+4)),this.add_iiiifff(e,t,r,i,s,a,n),this.add_String(h),this.add_String(_)}add_iiffffffffffffi(e,t,r,i,s,a,n,l,o,h,_,u,d,c,p){this._need(60);var f=this._idata,g=f[0],m=this._fdata;f[g++]=e,f[g++]=t,m[g++]=r,m[g++]=i,m[g++]=s,m[g++]=a,m[g++]=n,m[g++]=l,m[g++]=o,m[g++]=h,m[g++]=_,m[g++]=u,m[g++]=d,m[g++]=c,f[g++]=p,f[0]=g}add_iiffffffffiffffffffffi(e,t,r,i,s,a,n,l,o,h,_,u,d,c,p,f,g,m,T,x,y,E){this._need(88);var S=this._idata,b=this._fdata,v=S[0];S[v++]=e,S[v++]=t,b[v++]=r,b[v++]=i,b[v++]=s,b[v++]=a,b[v++]=n,b[v++]=l,b[v++]=o,b[v++]=h,S[v++]=_,b[v++]=u,b[v++]=d,b[v++]=c,b[v++]=p,b[v++]=f,b[v++]=g,b[v++]=m,b[v++]=T,b[v++]=x,b[v++]=y,S[v++]=E,S[0]=v}add_iiifffffffff(e,t,r,i,s,a,n,l,o,h,_,u){this._need(48);var d=this._idata,c=this._fdata,p=d[0];d[p++]=e,d[p++]=t,d[p++]=r,c[p++]=i,c[p++]=s,c[p++]=a,c[p++]=n,c[p++]=l,c[p++]=o,c[p++]=h,c[p++]=_,c[p++]=u,d[0]=p}add_iiffffiffi(e,t,r,i,s,a,n,l,o,h){this._need(40);let _=this._idata,u=this._fdata;var d=_[0];_[d++]=e,_[d++]=t,u[d++]=r,u[d++]=i,u[d++]=s,u[d++]=a,_[d++]=n,u[d++]=l,u[d++]=o,_[d++]=h,_[0]=d}add_iiifffffffff_ab_ab_ab(e,t,r,i,s,a,n,l,o,h,_,u,d,c,p){var f=this.getAlignLength(d),g=this.getAlignLength(c),m=this.getAlignLength(p);this._need(48+(f+4)+(g+4)+(m+4)),this.add_iiifffffffff(e,t,r,i,s,a,n,l,o,h,_,u),this.wab(d,d.byteLength,f,0),this.wab(c,c.byteLength,g,0),this.wab(p,p.byteLength,m,0)}wab(e,t,r,i){i=i||0,this._need(r+4),this._idata[this._idata[0]++]=t;var s=null;if(e instanceof Float32Array&&0==i)this._fdata.set(e,this._idata[0]);else{if(e instanceof ArrayBuffer)s=new Uint8Array(e,i,t);else{if(!e.buffer)return void console.log("not arraybuffer/dataview");s=new Uint8Array(e.buffer,i+e.byteOffset,t)}this._byteArray.set(s,4*this._idata[0])}this._idata[0]+=r/4}getAlignLength(e){return e.byteLength+3&4294967292}add_iif_ab(e,t,r,i){var s=this.getAlignLength(i);this._need(12+s+4),this.add_iff(e,t,r),this.wab(i,i.byteLength,s,0)}add_iffif_ab(e,t,r,i,s,a){var n=this.getAlignLength(a);this._need(20+n+4),this.add_iffif(e,t,r,i,s),this.wab(a,a.byteLength,n,0)}add_iffiiiifi_ab(e,t,r,i,s,a,n,l,o,h){var _=this.getAlignLength(h);this._need(45+_+4),this.add_iffiiiifi(e,t,r,i,s,a,n,l,o),this.wab(h,h.byteLength,_,0)}}Lr.ARRAY_BUFFER_TYPE_DATA=0,Lr.ARRAY_BUFFER_TYPE_CMD=1,Lr.ARRAY_BUFFER_REF_REFERENCE=0,Lr.ARRAY_BUFFER_REF_COPY=1,Lr.ENUM_TEXTALIGN_DEFAULT=0,Lr.ENUM_TEXTALIGN_CENTER=1,Lr.ENUM_TEXTALIGN_RIGHT=2;const Fr=new p(i.MAX_CLIP_SIZE,0,0,i.MAX_CLIP_SIZE,0,0);class Or{static __init__(){Or.MAXCLIPRECT=new g(0,0,i.MAX_CLIP_SIZE,i.MAX_CLIP_SIZE),Nr.DEFAULT=new Nr}drawImage(...e){}getImageData(...e){}measureText(e){return null}setTransform(...e){}$transform(e,t,r,i,s,a){}set material(e){this._shader2D.material=e}get material(){return this._shader2D.material}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,i){}_drawRect(e,t,r,i,s){s&&(this.fillStyle=s),this.fillRect(e,t,r,i,null)}drawTexture2(e,t,r,i,s,a){}transformByMatrix(e,t,r){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}saveTransform(e){this.save()}restoreTransform(e){this.restore()}drawRect(e,t,r,i,s,a,n){var l=this;null!=s&&(l.fillStyle=s,l.fillRect(e,t,r,i)),null!=a&&(l.strokeStyle=a,l.lineWidth=n,l.strokeRect(e,t,r,i))}alpha(e){this.globalAlpha*=e}_transform(e,t,r){this.translate(t,r),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-r)}_rotate(e,t,r){this.translate(t,r),this.rotate(e),this.translate(-t,-r)}_scale(e,t,r,i){this.translate(r,i),this.scale(e,t),this.translate(-r,-i)}_drawLine(e,t,r,i,s,a,n,l,o){this.beginPath(),this.strokeStyle=n,this.lineWidth=l,this.moveTo(e+r,t+i),this.lineTo(e+s,t+a),this.stroke()}_drawLines(e,t,r,i,s,a){this.beginPath(),this.strokeStyle=i,this.lineWidth=s,this.addPath(r.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,r,i,s){this.beginPath(),this.strokeStyle=i,this.lineWidth=s,this.moveTo(e+r[0],t+r[1]);for(var a=2,n=r.length;a<n;)this.quadraticCurveTo(e+r[a++],t+r[a++],e+r[a++],t+r[a++]);this.stroke()}_fillAndStroke(e,t,r,i=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&r>0&&(this.strokeStyle=t,this.lineWidth=r,this.stroke())}_drawCircle(e,t,r,i,s,a,n){this.beginPath(!0),this.arc(e,t,r,r,0,Or.PI2,!1,!0,40),this.closePath(),this._fillAndStroke(i,s,a)}_drawEllipse(e,t,r,i,s,a,n){this.beginPath(!0),this.arc(e,t,r,i,0,Or.PI2,!1,!0,40),this.closePath(),this._fillAndStroke(s,a,n)}_drawRoundRect(e,t,r,i,s,a,n,l,o,h,_){this.beginPath(!0);var u=this._getPath();0>=s?u.addPoint(e,t):this.arc(e+s,t+s,s,s,Math.PI,Math.PI+Or.HPI);let d=e+r-a;0>=a?u.addPoint(d,t):this.arc(d,t+a,a,a,Math.PI+Or.HPI,Or.PI2),d=e+r-l;let c=t+i-l;0>=l?u.addPoint(d,c):this.arc(d,c,l,l,0,Or.HPI),d=e+n,c=t+i-n,0>=n?u.addPoint(d,c):this.arc(d,c,n,n,Math.PI-Or.HPI,Math.PI),u.addPoint(e,t+s),this.closePath(),this._fillAndStroke(o,h,_)}_drawPie(e,t,r,i,s,a,n,l,o){this.beginPath(),this.moveTo(e,t),this.arc(e,t,r,r,i,s),this.closePath(),this._fillAndStroke(a,n,l)}_drawPoly(e,t,r,i,s,a,n,l){this.beginPath(),this.addPath(r.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(i,s,a,n)}_drawPath(e,t,r,i,s){this.beginPath();for(var a=0,n=r.length;a<n;a++){var l=r[a];switch(l[0]){case"moveTo":this.moveTo(e+l[1],t+l[2]);break;case"lineTo":this.lineTo(e+l[1],t+l[2]);break;case"arcTo":this.arcTo(e+l[1],t+l[2],e+l[3],t+l[4],l[5]);break;case"closePath":this.closePath()}}null!=i&&(this.fillStyle=i.fillStyle,this.fill()),null!=s&&(this.strokeStyle=s.strokeStyle,this.lineWidth=s.lineWidth||1,this.lineJoin=s.lineJoin,this.lineCap=s.lineCap,this.miterLimit=s.miterLimit,this.stroke())}static set2DRenderConfig(){if(!Or.const2DRenderCMD){const t=Or.const2DRenderCMD=x.renderEngine.createRenderStateComand();t&&(t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),re.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front))}Or.const2DRenderCMD&&Or.const2DRenderCMD.applyCMD(),Br.currentActive&&Br.currentActive._end(),J.currentActive&&J.currentActive.end(),x.renderEngine.viewport(0,0,j.width,j.height),x.renderEngine.scissorTest(!0),x.renderEngine.scissor(0,0,j.width,j.height)}constructor(){if(this._tmpMatrix=new p,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._id=++Or._COUNT,this._other=null,this._renderNextSubmitIndex=0,this._path=null,this._drawCount=1,this._width=i.MAX_CLIP_SIZE,this._height=i.MAX_CLIP_SIZE,this._renderCount=0,this._submits=null,this._curSubmit=null,this._submitKey=new Mt,this._pathMesh=null,this._triangleMesh=null,this.meshlist=[],this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Or.MAXCLIPRECT,this._globalClipMatrix=Fr.clone(),this._clipInCache=!1,this._clipInfoID=0,this._clipID_Gen=0,this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._targets=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new xr,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this.isMain=!1,this.clearColor=new Z,Or._contextcount++,Or._textRender=Or._textRender||new Rt,!this.defTexture){var t=new Y(2,2,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setPixelsData(new Uint8Array(16),!1,!1),t.lock=!0,this.defTexture=new ae(t)}this._lastTex=this.defTexture,this.clear()}clearBG(t,r,i,s){this.clearColor.r=t,this.clearColor.g=r,this.clearColor.b=i,this.clearColor.a=s,x.renderEngine.clearRenderTexture(e.RenderClearFlag.Color,this.clearColor,1)}_getSubmits(){return this._submits}_releaseMem(e=!1){if(this._submits){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear();for(var t=0,r=this._submits._length;t<r;t++)this._submits[t].releaseRender();var i;for(this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=Yt.RENDERBASE,this._path=null,this._save=null,t=0,i=this.meshlist.length;t<i;t++){this.meshlist[t].destroy()}this.meshlist.length=0,this.sprite=null,e||(this._targets&&this._targets.destroy(),this._targets=null)}}destroy(e=!1){--Or._contextcount,this.sprite=null,this._releaseMem(e),this._charSubmitCache&&this._charSubmitCache.destroy(),this._mesh.destroy(),e||(this._targets&&this._targets.destroy(),this._targets=null),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submits||(this._other=Nr.DEFAULT,this._curMat=p.create(),this._charSubmitCache=new Ir,this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(this._mesh),this._pathMesh=ir.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._triangleMesh=rr.getAMesh(this.isMain),this.meshlist.push(this._triangleMesh),this._submits=[],this._save=[gr.Create(this)],this._save.length=10,this._shader2D=new xr),this._submitKey.clear(),this._mesh.clearVB(),this._drawCount=1,this._other=Nr.DEFAULT,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=Or.MAXCLIPRECT,this._curSubmit=Yt.RENDERBASE,Yt.RENDERBASE._ref=16777215,Yt.RENDERBASE._numEle=0,this._shader2D.fillStyle=this._shader2D.strokeStyle=ur.DEFAULT;for(let e=0,t=this._submits._length;e<t;e++)this._submits[e].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(t,r){this._width==t&&this._height==r||(this._width=t,this._height=r,this._targets&&(this._targets.destroy(),this._targets=new J(t,r,e.RenderTargetFormat.R8G8B8A8,-1)),this.isMain&&(x.renderEngine.viewport(0,0,t,r),x.renderEngine.scissor(0,0,t,r),j.width=t,j.height=r)),0===t&&0===r&&this._releaseMem()}set asBitmap(t){if(t){let t=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");t&&t.width==this._width&&t.height==this._height||(t&&t.destroy(),this._targets=new J(this._width,this._height,e.RenderTargetFormat.R8G8B8A8))}else this._targets&&this._targets.destroy(),this._targets=null}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(e){this._shader2D.fillStyle.equal(e)||(pr.save(this,pr.TYPE_FILESTYLE,this._shader2D,!1),this._shader2D.fillStyle=ur.create(e),this._submitKey.other=-this._shader2D.fillStyle.toInt())}get fillStyle(){return this._shader2D.fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._shader2D.ALPHA&&(pr.save(this,pr.TYPE_ALPHA,this._shader2D,!1),this._shader2D.ALPHA=e)}get globalAlpha(){return this._shader2D.ALPHA}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),pr.save(this,pr.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),pr.save(this,pr.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){var t=re.TOINT[e];null==t||this._nBlendType===t||(pr.save(this,pr.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Yt.RENDERBASE,this._nBlendType=t)}get globalCompositeOperation(){return re.NAMES[this._nBlendType]}set strokeStyle(e){this._shader2D.strokeStyle.equal(e)||(pr.save(this,pr.TYPE_STROKESTYLE,this._shader2D,!1),this._shader2D.strokeStyle=ur.create(e),this._submitKey.other=-this._shader2D.strokeStyle.toInt())}get strokeStyle(){return this._shader2D.strokeStyle}translate(e,t){0===e&&0===t||(Tr.save(this),this._curMat._bTransform?(mr.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),pr.save(this,pr.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=gr.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var r=e-1;r>=0;r--){var i=this._save[r];if(i.restore(this),i.isSaveMark())return void(this._save._length=r)}t!=this._nBlendType&&(this._curSubmit=Yt.RENDERBASE)}}set font(e){this._other=this._other.make(),pr.save(this,pr.TYPE_FONT,this._other,!1)}fillText(e,t,r,i,s,a,n=0,l=""){Or._textRender.filltext(this,e,t,r,i,s,l,n,a)}drawText(e,t,r,i,s,a){Or._textRender.filltext(this,e,t,r,i,s,null,0,a)}strokeWord(e,t,r,i,s,a,n){Or._textRender.filltext(this,e,t,r,i,null,s,a,n)}fillBorderText(e,t,r,i,s,a,n,l){Or._textRender.filltext(this,e,t,r,i,s,a,n,l)}_fast_filltext(e,t,r,i,s,a,n,l){Or._textRender._fast_filltext(this,e,t,r,i,s,a,n,l)}filltext11(e,t,r,i,s,a,n,l){Or._textRender.filltext(this,e,t,r,i,s,a,n,l)}_fillRect(t,r,i,s,a){var n=this._curSubmit,l=n._key.submitType===Yt.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&this.isSameClipInfo(n)&&this._curSubmit.material==this.material;this._mesh.vertNum+4>Or._MAXVERTNUM&&(this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(this._mesh),l=!1),this.transformQuad(t,r,i,s,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,ae.NO_UV,a,!1),l||(n=this._curSubmit=wr.create(this,this._mesh,Dt.create(e.RenderSpriteData.Texture2D)),this._submits[this._submits._length++]=n,this._copyClipInfo(n,this._globalClipMatrix),!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1,n._renderType=Yt.TYPE_TEXTURE),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}fillRect(e,t,r,i,s){var a=s?ur.create(s):this._shader2D.fillStyle,n=this.mixRGBandAlpha(a.toInt());this._fillRect(e,t,r,i,n)}fillTexture(e,t,r,i,s,a,l,o){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,r,i,s,a,l.x,l.y,o):this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(t,r,i,s,a,n,l,o,h,_,u,d){var c=this._curSubmit;this._mesh.vertNum+4>Or._MAXVERTNUM&&(this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(this._mesh));var p=!0,f=!0;switch(h){case"repeat":break;case"repeat-x":f=!1;break;case"repeat-y":p=!1;break;case"no-repeat":p=f=!1}var g=this._temp4Points,m=0,T=0,x=0,y=0,E=0,S=0;if(_<0?(x=a,m=-_%r/r):x=a+_,u<0?(y=n,T=-u%i/i):y=n+u,E=a+l,S=n+o,!p&&(E=Math.min(E,a+_+r)),!f&&(S=Math.min(S,n+u+i)),!(E<a||S<n||x>E||y>S)){var b=(E-a-_)/r,v=(S-n-u)/i;if(this.transformQuad(x,y,E-x,S-y,0,this._curMat,this._transedPoints),g[0]=m,g[1]=T,g[2]=b,g[3]=T,g[4]=b,g[5]=v,g[6]=m,g[7]=v,!this.clipedOff(this._transedPoints)){var R=this._mixRGBandAlpha(d,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,g,R,!0);var A=Dt.create(e.RenderSpriteData.Texture2D);A.defines.addDefine(ct.FILLTEXTURE);var C=s.concat();we.tempVec4.setValue(C[0],C[1],C[2],C[3]),A.u_TexRange=we.tempVec4,c=this._curSubmit=wr.create(this,this._mesh,A),this._submits[this._submits._length++]=c,this._copyClipInfo(c,this._globalClipMatrix),c.shaderValue.textureHost=t,c._renderType=Yt.TYPE_TEXTURE,this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4}this.breakNextMerge()}}setColorFilter(e){pr.save(this,pr.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this._curSubmit=Yt.RENDERBASE}drawTexture(e,t,r,i,s,a=4294967295){this._drawTextureM(e,t,r,i,s,null,1,null,a)}drawTextures(e,t,r,i,s){if(e._getSource())for(var a=t.length/2,l=0,o=e.bitmap.id,h=0;h<a;h++){const a="number"==typeof s[h]?s[h]:4294967295;this._inner_drawTexture(e,o,t[l++]+r,t[l++]+i,0,0,null,null,1,!1,a)}else this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(e,t,r,i,s,a,n,l,o){var h=this.sprite;return!!e._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,r,i,s,a,l,n,!1,o)}_drawRenderTexture(e,t,r,i,s,a,n,l,o=4294967295){return this._inner_drawTexture(e,-1,t,r,i,s,a,l,n,!1,o)}submitDebugger(){this._submits[this._submits._length++]=wt.create([],(function(){}),this)}_copyClipInfo(e,t){var r=e.shaderValue.clipMatDir;r.x=t.a,r.y=t.b,r.z=t.c,r.w=t.d,e.shaderValue.clipMatDir=r;var i=e.shaderValue.clipMatPos;i.x=t.tx,i.y=t.ty,e.shaderValue.clipMatPos=i,e.clipInfoID=this._clipInfoID,this._clipInCache&&(e.shaderValue.clipOff.x=1,e.shaderValue.clipOff=e.shaderValue.clipOff)}isSameClipInfo(e){return e.clipInfoID===this._clipInfoID}_useNewTex2DSubmit(t,r){this._mesh.vertNum+r>Or._MAXVERTNUM&&(this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(this._mesh));var i=wr.create(this,this._mesh,Dt.create(e.RenderSpriteData.Texture2D));this._submits[this._submits._length++]=this._curSubmit=i,i.shaderValue.textureHost=t,this._copyClipInfo(i,this._globalClipMatrix)}_drawTexRect(e,t,r,i,s){this.transformQuad(e,t,r,i,this._italicDeg,this._curMat,this._transedPoints);var a=this._transedPoints;a[0]=a[0]+.5|0,a[1]=a[1]+.5|0,a[2]=a[2]+.5|0,a[3]=a[3]+.5|0,a[4]=a[4]+.5|0,a[5]=a[5]+.5|0,a[6]=a[6]+.5|0,a[7]=a[7]+.5|0,this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,s,this._fillColor,!0),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}drawCallOptimize(e){return this._charSubmitCache.enable(e,this),e}_inner_drawTexture(t,r,i,s,a,n,l,o,h,_,u){if(a<=0||n<=0)return!1;var d=this._curSubmit._key;if(o=o||t._uv,d.submitType===Yt.KEY_TRIANGLES&&d.other===r){var c=this._drawTexToDrawTri_Vert;c[0]=i,c[1]=s,c[2]=i+a,c[3]=s,c[4]=i+a,c[5]=s+n,c[6]=i,c[7]=s+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=o[0],p[1]=o[1],p[2]=o[2],p[3]=o[3],p[4]=o[4],p[5]=o[5],p[6]=o[6],p[7]=o[7],this.drawTriangles(t,0,0,c,p,this._drawTexToDrawTri_Index,l||this._curMat,h,null,null),this._drawTriUseAbsMatrix=!1,!0}var f=this._mesh,g=this._curSubmit,m=_?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(i,s,a||t.width,n||t.height,this._italicDeg,l||this._curMat,m),this.drawTexAlign){var T=Math.round;m[0]=T(m[0]),m[1]=T(m[1]),m[2]=T(m[2]),m[3]=T(m[3]),m[4]=T(m[4]),m[5]=T(m[5]),m[6]=T(m[6]),m[7]=T(m[7]),this.drawTexAlign=!1}var x=this._mixRGBandAlpha(u,this._shader2D.ALPHA*h);if(_)return this._charSubmitCache.add(this,t,r,m,o,x),!0;this._drawCount++;var y=r>=0&&d.submitType===Yt.KEY_DRAWTEXTURE&&d.other===r&&this.isSameClipInfo(g)&&this._curSubmit.material==this.material;return this._lastTex=t,f.vertNum+4>Or._MAXVERTNUM&&(f=this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(f),y=!1),f.addQuad(m,o,x,!0),y||(this._submits[this._submits._length++]=this._curSubmit=g=wr.create(this,f,Dt.create(e.RenderSpriteData.Texture2D)),g.shaderValue.textureHost=t,g._key.other=r,this._copyClipInfo(g,this._globalClipMatrix)),g._numEle+=6,f.indexNum+=6,f.vertNum+=4,!0}transform4Points(e,t,r){var i=t.tx,s=t.ty,a=t.a,n=t.b,l=t.c,o=t.d,h=e[0],_=e[1],u=e[2],d=e[3],c=e[4],p=e[5],f=e[6],g=e[7];t._bTransform?(r[0]=h*a+_*l+i,r[1]=h*n+_*o+s,r[2]=u*a+d*l+i,r[3]=u*n+d*o+s,r[4]=c*a+p*l+i,r[5]=c*n+p*o+s,r[6]=f*a+g*l+i,r[7]=f*n+g*o+s):(r[0]=h+i,r[1]=_+s,r[2]=u+i,r[3]=d+s,r[4]=c+i,r[5]=p+s,r[6]=f+i,r[7]=g+s)}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,r,i,s,a,n){var l=0;0!=s&&(l=Math.tan(s*Math.PI/180)*i);var o=e+r,h=t+i,_=a.tx,u=a.ty,d=a.a,c=a.b,p=a.c,f=a.d,g=e+l,m=t,T=o+l,x=t,y=o,E=h,S=e,b=h;a._bTransform?(n[0]=g*d+m*p+_,n[1]=g*c+m*f+u,n[2]=T*d+x*p+_,n[3]=T*c+x*f+u,n[4]=y*d+E*p+_,n[5]=y*c+E*f+u,n[6]=S*d+b*p+_,n[7]=S*c+b*f+u):(n[0]=g+_,n[1]=m+u,n[2]=T+_,n[3]=x+u,n[4]=y+_,n[5]=E+u,n[6]=S+_,n[7]=b+u)}pushRT(){this.addRenderObject(wt.create(null,J.pushRT,this))}popRT(){this.addRenderObject(wt.create(null,J.popRT,this)),this.breakNextMerge()}useRT(e){this.addRenderObject(wt.create([e],(function(e){if(!e)throw"error useRT";e.start(),e.clear(0,0,0,0)}),this)),this.breakNextMerge()}RTRestore(e){this.addRenderObject(wt.create([e],(function(e){e.restore()}),this)),this.breakNextMerge()}breakNextMerge(){this._curSubmit=Yt.RENDERBASE}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(e,t,r,i,s,a,n,l,o,h,_,u=4294967295){var d,c=this._curMat;if(h&&(d=this.globalCompositeOperation,this.globalCompositeOperation=h),!a)return this._drawTextureM(e,t+n,r+l,i,s,c,o,_,u),void(h&&(this.globalCompositeOperation=d));var f=this._tmpMatrix;f.a=a.a,f.b=a.b,f.c=a.c,f.d=a.d,f.tx=a.tx+n,f.ty=a.ty+l,f._bTransform=a._bTransform,a&&c._bTransform?(p.mul(f,c,f),(a=f)._bTransform=!0):(f.tx+=c.tx,f.ty+=c.ty,a=f),this._drawTextureM(e,t,r,i,s,a,o,_,u),h&&(this.globalCompositeOperation=d)}_flushToTarget(e,t){j.worldScissorTest=!1,x.renderEngine.scissorTest(!1);var r=j.worldAlpha,i=j.worldMatrix4,s=j.worldMatrix;j.worldShaderDefines,j.worldMatrix=p.EMPTY,j.restoreTempArray(),j.worldMatrix4=j.TEMPMAT4_ARRAY,j.worldAlpha=1,z.activeShader=null,t.start(),e._submits._length>0&&t.clear(0,0,0,0),e._curSubmit=Yt.RENDERBASE,e.flush(),e.clear(),t.restore(),e._curSubmit=Yt.RENDERBASE,z.activeShader=null,j.worldAlpha=r,j.worldMatrix4=i,j.worldMatrix=s}drawCanvas(e,t,r,i,s){if(e){var a,n=e.context;if(n._targets)n._submits._length>0&&(a=wt.create([n,n._targets],this._flushToTarget,this),this._submits[this._submits._length++]=a),this._drawRenderTexture(n._targets,t,r,i,s,null,1,J.flipyuv),this._curSubmit=Yt.RENDERBASE;else{var l=e;l.touches&&l.touches.forEach((function(e){e.touch()})),a=Dr.create(e,this._shader2D.ALPHA,this._shader2D.filters),this._submits[this._submits._length++]=a,a._key.clear();var o=a._matrix;this._curMat.copyTo(o);var h=o.tx,_=o.ty;o.tx=o.ty=0,o.transformPoint(f.TEMP.setTo(t,r)),o.translate(f.TEMP.x+h,f.TEMP.y+_),p.mul(l.invMat,o,o),this._curSubmit=Yt.RENDERBASE}}}drawTarget(e,t,r,i,s,a,n,l=null,o=-1,h=4294967295){if(this._drawCount++,this._mesh.vertNum+4>Or._MAXVERTNUM&&(this._mesh=tr.getAMesh(this.isMain),this.meshlist.push(this._mesh)),this.transformQuad(t,r,i,s,0,a||this._curMat,this._transedPoints),!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,l||ae.DEF_UV,h,!0);var _=this._curSubmit=Mr.create(this,this._mesh,n,e);return _.blendType=-1==o?this._nBlendType:o,this._copyClipInfo(_,this._globalClipMatrix),_._numEle=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4,this._submits[this._submits._length++]=_,this._curSubmit=Yt.RENDERBASE,!0}return this._curSubmit=Yt.RENDERBASE,!1}drawTriangles(t,r,i,s,a,l,o,h,_,u=4294967295){if(t._getSource()){var d=null;_&&(d=this.globalCompositeOperation,this.globalCompositeOperation=_),this._drawCount++;var c=this._tmpMatrix,f=this._triangleMesh,g=t.bitmap,m=this._curSubmit._key,T=m.submitType===Yt.KEY_TRIANGLES&&m.other===g.id&&m.blendShader==this._nBlendType&&this._curSubmit.material==this.material;if(f.vertNum+s.length/2>Or._MAXVERTNUM&&(f=this._triangleMesh=rr.getAMesh(this.isMain),this.meshlist.push(f),T=!1),!T){var x=this._curSubmit=wr.create(this,f,Dt.create(e.RenderSpriteData.Texture2D));x.shaderValue.textureHost=t,x._renderType=Yt.TYPE_TEXTURE,x._key.submitType=Yt.KEY_TRIANGLES,x._key.other=g.id,this._copyClipInfo(x,this._globalClipMatrix),this._submits[this._submits._length++]=x}var y=this._mixRGBandAlpha(u,this._shader2D.ALPHA*h);this._drawTriUseAbsMatrix?f.addData(s,a,l,o,y):(o?(c.a=o.a,c.b=o.b,c.c=o.c,c.d=o.d,c.tx=o.tx+r,c.ty=o.ty+i):(c.a=1,c.b=0,c.c=0,c.d=1,c.tx=r,c.ty=i),p.mul(c,this._curMat,c),f.addData(s,a,l,c||this._curMat,y)),this._curSubmit._numEle+=l.length,_&&(this.globalCompositeOperation=d)}else this.sprite&&n.systemTimer.callLater(this,this._repaintSprite)}transform(e,t,r,i,s,a){mr.save(this),p.mul(p.TEMP.setTo(e,t,r,i,s,a),this._curMat,this._curMat),this._curMat._checkTransform()}_transformByMatrix(e,t,r){e.setTranslate(t,r),p.mul(e,this._curMat,this._curMat),e.setTranslate(0,0),this._curMat._bTransform=!0}setTransformByMatrix(e){e.copyTo(this._curMat)}rotate(e){mr.save(this),this._curMat.rotateEx(e)}scale(e,t){mr.save(this),this._curMat.scaleEx(e,t)}clipRect(e,t,r,s,a){if(fr.save(this),this._clipRect==Or.MAXCLIPRECT?this._clipRect=new g(e,t,r,s):(this._clipRect.width=r,this._clipRect.height=s,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,a)Fr.copyTo(this._globalClipMatrix);else{var n=this._globalClipMatrix,l=n.tx,o=n.ty,h=l+n.a,_=o+n.d;if(this._clipRect.width>=i.MAX_CLIP_SIZE?(n.a=n.d=i.MAX_CLIP_SIZE,n.b=n.c=n.tx=n.ty=0):(this._curMat._bTransform?(n.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,n.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,n.a=this._clipRect.width*this._curMat.a,n.b=this._clipRect.width*this._curMat.b,n.c=this._clipRect.height*this._curMat.c,n.d=this._clipRect.height*this._curMat.d):(n.tx=this._clipRect.x+this._curMat.tx,n.ty=this._clipRect.y+this._curMat.ty,n.a=this._clipRect.width,n.b=n.c=0,n.d=this._clipRect.height),this._incache&&(this._clipInCache=!0)),n.a>0&&n.d>0){var u=n.tx+n.a,d=n.ty+n.d;u<=l||d<=o||n.tx>=h||n.ty>=_?(n.a=-.1,n.d=-.1):(n.tx<l&&(n.a-=l-n.tx,n.tx=l),u>h&&(n.a-=u-h),n.ty<o&&(n.d-=o-n.ty,n.ty=o),d>_&&(n.d-=d-_),n.a<=0&&(n.a=-.1),n.d<=0&&(n.d=-.1))}}}addRenderObject(e){this._submits[this._submits._length++]=e}submitElement(e,t){this.isMain;var r=this._submits,i=r._length;t<0&&(t=r._length);for(var s=Yt.RENDERBASE;e<t;)this._renderNextSubmitIndex=e+1,r[e]!==Yt.RENDERBASE?(Yt.preRender=s,e+=(s=r[e]).renderSubmit()):e++;return i}flush(){this._clipID_Gen=0;var e=this.submitElement(0,this._submits._length);this._path&&this._path.reset(),yr.instance&&yr.getInstance().reset(),this._curSubmit=Yt.RENDERBASE;for(var t=0,r=this.meshlist.length;t<r;t++){var i=this.meshlist[t];i.canReuse?i.releaseMesh():i.destroy()}return this.meshlist.length=0,this._mesh=tr.getAMesh(this.isMain),this._pathMesh=ir.getAMesh(this.isMain),this._triangleMesh=rr.getAMesh(this.isMain),this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh),this._flushCnt++,this._flushCnt%60==0&&this.isMain&&Rt.textRenderInst&&Rt.textRenderInst.GC(),e}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,r,i,s){let a=e.length;for(let t=0;t<a-1;t+=2)e[t]+=i,e[t+1]+=s;t&&a>5&&(e[a-2]!=e[0]||e[a-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,r)}fill(){var e=this._curMat,t=this._getPath(),r=this._curSubmit;r._key.submitType===Yt.KEY_VG&&r._key.blendShader===this._nBlendType&&this.isSameClipInfo(r)&&this._curSubmit.material==this.material||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var i,s=this.mixRGBandAlpha(this.fillStyle.toInt()),a=0,n=0,l=t.paths.length;n<l;n++){var o=t.paths[n],h=o.path.length/2;if(!(h<3||3==h&&!o.convex)){var _,u,d,c,p=o.path.concat(),f=0;if(e._bTransform)for(f=0;f<h;f++)u=(_=f<<1)+1,d=p[_],c=p[u],p[_]=e.a*d+e.c*c+e.tx,p[u]=e.b*d+e.d*c+e.ty;else for(f=0;f<h;f++)u=(_=f<<1)+1,d=p[_],c=p[u],p[_]=d+e.tx,p[u]=c+e.ty;this._pathMesh.vertNum+h>Or._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._pathMesh=ir.getAMesh(this.isMain),this._curSubmit=this.addVGSubmit(this._pathMesh));var g=this._pathMesh.vertNum;if(o.convex){var m=h-2;i=new Array(3*m);for(var T=0,x=0;x<m;x++)i[T++]=g,i[T++]=x+1+g,i[T++]=x+2+g}else if(i=vr.earcut(p,null,2),g>0)for(var y=0;y<i.length;y++)i[y]+=g;this._pathMesh.addVertAndIBToMesh(this,p,s,i),a+=i.length}}this._curSubmit._numEle+=a}addVGSubmit(t){var r=Cr.createShape(this,t,0,Dt.create(e.RenderSpriteData.Primitive));return r._key.submitType=Yt.KEY_VG,this._submits[this._submits._length++]=r,this._copyClipInfo(r,this._globalClipMatrix),r}stroke(){if(this.lineWidth>0){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),r=this._curSubmit;r._key.submitType===Yt.KEY_VG&&r._key.blendShader===this._nBlendType&&this.isSameClipInfo(r)&&this._curSubmit.material==this.material||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var i=0,s=0,a=t.paths.length;s<a;s++){var n=t.paths[s];if(!(n.path.length<=0)){var l=[],o=[],h=2*n.path.length;if(!(h<2)){this._pathMesh.vertNum+h>Or._MAXVERTNUM&&(this._curSubmit._numEle+=i,i=0,this._pathMesh=ir.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._curSubmit=this.addVGSubmit(this._pathMesh)),Sr.createLine2(n.path,l,this.lineWidth,this._pathMesh.vertNum,o,n.loop);var _,u,d,c,p=o.length/2,f=this._curMat,g=0;if(f._bTransform)for(g=0;g<p;g++)u=(_=g<<1)+1,d=o[_],c=o[u],o[_]=f.a*d+f.c*c+f.tx,o[u]=f.b*d+f.d*c+f.ty;else for(g=0;g<p;g++)u=(_=g<<1)+1,d=o[_],c=o[u],o[_]=d+f.tx,o[u]=c+f.ty;this._pathMesh.addVertAndIBToMesh(this,o,e,l),i+=l.length}}}this._curSubmit._numEle+=i}}moveTo(e,t){var r=this._getPath();r.newPath(),r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t)}lineTo(e,t){var r=this._getPath();Math.abs(e-r._lastOriX)<.001&&Math.abs(t-r._lastOriY)<.001||(r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t))}arcTo(e,t,r,i,s){var a=0,n=0,l=0,o=this._path._lastOriX-e,h=this._path._lastOriY-t,_=Math.sqrt(o*o+h*h);if(!(_<=1e-6)){var u=o/_,d=h/_,c=r-e,p=i-t,f=c*c+p*p,g=Math.sqrt(f);if(!(g<=1e-6)){var m=c/g,T=p/g,x=u+m,y=d+T,E=Math.sqrt(x*x+y*y);if(!(E<=1e-6)){var S=x/E,b=y/E,v=Math.acos(S*u+b*d),R=Math.PI/2-v,A=(_=s*Math.tan(R))*u+e,C=_*d+t,D=Math.sqrt(_*_+s*s),M=e+S*D,w=t+b*D,I=0,P=0;if(u*T-d*m>=0){var B=2*R/Or.SEGNUM;I=Math.sin(B),P=Math.cos(B)}else B=2*-R/Or.SEGNUM,I=Math.sin(B),P=Math.cos(B);var L=this._path._lastOriX,F=this._path._lastOriY,O=A,N=C;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(N-this._path._lastOriY)>.1)&&(n=O,l=N,L=O,F=N,this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l));var U=A-M,G=C-w;for(a=0;a<Or.SEGNUM;a++){var k=U*P+G*I,V=-U*I+G*P;n=k+M,l=V+w,(Math.abs(L-n)>.1||Math.abs(F-l)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l),L=n,F=l),U=k,G=V}}}}}arc(e,t,r,i,s,a,n=!1,l=!0,o=10){var h,_,u=0,d=0,c=0,p=0,f=0;if(d=a-s,n)if(Math.abs(d)>=2*Math.PI)d=2*-Math.PI;else for(;d>0;)d-=2*Math.PI;else if(Math.abs(d)>=2*Math.PI)d=2*Math.PI;else for(;d<0;)d+=2*Math.PI;var g=this.getMatScaleX(),m=this.getMatScaleY(),T=r*(g>m?g:m),x=2*Math.PI*T;_=0|Math.max(x/o,o);var y=this._getPath();for(h=0;h<=_;h++)u=s+d*(h/_),c=Math.cos(u),f=t+Math.sin(u)*i,(p=e+c*r)==this._path._lastOriX&&f==this._path._lastOriY||y.addPoint(p,f);c=Math.cos(a),f=t+Math.sin(a)*i,(p=e+c*r)==this._path._lastOriX&&f==this._path._lastOriY||y.addPoint(p,f)}quadraticCurveTo(e,t,r,i){for(var s=hr.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,e,t,r,i],30,2),a=0,n=s.length/2;a<n;a++)this.lineTo(s[2*a],s[2*a+1]);this.lineTo(r,i)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._shader2D.ALPHA)}_mixRGBandAlpha(e,t){if(t>=1)return e;var r=(4278190080&e)>>>24;return 0!=r?r*=t:r=255*t,16777215&e|r<<24}strokeRect(e,t,r,i,s){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,r+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t-n+i,r+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t+n,this.lineWidth,i-this.lineWidth,a),this._fillRect(e-n+r,t+n,this.lineWidth,i-this.lineWidth,a)}}clip(){}drawParticle(e,t,r){r.x=e,r.y=t,this._submits[this._submits._length++]=r}_getPath(){return this._path||(this._path=new dr)}get canvas(){return this._canvas}_fillTexture_h(e,t,r,i,s,a,n,l,o){i<=0&&console.error("_fillTexture_h error: oriw must>0");for(var h=a,_=Math.floor(l/i),u=l%i,d=0;d<_;d++)this._inner_drawTexture(e,t,h,n,i,s,this._curMat,r,1,!1,o),h+=i;if(u>0){var c=r[2]-r[0],p=r[0]+c*(u/i),f=Or.tmpuv1;f[0]=r[0],f[1]=r[1],f[2]=p,f[3]=r[3],f[4]=p,f[5]=r[5],f[6]=r[6],f[7]=r[7],this._inner_drawTexture(e,t,h,n,u,s,this._curMat,f,1,!1,o)}}_fillTexture_v(e,t,r,i,s,a,n,l,o){s<=0&&console.error("_fillTexture_v error: orih must>0");for(var h=n,_=Math.floor(l/s),u=l%s,d=0;d<_;d++)this._inner_drawTexture(e,t,a,h,i,s,this._curMat,r,1,!1,o),h+=s;if(u>0){var c=r[7]-r[1],p=r[1]+c*(u/s),f=Or.tmpuv1;f[0]=r[0],f[1]=r[1],f[2]=r[2],f[3]=r[3],f[4]=r[4],f[5]=p,f[6]=r[6],f[7]=p,this._inner_drawTexture(e,t,a,h,i,u,this._curMat,f,1,!1,o)}}drawTextureWithSizeGrid(e,t,r,i,s,a,n,l,o){if(!e._getSource())return;t+=n,r+=l;var h=e.uv,_=e.bitmap.width,u=e.bitmap.height;let d=e.offsetX,c=e.offsetY,p=e.sourceWidth,f=e.sourceHeight,g=p-e.width-d,m=f-e.height-c;var T=a[0];0>(T-=c)&&(c+=T,T=0),r+=c;var x=a[3];0>(x-=d)&&(d+=x,x=0),t+=d;var y=a[1];0>(y-=g)&&(g+=y,y=0);var E=a[2];0>(E-=m)&&(m+=E,E=0),i-=d+g,s-=c+m;var S=a[4];i==e.width&&(x=y=0),s==e.height&&(T=E=0);var b=T/u,v=x/_,R=y/_,A=E/u,C=e.bitmap.id,D=this._curMat,M=this._tempUV,w=1,I=1;x+y>i&&(w=i/(x+y)),T+E>s&&(I=s/(T+E)),x*=w,y*=w,T*=I,E*=I;var P=h[0],B=h[1],L=h[4],F=h[5],O=P,N=B,U=L,G=F;if(x&&T&&(U=P+v,G=B+b,M[0]=P,M[1]=B,M[2]=U,M[3]=B,M[4]=U,M[5]=G,M[6]=P,M[7]=G,this._inner_drawTexture(e,C,t,r,x,T,D,M,1,!1,o)),y&&T&&(O=L-R,N=B,U=L,G=B+b,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,this._inner_drawTexture(e,C,i-y+t,0+r,y,T,D,M,1,!1,o)),x&&E&&(O=P,N=F-A,U=P+v,G=F,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,this._inner_drawTexture(e,C,0+t,s-E+r,x,E,D,M,1,!1,o)),y&&E&&(O=L-R,N=F-A,U=L,G=F,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,this._inner_drawTexture(e,C,i-y+t,s-E+r,y,E,D,M,1,!1,o)),T&&(O=P+v,N=B,U=L-R,G=B+b,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,S?this._fillTexture_h(e,C,M,e.width-x-y,T,x+t,r,i-x-y,o):this._inner_drawTexture(e,C,x+t,r,i-x-y,T,D,M,1,!1,o)),E&&(O=P+v,N=F-A,U=L-R,G=F,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,S?this._fillTexture_h(e,C,M,e.width-x-y,E,x+t,s-E+r,i-x-y,o):this._inner_drawTexture(e,C,x+t,s-E+r,i-x-y,E,D,M,1,!1,o)),x&&(O=P,N=B+b,U=P+v,G=F-A,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,S?this._fillTexture_v(e,C,M,x,e.height-T-E,t,T+r,s-T-E,o):this._inner_drawTexture(e,C,t,T+r,x,s-T-E,D,M,1,!1,o)),y&&(O=L-R,N=B+b,U=L,G=F-A,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,S?this._fillTexture_v(e,C,M,y,e.height-T-E,i-y+t,T+r,s-T-E,o):this._inner_drawTexture(e,C,i-y+t,T+r,y,s-T-E,D,M,1,!1,o)),O=P+v,N=B+b,U=L-R,G=F-A,M[0]=O,M[1]=N,M[2]=U,M[3]=N,M[4]=U,M[5]=G,M[6]=O,M[7]=G,S){var k=Or.tmpUVRect;k[0]=O,k[1]=N,k[2]=U-O,k[3]=G-N,this._fillTexture(e,e.width-x-y,e.height-T-E,k,x+t,T+r,i-x-y,s-T-E,"repeat",0,0,o)}else this._inner_drawTexture(e,C,x+t,T+r,i-x-y,s-T-E,D,M,1,!1,o)}addRenderObject3D(e){this._curSubmit=Yt.RENDERBASE,this.addRenderObject(e)}}Or._SUBMITVBSIZE=32e3,Or._MAXVERTNUM=65535,Or.MAXCLIPRECT=null,Or._COUNT=0,Or.SEGNUM=32,Or._contextcount=0,Or.PI2=2*Math.PI,Or.HPI=.5*Math.PI,Or._textRender=null,Or.tmpuv1=[0,0,0,0,0,0,0,0],Or.tmpUV=[0,0,0,0,0,0,0,0],Or.tmpUVRect=[0,0,0,0];class Nr{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===Nr.DEFAULT?new Nr:this}}window.conch&&!window.conchConfig.conchWebGL&&(Or=Lr);class Ur extends w{get source(){return this._source}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}_getSource(){return this._source}constructor(e=!1){super(),this._source=e?bt.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new Or:this._ctx=this._source.getContext(l.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(e){this._ctx=e}getContext(e,t=null){return this.context}getMemSize(){return 0}size(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var t=new Y(this.source.width,this.source.height,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setImageData(this.source,!1,!1),this._texture=new ae(t)}return this._texture}toBase64(e,t){if(this._source){if(l.isConch){var r=window,i=this._ctx._targets.sourceWidth,s=this._ctx._targets.sourceHeight,a=this._ctx._targets.getData(0,0,i,s);return r.conchToBase64FlipY?r.conchToBase64FlipY(e,t,a.buffer,i,s):r.conchToBase64(e,t,a.buffer,i,s)}return this._source.toDataURL(e,t)}return null}toBase64Async(e,t,r){var i=this._ctx._targets.sourceWidth,s=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,i,s,(function(a){let n=window;var l=n.conchToBase64FlipY?n.conchToBase64FlipY(e,t,a.buffer,i,s):n.conchToBase64(e,t,a.buffer,i,s);r(l)}))}}class Gr{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){o.recover("BoundsStyle",this.reset())}static create(){return o.getItemByClass("BoundsStyle",Gr)}}class kr{constructor(){this.reset()}needBitmapCache(){return this.cacheForFilters||!!this.mask}needEnableCanvasRender(){return"none"!=this.userSetCache||this.cacheForFilters||!!this.mask}releaseContext(){if(this.canvas&&this.canvas.size){o.recover("CacheCanvas",this.canvas),this.canvas.size(0,0);try{this.canvas.width=0,this.canvas.height=0}catch(e){}}this.canvas=null}createContext(){if(!this.canvas){this.canvas=o.getItem("CacheCanvas")||new Ur(!1);var e=this.canvas.context;e||(e=this.canvas.getContext("2d"))}}releaseFilterCache(){var e=this.filterCache;e&&(e.destroy(),e.recycle(),this.filterCache=null)}recover(){this!==kr.EMPTY&&o.recover("SpriteCache",this.reset())}reset(){return this.releaseContext(),this.releaseFilterCache(),this.cacheAs="none",this.enableCanvasRender=!1,this.userSetCache="none",this.cacheForFilters=!1,this.staticCache=!1,this.reCache=!0,this.mask=null,this.maskParent=null,this.filterCache=null,this.filters=null,this.hasGlowFilter=!1,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}static create(){return o.getItemByClass("SpriteCache",kr)}_calculateCacheRect(e,t,r,i){var s,a=e._cacheStyle;if(a.cacheRect||(a.cacheRect=g.create()),"bitmap"===t?((s=e.getSelfBounds()).width=s.width+2*kr.CANVAS_EXTEND_EDGE,s.height=s.height+2*kr.CANVAS_EXTEND_EDGE,s.x=s.x-e.pivotX,s.y=s.y-e.pivotY,s.x=s.x-kr.CANVAS_EXTEND_EDGE,s.y=s.y-kr.CANVAS_EXTEND_EDGE,s.x=Math.floor(s.x+r)-r,s.y=Math.floor(s.y+i)-i,s.width=Math.floor(s.width),s.height=Math.floor(s.height),a.cacheRect.copyFrom(s)):a.cacheRect.setTo(-e._style.pivotX,-e._style.pivotY,1,1),s=a.cacheRect,e._style.scrollRect){var n=e._style.scrollRect;s.x-=n.x,s.y-=n.y}return kr._scaleInfo.setTo(1,1),kr._scaleInfo}}kr.EMPTY=new kr,kr._scaleInfo=new f,kr.CANVAS_EXTEND_EDGE=16;class Vr{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==Vr.EMPTY&&o.recover("SpriteStyle",this.reset())}static create(){return o.getItemByClass("SpriteStyle",Vr)}}Vr.EMPTY=new Vr;class Wr{static create(e){var t=o.getItemByClass("AlphaCmd",Wr);return t.alpha=e,t}recover(){o.recover("AlphaCmd",this)}run(e,t,r){e.alpha(this.alpha)}get cmdID(){return Wr.ID}}Wr.ID="Alpha";class Hr{constructor(){this.lineWidth=0}static create(e,t,r,i,s,a){var n=o.getItemByClass("DrawCircleCmd",Hr);return n.x=e,n.y=t,n.radius=r,n.fillColor=i,n.lineColor=s,n.lineWidth=a,n}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawCircleCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawCircle(this.x*s+t,this.y*a+r,this.radius*Math.min(s,a)-i,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+r,this.radius-i,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Hr.ID}getBoundPoints(e){return g._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?e:null)}}Hr.ID="DrawCircle",t.regClass("DrawCircleCmd",Hr);class Xr{static create(e,t,r,i,s){var a=o.getItemByClass("DrawCurvesCmd",Xr);return a.x=e,a.y=t,a.points=r,a.lineColor=i,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,o.recover("DrawCurvesCmd",this)}run(e,t,r){this.points&&e.drawCurves(this.x+t,this.y+r,this.points,this.lineColor,this.lineWidth)}get cmdID(){return Xr.ID}getBoundPoints(e){return hr.I.getBezierPoints(this.points)}}Xr.ID="DrawCurves",t.regClass("DrawCurvesCmd",Xr);class Yr{constructor(){this.color=4294967295}static create(e,t,r,i,s,a){null==i&&(i=e.sourceWidth),null==s&&(s=e.sourceHeight);let n=i/e.sourceWidth,l=s/e.sourceHeight;i=e.width*n,s=e.height*l,t+=e.offsetX*n,r+=e.offsetY*l;var h=o.getItemByClass("DrawImageCmd",Yr);return h.texture=e,e._addReference(),h.x=t,h.y=r,h.width=i,h.height=s,h.color=null!=a?Bt.create(a).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,o.recover("DrawImageCmd",this)}run(e,t,r){this.texture&&e.drawTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.color)}get cmdID(){return Yr.ID}}Yr.ID="DrawImage";class zr{constructor(){this.lineWidth=0}static create(e,t,r,i,s,a){var n=o.getItemByClass("DrawLineCmd",zr);return n.fromX=e,n.fromY=t,n.toX=r,n.toY=i,n.lineColor=s,n.lineWidth=a,n}recover(){o.recover("DrawLineCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawLine(t,r,this.fromX*s+i,this.fromY*a+i,this.toX*s+i,this.toY*a+i,this.lineColor,this.lineWidth,0)}else e._drawLine(t,r,this.fromX+i,this.fromY+i,this.toX+i,this.toY+i,this.lineColor,this.lineWidth,0)}get cmdID(){return zr.ID}getBoundPoints(e){let t;jr.length=0,t=.5*this.lineWidth;let r=this.fromX,i=this.fromY,s=this.toX,a=this.toY;return this.percent&&(r*=e.width,i*=e.height,s*=e.width,a*=e.height),r==s?jr.push(r+t,i,s+t,a,r-t,i,s-t,a):i==a?jr.push(r,i+t,s,a+t,r,i-t,s,a-t):jr.push(r,i,s,a),jr}}zr.ID="DrawLine";const jr=[];t.regClass("DrawLineCmd",zr);class qr{constructor(){this.lineWidth=0}static create(e,t,r,i,s){var a=o.getItemByClass("DrawLinesCmd",qr);return a.x=e,a.y=t,a.points=r,a.lineColor=i,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,o.recover("DrawLinesCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+i+t,this.y+i+r,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return qr.ID}}qr.ID="DrawLines",t.regClass("DrawLinesCmd",qr);class Kr{static create(e,t,r,i,s){var a=o.getItemByClass("DrawPathCmd",Kr);return a.x=e,a.y=t,a.paths=r,a.brush=i,a.pen=s,a}recover(){this.paths=null,this.brush=null,this.pen=null,o.recover("DrawPathCmd",this)}run(e,t,r){this.paths&&e._drawPath(this.x+t,this.y+r,this.paths,this.brush,this.pen)}get cmdID(){return Kr.ID}getBoundPoints(e){let t=$r;t.length=0;let r=this.paths,i=r.length;for(let e=0;e<i;e++){let i=r[e];i.length>1&&(t.push(i[1],i[2]),i.length>3&&t.push(i[3],i[4]))}return t}}Kr.ID="DrawPath";const $r=[];t.regClass("DrawPathCmd",Kr);class Zr{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,r,i,s,a,n,l){var h=o.getItemByClass("DrawPieCmd",Zr);return h.x=e,h.y=t,h.radius=r,h._startAngle=i,h._endAngle=s,h.fillColor=a,h.lineColor=n,h.lineWidth=l,h}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawPieCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;e._drawPie(this.x+i+t,this.y+i+r,this.radius-s,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Zr.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBoundPoints(e){let t=Qr;Qr.length=0;let r=Math.PI/180,i=this.endAngle-this.startAngle,s=this.x,a=this.y,n=this.radius;if(i>=360||i<=-360)return t.push(s-n,a-n),t.push(s+n,a-n),t.push(s+n,a+n),t.push(s-n,a+n),t;t.push(s,a);var l=i%360;l<0&&(l+=360);var o=this.startAngle+l,h=this.startAngle*r,_=o*r;t.push(s+n*Math.cos(h),a+n*Math.sin(h)),t.push(s+n*Math.cos(_),a+n*Math.sin(_));for(var u=90*Math.ceil(this.startAngle/90),d=90*Math.floor(o/90),c=u;c<=d;c+=90){var p=c*r;t.push(s+n*Math.cos(p),a+n*Math.sin(p))}return t}}Zr.ID="DrawPie";const Qr=[];t.regClass("DrawPieCmd",Zr);class Jr{static create(e,t,r,i,s,a){var n=o.getItemByClass("DrawPolyCmd",Jr);return n.x=e,n.y=t,n.points=r,n.fillColor=i,n.lineColor=s,n.lineWidth=a,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,o.recover("DrawPolyCmd",this)}run(e,t,r){let i=this.points.length<=6,s=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+s+t,this.y+s+r,this.points,this.fillColor,this.lineColor,this.lineWidth,i,0)}get cmdID(){return Jr.ID}}Jr.ID="DrawPoly",t.regClass("DrawPolyCmd",Jr);class ei{constructor(){this.lineWidth=0}static create(e,t,r,i,s,a,n,l){var h=o.getItemByClass("DrawRectCmd",ei);return h.x=e,h.y=t,h.width=r,h.height=i,h.fillColor=s,h.lineColor=a,h.lineWidth=n,h.percent=l,h}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawRectCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*a+i+t,this.y*n+i+r,this.width*a-s,this.height*n-s,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+i+t,this.y+i+r,this.width-s,this.height-s,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return ei.ID}getBoundPoints(e){return g._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}ei.ID="DrawRect",t.regClass("DrawRectCmd",ei);class ti{constructor(){this.color=4294967295,this.uv=null}static create(e,t,r,i,s,a,n,l,h,_){null==i&&(i=e.sourceWidth),null==s&&(s=e.sourceHeight);let u=i/e.sourceWidth,d=s/e.sourceHeight;i=e.width*u,s=e.height*d,t+=e.offsetX*u,r+=e.offsetY*d;var c=o.getItemByClass("DrawTextureCmd",ti);return c.texture=e,e._addReference(),c.x=t,c.y=r,c.width=i,c.height=s,c.matrix=a,c.alpha=n,c.blendMode=h,c.uv=_||null,c.color=null!=l?Bt.create(l).numColor:4294967295,c}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,o.recover("DrawTextureCmd",this)}run(e,t,r){this.texture&&e.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,t,r,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return ti.ID}}ti.ID="DrawTexture",t.regClass("DrawTextureCmd",ti);class ri{constructor(){this.color=4294967295}static create(e,t,r,i,s,a,n,l){var h=o.getItemByClass("FillTextureCmd",ri);return h.texture=e,e._addReference(),h.x=t,h.y=r,h.width=i,h.height=s,h.type=a,h.offset=n,h.color=null!=l?Bt.create(l).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,o.recover("FillTextureCmd",this)}run(e,t,r){if(this.texture)if(this.percent&&e.sprite){let i=e.sprite.width,s=e.sprite.height;e.fillTexture(this.texture,this.x*i+t,this.y*s+r,this.width*i,this.height*s,this.type,this.offset||f.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.type,this.offset||f.EMPTY,this.color)}get cmdID(){return ri.ID}getBoundPoints(e){return this.width&&this.height?g._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null):g._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}ri.ID="FillTexture",t.regClass("FillTextureCmd",ri);class ii{static create(){return o.getItemByClass("RestoreCmd",ii)}recover(){o.recover("RestoreCmd",this)}run(e,t,r){e.restore()}get cmdID(){return ii.ID}}ii.ID="Restore";class si{static create(e,t,r){var i=o.getItemByClass("RotateCmd",si);return i.angle=e,i.pivotX=t,i.pivotY=r,i}recover(){o.recover("RotateCmd",this)}run(e,t,r){e._rotate(this.angle,this.pivotX+t,this.pivotY+r)}get cmdID(){return si.ID}}si.ID="Rotate";class ai{static create(e,t,r,i){var s=o.getItemByClass("ScaleCmd",ai);return s.scaleX=e,s.scaleY=t,s.pivotX=r,s.pivotY=i,s}recover(){o.recover("ScaleCmd",this)}run(e,t,r){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+r)}get cmdID(){return ai.ID}}ai.ID="Scale";class ni{static create(e,t,r){var i=o.getItemByClass("TransformCmd",ni);return i.matrix=e,i.pivotX=t,i.pivotY=r,i}recover(){this.matrix=null,o.recover("TransformCmd",this)}run(e,t,r){e._transform(this.matrix,this.pivotX+t,this.pivotY+r)}get cmdID(){return ni.ID}}ni.ID="Transform";class li{static create(e,t){var r=o.getItemByClass("TranslateCmd",li);return r.tx=e,r.ty=t,r}recover(){o.recover("TranslateCmd",this)}run(e,t,r){e.translate(this.tx,this.ty)}get cmdID(){return li.ID}}li.ID="Translate";class oi{static create(e,t,r,i,s,a,n,l,h,_){var u=o.getItemByClass("DrawTrianglesCmd",oi);return u.texture=e,u.x=t,u.y=r,u.vertices=i,u.uvs=s,u.indices=a,u.matrix=n,u.alpha=l,u.color=null!=h?Bt.create(h).numColor:4294967295,u.blendMode=_,u}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,o.recover("DrawTrianglesCmd",this)}run(e,t,r){e.drawTriangles(this.texture,this.x+t,this.y+r,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return oi.ID}getBoundPoints(e){let t=this.vertices;var r=t.length;if(r<2)return[];for(var i=t[0],s=t[1],a=i,n=s,l=2;l<r;){var o=t[l++],h=t[l++];i>o&&(i=o),s>h&&(s=h),a<o&&(a=o),n<h&&(n=h)}return[i,s,a,s,a,n,i,n]}}oi.ID="DrawTriangles",t.regClass("DrawTrianglesCmd",oi);class hi{constructor(){this.color=4294967295}static create(e,t,r,i,s,a,n=!1,l=null){let h=o.getItemByClass("Draw9GridTextureCmd",hi);return h.texture=e,e._addReference(),h.x=t,h.y=r,h.width=i,h.height=s,h.sizeGrid=a,h.percent=n,h.color=null!=l?Bt.create(l).numColor:4294967295,h}recover(){this.texture._removeReference(),o.recover("Draw9GridTextureCmd",this)}run(e,t,r){if(this.texture){let i=this.sizeGrid||this.texture._sizeGrid||_i;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e.drawTextureWithSizeGrid(this.texture,this.x*s,this.y*a,this.width*s,this.height*a,i,t,r,this.color)}else e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,i,t,r,this.color)}}get cmdID(){return hi.ID}getBoundPoints(e){let t=this.x,r=this.y,i=this.width,s=this.height;return this.percent&&(t*=e.width,r*=e.height,i*=e.width,s*=e.height),[t,r,i,r,i,s,t,s]}}hi.ID="Draw9GridTexture";const _i=[0,0,0,0,0];t.regClass("Draw9GridTextureCmd",hi);class ui{static create(){return o.getItemByClass("SaveCmd",ui)}recover(){o.recover("SaveCmd",this)}run(e,t,r){e.save()}get cmdID(){return ui.ID}}ui.ID="Save";const di=new p,ci=new p,pi=[];class fi{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,o.recover("GraphicsBounds",this)}static create(){return o.getItemByClass("GraphicsBounds",fi)}reset(){this._temp&&(this._temp.length=0)}getBounds(e=!1){return(!this._bounds||!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._bounds=g._getWrapRec(this.getBoundPoints(e),this._bounds)),this._cacheBoundsType=e,this._bounds}getBoundPoints(e=!1){return(!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(e)),this._cacheBoundsType=e,this._rstBoundPoints=d.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(e=!1){let t=this._graphics.cmds,r=this._graphics._sp;this._affectBySize=!1;let i=this._temp||(this._temp=[]);if(i.length=0,0==t.length)return i;let s=pi;s.length=0;let a=ci;a.identity();let n=di;for(let e=0,l=t.length;e<l;e++){let l=t[e];switch(l.percent&&(this._affectBySize=!0),l.cmdID){case Wr.ID:case ui.ID:s.push(a),a=a.clone();break;case ii.ID:a=s.pop();break;case ai.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.scale(l.scaleX,l.scaleY),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case si.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.rotate(l.angle),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case li.ID:n.identity(),n.translate(l.tx,l.ty),this._switchMatrix(a,n);break;case ni.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.concat(l.matrix),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case Yr.ID:case ri.ID:addPointArrToRst(i,g._getBoundPointS(l.x,l.y,l.width,l.height),a);break;case ti.ID:a.copyTo(n),l.matrix&&n.concat(l.matrix),addPointArrToRst(i,g._getBoundPointS(l.x,l.y,l.width,l.height),n);break;case ei.ID:case Hr.ID:case zr.ID:addPointArrToRst(i,l.getBoundPoints(r),a);break;case Xr.ID:addPointArrToRst(i,l.getBoundPoints(r),a,l.x,l.y);break;case qr.ID:case Jr.ID:addPointArrToRst(i,l.points,a,l.x,l.y);break;case Kr.ID:addPointArrToRst(i,l.getBoundPoints(r),a,l.x,l.y);break;case Zr.ID:case oi.ID:case hi.ID:addPointArrToRst(i,l.getBoundPoints(r),a)}}return i.length>200?i=d.copyArray(i,g._getWrapRec(i)._getBoundPoints()):i.length>8&&(i=Ut.scanPList(i)),i}_switchMatrix(e,t){t.concat(e),t.copyTo(e)}}function addPointArrToRst(e,t,r,i=0,s=0){let a=t.length;for(let n=0;n<a;n+=2)addPointToRst(e,t[n]+i,t[n+1]+s,r)}function addPointToRst(e,t,r,i){var s=f.TEMP;s.setTo(t||0,r||0),i.transformPoint(s),e.push(s.x,s.y)}class gi{static create(e,t,r,i){var s=o.getItemByClass("ClipRectCmd",gi);return s.x=e,s.y=t,s.width=r,s.height=i,s}recover(){o.recover("ClipRectCmd",this)}run(e,t,r){e.clipRect(this.x+t,this.y+r,this.width,this.height)}get cmdID(){return gi.ID}}gi.ID="ClipRect";class mi{static create(e,t,r){var i=o.getItemByClass("DrawTexturesCmd",mi);return i.texture=e,e._addReference(),i.pos=t,i.colors=r||[],i}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,o.recover("DrawTexturesCmd",this)}run(e,t,r){e.drawTextures(this.texture,this.pos,t,r,this.colors)}get cmdID(){return mi.ID}}mi.ID="DrawTextures";class Ti{constructor(){this.x=0,this.y=0,this._strokeColor="#000000"}set text(e){this._text=e}get text(){return this._text}set strokeColor(e){this._strokeColor=e}get strokeColor(){return this._strokeColor}set stroke(e){this._stroke=e}get stroke(){return this._stroke}set align(e){this._align=e}get align(){return this._align}static create(e,t,r,s,a,n,l,h){var _=o.getItemByClass("FillTextCmd",Ti);switch(_._text=null,_._wordText=null,_.x=t,_.y=r,_.font=s,_.color=a,_._stroke=l,_._strokeColor=h,n){case"center":_._align=i.ENUM_TEXTALIGN_CENTER;break;case"right":_._align=i.ENUM_TEXTALIGN_RIGHT;break;default:_._align=i.ENUM_TEXTALIGN_DEFAULT}return e instanceof yt?(_._wordText=e,e.cleanCache()):_._text=e,_}recover(){o.recover("FillTextCmd",this)}run(e,t,r){n.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),e._fast_filltext(this._wordText||this._text,this.x+t,this.y+r,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return Ti.ID}get font(){return this._font}set font(e){this._font=e,e||(e=r.defaultFontSize+"px "+r.defaultFont),this._fontObj=gt.parse(e),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(e){this._color=e,this._wordText&&this._wordText.cleanCache()}}Ti.ID="FillText",t.regClass("FillTextCmd",Ti);class xi{constructor(){}static regCacheByFunction(e,t){var r;xi.unRegCacheByFunction(e,t),r={tryDispose:e,getCacheList:t},xi._cacheList.push(r)}static unRegCacheByFunction(e,t){var r,i;for(i=xi._cacheList.length,r=0;r<i;r++)if(xi._cacheList[r].tryDispose==e&&xi._cacheList[r].getCacheList==t)return void xi._cacheList.splice(r,1)}static forceDispose(){var e,t=xi._cacheList.length;for(e=0;e<t;e++)xi._cacheList[e].tryDispose(!0)}static beginCheck(e=15e3){n.systemTimer.loop(e,null,xi._checkLoop)}static stopCheck(){n.systemTimer.clear(null,xi._checkLoop)}static _checkLoop(){var e=xi._cacheList;if(!(e.length<1)){var t,r,i=n.Browser.now();for(r=t=e.length;t>0&&(xi._index++,xi._index=xi._index%r,e[xi._index].tryDispose(!1),!(n.Browser.now()-i>xi.loopTimeLimit));)t--}}}xi.loopTimeLimit=2,xi._cacheList=[],xi._index=0;class yi{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],xi.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return yi.instance=yi.instance||new yi}getId(){return this._id++}addShape(e,t){this.shapeDic[e]=t,this.useDic[e]||(this.useDic[e]=!0)}addLine(e,t){this.shapeLineDic[e]=t,this.shapeLineDic[e]||(this.shapeLineDic[e]=!0)}getShape(e){this._checkKey&&null!=this.useDic[e]&&(this.useDic[e]=!0)}deleteShape(e){this.shapeDic[e]&&(this.shapeDic[e]=null,delete this.shapeDic[e]),this.shapeLineDic[e]&&(this.shapeLineDic[e]=null,delete this.shapeLineDic[e]),null!=this.useDic[e]&&delete this.useDic[e]}getCacheList(){var e,t=[];for(e in this.shapeDic)t.push(this.shapeDic[e]);for(e in this.shapeLineDic)t.push(this.shapeLineDic[e]);return t}startDispose(e){var t;for(t in this.useDic)this.useDic[t]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var e;for(e in this.useDic)this.useDic[e]||this.deleteShape(e);this._checkKey=!1}}}class Ei{constructor(){this.lineWidth=0}static create(e,t,r,i,s,a,n,l){var h=o.getItemByClass("DrawEllipseCmd",Ei);return h.x=e,h.y=t,h.width=r,h.height=i,h.fillColor=s,h.lineColor=a,h.lineWidth=n,h.percent=l,h}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawEllipseCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawEllipse(this.x*s+t,this.y*a+r,this.width*s-i,this.height*a-i,this.fillColor,this.lineColor,this.lineWidth)}else e._drawEllipse(this.x+t,this.y+r,this.width-i,this.height-i,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Ei.ID}getBoundPoints(e){return g._getBoundPointS(this.x-this.width,this.y-this.height,2*this.width,2*this.height,this.percent?e:null)}}Ei.ID="DrawEllipse",t.regClass("DrawEllipseCmd",Ei);class Si{constructor(){this.lineWidth=0}static create(e,t,r,i,s,a,n,l,h,_,u,d){var c=o.getItemByClass("DrawRoundRectCmd",Si);return c.x=e,c.y=t,c.width=r,c.height=i,c.lt=s,c.rt=a,c.lb=n,c.rb=l,c.fillColor=h,c.lineColor=_,c.lineWidth=u,c.percent=d,c}recover(){this.fillColor=null,this.lineColor=null,o.recover("DrawRoundRectCmd",this)}run(e,t,r){let i=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e._drawRoundRect(this.x*a+i+t,this.y*n+i+r,this.width*a-s,this.height*n-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else e._drawRoundRect(this.x+i+t,this.y+i+r,this.width-s,this.height-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Si.ID}getBoundPoints(e){return g._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}Si.ID="DrawRoundRect",t.regClass("DrawRoundRectCmd",Si);class bi{static add2DGlobalUniformData(e,t,r){x.renderOBJCreate.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(e,t,r)}constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._destroyData()}clear(e=!0){if(e)for(let e=0,t=this._cmds.length;e<t;e++)this._cmds[e].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~Gt.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let e=0,t=this._vectorgraphArray.length;e<t;e++)yi.getInstance().deleteShape(this._vectorgraphArray[e]);this._vectorgraphArray.length=0}}_clearBoundsCache(e){this._graphicBounds&&(e&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=fi.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(e){this._sp&&(this._sp._renderType|=Gt.GRAPHICS),this._cmds=e;let t=e.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}addCmd(e){if(null!=e)return this._sp&&(this._sp._renderType|=Gt.GRAPHICS),this._cmds.push(e),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),e;console.warn("null cmd")}removeCmd(e){let t=this.cmds.indexOf(e);if(-1!=t){this._cmds.splice(t,1);let e=this._cmds.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}}getBounds(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(e)}getBoundPoints(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(e)}get material(){return this._material}set material(e){this._material!=e&&(this._material&&this._material._removeReference(),this._material=e,null!=e&&e._addReference())}drawImage(e,t=0,r=0,i=null,s=null,a=null){return e&&e.bitmap?this.addCmd(Yr.create(e,t,r,i,s,a)):null}drawTexture(e,t=0,r=0,i=null,s=null,a=null,n=1,l=null,o=null,h){return!e||n<.01?null:e.bitmap?this.addCmd(ti.create(e,t,r,i,s,a,n,l,o,h)):null}drawTextures(e,t,r){return e?this.addCmd(mi.create(e,t,r)):null}drawTriangles(e,t,r,i,s,a,n=null,l=1,o=null,h=null){return this.addCmd(oi.create(e,t,r,i,s,a,n,l,o,h))}fillTexture(e,t,r,i=0,s=0,a="repeat",n=null,l=null){return e&&e.bitmap?this.addCmd(ri.create(e,t,r,i,s,a,n||f.EMPTY,l)):null}clipRect(e,t,r,i){return this.addCmd(gi.create(e,t,r,i))}fillText(e,t,r,i,s,a){return this.addCmd(Ti.create(e,t,r,i,s,a,0,""))}fillBorderText(e,t,r,i,s,a,n,l){return this.addCmd(Ti.create(e,t,r,i,s,a,n,l))}strokeText(e,t,r,i,s,a,n){return this.addCmd(Ti.create(e,t,r,i,null,n,a,s))}alpha(e){return this.addCmd(Wr.create(e))}transform(e,t=0,r=0){return this.addCmd(ni.create(e,t,r))}rotate(e,t=0,r=0){return this.addCmd(si.create(e,t,r))}scale(e,t,r=0,i=0){return this.addCmd(ai.create(e,t,r,i))}translate(e,t){return this.addCmd(li.create(e,t))}save(){return this.addCmd(ui.create())}restore(){return this.addCmd(ii.create())}replaceTextColor(e){this._repaint();let t=this._cmds;for(let r=t.length-1;r>-1;r--){let i=t[r];switch(i.cmdID){case Ti.ID:i.color=e;break;case Yr.ID:i.color=null!=e?Bt.create(e).numColor:4294967295}}}loadImage(e,t=0,r=0,i=null,s=null,a=null){let l=n.loader.getRes(e);l?(this.drawImage(l,t,r,i,s),a&&a.call(this._sp)):n.loader.load(e).then((e=>{this.drawImage(e,t,r,i,s),a&&a.call(this._sp)}))}_renderEmpty(e,t,r,i){}_renderAll(e,t,r,i){t.sprite=e,t.material=this._material;var s=this._cmds;for(let e=0,a=s.length;e<a;e++)s[e].run(t,r,i);t.material=null}_renderOne(e,t,r,i){t.sprite=e,t.material=this._material,this._cmds[0].run(t,r,i),t.material=null}drawLine(e,t,r,i,s,a=1){return this.addCmd(zr.create(e,t,r,i,s,a))}drawLines(e,t,r,i,s=1){return!r||r.length<4?null:this.addCmd(qr.create(e,t,r,i,s))}drawCurves(e,t,r,i,s=1){return this.addCmd(Xr.create(e,t,r,i,s))}drawRect(e,t,r,i,s,a=null,n=1,l){return this.addCmd(ei.create(e,t,r,i,s,a,n,l))}drawRoundRect(e,t,r,i,s,a,n,l,o,h=null,_=1,u){return this.addCmd(Si.create(e,t,r,i,s,a,n,l,o,h,_,u))}drawCircle(e,t,r,i,s=null,a=1){return this.addCmd(Hr.create(e,t,r,i,s,a))}drawEllipse(e,t,r,i,s,a,n,l){return this.addCmd(Ei.create(e,t,r,i,s,a,n,l))}drawPie(e,t,r,i,s,a,n=null,l=1){return this.addCmd(Zr.create(e,t,r,d.toRadian(i),d.toRadian(s),a,n,l))}drawPoly(e,t,r,i,s=null,a=1){return this.addCmd(Jr.create(e,t,r,i,s,a))}drawPath(e,t,r,i=null,s=null){return this.addCmd(Kr.create(e,t,r,i,s))}draw9Grid(e,t=0,r=0,i=0,s=0,a,n){this.addCmd(hi.create(e,t,r,i,s,a,!1,n))}}const vi=[];class Ri extends v{get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=vi,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(e,t){e===s.DISPLAY&&(this._getBit(e)!=t&&this._updateDisplayedInstage());t?this._bits|=e:this._bits&=~e}_getBit(e){return!!(this._bits&e)}_setUpNoticeChain(){this._getBit(s.DISPLAY)&&this._setBitUp(s.DISPLAY)}_setBitUp(e){var t=this;for(t._setBit(e,!0),t=t._parent;t;){if(t._getBit(e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==E.DISPLAY&&e!==E.UNDISPLAY||this._getBit(s.DISPLAY)||this._setBitUp(s.DISPLAY)}bubbleEvent(e,t){let r=Ai.length>0?Ai.pop():[];r.length=0;let i=this;for(;i;)i.activeInHierarchy&&r.push(i),i=i.parent;if(t instanceof E){t._stopped=!1;for(let i of r)if(t.setTo(e,i,this),i.event(e,t),t._stopped)break}else for(let i of r)i.event(e,t);Ai.push(r)}hasHideFlag(e){return!!(this._hideFlags&e)}destroy(e=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(e?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let e=0,t=this._children.length;e<t;e++)this._children[0]&&this._children[0].destroy(!0)}addChild(e){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(s.HAS_ZORDER,!0),e._parent===this){var t=this.getChildIndex(e);t!==this._children.length-1&&(this._children.splice(t,1),this._children.push(e),this._childChanged())}else e._parent&&e._parent.removeChild(e),this._children===vi&&(this._children=[]),this._children.push(e),e._setParent(this);return e}addChildren(...e){for(var t=0,r=e.length;t<r;)this.addChild(e[t++])}addChildAt(e,t){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(s.HAS_ZORDER,!0),t>=0&&t<=this._children.length){if(e._parent===this){var r=this.getChildIndex(e);this._children.splice(r,1),this._children.splice(t,0,e),this._childChanged()}else e._parent&&e._parent.removeChild(e),this._children===vi&&(this._children=[]),this._children.splice(t,0,e),e._setParent(this);return e}throw new Error("appendChildAt:The index is out of bounds")}getChildIndex(e){return this._children.indexOf(e)}getChildByName(e){for(let t of this._children)if(t&&t.name===e)return t;return null}getChildAt(e){return this._children[e]||null}setChildIndex(e,t){var r=this._children;if(t<0||t>=r.length)throw new Error("setChildIndex:The index is out of bounds.");var i=this.getChildIndex(e);if(i<0)throw new Error("setChildIndex:node is must child of this object.");return r.splice(i,1),r.splice(t,0,e),this._childChanged(),e}_childChanged(e=null){}removeChild(e){if(!this._children)return e;var t=this._children.indexOf(e);return this.removeChildAt(t)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(e){var t=this.getChildByName(e);return t&&this.removeChild(t),t}removeChildAt(e){var t=this.getChildAt(e);return t&&(this._children.splice(e,1),t._setParent(null)),t}removeChildren(e=0,t=2147483647){if(this._children&&this._children.length>0){var r=this._children;if(0===e&&t>=r.length-1){var i=r;this._children=vi}else i=r.splice(e,t-e+1);for(var s=0,a=i.length;s<a;s++)i[s]._setParent(null)}return this}replaceChild(e,t){var r=this._children.indexOf(t);return r>-1?(this._children.splice(r,1,e),t._setParent(null),e._setParent(this),e):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(e){let t=e.parent;for(;t;){if(t==this)return!0;t=t.parent}return!1}_setParent(e){if(this._parent!==e)if(e)this._parent=e,this._onAdded(),this.event(E.ADDED),this._getBit(s.DISPLAY)&&(this._setUpNoticeChain(),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(E.REMOVED);let t=this._parent;this._getBit(s.DISPLAY)&&this._displayChild(this,!1),this._parent=e,t._childChanged(this)}}get displayedInStage(){return this._getBit(s.DISPLAY)||this._setBitUp(s.DISPLAY),this._getBit(s.DISPLAYED_INSTAGE)}_updateDisplayedInstage(){var e;e=this;for(var t=n.stage,r=!1;e;){if(e._getBit(s.DISPLAY)){r=e._getBit(s.DISPLAYED_INSTAGE);break}if(e===t||e._getBit(s.DISPLAYED_INSTAGE)){r=!0;break}e=e._parent}this._setBit(s.DISPLAYED_INSTAGE,r)}_setDisplay(e){this._getBit(s.DISPLAYED_INSTAGE)!==e&&(this._setBit(s.DISPLAYED_INSTAGE,e),e?this.event(E.DISPLAY):this.event(E.UNDISPLAY))}_displayChild(e,t){var r=e._children;if(r)for(var i=0,a=r.length;i<a;i++){var n=r[i];n&&(n._getBit(s.DISPLAY)&&(n._children.length>0?this._displayChild(n,t):n._setDisplay(t)))}e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,r,i=null,s=!0,a=!1){this.timer.loop(e,t,r,i,s,a)}timerOnce(e,t,r,i=null,s=!0){this.timer._create(!1,!1,e,t,r,i,s)}frameLoop(e,t,r,i=null,s=!0){this.timer._create(!0,!0,e,t,r,i,s)}frameOnce(e,t,r,i=null,s=!0){this.timer._create(!0,!1,e,t,r,i,s)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get active(){return!this._getBit(s.NOT_READY)&&!this._getBit(s.NOT_ACTIVE)}set active(e){if(e=!!e,!this._getBit(s.NOT_ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw e?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(s.NOT_ACTIVE,!e),this._parent&&this._parent.activeInHierarchy&&this._processActive(e,!0)}}get activeInHierarchy(){return this._getBit(s.ACTIVE_INHIERARCHY)}_onActive(){Xt.spriteCount++}_onInActive(){Xt.spriteCount--}_onActiveInScene(){this.event(Ri.EVENT_SET_ACTIVESCENE,this._scene)}_onInActiveInScene(){this.event(Ri.EVENT_SET_IN_ACTIVESCENE,this._scene)}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this.scene!=e){this._scene=e,this._onActiveInScene();for(let t=0,r=this._children.length;t<r;t++)this._children[t]._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let r=this._activeChangeScripts;e?this._activeHierarchy(r,t):this._inActiveHierarchy(r,t);for(let t=0,i=r.length;t<i;t++){let i=r[t];i.owner&&i._setActive(e)}r.length=0}_activeHierarchy(e,t){if(this._setBit(s.ACTIVE_INHIERARCHY,!0),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!0)}this._onActive();for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];!i._getBit(s.NOT_ACTIVE)&&!i._getBit(s.NOT_READY)&&i._activeHierarchy(e,t)}this._getBit(s.AWAKED)||(this._setBit(s.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(e,t){if(this._onInActive(),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!1)}this._setBit(s.ACTIVE_INHIERARCHY,!1);for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];i&&!i._getBit(s.NOT_ACTIVE)&&i._inActiveHierarchy(e,t)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0)}_destroyComponent(e){var t;if(!this._components)return;let r=this._components.indexOf(e);-1!=r&&(this._components.splice(r,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,r){var i=e;if(this._components)for(let e=0,t=this._components.length;e<t;e++){var s=i.addComponent(this._components[e].constructor);this._components[e]._cloneTo(s)}}addComponentInstance(e){if(e.owner)throw"Node:the component has belong to other node.";return e._singleton&&this.getComponent(e.constructor)?console.warn("Node:the component is singleton, can't add the second one.",e):this._addComponentInstance(e),e}addComponent(e){let t=o.createByClass(e);if(!t)throw"missing "+e.toString();return t._singleton&&this.getComponent(e)?console.warn("Node:the component is singleton, can't add the second one.",t):this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];if(r instanceof e)return r}return null}get components(){return this._components||vi}getComponents(e){var t;if(this._components)for(let r=0,i=this._components.length;r<i;r++){let i=this._components[r];i instanceof e&&(t=t||[]).push(i)}return t}get timer(){return this._scene?this._scene.timer:n.timer}onAfterDeserialize(){}}Ri.EVENT_SET_ACTIVESCENE="ActiveScene",Ri.EVENT_SET_IN_ACTIVESCENE="InActiveScene";const Ai=[],Ci=.5*Math.PI,Di=2*Math.PI;class Mi{static linearNone(e,t,r,i){return r*e/i+t}static linearIn(e,t,r,i){return r*e/i+t}static linearInOut(e,t,r,i){return r*e/i+t}static linearOut(e,t,r,i){return r*e/i+t}static bounceIn(e,t,r,i){return r-Mi.bounceOut(i-e,0,r,i)+t}static bounceInOut(e,t,r,i){return e<.5*i?.5*Mi.bounceIn(2*e,0,r,i)+t:.5*Mi.bounceOut(2*e-i,0,r,i)+.5*r+t}static bounceOut(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t}static backIn(e,t,r,i,s=1.70158){return r*(e/=i)*e*((s+1)*e-s)+t}static backInOut(e,t,r,i,s=1.70158){return(e/=.5*i)<1?.5*r*(e*e*((1+(s*=1.525))*e-s))+t:r/2*((e-=2)*e*((1+(s*=1.525))*e+s)+2)+t}static backOut(e,t,r,i,s=1.70158){return r*((e=e/i-1)*e*((s+1)*e+s)+1)+t}static elasticIn(e,t,r,i,s=0,a=0){var n;return 0==e?t:1==(e/=i)?t+r:(a||(a=.3*i),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/Di*Math.asin(r/s),-s*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*Di/a)+t)}static elasticInOut(e,t,r,i,s=0,a=0){var n;return 0==e?t:2==(e/=.5*i)?t+r:(a||(a=i*(.3*1.5)),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/Di*Math.asin(r/s),e<1?s*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*Di/a)*-.5+t:s*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*Di/a)*.5+r+t)}static elasticOut(e,t,r,i,s=0,a=0){var n;return 0==e?t:1==(e/=i)?t+r:(a||(a=.3*i),!s||r>0&&s<r||r<0&&s<-r?(s=r,n=a/4):n=a/Di*Math.asin(r/s),s*Math.pow(2,-10*e)*Math.sin((e*i-n)*Di/a)+r+t)}static strongIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static strongInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static strongOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static sineInOut(e,t,r,i){return.5*-r*(Math.cos(Math.PI*e/i)-1)+t}static sineIn(e,t,r,i){return-r*Math.cos(e/i*Ci)+r+t}static sineOut(e,t,r,i){return r*Math.sin(e/i*Ci)+t}static quintIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static quintInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static quintOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static quartIn(e,t,r,i){return r*(e/=i)*e*e*e+t}static quartInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e+t:.5*-r*((e-=2)*e*e*e-2)+t}static quartOut(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t}static cubicIn(e,t,r,i){return r*(e/=i)*e*e+t}static cubicInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e+t:.5*r*((e-=2)*e*e+2)+t}static cubicOut(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t}static quadIn(e,t,r,i){return r*(e/=i)*e+t}static quadInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e+t:.5*-r*(--e*(e-2)-1)+t}static quadOut(e,t,r,i){return-r*(e/=i)*(e-2)+t}static expoIn(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t-.001*r}static expoInOut(e,t,r,i){return 0==e?t:e==i?t+r:(e/=.5*i)<1?.5*r*Math.pow(2,10*(e-1))+t:.5*r*(2-Math.pow(2,-10*--e))+t}static expoOut(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t}static circIn(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t}static circInOut(e,t,r,i){return(e/=.5*i)<1?.5*-r*(Math.sqrt(1-e*e)-1)+t:.5*r*(Math.sqrt(1-(e-=2)*e)+1)+t}static circOut(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t}}class wi{constructor(e=null,t=null,r=null,i=!1){this.once=!1,this._id=0,this.setTo(e,t,r,i)}setTo(e,t,r,i=!1){return this._id=wi._gid++,this.caller=e,this.method=t,this.args=r,this.once=i,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var r=this.method.apply(this.caller,this.args);else r=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),r}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,wi._pool.push(this.clear()))}static create(e,t,r=null,i=!0){return wi._pool.length?wi._pool.pop().setTo(e,t,r,i):new wi(e,t,r,i)}}wi._pool=[],wi._gid=1;class Ii{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(e,t,r,i=null,s=null,a=0,n=!1,l=!0){return o.getItemByClass("tween",Ii)._create(e,t,r,i,s,a,n,!0,l,!0)}static from(e,t,r,i=null,s=null,a=0,n=!1,l=!0){return o.getItemByClass("tween",Ii)._create(e,t,r,i,s,a,n,!1,l,!0)}to(e,t,r,i=null,s=null,a=0,n=!1){return this._create(e,t,r,i,s,a,n,!0,!1,!0)}from(e,t,r,i=null,s=null,a=0,n=!1){return this._create(e,t,r,i,s,a,n,!1,!1,!0)}_create(e,t,r,i,s,a,l,o,h,_){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=r,this._ease=i||t.ease||Ii.easeNone,this._complete=s||t.complete,this._delay=a,this._props=[],this._usedTimer=0,this._startTimer=bt.now(),this._usedPool=h,this._delayParam=null,this.update=t.update;var u=e.$_GID||(e.$_GID=d.getGID());return Ii.tweenMap[u]?(l&&Ii.clearTween(e),Ii.tweenMap[u].push(this)):Ii.tweenMap[u]=[this],_?a<=0?this.firstStart(e,t,o):(this._delayParam=[e,t,o],n.timer.once(a,this,this.firstStart,this._delayParam)):this._initProps(e,t,o),this}firstStart(e,t,r){this._delayParam=null,e.destroyed?this.clear():(this._initProps(e,t,r),this._beginLoop())}_initProps(e,t,r){for(var i in t)if("number"==typeof e[i]){var s=r?e[i]:t[i],a=r?t[i]:e[i];this._props.push([i,s,a-s]),r||(e[i]=s)}}_beginLoop(){n.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(bt.now())}_updateEase(e){var t=this._target;if(t){if(t.destroyed)return Ii.clearTween(t);var r=this._usedTimer=e-this._startTimer-this._delay;if(!(r<0)){if(r>=this._duration)return this.complete();for(var i=r>0?this._ease(r,0,1,this._duration):0,s=this._props,a=0,n=s.length;a<n;a++){var l=s[a];t[l[0]]=l[1]+i*l[2]}this.update&&this.update.run()}}}set progress(e){var t=e*this._duration;this._startTimer=bt.now()-this._delay-t}complete(){if(this._target){n.timer.runTimer(this,this.firstStart);for(var e=this._target,t=this._props,r=this._complete,i=0,s=t.length;i<s;i++){var a=t[i];e[a[0]]=a[1]+a[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),r&&r.run()):this.restart()}}pause(){var e;n.timer.clear(this,this._beginLoop),n.timer.clear(this,this._doEase),n.timer.clear(this,this.firstStart),(e=bt.now()-this._startTimer-this._delay)<0&&(this._usedTimer=e)}setStartTime(e){this._startTimer=e}static clearAll(e){if(e&&e.$_GID){var t=Ii.tweenMap[e.$_GID];if(t){for(var r=0,i=t.length;r<i;r++)t[r]._clear();t.length=0}}}static clear(e){e.clear()}static clearTween(e){Ii.clearAll(e)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),n.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,o.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var e=Ii.tweenMap[this._target.$_GID];if(e)for(var t=0,r=e.length;t<r;t++)if(e[t]===this){e.splice(t,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=bt.now(),this._delayParam)n.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var e=this._props,t=0,r=e.length;t<r;t++){var i=e[t];this._target[i[0]]=i[1]}n.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=bt.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?n.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(e,t,r,i){return r*e/i+t}}Ii.tweenMap=[];class Pi{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(e,t,r,i,s,a,l=.92){this.clearTimer(),this.target=e,this.area=t,this.hasInertia=r,this.elasticDistance=t?i:0,this.elasticBackTime=s,this.data=a,this.ratio=l,this._parent=e.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,n.stage.on(E.MOUSE_UP,this,this.onStageMouseUp),n.stage.on(E.MOUSE_OUT,this,this.onStageMouseUp),n.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){n.systemTimer.clear(this,this.loop),n.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(n.stage.off(E.MOUSE_UP,this,this.onStageMouseUp),n.stage.off(E.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var e=this._parent.getMousePoint(),t=e.x,r=e.y,i=t-this._lastX,s=r-this._lastY;if(this._clickOnly){if(!(Math.abs(i*n.stage._canvasTransform.getScaleX())>1||Math.abs(s*n.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(E.DRAG_START,this.data)}else this._offsets.push(i,s);0===i&&0===s||(this._lastX=t,this._lastY=r,this.target.x+=i*this._elasticRateX,this.target.y+=s*this._elasticRateY,this.area&&this.checkArea(),this.target.event(E.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var e=this.area.x-this.target._x;else e=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this.target._y<this.area.y)var t=this.area.y-this.target.y;else t=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(e){if(n.stage.off(E.MOUSE_UP,this,this.onStageMouseUp),n.stage.off(E.MOUSE_OUT,this,this.onStageMouseUp),n.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var t=this._offsets.length,r=Math.min(t,6),i=this._offsets.length-r,s=t-1;s>i;s--)this._offsetY+=this._offsets[s--],this._offsetX+=this._offsets[s];this._offsetX=this._offsetX/r*2,this._offsetY=this._offsetY/r*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),n.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var e=NaN,t=NaN;if(this.target.x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target.y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),isNaN(e)&&isNaN(t))this.clear();else{var r={};isNaN(e)||(r.x=e),isNaN(t)||(r.y=t),this._tween=Ii.to(this.target,r,this.elasticBackTime,Mi.sineOut,wi.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(E.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(n.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var e=this.target;this.target=null,this._parent=null,e.event(E.DRAG_END,this.data)}}}class Bi{static getGlobalRecByPoints(e,t,r,i,s){var a,n;a=f.create().setTo(t,r),a=e.localToGlobal(a),n=f.create().setTo(i,s),n=e.localToGlobal(n);var l=g._getWrapRec([a.x,a.y,n.x,n.y]);return a.recover(),n.recover(),l}static getGlobalPosAndScale(e){return Bi.getGlobalRecByPoints(e,0,0,1,1)}static getTransformRelativeToWindow(e,t,r){var i=n.stage,s=Bi.getGlobalPosAndScale(e),a=i._canvasTransform.clone(),l=a.tx,o=a.ty;a.rotate(-Math.PI/180*i.canvasDegree),a.scale(i.clientScaleX,i.clientScaleY);var h,_,u,d,c=i.canvasDegree%180!=0;return c?(h=r+s.y,_=t+s.x,h*=a.d,_*=a.a,90==i.canvasDegree?(h=l-h,_+=o):(h+=l,_=o-_)):(h=t+s.x,_=r+s.y,h*=a.a,_*=a.d,h+=l,_+=o),_+=i._safariOffsetY,c?(u=a.d*s.height,d=a.a*s.width):(u=a.a*s.width,d=a.d*s.height),{x:h,y:_,scaleX:u,scaleY:d}}static fitDOMElementInArea(e,t,r,i,s,a){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var l=Bi.getTransformRelativeToWindow(t,r,i);e.style.transform=e.style.webkitTransform="scale("+l.scaleX+","+l.scaleY+") rotate("+n.stage.canvasDegree+"deg)",e.style.width=s+"px",e.style.height=a+"px",e.style.left=l.x+"px",e.style.top=l.y+"px"}static updateOrder(e){if(!e||e.length<2)return!1;for(var t,r,i,s=1,a=e.length;s<a;){for(i=e[t=s],r=e[t]._zOrder;--t>-1&&e[t]._zOrder>r;)e[t+1]=e[t];e[t+1]=i,s++}return!0}}class Li extends Ri{destroy(e=!0){super.destroy(e),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=Gt.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=Vr.EMPTY,this._cacheStyle=kr.EMPTY,this._boundStyle=null,this._graphics=null,this._ownGraphics=!1,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1,this._globalDeltaFlages=0,this._cacheGlobal=!1,this._globalPosx=0,this._globalPosy=0,this._globalRotate=0,this._globalScalex=1,this._globalScaley=1}get scene(){return this._scene}updateZOrder(){Bi.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=Gr.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(e){e&&(this._renderType|=Gt.CUSTOM,this._setCustomRender())}get cacheAs(){return this._cacheStyle.userSetCache}_setCacheAs(e){}set cacheAs(e){e!==this._cacheStyle.userSetCache&&("bitmap"!=e||this._cacheStyle.canvas instanceof Ur||(this._cacheStyle.canvas=null),this._getCacheStyle().userSetCache=e,this.mask&&"normal"===e||(this._setCacheAs(e),this._checkCanvasEnable(),this.repaint()))}_checkCanvasEnable(){var e=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=e,e?(this._cacheStyle.needBitmapCache()?this._cacheStyle.cacheAs="bitmap":this._cacheStyle.cacheAs=this._cacheStyle.userSetCache,this._cacheStyle.reCache=!0,this._renderType|=Gt.CANVAS):(this._cacheStyle.cacheAs="none",this._cacheStyle.releaseContext(),this._renderType&=~Gt.CANVAS),this._setCacheAs(this._cacheStyle.cacheAs)}get staticCache(){return this._cacheStyle.staticCache}set staticCache(e){this._getCacheStyle().staticCache=e,e||this.reCache()}reCache(){this._cacheStyle.reCache=!0,this._repaint|=Gt.REPAINT_CACHE}getRepaint(){return this._repaint}_setX(e){this._x=e}_setY(e){this._y=e}get x(){return this._x}set x(e){if(!this._destroyed&&this._x!==e){this._setX(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_X|Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Position_X|Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(Gt.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(Gt.REPAINT_CACHE)}}get y(){return this._y}set y(e){if(!this._destroyed&&this._y!==e){this._setY(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_Y|Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Position_Y|Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(Gt.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(Gt.REPAINT_CACHE)}}get width(){return this.get_width()}set width(e){this.set_width(e)}set_width(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-2):0==e?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===e&&t==this._sizeFlag||(this._width=e,this._setWidth(e),this._setPivotX(this._anchorX*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0!=this._width||1&this._sizeFlag||!this.texture?this._width:this.texture.width}get height(){return this.get_height()}set height(e){this.set_height(e)}set_height(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-3):0==e?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===e&&t==this._sizeFlag||(this._height=e,this._setHeight(e),this._setPivotY(this._anchorY*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0!=this._height||2&this._sizeFlag||!this.texture?this._height:this.texture.height}get _isWidthSet(){return 0!=this._width||!!(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||!!(2&this._sizeFlag)}_setWidth(e){}_setHeight(e){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(e){this._getBoundsStyle().userBounds=e}getBounds(){return this._getBoundsStyle().bounds=g._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=g._getWrapRec(this._getBoundPointsM(!1)):g.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(e=!1){let t=0,r=0;this._style&&(t=this.pivotX,r=this.pivotY,e=e||0!==this._style.rotation,this._style.scrollRect&&(t+=this._style.scrollRect.x,r+=this._style.scrollRect.y));let i=this._getBoundPointsM(e);if(!i||i.length<1)return i;if(8!=i.length&&(i=e?Ut.scanPList(i):g._getWrapRec(i,g.TEMP)._getBoundPoints()),!this.transform)return d.transPointList(i,this._x-t,this._y-r),i;let s=f.TEMP,a=i.length;for(let e=0;e<a;e+=2)s.x=i[e],s.y=i[e+1],this.toParentPoint(s),i[e]=s.x,i[e+1]=s.y;return i}getGraphicBounds(e=!1){return this._graphics?this._graphics.getBounds(e):g.TEMP.setTo(0,0,0,0)}_getBoundPointsM(e=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let t,r=this._boundStyle.temBM;if(r||(r=this._boundStyle.temBM=[]),this._style.scrollRect){r.length=0;var i=g.TEMP;return i.copyFrom(this._style.scrollRect),r.push(...i._getBoundPoints()),r}this._graphics?t=this._graphics.getBoundPoints():(r.length=0,t=r),this._texture&&((i=g.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),t.push(...i._getBoundPoints()));let s=this._children;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(!0===i._visible&&i._cacheStyle.maskParent!=this){let r=i._boundPointsToParent(e);r&&(t?t.push(...r):t=r)}}return t}_getCacheStyle(){return this._cacheStyle===kr.EMPTY&&(this._cacheStyle=kr.create()),this._cacheStyle}getStyle(){return this._style===Vr.EMPTY&&(this._style=Vr.create()),this._style}setStyle(e){this._style=e}get scaleX(){return this._style.scaleX}set scaleX(e){this.set_scaleX(e)}get scaleY(){return this._style.scaleY}set scaleY(e){this.set_scaleY(e)}set_scaleX(e){this.getStyle().scaleX!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_X|Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Scale_X|Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleX(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(e){this.getStyle().scaleY!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_Y|Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Scale_Y|Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(e){this._style.scaleX=e}_setScaleY(e){this._style.scaleY=e}get rotation(){return this._style.rotation}set rotation(e){this.getStyle().rotation!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Rotation|Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Rotation|Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setRotation(e),this._setTranformChange())}_setRotation(e){this.getStyle().rotation=e}get skewX(){return this._style.skewX}set skewX(e){this.getStyle().skewX!==e&&(this._setSkewX(e),this._setTranformChange())}_setSkewX(e){this._style.skewX=e}get skewY(){return this._style.skewY}set skewY(e){this.getStyle().skewY!==e&&(this._setSkewY(e),this._setTranformChange())}_setSkewY(e){this._style.skewY=e}_createTransform(){return p.create()}_adjustTransform(){this._tfChanged=!1;var e=this._style,t=e.scaleX,r=e.scaleY,i=e.skewX,s=e.skewY,a=e.rotation,n=this._transform||(this._transform=this._createTransform());if(a||1!==t||1!==r||0!==i||0!==s){n._bTransform=!0;var l=.0174532922222222*(a-i),o=.0174532922222222*(a+s),h=Math.cos(o),_=Math.sin(o),u=Math.sin(l),d=Math.cos(l);n.a=t*h,n.b=t*_,n.c=-r*u,n.d=r*d,n.tx=n.ty=0}else n.identity(),this._renderType&=~Gt.TRANSFORM;return n}_setTransform(e){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(e){this.set_transform(e)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(e){this._tfChanged=!1;var t=this._transform||(this._transform=this._createTransform());e.copyTo(t),this._setTransform(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),e?this._renderType|=Gt.TRANSFORM:this._renderType&=~Gt.TRANSFORM,this.parentRepaint()}_setPivotX(e){this.getStyle().pivotX=e}_getPivotX(){return this._style.pivotX}_setPivotY(e){this.getStyle().pivotY=e}_getPivotY(){return this._style.pivotY}get pivotX(){return this._getPivotX()}set pivotX(e){if(this.getStyle().pivotX!=e){this._setPivotX(e);let t=this.width;0!=t&&(this._anchorX=e/t),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(e){if(this.getStyle().pivotY!=e){this._setPivotY(e);let t=this.height;0!=t&&(this._anchorY=e/t),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(e){this.set_anchorX(e)}set_anchorX(e){isNaN(e)&&(e=null),this._anchorX!=e&&(this._anchorX=e,null!=e&&(this._setPivotX(e*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(e){this.set_anchorY(e)}set_anchorY(e){isNaN(e)&&(e=null),this._anchorY!=e&&(this._anchorY=e,null!=e&&(this._setPivotY(e*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(e){this._style.alpha!==e&&(this.getStyle().alpha=e,1!==e?this._renderType|=Gt.ALPHA:this._renderType&=~Gt.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(e){e=e<0?0:e>1?1:e,this._setAlpha(e)}get visible(){return this.get_visible()}set visible(e){this.set_visible(e)}get_visible(){return this._visible}set_visible(e){this._visible!==e&&(this._visible=e,this.parentRepaint(Gt.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(e){this.getStyle().blendMode!=e&&(this.getStyle().blendMode=e,e&&"source-over"!=e?this._renderType|=Gt.BLEND:this._renderType&=~Gt.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new bi,this._ownGraphics=!0),this._graphics}set graphics(e){this.setGraphics(e,!1)}setGraphics(e,t){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=t,this._graphics=e,e?(this._renderType|=Gt.GRAPHICS,e._sp=this):this._renderType&=~Gt.GRAPHICS,this.repaint()}get material(){var e;return null===(e=this._graphics)||void 0===e?void 0:e.material}set material(e){null==this._graphics&&null==e||(this.graphics.material=e)}get scrollRect(){return this._style.scrollRect}set scrollRect(e){null==this.getStyle().scrollRect&&null==e||(this.getStyle().scrollRect=e,e?this._renderType|=Gt.CLIP:this._renderType&=~Gt.CLIP,this.repaint())}pos(e,t,r=!1){if(this._x!==e||this._y!==t){if(this._destroyed)return this;if(r){this._setX(e),this._setY(t),this.parentRepaint(Gt.REPAINT_CACHE);var i=this._cacheStyle.maskParent;if(i&&i.repaint(Gt.REPAINT_CACHE),this.cacheGlobal){let e=Li.Sprite_GlobalDeltaFlage_Position_X|Li.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(e,!0),this._syncGlobalFlag(e,!0)}}else this.x=e,this.y=t}return this}pivot(e,t){return this.pivotX=e,this.pivotY=t,this}size(e,t){return this.width=e,this.height=t,this}scale(e,t,r){if(this._destroyed)return this;var i=this.getStyle();return i.scaleX==e&&i.scaleY==t||(r?(this._setScaleX(e),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=e,this.scaleY=t)),this}skew(e,t){return this.skewX=e,this.skewY=t,this}render(e,t,r){or.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}drawToCanvas(e,t,r,i){return Li.drawToCanvas(this,this._renderType,e,t,r,i)}drawToTexture(e,t,r,i,s=null){return Li.drawToTexture(this,this._renderType,e,t,r,i,s)}drawToTexture3D(e,t,r){throw"not implement"}static drawToCanvas(e,t,r,i,s,a){s-=e.x,a-=e.y,s|=0,a|=0,r|=0,i|=0;var n=new Or;n.size(r,i),n.asBitmap=!0,n._targets.start(),n._targets.clear(0,0,0,0),or.renders[t]._fun(e,n,s,a),n.flush(),n._targets.end(),n._targets.restore();var l=n._targets.getData(0,0,r,i);n.destroy();for(var o=new ImageData(r,i),h=4*r,_=o.data,u=i-1,d=u*h,c=0;u>=0;u--)_.set(l.subarray(c,c+h),d),d-=h,c+=h;var p=new Ur(!0);return p.size(r,i),p.getContext("2d").putImageData(o,0,0),p}static drawToTexture(e,t,r,i,s,a,n=null){Or.set2DRenderConfig(),Li.drawtocanvCtx||(Li.drawtocanvCtx=new Or),s-=e.x,a-=e.y,s|=0,a|=0,r|=0,i|=0;var l=n?Li.drawtocanvCtx:new Or;let o;if(l.clear(),l.size(r,i),n?l._targets=n:l.asBitmap=!0,l._targets){l._targets.start();let r=J._clearColor;l._targets.clear(r.r,r.g,r.b,r.a),l._drawingToTexture=!0,or.renders[t]._fun(e,l,s,a),l._drawingToTexture=!1,l.flush(),l._targets.end(),l._targets.restore(),n||(o=l._targets),l._targets=null}if(!n){var h=new ae(l._targets?l._targets:o,ae.INV_UV);return l.destroy(!0),h}return e._repaint=0,n}customRender(e,t,r){this._repaint=Gt.REPAINT_ALL}_applyFilters(){}get filters(){return this._cacheStyle.filters}set filters(e){e&&0===e.length&&(e=null),this._getCacheStyle().filters=e?e.slice():null,e?this._renderType|=Gt.FILTERS:this._renderType&=~Gt.FILTERS,e&&e.length>0?(this._getBit(s.DISPLAY)||this._setBitUp(s.DISPLAY),1==e.length&&e[0]instanceof Nt||(this._getCacheStyle().cacheForFilters=!0,this._checkCanvasEnable())):this._cacheStyle.cacheForFilters&&(this._cacheStyle.cacheForFilters=!1,this._checkCanvasEnable()),this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter(),this.repaint()}_isHaveGlowFilter(){var e,t;if(this.filters)for(e=0;e<this.filters.length;e++)if(this.filters[e].type==It.GLOW)return!0;for(e=0,t=this._children.length;e<t;e++)if(this._children[e]._isHaveGlowFilter())return!0;return!1}localToGlobal(e,t=!1,r=null){!0===t&&(e=new f(e.x,e.y));var i=this;for(r=r||n.stage;i&&!i._destroyed&&i!=r;)e=i.toParentPoint(e),i=i.parent;return e}globalToLocal(e,t=!1,r=null){t&&(e=new f(e.x,e.y));var i=this,s=[];for(r=r||n.stage;i&&!i._destroyed&&i!=r;)s.push(i),i=i.parent;for(var a=s.length-1;a>=0;)e=(i=s[a]).fromParentPoint(e),a--;return e}toParentPoint(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._style.scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}fromParentPoint(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._style.scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}onStartListeningToType(e){super.onStartListeningToType(e),1!==this._mouseState&&E.isMouseEvent(e)&&(this.mouseEnabled=!0,this._setBit(s.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(e){if(1!==this._mouseState){var t=this;for(t=t.parent;t&&1!==t._mouseState&&!t._getBit(s.HAS_MOUSE);)t.mouseEnabled=!0,t._setBit(s.HAS_MOUSE,!0),t=t.parent}}_setParent(e){super._setParent(e),e&&this._getBit(s.HAS_MOUSE)&&this._onDisplay()}loadImage(e,t=null){if(e){let r=n.loader.getRes(e);r?(this.texture=r,this.repaint(Gt.REPAINT_ALL),t&&t.run()):(this._skinBaseUrl&&(e=de.formatURL(e,this._skinBaseUrl)),n.loader.load(e).then((e=>{this.texture=e,this.repaint(Gt.REPAINT_ALL),t&&t.run()})))}else this.texture=null,this.repaint(Gt.REPAINT_ALL),t&&t.run();return this}static fromImage(e){return(new Li).loadImage(e)}repaint(e=Gt.REPAINT_CACHE){this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e)}_needRepaint(){return this._repaint&Gt.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache}_childChanged(e=null){super._childChanged(e),this._children.length?this._renderType|=Gt.CHILDS:this._renderType&=~Gt.CHILDS,e&&this._getBit(s.HAS_ZORDER)&&n.systemTimer.callLater(this,this.updateZOrder),this.repaint(Gt.REPAINT_ALL)}parentRepaint(e=Gt.REPAINT_CACHE){var t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}get stage(){return n.stage}get hitArea(){return this._style.hitArea}set hitArea(e){this.getStyle().hitArea=e}_setMask(e){}get mask(){return this._cacheStyle.mask}set mask(e){e==this||e&&this.mask==e&&e._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=e,this._setMask(e),this._checkCanvasEnable(),e?(e._getCacheStyle().maskParent=this,this._renderType|=Gt.MASK):this._renderType&=~Gt.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(e){this._mouseState=e?2:1}startDrag(e=null,t=!1,r=0,i=300,s=null,a=.92){this._style.dragging||(this.getStyle().dragging=new Pi),this._style.dragging.start(this,e,t,r,i,s,a)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(e){e||this._cacheStyle&&(this._cacheStyle.releaseContext(),this._cacheStyle.releaseFilterCache(),this._cacheStyle.hasGlowFilter&&(this._cacheStyle.hasGlowFilter=!1)),super._setDisplay(e)}hitTestPoint(e,t){var r=this.globalToLocal(f.TEMP.setTo(e,t));return e=r.x,t=r.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?g.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(e,t)}getMousePoint(){return this.globalToLocal(f.TEMP.setTo(n.stage.mouseX,n.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(s.HAS_ZORDER,!0),n.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(e){}set texture(e){"string"==typeof e?this.loadImage(e):this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e&&e._addReference(),this._setTexture(e),this._setWidth(this.width),this._setHeight(this.height),e?this._renderType|=Gt.TEXTURE:this._renderType&=~Gt.TEXTURE,this.repaint())}get viewport(){return this._style.viewport}set viewport(e){if("string"==typeof e){let t=e.split(",");t.length>3&&(e=new g(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])))}this.getStyle().viewport=e}_setTranformChange(){this._tfChanged=!0,this._renderType|=Gt.TRANSFORM,this.parentRepaint(Gt.REPAINT_CACHE)}set drawCallOptimize(e){this._setBit(s.DRAWCALL_OPTIMIZE,e)}get drawCallOptimize(){return this._getBit(s.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),l.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}get cacheGlobal(){return this._cacheGlobal}set cacheGlobal(e){if(this._cacheGlobal!=e)if(this._cacheGlobal=e,e){if(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_X,!0),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_Y,!0),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_X,!0),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_Y,!0),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Rotation,!0),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent==n.stage||!this._parent)return;this._parent.cacheGlobal=e}else this._children.forEach((t=>{t.cacheGlobal=e}))}getGlobalMatrix(){return null==this._globalMatrix&&(this._globalMatrix=p.create()),this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix)&&(this._globalMatrix.identity(),this._globalMatrix.translate(-this.pivotX,-this.pivotY),this._globalMatrix.scale(this.globalScaleX,this.globalScaleY),this._globalMatrix.rotate(d.toRadian(this.globalRotation)),this._globalMatrix.translate(this.globalPosX,this.globalPosY),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!1)),this._globalMatrix}CustomMaterial(){}set globalPosX(e){this.setGlobalPos(e,this._globalPosy)}set globalPosY(e){this.setGlobalPos(this._globalPosx,e)}setGlobalPos(e,t){if(e!=this.globalPosX||t!=this.globalPosY)if(this._cacheGlobal){let r=this.parent.getGlobalMatrix().invertTransformPoint(f.TEMP.setTo(e,t));this._setX(r.x),this._setY(r.y),this._globalPosx=e,this._globalPosy=t;let i=Li.Sprite_GlobalDeltaFlage_Position_X|Li.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(i,!1),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(i|Li.Sprite_GlobalDeltaFlage_Matrix,!0)}else{f.TEMP.setTo(e,t);let r=this.globalToLocal(f.TEMP,!1,null);r=this.toParentPoint(r),this.x=r.x,this.y=r.y}}get globalPosX(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix|Li.Sprite_GlobalDeltaFlage_Position_X)){this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_X,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(f.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosx=t.x,this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosx}return this.localToGlobal(f.TEMP.setTo(0,0),!1,null).x}get globalPosY(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix|Li.Sprite_GlobalDeltaFlage_Position_Y)){this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Position_Y,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(f.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosy=t.y,this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosy}return this.localToGlobal(f.TEMP.setTo(0,0),!1,null).y}get globalRotation(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Rotation)&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Rotation,!1),this._parent!=n.stage&&this._parent?this._globalRotate=this.rotation+this.parent.globalRotation:this._globalRotate=this.rotation),this._globalRotate;for(var e=0,t=this;t&&t!==n.stage;)e+=t.rotation,t=t.parent;return e}set globalRotation(e){e!=this.globalRotation&&(this._parent!=n.stage&&this._parent?(this._setRotation(e-this.parent.globalRotation),this._setTranformChange()):(this._setRotation(e),this._setTranformChange()),this._cacheGlobal&&(this._globalRotate=e,this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Rotation,!1),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0)))}get globalScaleX(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_X)&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_X,!1),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=n.stage&&this._parent?this._globalScalex=this.scaleX*this.parent.globalScaleX:this._globalScalex=this.scaleX,this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScalex;for(var e=1,t=this;t&&t!==n.stage;)e*=t.scaleX,t=t.parent;return e}get globalScaleY(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_Y)&&(this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Scale_Y,!1),this._setGlobalCacheFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=n.stage&&this._parent?this._globalScaley=this.scaleY*this.parent.globalScaleY:this._globalScaley=this.scaleY,this._syncGlobalFlag(Li.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScaley;for(var e=1,t=this;t&&t!==n.stage;)e*=t.scaleY,t=t.parent;return e}_getGlobalCacheFlag(e){return!!(this._globalDeltaFlages&e)}_getGlobalCacheLocalToGlobal(e,t){return this._cacheGlobal?this.getGlobalMatrix().transformPoint(f.TEMP.setTo(this.pivotX+e,this.pivotY+t)):this.localToGlobal(f.TEMP.setTo(e,t),!1,null)}_getGlobalCacheGlobalToLocal(e,t){if(this._cacheGlobal){let r=this.getGlobalMatrix().invertTransformPoint(f.TEMP.setTo(e,t));return r.x-=this.pivotX,r.y-=this.pivotY,r}return this.globalToLocal(f.TEMP.setTo(e,t),!1,null)}_setGlobalCacheFlag(e,t){t?this._globalDeltaFlages|=e:this._globalDeltaFlages&=~e,t&&this.event("GlobaChange",e)}get globalDeltaFlages(){return this._globalDeltaFlages}_syncGlobalFlag(e,t){this.cacheGlobal&&this._children.forEach((r=>{r._setGlobalCacheFlag(e,t),r._syncGlobalFlag(e,t)}))}}Li.Sprite_GlobalDeltaFlage_Position_X=1,Li.Sprite_GlobalDeltaFlage_Position_Y=2,Li.Sprite_GlobalDeltaFlage_Rotation=4,Li.Sprite_GlobalDeltaFlage_Scale_X=8,Li.Sprite_GlobalDeltaFlage_Scale_Y=16,Li.Sprite_GlobalDeltaFlage_Matrix=32;class Fi extends Li{constructor(){super(),this.wrapMode=0,this._interval=r.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(s.DISPLAY)}play(e=0,t=!0,r=""){this._isPlaying=!0,this._actionName=r,this.index="string"==typeof e?this._getFrameByLabel(e):e,this.loop=t,this._isReverse=this.wrapMode===Fi.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(e){this._interval!=e&&(this._frameRateChanged=!0,this._interval=e,this._isPlaying&&e>0&&this.timerLoop(e,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(e){for(var t=0;t<this._count;t++){var r=this._labels[t];if(r&&r.indexOf(e)>-1)return t}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(E.COMPLETE);this.wrapMode==Fi.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(E.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(E.COMPLETE);this.wrapMode==Fi.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(E.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(e){this._controlNode&&(this._controlNode.off(E.DISPLAY,this,this._resumePlay),this._controlNode.off(E.UNDISPLAY,this,this._resumePlay)),this._controlNode=e,e&&e!=this&&(e.on(E.DISPLAY,this,this._resumePlay),e.on(E.UNDISPLAY,this,this._resumePlay))}_setDisplay(e){super._setDisplay(e),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(e,t){this._labels||(this._labels={}),this._labels[t]||(this._labels[t]=[]),this._labels[t].push(e)}removeLabel(e){if(e){if(this._labels)for(var t in this._labels)this._removeLabelFromList(this._labels[t],e)}else this._labels=null}_removeLabelFromList(e,t){if(e)for(var r=e.length-1;r>=0;r--)e[r]==t&&e.splice(r,1)}gotoAndStop(e){this.index="string"==typeof e?this._getFrameByLabel(e):e,this.stop()}get index(){return this._index}set index(e){if(this._index=e,this._displayToIndex(e),this._labels&&this._labels[e])for(var t=this._labels[e],r=0,i=t.length;r<i;r++)this.event(E.LABEL,t[r])}_displayToIndex(e){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}Fi.WRAP_POSITIVE=0,Fi.WRAP_REVERSE=1,Fi.WRAP_PINGPONG=2;class Oi{static enable(e,t=null){n.loader.fetch(e,"json").then((e=>{e&&(Oi.addAtlases(e),t&&t.run())}))}static addAtlases(e){let t=Oi._fileLoadDic;for(let r in e){let i=e[r],s=de.formatURL(i[0]),a=i[1],n=a.length,l={url:r};for(let e=0;e<n;e++)t[s+a[e]]=l}}static addAtlas(e,t,r){t=de.formatURL(t);let i=Oi._fileLoadDic,s={url:e};for(let e of r)i[t+e]=s}static getFileLoadPath(e){return Oi._fileLoadDic[e]}}Oi._fileLoadDic={};class Ni{static workerSupported(){return!!Worker}static set enable(e){if(Ni._enable!=e){if(e){if(!Worker)return;Ni._worker||(Ni._worker=new Worker(Ni.workerPath),Ni._worker.onmessage=Ni.workerMessage,Ni._dispatcher=new v)}Ni._enable=e}}static get enable(){return Ni._enable}static load(e,t){return new Promise((r=>{Ni._worker.postMessage({url:e,options:t}),Ni._dispatcher.once(e,r)}))}static workerMessage(e){let t=e.data;if(t)switch(t.type){case"Image":Ni._dispatcher.event(t.url,t.imageBitmap);break;case"Disable":Ni.enable=!1}}}Ni.workerPath="libs/laya.workerloader.js",Ni._enable=!1;class Ui extends w{constructor(e,t,r){super(),this.dir=e,this.textures=t,this.frames=r,this.lock=!0}_disposeResource(){for(let e of this.textures)e&&e.destroy();for(let e of this.frames)e.destroy();this.frames.length=0,this.textures.length=0}}class Gi{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let r=0,i=this._items,s=this._weights,a=1/i.length;for(let e=0;e<i.length;e++){let t=i[e],n=s[e];null!=t&&(r+=t*(null!=n?n:a))}(t=r)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class ki{static compareVersion(e,t){let r=e.split("."),i=t.split(".");const s=Math.max(r.length,i.length);for(;r.length<s;)r.push("0");for(;i.length<s;)i.push("0");for(let e=0;e<s;e++){const t=parseInt(r[e]),s=parseInt(i[e]);if(t>s)return!0;if(t<s)return!1}return!0}static get isSupport(){if(bt._isMiniGame){var e=bt.window.wx.getSystemInfoSync().SDKVersion;return ki.compareVersion(e,"2.14.0")}return!!bt.onLayaRuntime||!!bt.window.Blob&&!!bt.window.Blob}static arrayBufferToURL(e,t){if(!ki.isSupport)return e;if(ki.data[e])return ki.data[e];var r="";if(bt._isMiniGame||bt.onLayaRuntime)r=bt.window.wx.createBufferURL(t);else if(bt.window.Blob){let e=new Blob([t],{type:"application/octet-binary"});r=bt.window.URL.createObjectURL(e)}return ki.isSavaData&&(ki.data[e]=r),r}static _arrayBufferToURL(e){if(!ki.isSupport)return null;var t="";if(bt._isMiniGame||bt.onLayaRuntime)t=bt.window.wx.createBufferURL(e);else if(bt.window.Blob){let r=new Blob([e],{type:"application/octet-binary"});t=bt.window.URL.createObjectURL(r)}return t}static destroy(e){if(ki.isSupport){var t=ki.data[e];t&&(bt._isMiniGame||bt.onLayaRuntime?bt.window.wx.revokeBufferURL(t):bt.window.Blob&&bt.window.URL.revokeObjectURL(t),delete ki.data[e])}}}ki.data={},ki.isSavaData=!1;class Vi{static decodeString(e){let t=e.length,r="",i=0,s=0;for(;;){if(s=e.indexOf("&",i),-1==s){r+=e.substring(i);break}r+=e.substring(i,s),i=s+1,s=i;let a=Math.min(t,s+10);for(;s<a&&";"!=e[s];s++);if(s<a&&s>i){let t=e.substring(i,s),a=0;if("#"==t[0])t.length>1?(a="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),r+=String.fromCharCode(a),i=s+1):r+="&";else{switch(t){case"amp":a=38;break;case"apos":a=39;break;case"gt":a=62;break;case"lt":a=60;break;case"nbsp":a=32;break;case"quot":a=34}a>0?(r+=String.fromCharCode(a),i=s+1):r+="&"}}else r+="&"}return r}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,r){if(null==e)return null==r?null:r;let i=e[t];return null!=i?""+i:null==r?null:r}static getInt(e,t,r){let i=this.getString(e,t);if(null!=i&&i.length>0)if("%"==i[i.length-1]){let e=parseInt(i.substring(0,i.length-1));if(!isNaN(e))return Math.ceil(e/100*r)}else{let e=parseInt(i);if(!isNaN(e))return e}return null==r?0:r}static getFloat(e,t,r){let i=this.getString(e,t);if(null==i||0==i.length)return null==r?0:r;let s=parseFloat(i);return isNaN(s)?null==r?0:r:s}static getBool(e,t,r){let i=this.getString(e,t);return null==i||0==i.length?null!=r&&r:"true"==i||"1"==i||"false"!=i&&"0"!=i&&(null!=r&&r)}}var Wi;e.XMLTagType=void 0,(Wi=e.XMLTagType||(e.XMLTagType={}))[Wi.Start=0]="Start",Wi[Wi.End=1]="End",Wi[Wi.Void=2]="Void",Wi[Wi.CDATA=3]="CDATA",Wi[Wi.Comment=4]="Comment",Wi[Wi.Instruction=5]="Instruction";class Hi{static begin(e,t){Hi.source=e,Hi.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,r,i="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(r=this.source[t],"!"==r){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==r?(t++,this.tagType=e.XMLTagType.End):"?"==r&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(r=this.source[t],-1==" \t\n\r\v".indexOf(r)&&">"!=r&&"/"!=r);t++);if(t==this.sourceLen)break;i+=this.source.substring(this.parsePos+1,t),i.length>0&&"/"==i[0]&&(i=i.substring(1));let s=!1,a=!1,n=-1;for(;t<this.sourceLen;t++)if(r=this.source[t],'"'==r?s||(a=!a):"'"==r&&(a||(s=!s)),">"==r){if(!s&&!a){n=-1;break}n=t}else if("<"==r)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=i,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":Vi.decodeString(this.source.substring(e,this.tagPos)).trimEnd()}return Vi.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,r=0,i=0,s=!1,a=0,n="",l=this.tagPos,o=this.tagPos+this.tagLength;if(l<o&&"<"==this.source[l])for(;l<o;l++){let e=this.source[l];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;l<o;l++){let h=this.source[l];if("="==h){r=-1,i=-1,a=0;for(let e=l+1;e<o;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=r&&0==a){i=e-1;break}}else if(">"==t){if(0==a){i=e-1;break}}else if('"'==t)if(-1!=r){if(1!=a){i=e-1;break}}else a=2,r=e+1;else if("'"==t)if(-1!=r){if(2!=a){i=e-1;break}}else a=1,r=e+1;else-1==r&&(r=e)}if(-1==r||-1==i)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=Vi.decodeString(this.source.substring(r,i+1)),l=i+1}else-1==" \t\n\r\v".indexOf(h)?((s||"/"==h||">"==h)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),s=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(s=!0)}}}Hi._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class Xi{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return Vi.getString(this._attrs,e,t)}getAttrInt(e,t){return Vi.getInt(this._attrs,e,t)}getAttrFloat(e,t){return Vi.getFloat(this._attrs,e,t)}getAttrBool(e,t){return Vi.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find((t=>t.name==e)):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter((t=>t.name==e)):this._children}parse(t){let r;this.reset();let i=new Array;for(Hi.begin(t);Hi.nextTag();)if(Hi.tagType==e.XMLTagType.Start||Hi.tagType==e.XMLTagType.Void){let t;if(r)t=new Xi;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=Hi.tagName,t._attrs=Object.assign({},Hi.attributes),r&&(Hi.tagType!=e.XMLTagType.Void&&i.push(r),null==r._children&&(r._children=new Array),r._children.push(t)),Hi.tagType!=e.XMLTagType.Void&&(r=t)}else if(Hi.tagType==e.XMLTagType.End){if(null==r||r.name!=Hi.tagName)throw this.reset(),new Error("Invalid xml format - <"+Hi.tagName+"> dismatched.");null!=r._children&&0!=r._children.length||(r.text=Hi.getText()),r=i.length>0?i.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class Yi extends v{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,r="get",i="text",s){this._responseType=i,this._data=null,(bt.onVVMiniGame||bt.onQGMiniGame||bt.onQQMiniGame||bt.onAlipayMiniGame||bt.onBLMiniGame||bt.onHWMiniGame||bt.onTTMiniGame||bt.onTBMiniGame)&&(e=Yi._urlEncode(e)),this._url=e;let a=this._http;if(a.open(r,e,!0),t?"string"==typeof t?a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(a.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):bt.onBLMiniGame&&bt.onAndroid&&(t={}),s)for(let e=0;e<s.length;e++)a.setRequestHeader(s[e++],s[e]);let n="arraybuffer"!==i?"text":"arraybuffer";a.responseType=n,a.dataType&&(a.dataType=n),a.onerror=e=>{this._onError(e)},a.onabort=e=>{this._onAbort(e)},a.onprogress=e=>{this._onProgress(e)},a.onload=e=>{this._onLoad(e)},a.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(E.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,r=void 0!==t.status?t.status:200;200===r||204===r||0===r?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(E.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new Xi(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(E.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}Yi._urlEncode=encodeURI;class zi{constructor(){this.httpRequestPool=[]}common(e,t,r,i,s,a){let n=this.getRequestInst();n.on(E.COMPLETE,(()=>{let e=n.data;this.returnRequestInst(n),a(e)})),n.on(E.ERROR,null,(e=>{this.returnRequestInst(n),a(null,e)})),s&&n.on(E.PROGRESS,s),n.send(t,null,"get",i),e.$ref=n}image(e,t,r,i,s){let a=new bt.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,s(a)},a.onerror=()=>{a.onload=null,a.onerror=null,s(null,"")},a.src=t,e.$ref=a}imageWithBlob(e,t,r,i,s){let a=ki.arrayBufferToURL(r,t);this.image(e,a,r,i,s)}imageWithWorker(e,t,r,i,s){Ni.enable=!0,Ni.enable?Ni.load(t,e.workerLoaderOptions).then((e=>{e?s(e):s(null,"workerloader failed!")})):this.image(e,t,r,i,s)}audio(e,t,r,i,s){let a=bt.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,s(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,s(null,"")},a.src=t,e.$ref=a}getRequestInst(){return 0==this.httpRequestPool.length||bt.onVVMiniGame||bt.onHWMiniGame?new Yi:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var ji=0;const qi={ext:null,typeId:null,main:!1,loaderType:null};class Ki extends v{static registerLoader(e,t,r){let i;r?(i=Ki.typeMap[r],i?i.loaderType!=t&&(i={typeId:i.typeId,loaderType:t}):Ki.typeMap[r]=i={typeId:ji++,loaderType:t}):i={typeId:ji++,loaderType:t};for(let s of e){let e=Ki.extMap[s];if(e&&r){let r=e.findIndex((e=>e.typeId==i.typeId));-1==r?e.push(i):e[r].loaderType=t}else Ki.extMap[s]=[i]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(e,t,r,i,s,a,n,l,o){let h,_,u,d,c=Qi;if(t instanceof wi?(h=t,_=i):"string"==typeof t?_=t:null!=t&&(_=t.type,c=t),null==s&&null==a&&null==l&&null==n&&null==o||(c=c===Qi?{priority:s,cache:a,ignoreCache:l,group:n,useWorkerLoader:o}:Object.assign(c,{priority:s,cache:a,ignoreCache:l,group:n,useWorkerLoader:o})),!1===c.cache&&(c.ignoreCache=!0),u=r instanceof wi?e=>r.runWith(e):r,Array.isArray(e)){let t;u&&(t=new Gi(u));let r=[];for(let i=0;i<e.length;i++){let s=e[i];s&&("string"==typeof s?r.push(this._load1(s,_,c,null==t?void 0:t.createCallback())):r.push(this._load1(s.url,s.type||_,c!==Qi?Object.assign({},c,s):s,null==t?void 0:t.createCallback())))}d=Promise.all(r)}else d="string"==typeof e?this._load1(e,_,c,u):this._load1(e.url,e.type||_,c!==Qi?Object.assign({},c,e):e,u);return h?d.then((e=>(h.runWith(e),e))):d}_load1(e,t,r,i){if(l.isPreview){if(e.startsWith("res://")){let s=e.substring(6);return ue.inst.UUID_to_URL_async(s).then((a=>{var n;return a?this._load2(a,s,t,r,i):(!r.silent&&Ki.warnFailed(e,void 0,null===(n=r.initiator)||void 0===n?void 0:n.url),Promise.resolve(null))}))}return ue.inst.URL_to_UUID_async(e).then((s=>this._load2(e,s,t,r,i)))}return this._load2(e,null,t,r,i)}_load2(e,t,r,i,s){var a,n;let{ext:l,typeId:o,main:h,loaderType:_}=Ki.getURLInfo(e,r);if(!_)return!i.silent&&Ki.warnFailed(e,void 0,null===(a=i.initiator)||void 0===a?void 0:a.url),Promise.resolve(null);let u,d=de.formatURL(e);if(i.group){let e=Ki.groupMap[i.group];e||(e=Ki.groupMap[i.group]=new Set),e.add(d)}if(!i.ignoreCache){let e=Ki._getRes(d,r);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof w))return Promise.resolve(e);if(e.obsolute&&(u=e),!(u||e.uuid&&t&&t!=e.uuid))return Promise.resolve(e)}}let c=d;h||(c+="@"+o);let p=this._loadings.get(c);if(p){let e=i.initiator;for(;e;){if(e===p)return Promise.resolve();e=e.options.initiator}return s&&p.onProgress.add(s),new Promise((e=>p.onComplete.add(e)))}let f=Oi.getFileLoadPath(d);if(f)return this.load(f.url,{type:Ki.ATLAS,baseUrl:f.baseUrl}).then((()=>Ki.getRes(e,r)));p=Zi.length>0?Zi.pop():new $i,p.type=r,p.url=e,p.uuid=t,p.ext=l,delete(i=Object.assign(p.options,i)).type,null==i.priority&&(i.priority=0),null==i.useWorkerLoader&&(i.useWorkerLoader=Ni.enable),s&&p.onProgress.add(s),p.loader=this,p.obsoluteInst=u;let g,m=new _;this._loadings.set(c,p);try{g=m.load(p)}catch(t){!i.silent&&Ki.warnFailed(e,t,null===(n=i.initiator)||void 0===n?void 0:n.url),g=Promise.resolve(null)}return g.then((r=>(r instanceof w&&r._setCreateURL(e,t),!1!==p.options.cache&&Ki._cacheRes(d,r,o,h),p.progress.update(-1,1),p.onComplete.invoke(r),r))).catch((t=>{var r;return!i.silent&&Ki.warnFailed(e,t,null===(r=i.initiator)||void 0===r?void 0:r.url),!1!==p.options.cache&&Ki._cacheRes(d,null,o,h),p.onComplete.invoke(null),null})).then((e=>(this._loadings.delete(c),p.reset(),Zi.push(p),0==this._loadings.size&&this.event(E.COMPLETE),e)))}fetch(e,t,r,i){var s;let a={originalUrl:e,url:e,contentType:t,priority:null!==(s=(i=i||Qi).priority)&&void 0!==s?s:1,retryCnt:0,onProgress:r,onComplete:null};return i.useWorkerLoader&&(a.useWorkerLoader=!0,a.workerLoaderOptions=i.workerLoaderOptions),i.blob&&(a.blob=i.blob),i.noRetry&&(a.retryCnt=-1),i.silent&&(a.silent=!0),ue.inst.resolveURL(e).then((e=>e?new Promise((t=>{a.url=de.formatURL(e),a.onComplete=t,this.queueToDownload(a)})):null))}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let r=this._queue.findIndex((e=>e.priority<t));-1!=r?this._queue.splice(r,0,e):this._queue.push(e)}}download(e){this._downloadings.add(e);let t=de.postFormatURL(e.url);if("image"==e.contentType){let r=Ki.preLoadedMap[e.url];if(r){if(!(r instanceof ArrayBuffer))return void this.completeItem(e,r);e.blob=r}e.blob?Ki.downloader.imageWithBlob(e,e.blob,e.originalUrl,e.onProgress,((t,r)=>{t||(e.retryCnt=-1),this.completeItem(e,t,r)})):e.useWorkerLoader?Ki.downloader.imageWithWorker(e,t,e.originalUrl,e.onProgress,((t,r)=>{t||(e.useWorkerLoader=!1),this.completeItem(e,t,r)})):Ki.downloader.image(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}else if("sound"==e.contentType)Ki.downloader.audio(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)));else{let r=Ki.preLoadedMap[e.url];if(r)return void this.completeItem(e,r);Ki.downloader.common(e,t,e.originalUrl,e.contentType,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}}completeItem(e,t,r){this._downloadings.delete(e),t?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onProgress&&e.onProgress(1),e.onComplete(t)):-1!=e.retryCnt&&e.retryCnt<this.retryNum?(e.retryCnt++,e.silent||console.debug(`Retry to load ${e.url} (${e.retryCnt})`),n.systemTimer.once(this.retryDelay,this,this.queueToDownload,[e],!1)):(!e.silent&&Ki.warnFailed(e.url),e.onProgress&&e.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onComplete(null))}static getURLInfo(e,t){let r,i,s,a,n=e.startsWith("data:")?"png":d.getFileExtension(e);if(n.length>0&&(r=Ki.extMap[n]),t){let e=Ki.typeMap[t];if(!e)return qi;i=e.typeId;let n=0;r?r[0].typeId===i||-1!=(n=r.findIndex((e=>e.typeId===i)))?(s=0==n,a=r[n].loaderType):(s=!1,a=e.loaderType):(s=t!=Ki.TEXTURE2D,a=e.loaderType)}else{if(!r)return qi;s=!0,i=r[0].typeId,a=r[0].loaderType}return{ext:n,main:s,typeId:i,loaderType:a}}static warnFailed(e,t,r){r?this.warn(`Failed to load '${e}' (in '${r}')`,t):this.warn(`Failed to load '${e}'`,t)}static warn(e,t){t?console.warn(e,t):console.warn(e)}static getRes(e,t){return e=de.formatURL(e),Ki._getRes(e,t)||null}static _getRes(e,t){let r,i=Ki.loadedMap[e];if(i){if(t){let e=Ki.typeMap[t];if(!e)return;if(2==i.length)i[0]==e.typeId&&(r=i[1]);else{let t=i.indexOf(e.typeId);-1!=t&&(r=i[t+1])}}else r=i[1];return r instanceof w&&r.destroyed?void 0:r}}static getTexture2D(e){return Ki.getRes(e,Ki.TEXTURE2D)}static getBaseTexture(e){return Ki.getRes(e,Ki.TEXTURE2D)}static getAtlas(e){return Ki.getRes(e,Ki.ATLAS)}getRes(e,t){return Ki.getRes(e,t)}static createNodes(e){var t;return null===(t=Ki.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,r){e=de.formatURL(e);let i=Ki.getURLInfo(e,r);null!=i.typeId&&Ki._cacheRes(e,t,i.typeId,i.main)}static _cacheRes(e,t,r,i){let s=Ki.loadedMap[e];if(i)s?(s[0]=r,s[1]=t):s=Ki.loadedMap[e]=[r,t];else if(s){let e=s.findIndex((e=>e===r));-1!=e?s[e+1]=t:s.push(r,t)}else s=Ki.loadedMap[e]=[null,void 0,r,t]}cacheRes(e,t,r){Ki.cacheRes(e,t,r)}static clearRes(e,t){e=de.formatURL(e),Ki._clearRes(e,t)}clearRes(e,t){e=de.formatURL(e),Ki._clearRes(e,t)}static _clearRes(e,t){let r=Ki.loadedMap[e];if(r)if(t){if(r[1]==t)2==r.length?delete Ki.loadedMap[e]:r[1]=void 0;else{let i=r.indexOf(t);if(-1==i)return;4==r.length&&null==r[0]?delete Ki.loadedMap[e]:r.splice(i-1,2)}t instanceof w&&!t.destroyed&&t.destroy()}else if(delete Ki.loadedMap[e],r.length>2)for(let e=1;e<r.length;e+=2){let t=r[e];t instanceof w&&!t.destroyed&&t.destroy()}else{let e=r[1];e instanceof w&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=de.formatURL(e);let t=Ki.loadedMap[e];if(!t)return;let r=t[1];if(r instanceof ae)r.disposeBitmap();else if(r instanceof Ui)for(let e of r.textures)e.disposeBitmap()}static setGroup(e,t){e=de.formatURL(e);let r=Ki.groupMap[t];r||(r=Ki.groupMap[t]=new Set),r.add(e)}static clearResByGroup(e){let t=Ki.groupMap[e];if(t)for(let e of t)Ki._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,r=e.length;t<r;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=de.formatURL(e);let t=this._queue.findIndex((t=>t.url==e));if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,r){let i,s;if("string"==typeof t?(s=t,i=r):i=t,s){s.endsWith("/")||(s+="/");let t=e+"/";return de.basePaths[t]=s,this._loadSubFileConfig(e,null,i)}{if(l.isPreview)return Promise.resolve();let t=n.Browser.miniGameContext;return null==t?this._loadSubFileConfig(e,null,i):this._loadMiniPackage(t,e,i).then((()=>this._loadSubFileConfig(e,t,i)))}}_loadMiniPackage(e,t,r){return e.subPkgNameSeperator&&(t=t.replace(/\//g,e.subPkgNameSeperator)),t.length>0?new Promise(((i,s)=>{let a=e.loadSubpackage({name:t,success:e=>{i(e)},fail:e=>{s(e)}});a.onProgressUpdate&&a.onProgressUpdate((e=>{r&&r(e)}))})):Promise.resolve()}_loadSubFileConfig(e,t,r){return t&&t.subPkgPathSeperator&&(e=e.replace(/\//g,t.subPkgPathSeperator)),e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",r).then((r=>{let i=[],s=r.files;for(let e in s)if(e.length>0)for(let t of s[e])i.push(e+"/"+t);else for(let t of s[e])i.push(t);if(r.hash){let e=0,t=de.version;for(let s of r.hash)null!=s&&(t[i[e]]=s),e++}let a,l,o=r.config,h=o.length,_=0,u=0,d=0,c=0,p=0,f=ue.inst.metaMap;for(;;){if(null==a){if(_>=h)break;l=o[_],a=l.i,Array.isArray(a)?p=a.length:(d=a,p=0,c=1),u=0}if(0==c){if(u>=p){_++,a=null;continue}c=a[u++],c>0?(d=c,c=0):c=-c}else c--;let e=i[d+c];switch(l.t){case 0:f[e]=l;break;case 1:Oi.addAtlas(e,l.prefix,l.frames);break;case 2:ue.inst.shaderNameMap[l.shaderName]=e;break;case 3:Ki.preLoadedMap[de.formatURL(e)]=l}}return!t&&r.entry?n.Browser.loadLib(de.formatURL(e+r.entry)):Promise.resolve()}))}}Ki.TEXT="text",Ki.JSON="json",Ki.XML="xml",Ki.BUFFER="arraybuffer",Ki.IMAGE="image",Ki.SOUND="sound",Ki.VIDEO="video",Ki.ATLAS="atlas",Ki.FONT="font",Ki.TTF="ttf",Ki.HIERARCHY="HIERARCHY",Ki.MESH="MESH",Ki.MATERIAL="MATERIAL",Ki.TEXTURE2D="TEXTURE2D",Ki.TEXTURECUBE="TEXTURE2D",Ki.TEXTURE2DARRAY="TEXTURE2D",Ki.ANIMATIONCLIP="ANIMATIONCLIP",Ki.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Ki.TERRAINRES="TERRAIN",Ki.SPINE="SPINE",Ki.extMap={},Ki.typeMap={},Ki.downloader=new zi,Ki.groupMap={},Ki.loadedMap={},Ki.preLoadedMap={};class $i{constructor(){this.options={},this.onProgress=new y,this.onComplete=new y,this.progress=new Gi((e=>this.onProgress.invoke(e)))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null}}const Zi=[],Qi={};class Ji{static subtractVector3(e,t,r){r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2]}static lerp(e,t,r){return e*(1-r)+t*r}static scaleVector3(e,t,r){r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t}static lerpVector3(e,t,r,i){var s=e[0],a=e[1],n=e[2];i[0]=s+r*(t[0]-s),i[1]=a+r*(t[1]-a),i[2]=n+r*(t[2]-n)}static lerpVector4(e,t,r,i){var s=e[0],a=e[1],n=e[2],l=e[3];i[0]=s+r*(t[0]-s),i[1]=a+r*(t[1]-a),i[2]=n+r*(t[2]-n),i[3]=l+r*(t[3]-l)}static slerpQuaternionArray(e,t,r,i,s,a,n){var l,o,h,_,u,d=e[t+0],c=e[t+1],p=e[t+2],f=e[t+3],g=r[i+0],m=r[i+1],T=r[i+2],x=r[i+3];return(o=d*g+c*m+p*T+f*x)<0&&(o=-o,g=-g,m=-m,T=-T,x=-x),1-o>1e-6?(l=Math.acos(o),h=Math.sin(l),_=Math.sin((1-s)*l)/h,u=Math.sin(s*l)/h):(_=1-s,u=s),a[n+0]=_*d+u*g,a[n+1]=_*c+u*m,a[n+2]=_*p+u*T,a[n+3]=_*f+u*x,a}static getRotation(e,t,r,i){return Math.atan2(i-t,r-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,r=!0){var i;return i=t?r?Ji.sortNumBigFirst:Ji.sortBigFirst:r?Ji.sortNumSmallFirst:Ji.sortSmallFirst,function(t,r){return i(t[e],r[e])}}}class es extends Fi{static _sortIndexFun(e,t){return e.index-t.index}constructor(){super(),void 0===es._sortIndexFun&&(es._sortIndexFun=Ji.sortByKey("index",!1,!0))}_setUp(e,t){this._targetDic=e,this._animationData=t,this.interval=1e3/t.frameRate,t.parsed?(this._count=t.count,this._labels=t.labels,this._usedFrames=t.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),t.parsed=!0,t.labels=this._labels,t.count=this._count,t.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){r||(r=this._targetDic);var i=r[e.target];if(i){var s,a,n,l,o=e.frames,h=e.keys,_=h.length;for(l=0;l<_;l++)n=(a=o[s=h[l]]).length>t?a[t]:a[a.length-1],i[s]=n;var u,d=e.funkeys;if(0!=(_=d.length))for(l=0;l<_;l++)void 0!==(u=o[s=d[l]])[t]&&i[s]&&i[s].apply(i,u[t])}}_calculateDatas(){if(this._animationData){var e,t,r=this._animationData.nodes,i=r.length;for(this._count=0,e=0;e<i;e++)t=r[e],this._calculateKeyFrames(t);this._count+=1}}_calculateKeyFrames(e){var t,r,i=e.keyframes,s=e.target;for(t in e.frames||(e.frames={}),e.keys?e.keys.length=0:e.keys=[],e.funkeys?e.funkeys.length=0:e.funkeys=[],e.initValues||(e.initValues={}),i){var a=-1!=t.indexOf("()");if(r=i[t],a&&(t=t.substr(0,t.length-2)),e.frames[t]||(e.frames[t]=[]),a){e.funkeys.push(t);for(var n=e.frames[t],l=0;l<r.length;l++){var o=r[l];n[o.index]=o.value,o.index>this._count&&(this._count=o.index)}}else this._targetDic&&this._targetDic[s]&&(e.initValues[t]=this._targetDic[s][t]),r.sort(es._sortIndexFun),e.keys.push(t),this._calculateNodePropFrames(r,e.frames[t],t,s)}}resetNodes(){if(this._targetDic&&this._animationData){var e,t,r,i=this._animationData.nodes,s=i.length;for(e=0;e<s;e++)if(r=(t=i[e]).initValues){var a,n=this._targetDic[t.target];if(n)for(a in r)n[a]=r[a]}}}_calculateNodePropFrames(e,t,r,i){var s,a=e.length-1;for(t.length=e[a].index+1,s=0;s<a;s++)this._dealKeyFrame(e[s]),this._calculateFrameValues(e[s],e[s+1],t);0==a&&(t[0]=e[0].value,this._usedFrames&&(this._usedFrames[e[0].index]=!0)),this._dealKeyFrame(e[s])}_dealKeyFrame(e){e.label&&""!=e.label&&this.addLabel(e.label,e.index)}_calculateFrameValues(e,t,r){var i,s,a=e.index,n=t.index,l=e.value,o=t.value-e.value,h=n-a,_=this._usedFrames;if(n>this._count&&(this._count=n),e.tween)for(null==(s=Mi[e.tweenMethod])&&(s=Mi.linearNone),i=a;i<n;i++)r[i]=s(i-a,l,o,h),_&&(_[i]=!0);else for(i=a;i<n;i++)r[i]=l;_&&(_[e.index]=!0,_[t.index]=!0),r[t.index]=t.value}}class ts extends es{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(e){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[e.compId]=e.props,e.compId&&this._nodeList.push(e.compId);var t=e.child;if(t){var r,i=t.length;for(r=0;r<i;r++)this._parseNodeList(t[r])}}_calGraphicData(e){var t;if(this._setUp(null,e),this._createGraphicData(),this._nodeIDAniDic)for(t in this._nodeIDAniDic)this._nodeIDAniDic[t]=null}_createGraphicData(){var e,t,r=[],i=this.count,s=this._usedFrames;for(s||(s=[]),e=0;e<i;e++)!s[e]&&t||(t=this._createFrameGraphic(e)),r.push(t);this._gList=r}_createFrameGraphic(e){var t=new bi;return ts._rootMatrix||(ts._rootMatrix=new p),this._updateNodeGraphic(this._rootNode,e,ts._rootMatrix,t),t}_updateNodeGraphic(e,t,r,i,s=1){var a,n,l;(a=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId])).resultTransform||(a.resultTransform=new p),n=a.resultTransform,p.mul(a.transform,r,n);var o=a.alpha*s;if(!(o<.01)){a.skin&&(l=this._getTextureByUrl(a.skin))&&(n._checkTransform()?(i.drawTexture(l,0,0,a.width,a.height,n,o),a.resultTransform=null):i.drawTexture(l,n.tx,n.ty,a.width,a.height,null,o));var h,_,u=e.child;if(u)for(_=u.length,h=0;h<_;h++)this._updateNodeGraphic(u[h],t,n,i,o)}}_updateNoChilds(e,t){if(e.skin){var r=this._getTextureByUrl(e.skin);if(r){var i=e.transform;i._checkTransform(),!i._bTransform?t.drawTexture(r,i.tx,i.ty,e.width,e.height,null,e.alpha):t.drawTexture(r,0,0,e.width,e.height,i.clone(),e.alpha)}}}_updateNodeGraphic2(e,t,r){var i;if(i=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId]),e.child){var s,a,n,l=i.transform;l._checkTransform(),a=(s=!l._bTransform)&&(0!=l.tx||0!=l.ty),(n=l._bTransform||1!=i.alpha)&&r.save(),1!=i.alpha&&r.alpha(i.alpha),s?a&&r.translate(l.tx,l.ty):r.transform(l.clone());var o,h,_,u=e.child;if(i.skin&&(o=this._getTextureByUrl(i.skin))&&r.drawImage(o,0,0,i.width,i.height),u)for(_=u.length,h=0;h<_;h++)this._updateNodeGraphic2(u[h],t,r);n?r.restore():s?a&&r.translate(-l.tx,-l.ty):r.transform(l.clone().invert())}else this._updateNoChilds(i,r)}_calculateKeyFrames(e){super._calculateKeyFrames(e),this._nodeIDAniDic[e.target]=e}getNodeDataByID(e){return this._nodeIDAniDic[e]}_getParams(e,t,r,i){var s=ts._temParam;s.length=t.length;var a,n=t.length;for(a=0;a<n;a++)s[a]=this._getObjVar(e,t[a][0],r,t[a][1],i);return s}_getObjVar(e,t,r,i,s){if(t in e){var a=e[t];return r>=a.length&&(r=a.length-1),e[t][r]}return t in s?s[t]:i}_getNodeGraphicData(e,t,r){r||(r=new rs),r.transform?r.transform.identity():r.transform=new p;var i=this.getNodeDataByID(e);if(!i)return r;var s,a,n,l=i.frames,o=this._getParams(l,ts._drawTextureCmd,t,this._nodeDefaultProps[e]),h=o[0],_=o[5],u=o[6],d=o[13],c=o[14],f=o[7],g=o[8],m=o[9],T=o[11],x=o[12];s=o[3],a=o[4],0!=s&&0!=a||(h=null),-1==s&&(s=0),-1==a&&(a=0),r.skin=h,r.width=s,r.height=a,h&&((n=this._getTextureByUrl(h))?(s||(s=n.sourceWidth),a||(a=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=o[10];var y=r.transform;0!=d&&(_=d*s),0!=c&&(u=c*a),0==_&&0==u||y.translate(-_,-u);var E=null;if(m||1!==f||1!==g||T||x){(E=ts._tempMt).identity(),E._bTransform=!0;var S=.0174532922222222*(m-T),b=.0174532922222222*(m+x),v=Math.cos(b),R=Math.sin(b),A=Math.sin(S),C=Math.cos(S);E.a=f*v,E.b=f*R,E.c=-g*A,E.d=g*C,E.tx=E.ty=0}return E&&(y=p.mul(y,E,y)),y.translate(o[1],o[2]),r}_getTextureByUrl(e){return Ki.getRes(e)}setAniData(e,t=null){if(e.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e);var r,i,s={},a=[],n=e.animations,l=n.length;for(r=0;r<l;r++)if(i=n[r],this._labels=null,(!t||t==i.name)&&i){try{this._calGraphicData(i)}catch(e){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var o={};o.interval=1e3/i.frameRate,o.frames=this._gList,o.labels=this._labels,o.name=i.name,a.push(o),s[i.name]=o}this.animationList=a,this.animationDic=s}ts._temParam.length=0}parseByData(e){var t,r;t=e.nodeRoot,r=e.aniO,delete e.nodeRoot,delete e.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t),this._labels=null;try{this._calGraphicData(r)}catch(e){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var i=e;return i.interval=1e3/r.frameRate,i.frames=this._gList,i.labels=this._labels,i.name=r.name,i}setUpAniData(e){if(e.animations){var t,r,i={},s=[],a=e.animations,n=a.length;for(t=0;t<n;t++)if(r=a[t]){var l={};l.name=r.name,l.aniO=r,l.nodeRoot=e,s.push(l),i[r.name]=l}this.animationList=s,this.animationDic=i}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(e){var t;return ts._I||(ts._I=new ts),t=ts._I.parseByData(e),ts._I._clear(),t}static parseAnimationData(e){var t;return ts._I||(ts._I=new ts),ts._I.setUpAniData(e),(t={}).animationList=ts._I.animationList,t.animationDic=ts._I.animationDic,ts._I._clear(),t}}ts._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],ts._temParam=[],ts._tempMt=new p;class rs{constructor(){this.alpha=1}}class is extends Fi{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(e=!0){this.stop(),super.destroy(e),this._frames=null,this._labels=null}play(e=0,t=!0,r=""){r&&this._setFramesFromCache(r,!0),super.play(e,t,r)}_setFramesFromCache(e,t=!1){if(this._url&&(e=this._url+"#"+e),e&&is.framesMap[e]){var r=is.framesMap[e];return r instanceof Array?(this._frames=is.framesMap[e],this._count=this._frames.length):(r.nodeRoot&&(is.framesMap[e]=ts.parseAnimationByData(r),r=is.framesMap[e]),this._frames=r.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=r.interval),this._labels=this._copyLabels(r.labels)),!0}return t&&console.log("ani not found:",e),!1}_copyLabels(e){if(!e)return null;var t,r;for(r in t={},e)t[r]=d.copyArray([],e[r]);return t}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(e){this._frames&&(this.graphics=this._frames[e])}get frames(){return this._frames}set frames(e){this._frames=e,e&&(this._count=e.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(e){this._source=e,e?e.indexOf(".ani")>-1?this.loadAnimation(e):e.startsWith("res://")||e.indexOf(".json")>-1||e.indexOf("als")>-1||e.indexOf("atlas")>-1?this.loadAtlas(e):this.loadImages(e.split(",")):this.clear()}set autoPlay(e){this._autoPlay=e,e?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(e,t=""){return this._url="",this._setFramesFromCache(t)||(this.frames=is.framesMap[t]?is.framesMap[t]:is.createFrames(e,t)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(e,t=null,r=""){if(this._url="",!this._setFramesFromCache(r)){let onLoaded=i=>{e===i&&(this.frames=is.framesMap[r]?is.framesMap[r]:is.createFrames(e,r),!this._isPlaying&&this._autoPlay&&this.play(),t&&t.run())};Ki.getAtlas(e)?onLoaded(e):n.loader.load(e,wi.create(null,onLoaded,[e]),null,Ki.ATLAS)}return this}loadAnimation(e,t=null,r=null){this._url=e;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,t&&t.run()):!r||Ki.getAtlas(r)?this._loadAnimationData(e,t,r):n.loader.load(r,wi.create(this,this._loadAnimationData,[e,t,r]),null,Ki.ATLAS),this}_loadAnimationData(e,t=null,r=null){!r||Ki.getAtlas(r)?n.loader.fetch(e,"json").then((r=>{if(this._url!==e)return;if(!r)return void(is.framesMap[e+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),t&&t.run()));let i;if(is.framesMap[e+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let t=ts.parseAnimationData(r);if(!t)return;let s,a=t.animationList,n=a.length;for(let t=0;t<n;t++)i=a[t],is.framesMap[e+"#"+i.name]=i,s||(s=i);s&&(is.framesMap[e+"#"]=s,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}t&&t.run()})):console.warn("atlas load fail:"+r)}static createFrames(e,t){var r;if("string"==typeof e){var i=Ki.getAtlas(e);if(i&&i.frames.length){let e=i.frames;r=[];for(var s=0,a=e.length;s<a;s++){var n=new bi;n.drawImage(e[s],0,0),r.push(n)}}}else if(e instanceof Array)for(r=[],s=0,a=e.length;s<a;s++)(n=new bi).loadImage(e[s],0,0),r.push(n);return t&&(is.framesMap[t]=r),r}static clearCache(e){var t,r=is.framesMap,i=e+"#";for(t in r)t!==e&&0!==t.indexOf(i)||delete is.framesMap[t]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}is.framesMap={};class ss extends w{static loadFont(e,t){n.loader.load(e,Ki.FONT).then((e=>{t&&t.runWith(e)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(e,t){var r;if(null==e||null==t)return;this.texture=t,t._addReference();let i=e.getNode("info");this.fontSize=i.getAttrInt("size",12),this.autoScaleSize=i.getAttrBool("autoScaleSize"),this.lineHeight=i.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let s=i.getAttrString("padding","").split(",");this.padding=[parseInt(s[0]),parseInt(s[1]),parseInt(s[2]),parseInt(s[3])];let a=(null===(r=e.getNode("chars"))||void 0===r?void 0:r.elements("char"))||[],n=0,l=this.dict;for(let e=0,r=a.length;e<r;e++){let r=a[e],i=r.getAttrInt("id"),s=r.getAttrInt("xoffset")/1,o=r.getAttrInt("yoffset")/1,h=r.getAttrInt("xadvance")/1,_=r.getAttrInt("x"),u=r.getAttrInt("y"),d=r.getAttrInt("width"),c=r.getAttrInt("height"),p=ae.create(t,_,u,d,c,s,o);0==h&&(h=d),h+=this.letterSpacing,n=Math.max(n,h),l[i]={x:0,y:0,width:d,height:c,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,l[32]||(l[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let r=0;for(let i=0,s=e.length;i<s;i++){let s=this.dict[e.charCodeAt(i)];if(s){let e=this.autoScaleSize?t/this.fontSize:1;r+=Math.round(s.advance*e)}}return r}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class as extends es{constructor(){super(...arguments),this._initData={}}set target(e){this._target&&this._target.off(as.EFFECT_BEGIN,this,this._onOtherBegin),this._target=e,this._target&&this._target.on(as.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}get target(){return this._target}_onOtherBegin(e){e!==this&&this.stop()}set playEvent(e){this._playEvent=e,e&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(e=0,t=!0,r=""){this._target&&(this._target.event(as.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(e,t,r))}_recordInitData(){var e,t,r;if(this._aniKeys)for(t=this._aniKeys.length,e=0;e<t;e++)r=this._aniKeys[e],this._initData[r]=this._target[r]}set effectClass(e){if(this._effectClass=t.getClass(e),this._effectClass){var r=this._effectClass.uiView;if(r){var i=r.animations;if(i&&i[0]){var s=i[0];this._setUp({},s),s.nodes&&s.nodes[0]&&(this._aniKeys=s.nodes[0].keys)}}}}set effectData(e){if(e){var t=e.animations;if(t&&t[0]){var r=t[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(i=i>1?1:i,t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){if(this._target){var i,s,a,n,l,o,h,_,u,d=this._target,c=e.frames,p=e.keys,f=p.length,g=e.secondFrames;for(n=0;n<f;n++)s=c[i=p[n]],-1==(l=g[i])?a=this._initData[i]:t<l?(_=(h=e.keyframes[i])[0]).tween?(null==(o=Mi[_.tweenMethod])&&(o=Mi.linearNone),u=h[1],a=o(t,this._initData[i],u.value-this._initData[i],u.index)):a=this._initData[i]:a=s.length>t?s[t]:s[s.length-1],d[i]=a}}_calculateKeyFrames(e){super._calculateKeyFrames(e);var t,r,i=e.keyframes;e.target;var s={};for(t in e.secondFrames=s,i)(r=i[t]).length<=1?s[t]=-1:s[t]=r[1].index}}as.EFFECT_BEGIN="effectbegin";class ns{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var ls;e.HtmlElementType=void 0,(ls=e.HtmlElementType||(e.HtmlElementType={}))[ls.Text=0]="Text",ls[ls.Link=1]="Link",ls[ls.Image=2]="Image",ls[ls.Input=3]="Input",ls[ls.Select=4]="Select",ls[ls.Object=5]="Object",ls[ls.LinkEnd=6]="LinkEnd";class os{constructor(){this.style=new ns}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return Vi.getString(this._attrs,e,t)}getAttrInt(e,t){return Vi.getInt(this._attrs,e,t)}getAttrFloat(e,t){return Vi.getFloat(this._attrs,e,t)}getAttrBool(e,t){return Vi.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},Hi.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),o.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let r;return r=this.pool.length>0?this.pool.pop():new os,r.type=t,r.type==e.HtmlElementType.Text||r._attrs||(r._attrs={}),r}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}os.pool=[];class hs{constructor(){this.obj=new Li}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let r=this._element.getAttrString("src");r&&this.loadTexture(r)}loadTexture(e){let t=this._element.getAttrInt("width",-1),r=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=r&&(this.obj.height=r);let i=Ki.getRes(e);i?(this.obj.texture=i,-1==t&&(this.obj.width=i.sourceWidth),-1==r&&(this.obj.height=i.sourceHeight)):n.loader.load(e,{silent:!0}).then((e=>{if(this.obj.destroyed)return;let i=this.obj.width,s=this.obj.height;this.obj.texture=e,-1==t&&(this.obj.width=e?e.sourceWidth:0),-1==r&&(this.obj.height=e?e.sourceHeight:0),!this._owner||i==this.obj.width&&s==this.obj.height||this._owner.refreshLayout()}))}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null}destroy(){this.obj.destroy()}}class _s{constructor(){this._shape=new Li,this._shape.hitArea=this,this._shape.on(E.CLICK,(()=>{this._owner.bubbleEvent(E.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,r,i){let s=this._rects[this._rectCnt];s||(s=this._rects[this._rectCnt]=new g),this._rectCnt++,s.setTo(e,t,r,i)}contains(e,t){for(let r=0;r<this._rectCnt;r++)if(this._rects[r].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class us{constructor(){this.linkUnderline=us.defaultLinkUnderline,this.linkColor=us.defaultLinkColor}}us.defaultLinkUnderline=!0,us.defaultLinkColor=null,t.regClass("HtmlParseOptions",us);const ds=new Array,cs=new Array;class ps{constructor(){this._styleStack=new Array,this._style=new ns,this._options=new us}parse(t,r,i,s){null==s&&(s=this._options),this._elements=i,this._styleStackTop=0,Object.assign(this._style,r),this._style.colorChanged=!1;let a,n=0,l=s.ignoreWhiteSpace,o=!1;for(Hi.begin(t,!0);Hi.nextTag();)switch(0==n&&(a=Hi.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),o=!1,Hi.tagName){case"b":Hi.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":Hi.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":Hi.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":Hi.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(Hi.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=Vi.getInt(Hi.attributes,"size",this._style.fontSize);let e=Hi.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else Hi.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(Hi.tagType==e.XMLTagType.Start||Hi.tagType==e.XMLTagType.Void){let t=os.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(Hi.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||s.linkUnderline,this._style.colorChanged||null==s.linkColor||(this._style.color=s.linkColor);let t=os.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(Hi.tagType==e.XMLTagType.End){this.popStyle();let t=os.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=os.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(Hi.tagType==e.XMLTagType.Start||Hi.tagType==e.XMLTagType.Void){let t=os.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),Hi.tagType==e.XMLTagType.Start){for(ds.length=0,cs.length=0;Hi.nextTag()&&"select"!=Hi.tagName;)"option"==Hi.tagName&&(Hi.tagType==e.XMLTagType.Start||Hi.tagType==e.XMLTagType.Void?cs.push(Vi.getString(Hi.attributes,"value","")):ds.push(Hi.getText()));t.setAttr("items",ds.slice()),t.setAttr("values",cs.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":Hi.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=Hi.getAttribute("align"),this.isNewLine()||this.appendText("\n")):Hi.tagType==e.XMLTagType.End&&(this.appendText("\n"),o=!0,this.popStyle());break;case"ui":case"div":case"li":Hi.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),o=!0);break;case"html":case"body":l=!0;break;case"head":case"style":case"script":case"form":Hi.tagType==e.XMLTagType.Start?n++:Hi.tagType==e.XMLTagType.End&&n--}0==n&&(a=Hi.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new ns,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let r;this._elements.length>0&&(r=this._elements[this._elements.length-1],r.type==e.HtmlElementType.Text&&function(e,t){for(let r in e)if(!r.startsWith("_")&&e[r]!=t[r])return!1;return!0}(r.style,this._style))?r.text+=t:(r=os.getFromPool(e.HtmlElementType.Text),r.text=t,Object.assign(r.style,this._style),this._elements.push(r))}}ps.defaultParser=new ps,ps.classMap={[e.HtmlElementType.Image]:hs,[e.HtmlElementType.Link]:_s};class fs{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,r){return t?"</a>":null!=r?'<a href="'+r+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,r){if(t)return null;var i=this.getTagText(!0);return i?this.defaultImgWidth?'<img src="'+i+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+i+'"/>':null}onTag_B(e,t,r){return t?"</b>":"<b>"}onTag_I(e,t,r){return t?"</i>":"<i>"}onTag_U(e,t,r){return t?"</u>":"<u>"}onTag_Simple(e,t,r){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,r){return t?"</font>":(this.lastColor=r,'<font color="'+r+'">')}onTag_FONT(e,t,r){return t?"</font>":'<font face="'+r+'">'}onTag_SIZE(e,t,r){return t?"</font>":(this.lastSize=r,'<font size="'+r+'">')}getTagText(e){for(var t,r=this._readPos,i="";-1!=(t=this._text.indexOf("[",r));){if(92!=this._text.charCodeAt(t-1)){i+=this._text.substring(r,t);break}i+=this._text.substring(r,t-1),i+="[",r=t+1}return-1==t?null:(e&&(this._readPos=t),i)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var r,i,s,a,n,l,o,h=0,_="";-1!=(r=e.indexOf("[",h));)if(r>0&&92==e.charCodeAt(r-1))_+=e.substring(h,r-1),_+="[",h=r+1;else{if(_+=e.substring(h,r),h=r,-1==(r=e.indexOf("]",h)))break;s="/"==e.charAt(h+1),a=e.substring(s?h+2:h+1,r),this._readPos=r+1,n=null,l=null,-1!=(i=a.indexOf("="))&&(n=a.substring(i+1),a=a.substring(0,i)),a=a.toLowerCase(),null!=(o=this._handlers[a])?t||null!=(l=o.call(this,a,s,n))&&(_+=l):_+=e.substring(h,this._readPos),h=this._readPos}return h<e.length&&(_+=e.substring(h)),this._text=null,_}}fs.defaultParser=new fs;class gs extends Li{constructor(){super(),this._overflow=gs.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new ns,this._textStyle.fontSize=r.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(e,t){t._addReference(),gs._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let r=gs._bitmapFonts[e];r&&(r._removeReference(),t&&r.destroy(),delete gs._bitmapFonts[e])}destroy(e=!0){recoverLines(this._lines),os.returnToPool(this._elements),super.destroy(e)}_getBoundPointsM(e=!1){var t=g.TEMP;return t.setTo(0,0,this.width,this.height),t._getBoundPoints()}getGraphicBounds(e=!1){var t=g.TEMP;return t.setTo(0,0,this.width,this.height),t}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(e){super._setWidth(e),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(e){super._setHeight(e),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&gs.langPacks&&(e=gs.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(E.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=r.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=gs._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(d.getFileExtension(e)||e.startsWith("res://"))){let t=e,r=n.loader.getRes(e);!r||r.obsolute?n.loader.load(e).then((e=>{e&&this._realFont==t&&(e instanceof ss?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())})):(r instanceof ss?this._bitmapFont=r:this._realFont=r.family,this._text&&this.markChanged())}else this._realFont=n.Browser.onIPhone&&r.fontFamilyMap[e]||e,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this.set_color(e)}set_color(e){this._textStyle.color!=e&&(this._textStyle.color=e,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(e){this._textStyle.alignItems!=e&&(this._textStyle.alignItems=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let r=parseFloat(t[e]);isNaN(r)&&(r=0),this._padding.push(r)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,this.markChanged())}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender=e}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}parseTemplate(e){let t,r,i,s,a=0,n="";for(;-1!=(t=e.indexOf("{",a));)if(t>0&&92==e.charCodeAt(t-1))n+=e.substring(a,t-1),n+="{",a=t+1;else{if(n+=e.substring(a,t),a=t,t=e.indexOf("}",a),-1==t)break;t!=a+1?(i=e.substring(a+1,t),r=i.indexOf("="),-1!=r?(s=this._templateVars[i.substring(0,r)],n+=null==s?i.substring(r+1):s):(s=this._templateVars[i],null!=s&&(n+=s)),a=t+1):(n+=e.substring(a,a+2),a=t+1)}return a<e.length&&(n+=e.substring(a)),n}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,n.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&n.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){n.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new Li,this._objContainer.hideFlags|=a.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;os.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,r=this._text;if(!r&&this._prompt&&(r=this._prompt,t=!0),!r)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let i,s=this._html;if(r=r.replace(Es,"\n"),this._parseEscapeChars&&(r=r.replace(Ss,getReplaceStr)),!t&&this._templateVars&&(r=this.parseTemplate(r)),this._ubb&&(r=fs.defaultParser.parse(r),s=!0),!t&&this._asPassword&&(r=gs._passwordChar.repeat(r.length)),t&&(i=this._textStyle.color,this._textStyle.color=this._promptColor),s)ps.defaultParser.parse(r,this._textStyle,this._elements,this._htmlParseOptions);else{let t=os.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=r,this._elements.push(t)}t&&(this._textStyle.color=i),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,r=this._wordWrap||this._overflow==gs.ELLIPSIS,i=this._padding;if(t=this._isWidthSet?this._width-i[3]-i[1]:Number.MAX_VALUE,this._maxWidth>0){let e=this._maxWidth-i[3]-i[1];(!r||e<t)&&(t=e),r=!0}let s,a,l,h,_,u,d,c=this._isHeightSet?this._height-i[0]-i[2]:Number.MAX_VALUE,p=this._bitmapFont,m="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,getTextWidth=e=>{if(p)return p.getTextWidth(e,d);{let t=n.Browser.context.measureText(e);return t?t.width:100}},buildLines=(e,t)=>{if(p)_=p.getMaxWidth(d),u=p.getMaxHeight(d);else{let e=(t.italic?"italic ":"")+(t.bold?"bold ":"")+d+"px "+this._realFont;t._ctxFont=e,n.Browser.context.font=e;let r=n.Browser.context.measureText(gs._testWord);r?(_=r.width,u=Math.ceil(r.height||d)):(_=100,u=d)}let i=e.split("\n");if(r)for(let e=0,r=i.length;e<r;e++){let s=i[e];s.length>0&&wrapText(s,t),e!=r-1&&(endLine(),startLine())}else for(let e=0,r=i.length;e<r;e++){let s=i[e];s.length>0&&addCmd(s,t,null),e!=r-1&&(endLine(),startLine())}},addCmd=(e,t,r)=>{let i=ms.length>0?ms.pop():{};i.x=s,i.y=a,"string"==typeof e?(r||(r=getTextWidth(e)),i.wt||(i.wt=new yt),i.wt.setText(e),i.wt.width=r,i.wt.splitRender=this._singleCharRender,i.width=r,i.height=u):(i.obj=e,i.x++,i.width=e.width+2,i.height=e.height),i.style=t,i.linkEnd=!1,i.next=null,s+=Math.round(i.width),l.cmd?h.next=i:l.cmd=i,h=i},endLine=()=>{let e=0,t=l.cmd;for(;t;)t.height>e&&(e=t.height),t=t.next;for(t=l.cmd;t;)t.y=1==m?Math.floor(.5*(e-t.height)):2==m?Math.floor(e-t.height):0,t=t.next;0==e&&(e=u),e++,l.height=e,l.width=s},startLine=()=>(s=0,l&&(a+=l.height+Math.floor(this._textStyle.leading*this._fontSizeScale)),l=Ts.length>0?Ts.pop():{cmds:[]},l.x=0,l.y=a,this._lines.push(l),l),wrapText=(e,r)=>{let i=Math.max(0,t-s),a=getTextWidth(e);if(a<=i)return void addCmd(e,r,a);let n=0,l=0,o=0,h=testEmoji(e);p||h||(n=Math.floor(i/_),0==n&&(n=1),l=getTextWidth(e.substring(0,n)),i<l&&0!=s&&(endLine(),startLine(),i=t));let u=e.length;for(let _=n;_<u;_++){a=getTextWidth(e.charAt(_)),l+=a;let c=!1;if(h&&_+1<u&&testEmoji(e.charAt(_)+e.charAt(_+1))&&(l+=a>>1,_++,c=!0),l>i){if(c&&(l==a+(a>>1)?_++:_--),0==_){s>0&&(endLine(),startLine(),i=t);continue}let h=e.substring(o,_);l-=a;let p=h.charCodeAt(h.length-1);if((d=p)>=65&&d<=90||d>=97&&d<=122||39===d){let t=ys.exec(h);t&&(_=t.index+o,0==t.index?_+=h.length:(l=null,h=e.substring(o,_)))}if(addCmd(h,r,l),endLine(),startLine(),i=t,o=_,!(_+n<u)){addCmd(e.substring(o,u),r),o=-1;break}0!=n&&(_+=n-1),l=getTextWidth(e.substring(o,_+1))}}var d;-1!=o&&addCmd(e.substring(o,u),r)},calcTextSize=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=i[1]+i[3]),this._textWidth=e;let r=this._lines[this._lines.length-1];r&&(t=r.y+r.height),t>0&&(t+=i[0]+i[2]),this._textHeight=t},run=()=>{s=a=_=u=0,l=null,h=null,recoverLines(this._lines),startLine();let i=this._elements;for(let a=0,n=i.length;a<n;a++){let n=i[a];if(n.type==e.HtmlElementType.Text)d=Math.floor(n.style.fontSize*this._fontSizeScale),0==d&&(d=1),buildLines(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)h&&(h.linkEnd=!0);else{let e=n.obj;if(!e){let t=ps.classMap[n.type];t&&(e=o.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(r){t-s<e.width+1&&s>0&&(endLine(),startLine())}addCmd(e,n.style)}}}endLine(),calcTextSize()};if(run(),this._overflow==gs.SHRINK){if(this._lines.length>1&&this._textHeight>c){let e=0,r=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(c/this._textHeight);let i=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;run(),this._textWidth>t||this._textHeight>c?r=i:e=i,r-e>1||r!=e&&i==r;)i=e+(r-e)/2,this._fontSizeScale=i/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,run(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,run()}}else if(this._overflow==gs.ELLIPSIS&&(this._textWidth>t||this._textHeight>c)){let e=this._lines.findIndex((e=>e.y+e.height>c));0==e&&(e=1);let r=!1;-1!=e&&this._lines.length>e&&(recoverLines(this._lines.splice(e,this._lines.length-e)),r=!0);let i,s=this._lines[this._lines.length-1].cmd,a=!1;for(;s;)i=s.next,a?(s.obj?s.obj=null:s.wt&&s.wt.cleanCache(),ms.push(s)):(!i&&r||s.x+s.width>t)&&(s.obj&&(s.obj=null),s.wt||(s.wt=new yt),s.wt.setText(s.wt.text.substring(0,Math.max(0,s.wt.text.length-2))+vs),d=s.style.fontSize,s.width=s.wt.width=getTextWidth(s.wt.text),s.wt.splitRender=this._singleCharRender,s.next=null,a=!0),s=i;a&&calcTextSize()}this._onPostLayout&&this._onPostLayout();let T="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=T&&this._isWidthSet){let e=this._width-i[3]-i[1];for(let t of this._lines){let r=0;1==T?r=Math.floor(.5*(e-t.width)):2==T&&(r=e-t.width),r>0&&(t.x=r)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==gs.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new f(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==gs.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new g),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0),this.drawBg();let r=this._padding,i=r[3],s=r[0],a=this._bitmapFont,n=this._scrollPos,l=this._isWidthSet?this._width:this._textWidth,o=this._isHeightSet?this._height:this._textHeight,h=o-r[2],_=this._overflow==gs.HIDDEN||this._overflow==gs.SCROLL;_&&(t.save(),t.clipRect(0,0,l,o),this.repaint()),l-=r[3]+r[1],o-=r[0]+r[2];let u,d,c=0,p=0,f=this._lines,g=f.length;for(let r=0;r<g;r++){let o=f[r];c=i+o.x,p=s+o.y,n&&(c-=n.x,p-=n.y);let g=_&&(p+o.height<=s||p>=h),m=o.cmd;for(;m;){if(m.linkEnd&&u&&(u.addRect(d,p,c+m.x+m.width-d,o.height),u=null),m.obj)m.obj.pos(c+m.x,p+m.y),m.obj.element.type==e.HtmlElementType.Link&&(u=m.obj,u.resetArea(),d=c+m.x);else if(!g)if(a){let e=0,r=m.wt.text,i=a.tint?m.style.color:"#FFFFFF",s=Math.floor((a.autoScaleSize?m.style.fontSize:a.fontSize)*this._fontSizeScale)/a.fontSize;for(let n=0,l=r.length;n<l;n++){let l=r.charCodeAt(n),o=a.dict[l];o&&(o.texture&&t.drawImage(o.texture,c+m.x+e+o.x*s,p+m.y+o.y*s,o.width*s,o.height*s,i),e+=Math.round(o.advance*s))}}else{let e=m.style._ctxFont;m.style.stroke?t.fillBorderText(m.wt,c+m.x,p+m.y,e,m.style.color,null,m.style.stroke,m.style.strokeColor):t.fillText(m.wt,c+m.x,p+m.y,e,m.style.color,null)}if(!g&&m.style.underline){let e=Math.max(1,m.style.fontSize*this._fontSizeScale/16);t.drawLine(c+m.x,p+o.height-e,c+m.x+m.width,p+o.height-e,m.style.underlineColor||m.style.color,e)}m=m.next}u&&(u.addRect(d,p,l-d+i,o.height),d=i)}_&&t.restore()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new ei,e.x=e.y=0,e.width=e.height=1,e.percent=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,r=t.indexOf(e);0!=r&&(-1!=r&&t.splice(r,1),t.unshift(e),this.graphics.cmds=t)}else e&&this.graphics.removeCmd(e)}}gs.VISIBLE="visible",gs.SCROLL="scroll",gs.HIDDEN="hidden",gs.SHRINK="shrink",gs.ELLIPSIS="ellipsis",gs.RightToLeft=!1,gs._testWord="游",gs._passwordChar="●",gs._bitmapFonts={};const ms=[],Ts=[];function recoverLines(e){for(let t of e){let e=t.cmd;for(;e;)e.obj?e.obj=null:e.wt&&e.wt.cleanCache(),ms.push(e),e=e.next;t.cmd=null}Ts.push(...e),e.length=0}const xs=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;function testEmoji(e){return null!=e&&xs.test(e)}const ys=/(?:[^\s\!-\/])+$/,Es=/\r\n/g,Ss=/\\(\w)/g,bs={"\\n":"\n","\\t":"\t"},vs="…";function getReplaceStr(e){return bs[e]}var Rs=!0;const As=new f,Cs=new g,Ds=[],Ms=[];var ws;class Is{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new Bs(this._touches),this._pressKeys=new Set,this._keyEvent=new E,this._keyEvent._touches=this._touches}static get inst(){return ws}static getTouchPos(e){var t,r;return null==e?(null===(t=ws._touches[0])||void 0===t?void 0:t.pos)||f.EMPTY:(null===(r=ws.getTouch(e))||void 0===r?void 0:r.pos)||f.EMPTY}static get touchTarget(){return ws._touchTarget}static get touches(){return ws._touches}static get touchCount(){return ws._touches.length}static cancelClick(e){let t=null==e?ws._touches[0]:ws.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return ws._pressKeys.has(e)}static __init__(e,t){let r=ws=new Is;r._stage=e,t.oncontextmenu=()=>!1,t.addEventListener("mousedown",(e=>{bt.onIE||e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,0)}),{passive:!1}),t.addEventListener("mouseup",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,1)}),{passive:!1}),t.addEventListener("mousemove",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,2)}),{passive:!1}),t.addEventListener("mouseout",(e=>{r._touchInput||r.handleMouse(e,3)}),{passive:!1}),t.addEventListener("touchstart",(e=>{r._touchInput=!0,Rs||Is.isTextInputting||e.cancelable&&e.preventDefault(),r.handleTouch(e,0)}),{passive:!1}),t.addEventListener("touchend",(e=>{Rs||Is.isTextInputting||e.cancelable&&e.preventDefault(),Rs=!1,r.handleTouch(e,1)}),{passive:!1}),t.addEventListener("touchmove",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,2)}),{passive:!1}),t.addEventListener("touchcancel",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,3)}),{passive:!1}),t.addEventListener("wheel",(e=>{r.handleMouse(e,4)}),{passive:!1}),t.addEventListener("pointerdown",(e=>{t.setPointerCapture(e.pointerId)})),t.addEventListener("pointerup",(e=>{t.releasePointerCapture(e.pointerId)}),!0);let i=bt.document;i.addEventListener("keydown",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keypress",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keyup",(e=>{r.handleKeys(e)}),!0)}handleMouse(e,t){var r,i,s,a,n;this._eventType=t,this._nativeEvent=e;let l=this._mouseTouch;As.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(As),Is.mouseX=As.x,Is.mouseY=As.y;let o=As.x/this._stage.clientScaleX,h=As.y/this._stage.clientScaleY;if(l.event.nativeEvent=e,3!=t&&Is.mouseEventsEnabled){l.target=this._touchTarget=this.getNodeUnderPoint(o,h);let e=Math.round(o),t=Math.round(h);if((e!=l.pos.x||t!=l.pos.y)&&(this._stage._mouseMoveTime=bt.now(),l.pos.setTo(e,t),l.move(),Is.mouseEventsEnabled)){l.target.bubbleEvent(E.MOUSE_MOVE,l.event);for(let e of l.downTargets)e.event(E.MOUSE_DRAG,l.event)}}else l.target=this._touchTarget=null;if(l.lastRollOver!=l.target&&this.handleRollOver(l),0==t)l.began||(l.begin(),this._touches[0]=l,l.event.button=e.button,Is.mouseEventsEnabled&&(this.handleFocus(),0==e.button?null===(r=l.target)||void 0===r||r.bubbleEvent(E.MOUSE_DOWN,l.event):null===(i=l.target)||void 0===i||i.bubbleEvent(E.RIGHT_MOUSE_DOWN,l.event)));else if(1==t){if(l.began){if(l.end(),this._touches.length=0,l.event.button=e.button,Is.mouseEventsEnabled){if(0==e.button?null===(s=l.target)||void 0===s||s.bubbleEvent(E.MOUSE_UP,l.event):null===(a=l.target)||void 0===a||a.bubbleEvent(E.RIGHT_MOUSE_UP,l.event),l.moved)for(let e of l.downTargets)e.event(E.MOUSE_DRAG_END,l.event);let t=l.clickTest();t&&(0==e.button?(l.event.isDblClick=2==l.clickCount,t.bubbleEvent(E.CLICK,l.event),2==l.clickCount&&t.bubbleEvent(E.DOUBLE_CLICK,l.event),l.event.isDblClick=!1):(l.event.isDblClick=2==l.clickCount,t.bubbleEvent(E.RIGHT_CLICK,l.event),l.event.isDblClick=!1))}l.event.button=0}}else 4==t&&Is.mouseEventsEnabled&&(l.event.delta=.025*e.deltaY,null===(n=l.target)||void 0===n||n.bubbleEvent(E.MOUSE_WHEEL,l.event),l.event.delta=0)}handleTouch(e,t){var r,i;this._eventType=t,this._nativeEvent=e;let s=e.changedTouches;for(let a=0;a<s.length;++a){let n=s[a];if(!Is.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=n.identifier)continue;As.setTo(n.pageX,n.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(As),Is.mouseX=As.x,Is.mouseY=As.y;let l=As.x/this._stage.clientScaleX,o=As.y/this._stage.clientScaleY,h=this.getTouch(n.identifier,0==t);if(h){if(h.event.nativeEvent=e,h.event.touchId=h.touchId,3!=t&&Is.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(l,o),this._stage._mouseMoveTime=bt.now();let e=Math.round(l),r=Math.round(o);if((Math.abs(e-h.pos.x)>1.5||Math.abs(r-h.pos.y)>1.5)&&(h.pos.setTo(e,r),2==t&&(h.move(),Is.mouseEventsEnabled))){h.target.bubbleEvent(E.MOUSE_MOVE,h.event);for(let e of h.downTargets)e.event(E.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==t)h.began||(h.begin(),Is.mouseEventsEnabled&&(this.handleFocus(),null===(r=h.target)||void 0===r||r.bubbleEvent(E.MOUSE_DOWN,h.event)));else if(1==t||3==t){if(h.began){if(h.end(),Is.mouseEventsEnabled){if(null===(i=h.target)||void 0===i||i.bubbleEvent(E.MOUSE_UP,h.event),h.moved)for(let e of h.downTargets)e.event(E.MOUSE_DRAG_END,h.event);if(3!=t){let e=h.clickTest();null!=e&&(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(E.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(E.DOUBLE_CLICK,h.event),h.event.isDblClick=!1)}}h.target=null,this.handleRollOver(h)}h.reset(),this._touches.splice(this._touches.indexOf(h),1),this._touchPool.push(h)}}}}getTouch(e,t){let r=this._touches.find((t=>t.touchId==e));return r||!t||(r=this._touchPool.length>0?this._touchPool.pop():new Bs(this._touches),r.touchId=e,this._touches.push(r)),r}handleFocus(){if(Is.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let e=this._stage.focus._tf||this._stage.focus,t=this._touchTarget._tf||this._touchTarget;t.nativeInput&&t.multiline==e.multiline?e._focusOut():e.focus=!1}}handleKeys(e){let t=e.type,r=e.keyCode;if("keydown"===t?(0!=r&&this._pressKeys.add(r),this._pressKeys.add(e.key)):"keyup"===t&&(0!=r&&this._pressKeys.delete(r),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,Is.keyEventsEnabled){let e=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,r=e;for(;r;)r.event(t,this._keyEvent.setTo(t,r,e)),r=r.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let r=this.getSpriteUnderPoint(this._stage,e,t);return r||(r=this.getSprite3DUnderPoint(e,t)),r||this._stage}getSpriteUnderPoint(e,t,r){let i=e._style.scrollRect;if(i&&!e._getBit(s.DISABLE_INNER_CLIPPING)&&(Cs.setTo(i.x,i.y,i.width,i.height),!Cs.contains(t,r)))return null;let n=e._getBit(s.EDITING_NODE);if(!n&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,r))return null;for(let i=e._children.length-1;i>-1;i--){let l=e._children[i],o=n||l._getBit(s.EDITING_NODE);if(!l._destroyed&&(o?(!l.hasHideFlag(a.HideInHierarchy)||l.mouseThrough)&&!l._getBit(s.HIDE_BY_EDITOR):l._mouseState>1)&&(l._visible||l._getBit(s.DISABLE_VISIBILITY))){As.setTo(t,r),l.fromParentPoint(As);let e=this.getSpriteUnderPoint(l,As.x,As.y);if(e)return e}}if(n){if(!e._getBit(s.LOCK_BY_EDITOR)&&!e.hasHideFlag(a.HideInHierarchy)&&this.hitTest(e,t,r,n))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,r)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,r,i){let s=!1;e.scrollRect&&(t-=e._style.scrollRect.x,r-=e._style.scrollRect.y);let a=e._style.hitArea,n=e.mouseThrough;return i&&(a=null,n=!1),a?a.contains(t,r,e):((e.width>0&&e.height>0||n||a)&&(s=n?e.getGraphicBounds().contains(t,r):(a||Cs.setTo(0,0,e.width,e.height)).contains(t,r)),s)}handleRollOver(e){if(!Is.mouseEventsEnabled)return void(e.lastRollOver=e.target);Ds.length=0,Ms.length=0;let t=e.lastRollOver;for(;t;)Ms.push(t),t=t.parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=Ms.indexOf(t);if(-1!=e){Ms.splice(e,Ms.length-e);break}Ds.push(t),t=t.parent}let r=Ms.length;if(r>0){for(let i=0;i<r;i++)t=Ms[i],t._destroyed||t.event(E.MOUSE_OUT,e.event.setTo(E.MOUSE_OUT,t,t));Ms.length=0}if(r=Ds.length,r>0){for(let i=0;i<r;i++)t=Ds[i],t.activeInHierarchy&&t.event(E.MOUSE_OVER,e.event.setTo(E.MOUSE_OVER,t,t));Ds.length=0}}}Is.multiTouchEnabled=!0,Is.mouseEventsEnabled=!0,Is.keyEventsEnabled=!0,Is.clickTestThreshold=10,Is.mouseX=0,Is.mouseY=0,Is.isTextInputting=!1,Is.isiOSWKwebView=!1;const Ps={};class Bs{constructor(e){this.downPos=new f,this.downTargets=[],this.event=new E,this.event._touches=e,this.pos=this.event.touchPos,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>Is.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>Is.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=Ps[this.touchId];t||(t={pos:new f,time:0,button:0},Ps[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>Is.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>Is.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<Is.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<Is.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e.parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1}}class Ls{static customRequestAnimationFrame(e,t){Ls._customRequestAnimationFrame=e,Ls._loopFunction=t}static set customRenderEngine(e){Ls._customEngine=e}static get customRenderEngine(){return Ls._customEngine}constructor(e,t,i){this._first=!0,this._startTm=0,this._timeId=0,Ls._Render=this,Ls._mainCanvas=i;let s=Ls._mainCanvas.source;s.id="layaCanvas",s.width=e,s.height=t,l.isConch&&document.body.appendChild(s),this.initRender(Ls._mainCanvas,e,t),r._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop);let a=this;performance.now();let o=r.FPS,h=Ls.ifps=1e3/o;function loop(e){performance.now(),a._first&&(a._startTm=Math.floor(e/h)*h,a._first=!1),e-=a._startTm;let t=Math.floor(e/h);(t-Ls.lastFrm>0||l.isConch||!r.fixedFrames)&&(Ls.lastFrm=t,n.stage._loop()),Ls._customRequestAnimationFrame&&Ls._loopFunction?Ls._customRequestAnimationFrame(Ls._loopFunction):r._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop)}n.stage.on("visibilitychange",this,this._onVisibilitychange)}_onVisibilitychange(){n.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return Ls.lastFrm*Ls.ifps}initRender(e,t,r){e.size(t,r),ct.__init__(),ot.__init__(),Or.__init__(),Yt.__init__();var i=new Or;return Or._rendercontex=i,i.isMain=!0,Ls._context=i,e._setContext(i),xr.__init__(),re._init_(),!0}_enterFrame(e=null){n.stage._loop()}static get context(){return Ls._context}static get canvas(){return Ls._mainCanvas.source}}Ls.lastFrm=0,Ls.ifps=1e3/60;const Fs={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var Os,Ns,Us;class Gs{static decodeObj(e,t,r){r?(Os=r.outErrors,Ns=r.getNodeByRef,Us=r.getNodeData):(Os=null,Ns=null,Us=null),Gs.isDeserializing=!0;try{return Gs._decodeObj(e,t)}finally{Gs.isDeserializing=!1}}static _decodeObj(e,r){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(null!=i)try{t[r]=Gs._decodeObj(i)}catch(e){Os&&Os.push(e),t[r]=null}else t[r]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=de.getResURLByUUID(e._$uuid);return n.loader.getRes(t,Gs.getLoadTypeByEngineType(e._$type))}if(null!=e._$ref){let r=null==Ns?void 0:Ns(e._$ref);if(r&&e._$type){let i=t.getClass(e._$type);return i?r.getComponent(i):null}return r}let i=e._$type;if("any"===i)return e._$type?e.value:e;let s=Fs[i];if(null!=s)return e._$type?new s(e.value):new s(e);if(!r){let e=t.getClass(i);if(!e)return null;r=new e}for(let t in e){if(t.startsWith("_$"))continue;let i=e[t];if(null==i||"object"!=typeof i||Array.isArray(i)||i._$type||i._$uuid||i._$ref)try{let e=Gs._decodeObj(i);r[t]=e,null!=e&&null!=i&&i._$tmpl&&(r[i._$tmpl]=Us(e))}catch(e){Os&&Os.push(e)}else{let e=r[t];if(e)try{Gs._decodeObj(i,e)}catch(e){Os&&Os.push(e)}}}return r.onAfterDeserialize&&r.onAfterDeserialize(),r}return e}static getLoadTypeByEngineType(e){switch(e){case"Texture2D":case"RenderTexture":return Ki.TEXTURE2D;case"TextureCube":return Ki.TEXTURECUBE;case"Prefab":return Ki.HIERARCHY;case"Material":return Ki.MATERIAL;case"Mesh":return Ki.MESH;default:return null}}static bakeOverrideData(e){let t=null;for(let r=e.length,i=r-1;i>=0;i--){let s=e[i];if(s&&s.length>0)for(let e of s){let s,a=e._$override||e._$parent;if(Array.isArray(a)?s=a[r-i-1]:i==r-1&&(s=a),null!=s){t||(t={});let a=t[s];a||(t[s]=a=[]),a.push(r-i,e)}}}return t}static applyOverrideData(e,t){return function test(e){if(t[e._$id])return!0;let r=e._$child;return!(!r||!r.find((e=>test(e))))}(e)&&(e=function cloneTree(e){let t=Object.assign({},e),r=t._$child;r&&(t._$child=r.map((e=>cloneTree(e))));let i=t._$comp;return i&&(t._$comp=i.map((e=>Object.assign({},e)))),t}(e),function visit(e){let r=e._$child;if(r)for(let e of r)e._$id&&visit(e);let i=t[e._$id];if(i)for(let t=0;t<i.length;t+=2){let s,a=i[t],n=i[t+1];if(s=n._$override){let t;if(Array.isArray(s))if(a==s.length-1){let i=s[a];r?t=r.find((e=>e._$override==i)):e._$child=r=[],t||(t={_$override:i},r.push(t))}else if(a<s.length-1){let i=s.slice(a);r?t=r.find((e=>{let t=e._$override;return Array.isArray(t)&&arrayEquals(t,i)})):e._$child=r=[],t||(t={_$override:i},r.push(t))}else t=e;else t=e;if(mergeData(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let r=t._$type||t._$override,i=e.find((e=>e._$override==r||e._$type==r));i||(i={},t._$type?i._$type=r:i._$override=r,e.push(i)),mergeData(i,t)}}}else if(s=n._$parent){let t;if(r||(e._$child=r=[]),a<s.length){t=a==s.length-1?s[a]:s.slice(a);let e=Object.assign({},n);e._$parent=t,r.push(e)}else{let t=Object.assign({},n);delete t._$parent,e._$prefab?r.push(t):(delete t._$index,n._$index<r.length?r.splice(n._$index,0,t):r.push(t))}}}}(e)),e}}function mergeData(e,t){for(let r in t){if(r.startsWith("_$"))continue;let i=t[r];if(null==i||"object"!=typeof i||Array.isArray(i)||(i._$type||i._$uuid||i._$ref))e[r]=i;else{let t=e[r];null!=t&&"object"==typeof t?(e[r]=t=Object.assign({},t),mergeData(t,i)):e[r]=i}}}function arrayEquals(e,t){if(e.length===t.length){for(var r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1}Gs.isDeserializing=!1;class ks extends gs{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",ks.IOS_IFRAME=n.Browser.onIOS&&n.Browser.window.top!=n.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=gs.SCROLL,this._promptColor="#A9A9A9",this.on(E.MOUSE_DOWN,this,this._onMouseDown),this.on(E.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(ks._createInputElement(),n.Browser.onMobile){var e=!1;(n.Browser.onMiniGame||n.Browser.onBDMiniGame||n.Browser.onQGMiniGame||n.Browser.onKGMiniGame||n.Browser.onVVMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onQQMiniGame||n.Browser.onBLMiniGame||n.Browser.onTTMiniGame||n.Browser.onHWMiniGame||n.Browser.onTBMiniGame)&&(e=!0),Ls.canvas.addEventListener(ks.IOS_IFRAME?e?"touchend":"click":"touchend",ks._popupInputMethod)}}static _popupInputMethod(e){Is.isTextInputting&&ks.inputElement.focus()}static _createInputElement(){ks._initInput(ks.area=n.Browser.createElement("textarea")),ks._initInput(ks.input=n.Browser.createElement("input")),ks.inputContainer=n.Browser.createElement("div"),ks.inputContainer.style.position="absolute",ks.inputContainer.style.zIndex="1E5",n.Browser.container.appendChild(ks.inputContainer),ks.inputContainer.setPos=function(e,t){ks.inputContainer.style.left=e+"px",ks.inputContainer.style.top=t+"px"}}static _initInput(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",e.addEventListener("input",ks._processInputting),e.addEventListener("mousemove",ks._stopEvent,{passive:!1}),e.addEventListener("mousedown",ks._stopEvent,{passive:!1}),e.addEventListener("touchmove",ks._stopEvent,{passive:!1}),e.setFontFace=function(t){e.style.fontFamily=t},l.isConch&&!ks.isAppUseNewInput||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}static _processInputting(e){var t=ks.inputElement.target;if(t){var r=ks.inputElement.value;t._restrictPattern&&(r=r.replace(/\u2006|\x27/g,""),t._restrictPattern.test(r)&&(r=r.replace(t._restrictPattern,""),ks.inputElement.value=r)),null==r&&(r=""),t._text=r,t.event(E.INPUT)}}static _stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}setSelection(e,t){this.focus=!0,ks.inputElement.selectionStart=e,ks.inputElement.selectionEnd=t}get multiline(){return this._multiline}set multiline(e){this._multiline=e,Gs.isDeserializing||(this.valign=e?"top":"middle")}get nativeInput(){return this._multiline?ks.area:ks.input}_onUnDisplay(e=null){this.focus=!1}_onMouseDown(e){this.focus=!0}_syncInputTransform(){var e=this.nativeInput,t=Bi.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),r=this._width-this._padding[1]-this._padding[3],i=this._height-this._padding[0]-this._padding[2];l.isConch&&!ks.isAppUseNewInput?(e.setScale(t.scaleX,t.scaleY),e.setSize(r,i),e.setPos(t.x,t.y)):(ks.inputContainer.style.transform=ks.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+n.stage.canvasDegree+"deg)",e.style.width=r+"px",e.style.height=i+"px",ks.inputContainer.style.left=t.x+"px",ks.inputContainer.style.top=t.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),(t=this.nativeInput).target=this,this._focusIn()):(t.target=null,this._focusOut(),n.Browser.document.body.scrollTop=0,t.blur(),l.isConch&&!ks.isAppUseNewInput?t.setPos(-1e4,-1e4):ks.inputContainer.contains(t)&&ks.inputContainer.removeChild(t)))}_setInputMethod(){ks.input.parentElement&&ks.inputContainer.removeChild(ks.input),ks.area.parentElement&&ks.inputContainer.removeChild(ks.area),n.Browser.onAndroid&&(ks.input=ks.inputElement=n.Browser.createElement("input"),ks._initInput(ks.input)),ks.inputElement=this._multiline?ks.area:ks.input,ks.inputContainer.appendChild(ks.inputElement),gs.RightToLeft&&(ks.inputElement.style.direction="rtl")}_focusIn(){Is.isTextInputting=!0;var e=this.nativeInput;ks.input&&(ks.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,l.isConch&&!ks.isAppUseNewInput&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars<=0?1e5:this._maxChars,e.value=this._text,e.placeholder=this._prompt,n.stage.off(E.KEY_DOWN,this,this._onKeyDown),n.stage.on(E.KEY_DOWN,this,this._onKeyDown),n.stage.focus=this,this.event(E.FOCUS),n.Browser.onPC&&e.focus(),l.isConch&&ks.isAppUseNewInput||n.Browser.onMiniGame||n.Browser.onBDMiniGame||n.Browser.onQGMiniGame||n.Browser.onKGMiniGame||n.Browser.onVVMiniGame||n.Browser.onAlipayMiniGame||n.Browser.onQQMiniGame||n.Browser.onBLMiniGame||n.Browser.onTTMiniGame||n.Browser.onHWMiniGame||n.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),e.setColor(this.color),e.setFontSize(this.fontSize),e.setFontFace(this._realFont),l.isConch&&!ks.isAppUseNewInput&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!l.isConch&&n.Browser.onPC&&n.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){ks.promptStyleDOM=n.Browser.getElementById("promptStyle"),ks.promptStyleDOM||(ks.promptStyleDOM=n.Browser.createElement("style"),ks.promptStyleDOM.setAttribute("id","promptStyle"),n.Browser.document.head.appendChild(ks.promptStyleDOM)),ks.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){Is.isTextInputting&&(Is.isiOSWKwebView||(Is.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),n.stage.off(E.KEY_DOWN,this,this._onKeyDown),n.stage.focus=null,this.event(E.BLUR),this.event(E.CHANGE),l.isConch&&!ks.isAppUseNewInput&&this.nativeInput.blur(),n.Browser.onPC&&n.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(e){13===e.keyCode&&(n.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(E.ENTER))}miniGameTxt(e){e+="",this._multiline||(e=e.replace(/\r?\n/g,"")),this.text=e}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),this._focus?(this.nativeInput.value=e,this.event(E.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get text(){return this._focus?this.nativeInput.value:super.text}set_color(e){this._focus&&this.nativeInput.setColor(e),super.set_color(e)}set bgColor(e){super.bgColor=e,l.isConch&&!ks.isAppUseNewInput&&this.nativeInput.setBgColor(e)}get bgColor(){return super.bgColor}get restrict(){return this._restrict}set restrict(e){this._restrict=e,e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}set editable(e){this._editable=e,l.isConch&&!ks.isAppUseNewInput&&ks.input.setForbidEdit(!e)}get editable(){return this._editable}get maxChars(){return this._maxChars}set maxChars(e){this._maxChars=e}get prompt(){return this._prompt}set prompt(e){var t;e=(null===(t=gs.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e,this.markChanged()}}ks.TYPE_TEXT="text",ks.TYPE_PASSWORD="password",ks.TYPE_EMAIL="email",ks.TYPE_URL="url",ks.TYPE_NUMBER="number",ks.TYPE_RANGE="range",ks.TYPE_DATE="date",ks.TYPE_MONTH="month",ks.TYPE_WEEK="week",ks.TYPE_TIME="time",ks.TYPE_DATE_TIME="datetime",ks.TYPE_DATE_TIME_LOCAL="datetime-local",ks.TYPE_SEARCH="search",ks.IOS_IFRAME=!1,ks.isAppUseNewInput=!1;class Vs extends c{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=a.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(E.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(E.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(E.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(E.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(E.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var r=(t._width-this._left-this._right)/(e.scaleX||.01);if(r!=e._width)return e.width=r,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var r=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(r!=e._height)return e.height=r,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}Vs.EMPTY=null,Vs.EMPTY=new Vs;const Ws=new g,Hs=new f;class Xs{contains(e,t,r){return!!Xs._isHitGraphic(e,t,r,this._hit)&&!Xs._isHitGraphic(e,t,r,this._unHit)}static _isHitGraphic(e,t,r,i){if(!i)return!1;let s=i.cmds;if(0==s.length)return!1;let a=s.length;for(let i=0;i<a;i++){let a=s[i];if(a){if("Translate"===a.cmdID)e-=a.tx,t-=a.ty;if(Xs._isHitCmd(e,t,r,a))return!0}}return!1}static _isHitCmd(e,t,r,i){if(!i)return!1;var s=!1;switch(i.cmdID){case"DrawRect":i.percent?Ws.setTo(i.x*r.width,i.y*r.height,i.width*r.width,i.height*r.height):Ws.setTo(i.x,i.y,i.width,i.height),s=Ws.contains(e,t);break;case"DrawCircle":let a=i.radius;i.percent?(e-=i.x*r.width,t-=i.y*r.height,a*=r.width):(e-=i.x,t-=i.y),s=e*e+t*t<a*a;break;case"DrawPoly":e-=i.x,t-=i.y,s=Xs._ptInPolygon(e,t,i.points)}return s}static _ptInPolygon(e,t,r){var i=Hs;i.setTo(e,t);var s,a,n,l,o,h=0;o=r.length;for(var _=0;_<o;_+=2){if(s=r[_],a=r[_+1],n=r[(_+2)%o],a!=(l=r[(_+3)%o]))if(!(i.y<Math.min(a,l)))if(!(i.y>=Math.max(a,l)))(i.y-a)*(n-s)/(l-a)+s>i.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new bi),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new bi),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){l.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}t.regClass("HitArea",Xs);class Ys{static __init__(){Ys.I=new Ys,Ys.supportWeakMap||n.systemTimer.loop(Ys.delInterval,null,Ys.clearCache)}static clearCache(){for(var e=0,t=Ys._maps.length;e<t;e++){Ys._maps[e]._obj={}}}constructor(){this._obj={},Ys._maps.push(this)}set(e,t){null!=e&&(Ys.supportWeakMap||("string"==typeof e||"number"==typeof e?this._obj[e]=t:(e.$_GID||(e.$_GID=d.getGID()),this._obj[e.$_GID]=t)))}get(e){return null==e?null:Ys.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]}del(e){null!=e&&(Ys.supportWeakMap||("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]))}has(e){return null!=e&&(!Ys.supportWeakMap&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID]))}}Ys.supportWeakMap=!1,Ys.delInterval=6e5,Ys._maps=[];class zs extends w{constructor(e){super(),this.version=e,this._deps=[]}create(e,t){return this.json?Zs.createByData(null,this.json):null}get deps(){return this._deps}addDep(e){e instanceof w&&(e._addReference(),this._deps.push(e),!l.isPlaying&&e instanceof zs&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof w&&(t._addReference(),this._deps.push(t),!l.isPlaying&&t instanceof zs&&t.on("obsolute",this,this.onDepObsolute))}_disposeResource(){for(let e of this._deps)e._removeReference(),!l.isPlaying&&e instanceof zs&&e.off("obsolute",this,this.onDepObsolute)}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!l.isPlaying&&this.event("obsolute"))}onDepObsolute(){this.obsolute=!0}}var js,qs,Ks=zs;class $s extends zs{constructor(e,t,r){super(r),this.api=e,this.data=t}create(e,t){let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}class Zs{static parse(e,r){let i=null==r?void 0:r.root;if(!i){let r=l.isPlaying&&e.props.runtime?e.props.runtime:e.type,s=t.getClass(r);i="instance"==e.props.renderType?s.instance||(s.instance=new s):new s}return i&&i._viewCreated?i:Zs.createByData(i,e)}static getBindFun(e){let t=Zs._funMap;t||(t=Zs._funMap=new Ys);var r=Zs._funMap.get(e);if(null==r){var i='"'+e+'"',s="(function(data){if(data==null)return;with(data){try{\nreturn "+(i=i.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";r=window.Laya._runScript(s),Zs._funMap.set(e,r)}return r}static createByData(e,t){var r=Js.create();if("_idMap"in(e=Zs.createComp(t,e,e,null,r))&&(e._idMap=r._idMap),t.animations){var i,a,n,l=[],o=t.animations,h=o.length;for(i=0;i<h;i++){switch(a=new es,n=o[i],a._setUp(r._idMap,n),e[n.name]=a,a._setControlNode(e),n.action){case 1:a.play(0,!1);break;case 2:a.play(0,!0)}l.push(a)}e._aniList=l}return e instanceof ea&&e._width>0&&null==t.props.hitTestPrior&&!e.mouseThrough&&(e.hitTestPrior=!0),r.finish(),e._setBit(s.NOT_READY,!1),e.parent&&e.parent.activeInHierarchy&&e.active&&e._processActive(!0),e}static createInitTool(){return Js.create()}static createComp(e,r=null,i=null,s=null,a=null){if(!(r=r||Zs.getCompInstance(e)))return e.props&&e.props.runtime?console.warn("runtime not found:"+e.props.runtime):console.warn("can not create:"+e.type),null;var n=e.child;if(n)for(var l=r instanceof(js||(js=t.getClass("List"))),o=0,h=n.length;o<h;o++){var _=n[o];if(!("itemRender"in r)||"render"!=_.props.name&&"render"!==_.props.renderType)if("Graphic"==_.type)this._addGraphicsToSprite(_,r);else if(this._isDrawType(_.type))this._addGraphicToSprite(_,r,!0);else{if(l){var u=[],d=Zs.createComp(_,null,i,u,a);u.length&&(d._$bindData=u)}else d=Zs.createComp(_,null,i,s,a);"Script"==_.type?d instanceof c?r.addComponentInstance(d):"owner"in d?d.owner=r:"target"in d&&(d.target=r):"mask"==_.props.renderType||"mask"==_.props.name?r.mask=d:d instanceof Ri&&r.addChild(d)}else r.itemRender=_}var p=e.props;for(var f in p){var g=p[f];"string"==typeof g&&(g.indexOf("@node:")>=0||g.indexOf("@Prefab:")>=0)?a&&a.addNodeRef(r,f,g):Zs.setCompValue(r,f,g,i,s)}return r._afterInited&&r._afterInited(),e.compId&&a&&a._idMap&&(a._idMap[e.compId]=r),r}static setCompValue(e,r,i,s=null,a=null){if("string"==typeof i&&i.indexOf("${")>-1){if(Zs._sheet||(Zs._sheet=t.getClass("laya.data.Table")),!Zs._sheet)return void console.warn("Can not find class Sheet");if(a)a.push(e,r,i);else if(s){-1==i.indexOf("].")&&(i=i.replace(".","[0]."));var n,l,o=new Qs(e,r,i);o.exe(s);for(var h=i.replace(/\[.*?\]\./g,".");null!=(n=Zs._parseWatchData.exec(h));){for(var _=n[1];null!=(l=Zs._parseKeyWord.exec(_));){var u=l[0],d=s._watchMap[u]||(s._watchMap[u]=[]);d.push(o),Zs._sheet.I.notifer.on(u,s,s.changeData,[u])}(d=s._watchMap[_]||(s._watchMap[_]=[])).push(o),Zs._sheet.I.notifer.on(_,s,s.changeData,[_])}}}else"var"===r&&s?s[i]=e:e[r]="true"===i||"false"!==i&&i}static getCompInstance(e){if("UIView"==e.type&&e.props&&e.props.pageData)return Zs.createByData(null,e.props.pageData);var r=l.isPlaying&&e.props&&e.props.runtime||e.type,i=t.getClass(r);if(!i)throw"Can not find class "+r;if("Script"===e.type&&i.prototype._doAwake){var s=o.createByClass(i);return s._destroyed=!1,s}if(e.props&&"renderType"in e.props&&"instance"==e.props.renderType)return i.instance||(i.instance=new i),i.instance;let a=new i;return a instanceof(qs||(qs=t.getClass("View")))&&(a._scene=a),a}static collectResourceLinks(e){let t=new Set,r=[];function addInnerUrl(e){t.has(e)||(t.add(e),r.push(e))}if(e.loadList)for(let t of e.loadList)addInnerUrl(t);if(e.loadList3D)for(let t of e.loadList3D)addInnerUrl(t);return function check(e){let t=e.props;for(let e in t){let r=t[e];if("string"==typeof r&&r.indexOf("@Prefab:")>=0){addInnerUrl(r.replace("@Prefab:",""))}}let r=e.child;if(r)for(let e=0,t=r.length;e<t;e++){check(r[e])}}(e),r}static createByJson(e,r=null,i=null,s=null,a=null){"string"==typeof e&&(e=JSON.parse(e));var n=e.props;if(!r&&!(r=a?a.runWith(e):t.getInstance(l.isPlaying&&n.runtime||e.type)))return null;var o=e.child;if(o)for(var h=0,_=o.length;h<_;h++){var u=o[h];if("render"!==u.props.name&&"render"!==u.props.renderType||!r._$set_itemRender)if("Graphic"==u.type)this._addGraphicsToSprite(u,r);else if(this._isDrawType(u.type))this._addGraphicToSprite(u,r,!0);else{var d=this.createByJson(u,null,i,s,a);"Script"===u.type?"owner"in d?d.owner=r:"target"in d&&(d.target=r):"mask"==u.props.renderType?r.mask=d:r.addChild(d)}else r.itemRender=u}if(n)for(var c in n){var p=n[c];"var"===c&&i?i[p]=r:p instanceof Array&&r[c]instanceof Function?r[c].apply(r,p):r[c]=p}return s&&e.customProps&&s.runWith([r,e]),r.created&&r.created(),r}static _addGraphicsToSprite(e,t){var r=e.child;if(r&&!(r.length<1)){var i,s,a=this._getGraphicsFromSprite(e,t),n=0,l=0;for(e.props&&(n=this._getObjVar(e.props,"x",0),l=this._getObjVar(e.props,"y",0)),0!=n&&0!=l&&a.translate(n,l),s=r.length,i=0;i<s;i++)this._addGraphicToGraphics(r[i],a);0!=n&&0!=l&&a.translate(-n,-l)}}static _addGraphicToSprite(e,t,r=!1){var i=r?this._getGraphicsFromSprite(e,t):t.graphics;this._addGraphicToGraphics(e,i)}static _getGraphicsFromSprite(e,t){if(!e||!e.props)return t.graphics;var r=e.props.renderType;if("hit"===r||"unHit"===r){var i=t._style.hitArea||(t.hitArea=new Xs);i[r]||(i[r]=new bi);var s=i[r]}return s||(s=t.graphics),s}static _getTransformData(e){var t;("pivotX"in e||"pivotY"in e)&&(t=t||new p).translate(-this._getObjVar(e,"pivotX",0),-this._getObjVar(e,"pivotY",0));var r=this._getObjVar(e,"scaleX",1),i=this._getObjVar(e,"scaleY",1),s=this._getObjVar(e,"rotation",0);return this._getObjVar(e,"skewX",0),this._getObjVar(e,"skewY",0),1==r&&1==i&&0==s||((t=t||new p).scale(r,i),t.rotate(.0174532922222222*s)),t}static _addGraphicToGraphics(e,t){var r,i;if((r=e.props)&&(i=this.DrawTypeDic[e.type])){var s=t,a=this._getParams(r,i[1],i[2],i[3]),n=this._tM;(n||1!=this._alpha)&&(s.save(),n&&s.transform(n),1!=this._alpha&&s.alpha(this._alpha)),s[i[0]].apply(s,a),(n||1!=this._alpha)&&s.restore()}}static _adptLineData(e){return e[2]=parseFloat(e[0])+parseFloat(e[2]),e[3]=parseFloat(e[1])+parseFloat(e[3]),e}static _adptTextureData(e){return e[0]=n.Loader.getRes(e[0]),e}static _adptLinesData(e){return e[2]=this._getPointListByStr(e[2]),e}static _isDrawType(e){return"Image"!==e&&e in this.DrawTypeDic}static _getParams(e,t,r=0,i=null){var s,a,n,l=this._temParam;for(l.length=t.length,a=t.length,s=0;s<a;s++)l[s]=this._getObjVar(e,t[s][0],t[s][1]);return this._alpha=this._getObjVar(e,"alpha",1),(n=this._getTransformData(e))?(r||(r=0),n.translate(l[r],l[r+1]),l[r]=l[r+1]=0,this._tM=n):this._tM=null,i&&this[i]&&(l=this[i](l)),l}static _getPointListByStr(e){var t,r,i=e.split(",");for(r=i.length,t=0;t<r;t++)i[t]=parseFloat(i[t]);return i}static _getObjVar(e,t,r){return t in e?e[t]:r}}Zs._parseWatchData=/\${(.*?)}/g,Zs._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g,Zs.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},Zs._temParam=[];class Qs{constructor(e,t,r){this.comp=e,this.prop=t,this.value=r}exe(e){var t=Zs.getBindFun(this.value);this.comp[this.prop]=t.call(this,e)}}class Js{reset(){this._nodeRefList=null,this._initList=null,this._idMap=null}recover(){this.reset(),o.recover("InitTool",this)}static create(){var e=o.getItemByClass("InitTool",Js);return e._idMap={},e}addNodeRef(e,t,r){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([e,t,r])}setNodeRef(){if(this._nodeRefList)if(this._idMap){var e,t,r;for(t=this._nodeRefList.length,e=0;e<t;e++)(r=this._nodeRefList[e])[0][r[1]]=this.getReferData(r[2]);this._nodeRefList=null}else this._nodeRefList=null}getReferData(e){if(e.indexOf("@Prefab:")>=0)return new $s(Zs,Ki.getRes(e.replace("@Prefab:","")),2);if(e.indexOf("@arr:")>=0){var t,r,i,s;i=(t=(e=e.replace("@arr:","")).split(",")).length;var a=[];for(r=0;r<i;r++)(s=t[r])?a.push(this._idMap[s.replace("@node:","")]):a.push(null);return a}return this._idMap[e.replace("@node:","")]}addInitItem(e){this._initList||(this._initList=[]),this._initList.push(e)}doInits(){this._initList&&(this._initList=null)}finish(){this.setNodeRef(),this.doInits(),this.recover()}}class ea extends Li{constructor(e=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=n.timer,this._widget=Vs.EMPTY,this._scene=this,e&&this.createChildren()}createChildren(){}static setUIMap(e){let t=n.loader.getRes(e);if(!t)throw"请提前加载uimap的json，再使用该接口设置！";for(let e in t)n.Loader.loadedMap[e+".scene"]=t[e]}loadScene(e){ea.unDestroyedScenes.add(this);let t=e.indexOf(".")>-1?e:e+".scene",r=n.loader.getRes(t);r?this._viewCreated||(r.create({root:this}),this._viewCreated=!0,ea.unDestroyedScenes.add(this)):(this._setBit(s.NOT_READY,!0),n.loader.load(t,null,(e=>{ea._loadPage&&ea._loadPage.event("progress",e)})).then((r=>{if(!r)throw"Can not find scene:"+e;this._viewCreated?this._setBit(s.NOT_READY,!1):(this.url=t,ea.hideLoadingPage(),r.create({root:this}),this._viewCreated=!0,ea.unDestroyedScenes.add(this))})))}createView(e){e&&!this._viewCreated&&(this._viewCreated=!0,Zs.createByData(this,e))}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e=!0,t=null){e&&ea.closeAll(),ea.root.addChild(this),this._scene3D&&n.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e=null){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,ea.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._x+r.width*r.scaleX,e))}return e}get_height(){if(this._isHeightSet)return this._height;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._y+r.height*r.scaleY,e))}return e}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(E.RESIZE),this._widget!==Vs.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=Vs.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===Vs.EMPTY&&(this._widget=this.addComponent(Vs)),this._widget}static get root(){let e=ea._root;return e||(e=ea._root=n.stage.addChild(new Li),e.name="root",e.mouseThrough=!0,n.stage.on("resize",null,(()=>{e.size(n.stage.width,n.stage.height),e.event(E.RESIZE)})),e.size(n.stage.width,n.stage.height),e.event(E.RESIZE)),e}static load(e,t=null,r=null){return n.loader.load(e,null,(e=>{ea._loadPage&&ea._loadPage.event("progress",e),r&&r.runWith(e)})).then((r=>{if(!r)throw"Can not find scene:"+e;let i,s=[],a=r.create(null,s);if(s.length>0&&console.warn(`Error loading ${e}: \n${s.join("\n")}`),a instanceof ea)i=a;else{if(!a._is3D)throw"Not a scene:"+e;i=new ea,i.left=i.right=i.top=i.bottom=0,i._scene3D=a}return i._viewCreated=!0,i._scene3D&&(i._scene3D._scene2D=i),ea.unDestroyedScenes.add(i),ea.hideLoadingPage(),t&&t.runWith(i),i}))}static open(e,t=!0,r=null,i=null,s=null){if(r instanceof wi){var a=i;i=r,r=a}return ea.showLoadingPage(),ea.load(e,wi.create(null,this._onSceneLoaded,[t,i,r]),s)}static _onSceneLoaded(e,t,r,i){i.open(e,r),t&&t.runWith(i)}static close(e,t){let r=!1;for(let i of ea.unDestroyedScenes)if(i&&i.parent&&i.url===e&&(null==t||i.name==t)){i.close(),r=!0;break}return r}static closeAll(){let e=ea.root;for(let r=0,i=e.numChildren;r<i;r++){var t=e.getChildAt(0);t instanceof ea?t.close():t.removeSelf()}}static destroy(e,t){let r=!1;for(let i of ea.unDestroyedScenes)if(i.url===e&&(null==t||i.name==t)&&!i._destroyed){i.destroy(),r=!0;break}return r}static gc(){w.destroyUnusedResources()}static setLoadingPage(e){ea._loadPage=e}static showLoadingPage(e=null,t=500){ea._loadPage&&(n.systemTimer.clear(null,ea._showLoading),n.systemTimer.clear(null,ea._hideLoading),n.systemTimer.once(t,null,ea._showLoading,[e],!1))}static _showLoading(e){n.stage.addChild(ea._loadPage),ea._loadPage instanceof ea&&ea._loadPage.onOpened(e)}static _hideLoading(){ea._loadPage instanceof ea?ea._loadPage.close():ea._loadPage.removeSelf()}static hideLoadingPage(e=500){ea._loadPage&&(n.systemTimer.clear(null,ea._showLoading),n.systemTimer.clear(null,ea._hideLoading),n.systemTimer.once(e,null,ea._hideLoading))}}ea.unDestroyedScenes=new Set;class ta{constructor(e=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,e&&ta.gSysTimer&&ta.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var e=this.currFrame=this.currFrame+this.scale,t=this._getNowData(),r=t-this._lastTimer>3e4;this._delta=(t-this._lastTimer)*this.scale;var i=this.currTimer=this.currTimer+this._delta;this._lastTimer=t;var s=this._handlers;this._count=0;for(var a=0,n=s.length;a<n;a++){var l=s[a];if(null!==l.method){var o=l.userFrame?e:i;if(o>=l.exeTime)if(l.repeat)if(!l.jumpFrame||r)l.exeTime+=l.delay,l.run(!1),o>l.exeTime&&(l.exeTime+=Math.ceil((o-l.exeTime)/l.delay)*l.delay);else for(;o>=l.exeTime;)l.exeTime+=l.delay,l.run(!1);else l.run(!0)}else this._count++}(this._count>30||e%200==0)&&this._clearHandlers()}_clearHandlers(){for(var e=this._handlers,t=0,r=e.length;t<r;t++){var i=e[t];null!==i.method?this._temp.push(i):this._recoverHandler(i)}this._handlers=this._temp,e.length=0,this._temp=e}_recoverHandler(e){this._map[e.key]==e&&delete this._map[e.key],e.clear(),ta._pool.push(e)}_getNowData(){return Date.now()}_create(e,t,r,i,s,a,n){if(!r)return s.apply(i,a),null;if(n){var l=this._getHandler(i,s);if(l)return l.repeat=t,l.userFrame=e,l.delay=r,l.caller=i,l.method=s,l.args=a,l.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),l}return(l=ta._pool.length>0?ta._pool.pop():new ra).repeat=t,l.userFrame=e,l.delay=r,l.caller=i,l.method=s,l.args=a,l.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(l),this._handlers.push(l),l}_indexHandler(e){var t=e.caller,r=e.method,i=t?t.$_GID||(t.$_GID=d.getGID()):0,s=r.$_TID||(r.$_TID=ta._mid++);e.key=i+"_"+s,this._map[e.key]=e}once(e,t,r,i=null,s=!0){this._create(!1,!1,e,t,r,i,s)}loop(e,t,r,i=null,s=!0,a=!1){var n=this._create(!1,!0,e,t,r,i,s);n&&(n.jumpFrame=a)}frameOnce(e,t,r,i=null,s=!0){this._create(!0,!1,e,t,r,i,s)}frameLoop(e,t,r,i=null,s=!0){this._create(!0,!0,e,t,r,i,s)}toString(){return" handlers:"+this._handlers.length+" pool:"+ta._pool.length}clear(e,t){var r=this._getHandler(e,t);r&&r.clear()}clearAll(e){if(e)for(var t=0,r=this._handlers.length;t<r;t++){var i=this._handlers[t];i.caller===e&&i.clear()}}_getHandler(e,t){var r=(e?e.$_GID||(e.$_GID=d.getGID()):0)+"_"+(t.$_TID||(t.$_TID=ta._mid++));return this._map[r]}callLater(e,t,r=null){ia.I.callLater(e,t,r)}runCallLater(e,t){ia.I.runCallLater(e,t)}clearCallLater(e,t){ia.I.clear(e,t)}runTimer(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}ta.gSysTimer=null,ta._pool=[],ta._mid=1;class ra{clear(){this.caller=null,this.method=null,this.args=null}run(e){var t=this.caller;if(t&&t.destroyed)return this.clear();var r=this.method,i=this.args;e&&this.clear(),null!=r&&(i?r.apply(t,i):r.call(t))}}class ia{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let e=this._laters,t=e.length;if(t>0){for(let r=0,i=t-1;r<=i;r++){let t=e[r];this._map[t.key]=null,null!==t.method&&(t.run(),t.clear()),this._pool.push(t),r===i&&(i=e.length-1)}e.length=0}}_getHandler(e,t){var r=e?e.$_GID||(e.$_GID=d.getGID()):0,i=t.$_TID||(t.$_TID=ta._mid++);return this._map[r+"."+i]}callLater(e,t,r=null){if(null==this._getHandler(e,t)){let a;a=this._pool.length?this._pool.pop():new sa,a.caller=e,a.method=t,a.args=r;var i=e?e.$_GID:0,s=t.$_TID;a.key=i+"."+s,this._map[a.key]=a,this._laters.push(a)}}runCallLater(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(),r.clear())}clear(e,t){var r=this._getHandler(e,t);return!!r&&(this._map[r.key]=null,r.key="",r.clear(),!0)}clearAll(e){if(e)for(var t=0,r=this._laters.length;t<r;t++){var i=this._laters[t];i.caller===e&&(this._map[i.key]=null,i.key="",i.clear())}}}ia.I=new ia;class sa{clear(){this.caller=null,this.method=null,this.args=null}run(){var e=this.caller;if(e&&e.destroyed)return this.clear();var t=this.method,r=this.args;null!=t&&(r?t.apply(e,r):t.call(e))}}class aa{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(e,t){x.renderEngine.viewport(0,0,e,t),j.width=e,j.height=t}}aa.isNativeRender_enable=!1;class na{}na.changeWebGLSize=function(e,t){aa.onStageResize(e,t)};class la{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){this.onError(e)}}this._toStarts.clear()}callUpdate(){for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){this.onError(e)}}callLateUpdate(){for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){this.onError(e)}}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){this.onError(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){this.onError(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){this.onError(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}onError(e){console.error(e)}}class oa extends Li{constructor(){super(),this.offset=new f,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new p,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=bt.window.orientation,this._wgColor=[0,0,0,1],this._scene3Ds=[],this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(s.DISPLAYED_INSTAGE,!0),this._setBit(s.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=r.useRetinalCanvas;var e=bt.window;e.addEventListener("focus",(()=>{this._isFocused=!0,this.event(E.FOCUS),this.event(E.FOCUS_CHANGE)})),e.addEventListener("blur",(()=>{this._isFocused=!1,this.event(E.BLUR),this.event(E.FOCUS_CHANGE),this._isInputting()&&(ks.inputElement.target.focus=!1)}));var t="visibilityState",i="visibilitychange",a=e.document;void 0!==a.hidden?(i="visibilitychange",t="visibilityState"):void 0!==a.mozHidden?(i="mozvisibilitychange",t="mozVisibilityState"):void 0!==a.msHidden?(i="msvisibilitychange",t="msVisibilityState"):void 0!==a.webkitHidden&&(i="webkitvisibilitychange",t="webkitVisibilityState"),e.document.addEventListener(i,(()=>{"hidden"==bt.document[t]?(this._isVisibility=!1,this._isInputting()&&(ks.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(E.VISIBILITY_CHANGE)})),e.addEventListener("resize",(()=>{var e=bt.window.orientation;null!=e&&e!=this._previousOrientation&&this._isInputting()&&(ks.inputElement.target.focus=!1),this._previousOrientation=e,this._isInputting()||(bt.onSafari&&(this._safariOffsetY=bt.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(E.WILL_RESIZE),this.updateCanvasSize()))})),e.addEventListener("orientationchange",(e=>{this.screenAdaptationEnabled&&(this.event(E.WILL_RESIZE),this.updateCanvasSize())})),this._componentDriver=new la}_isInputting(){return bt.onMobile&&Is.isTextInputting}set_width(e){this.designWidth=e,super.set_width(e),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(e){this.designHeight=e,super.set_height(e),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}set transform(e){super.set_transform(e)}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,n.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(bt.clientWidth*bt.pixelRatio,bt.clientHeight*bt.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,t){this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==oa.SCREEN_NONE&&(r=(e/t<1?oa.SCREEN_VERTICAL:oa.SCREEN_HORIZONTAL)!==this._screenMode)){var i=t;t=e,e=i}this.canvasRotation=r;var s=Ls._mainCanvas,a=this._canvasTransform.identity(),n=this._scaleMode,l=e/this.designWidth,o=t/this.designHeight,h=this.useRetinalCanvas?e:this.designWidth,_=this.useRetinalCanvas?t:this.designHeight,u=e,d=t,c=bt.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,n){case oa.SCALE_NOSCALE:l=o=1,u=this.designWidth,d=this.designHeight;break;case oa.SCALE_SHOWALL:l=o=Math.min(l,o),h=u=Math.round(this.designWidth*l),_=d=Math.round(this.designHeight*o);break;case oa.SCALE_NOBORDER:l=o=Math.max(l,o),u=Math.round(this.designWidth*l),d=Math.round(this.designHeight*o);break;case oa.SCALE_FULL:l=o=c,h=e,_=t,this._width=e/c,this._height=t/c;break;case oa.SCALE_FIXED_WIDTH:o=l,this._height=_=Math.round(t/l);break;case oa.SCALE_FIXED_HEIGHT:l=o,this._width=h=Math.round(e/o);break;case oa.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(o=l,this._height=_=Math.round(t/l)):(l=o,this._width=h=Math.round(e/o));break;case oa.SCALE_FIXED_AUTO_LAYAME:e<t?(o=l,this._height=_=Math.round(t/l)):(o=l=t/this.designWidth,this._width=h=Math.round(e/l),this._height=_=Math.round(t/o));break;case oa.SCALE_FIXED_AUTO_LAYAVERSE:e>t?(l=o,this._width=h=Math.round(e/o)):(o=l=e/this.designHeight,this._width=h=Math.round(e/l),this._height=_=Math.round(t/o))}this.useRetinalCanvas&&(u=h=e,d=_=t),l*=this.scaleX,o*=this.scaleY,1===l&&1===o?this.transform.identity():(this.transform.a=this._formatData(l/(u/h)),this.transform.d=this._formatData(o/(d/_))),s.size(h,_),na.changeWebGLSize(h,_),a.scale(u/h/c,d/_/c),this._alignH===oa.ALIGN_LEFT?this.offset.x=0:this._alignH===oa.ALIGN_RIGHT?this.offset.x=e-u:this.offset.x=.5*(e-u)/c,this._alignV===oa.ALIGN_TOP?this.offset.y=0:this._alignV===oa.ALIGN_BOTTOM?this.offset.y=t-d:this.offset.y=.5*(t-d)/c,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),a.translate(this.offset.x,this.offset.y),this._safariOffsetY&&a.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===oa.SCREEN_HORIZONTAL?(a.rotate(Math.PI/2),a.translate(t/c,0),this.canvasDegree=90):(a.rotate(-Math.PI/2),a.translate(0,e/c),this.canvasDegree=-90)),a.a=this._formatData(a.a),a.d=this._formatData(a.d),a.tx=this._formatData(a.tx),a.ty=this._formatData(a.ty),super.set_transform(this.transform),oa._setStageStyle(s,h,_,a),this._safariOffsetY&&a.translate(0,-this._safariOffsetY),this.visible=!0,this._repaint|=Gt.REPAINT_CACHE,this.event(E.RESIZE)}static _setStageStyle(e,t,r,i){var s=e.source.style;s.transformOrigin=s.webkitTransformOrigin=s.msTransformOrigin=s.mozTransformOrigin=s.oTransformOrigin="0px 0px 0px",s.transform=s.webkitTransform=s.msTransform=s.mozTransform=s.oTransform="matrix("+i.toString()+")",s.width=t,s.height=r,i.translate(parseInt(s.left)||0,parseInt(s.top)||0)}setScreenSizeForScene(e,t,r){var i=!1;if(r!==oa.SCREEN_NONE&&(i=(e/t<1?oa.SCREEN_VERTICAL:oa.SCREEN_HORIZONTAL)!==r)){var s=t;t=e,e=s}this.canvasRotation=i,Ls._mainCanvas.source.style,this._canvasTransform.clone().identity();var a=this._scaleMode,n=e/this.designWidth,l=t/this.designHeight,o=this.useRetinalCanvas?e:this.designWidth,h=this.useRetinalCanvas?t:this.designHeight,_=e,u=t;bt.pixelRatio;let d=this.designWidth,c=this.designHeight;switch(a){case oa.SCALE_NOSCALE:n=l=1,_=this.designWidth,u=this.designHeight;break;case oa.SCALE_SHOWALL:n=l=Math.min(n,l),o=_=Math.round(this.designWidth*n),h=u=Math.round(this.designHeight*l);break;case oa.SCALE_NOBORDER:n=l=Math.max(n,l),_=Math.round(this.designWidth*n),u=Math.round(this.designHeight*l);break;case oa.SCALE_FULL:n=l=1,d=o=e,c=h=t;break;case oa.SCALE_FIXED_WIDTH:l=n,c=h=Math.round(t/n);break;case oa.SCALE_FIXED_HEIGHT:n=l,d=o=Math.round(e/l);break;case oa.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(l=n,c=h=Math.round(t/n)):(n=l,d=o=Math.round(e/l))}return this.useRetinalCanvas&&(_=o=e,u=h=t),{stageWidth:d,stageHeight:c,canvasWidth:o,canvasHeight:h,scaleX:n/(_/o),scaleY:l/(u/h)}}_formatData(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this._wgColor=e?Bt.create(e).arrColor:null,oa._setStyleBgColor(e)}static _setStyleBgColor(e){Ls.canvas.style.background=e||"none"}get mouseX(){return Math.round(Is.mouseX/this.clientScaleX)}get mouseY(){return Math.round(Is.mouseY/this.clientScaleY)}getMousePoint(){return f.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}repaint(e=Gt.REPAINT_CACHE){this._repaint|=e}parentRepaint(e=Gt.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(Ls._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return bt.now()-this._frameStartTime}set visible(e){this.visible!==e&&(super.set_visible(e),oa._setVisibleStyle(e))}static _setVisibleStyle(e){Ls._mainCanvas.source.style.visibility=e?"visible":"hidden"}get visible(){return super.visible}render(e,t,r){if(l.isConch)this.renderToNative(e,t,r);else{if(n.timer._delta,this._frameRate===oa.FRAME_SLEEP){var i=bt.now();if(i-this._frameStartTime<1e3)return;this._frameStartTime=i}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(ia.I._update(),Xt.loopCount++,pt.loopCount=Xt.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=bt.now(),pt.loopStTm=this._frameStartTime}this._renderCount++;var s=(this._frameRate===oa.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?oa.FRAME_FAST:oa.FRAME_SLOW:this._frameRate)!==oa.FRAME_SLOW,a=this._renderCount%2==0;if(Xt.renderSlow=!s,s||a){if(ia.I._update(),Xt.loopCount++,pt.loopCount=Xt.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),e.clear(),this._componentDriver.callPreRender(),super.render(e,t,r),Xt.render(e,t,r),oa.clear(this._bgColor),e.flush(),this._componentDriver.callPostRender(),yi.instance&&yi.getInstance().endDispose()}else this._runComponents();this._updateTimers()}}}renderToNative(e,t,r){if(this._renderCount++,this._visible){if(this._frameStartTime=bt.now(),ia.I._update(),Xt.loopCount++,pt.loopCount=Xt.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),this._componentDriver.callPreRender(),e.clear(),super.render(e,t,r),Xt.render(e,t,r),this._componentDriver.callPostRender()}else this._runComponents();this.renderingEnabled&&(oa.clear(this._bgColor),e.flush(),yi.instance&&yi.getInstance().endDispose()),this._updateTimers()}else this._renderCount%5==0&&(ia.I._update(),Xt.loopCount++,pt.loopCount=Xt.loopCount,this._runComponents(),this._updateTimers())}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){n.systemTimer._update(),n.physicsTimer._update(),n.timer._update()}set fullScreenEnabled(e){var t=bt.document,r=Ls.canvas;e?(r.addEventListener("mousedown",requestFullscreen),r.addEventListener("touchstart",requestFullscreen),t.addEventListener("fullscreenchange",fullScreenChanged),t.addEventListener("mozfullscreenchange",fullScreenChanged),t.addEventListener("webkitfullscreenchange",fullScreenChanged),t.addEventListener("msfullscreenchange",fullScreenChanged)):(r.removeEventListener("mousedown",requestFullscreen),r.removeEventListener("touchstart",requestFullscreen),t.removeEventListener("fullscreenchange",fullScreenChanged),t.removeEventListener("mozfullscreenchange",fullScreenChanged),t.removeEventListener("webkitfullscreenchange",fullScreenChanged),t.removeEventListener("msfullscreenchange",fullScreenChanged))}exitFullscreen(){var e=bt.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}get frameRate(){return l.isConch?this._frameRateNative:this._frameRate}set frameRate(e){if(l.isConch){var t=window.conch;switch(e){case oa.FRAME_FAST:t.config.setLimitFPS(60);break;case oa.FRAME_MOUSE:t.config.setMouseFrame(2e3);break;case oa.FRAME_SLOW:t.config.setSlowFrame(!0);break;case oa.FRAME_SLEEP:t.config.setLimitFPS(1)}this._frameRateNative=e}else this._frameRate=e}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function requestFullscreen(){var e=bt.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen();var t=Ls.canvas;t.removeEventListener("mousedown",requestFullscreen),t.removeEventListener("touchstart",requestFullscreen)}function fullScreenChanged(){n.stage.event(E.FULL_SCREEN_CHANGE)}oa.SCALE_NOSCALE="noscale",oa.SCALE_EXACTFIT="exactfit",oa.SCALE_SHOWALL="showall",oa.SCALE_NOBORDER="noborder",oa.SCALE_FULL="full",oa.SCALE_FIXED_WIDTH="fixedwidth",oa.SCALE_FIXED_HEIGHT="fixedheight",oa.SCALE_FIXED_AUTO="fixedauto",oa.SCALE_FIXED_AUTO_LAYAME="fixedauto_layame",oa.SCALE_FIXED_AUTO_LAYAVERSE="fixedauto_layaverse",oa.ALIGN_LEFT="left",oa.ALIGN_RIGHT="right",oa.ALIGN_CENTER="center",oa.ALIGN_TOP="top",oa.ALIGN_MIDDLE="middle",oa.ALIGN_BOTTOM="bottom",oa.SCREEN_NONE="none",oa.SCREEN_HORIZONTAL="horizontal",oa.SCREEN_VERTICAL="vertical",oa.FRAME_FAST="fast",oa.FRAME_SLOW="slow",oa.FRAME_MOUSE="mouse",oa.FRAME_SLEEP="sleep",oa.clear=function(e){Or.set2DRenderConfig(),j.worldScissorTest&&x.renderEngine.scissorTest(!1);var t=Ls.context,i=0==t._submits._length||r.preserveDrawingBuffer?Bt.create(e).arrColor:n.stage._wgColor;i?t.clearBG(i[0],i[1],i[2],i[3]):t.clearBG(0,0,0,0),j.clear()};var ha={};class _a{render(t,r,i,s,a){var n=Dt.create(e.RenderSpriteData.Texture2D);a.strength>=2&&this.setShaderInfo(n,a,t.width,t.height),r.drawTarget(t,0,0,i,s,p.EMPTY.identity(),n)}setShaderInfo(e,t,r,i){e.defines.addDefine(ct.FILTERBLUR);var s=e;_a.blurinfo.x=r,_a.blurinfo.y=i,s.blurInfo=_a.blurinfo;let a=Math.max(Math.abs(t.strength),2);var n=a/3,l=n*n;let o=2*l,h=1/(2*Math.PI*l),_=0,u=Math.floor(10*a);if(null!=ha[u])_=ha[u];else{for(let e=-4;e<=4;++e)for(let t=-4;t<=4;++t)_+=h*Math.exp(-(t*t+e*e)/o);ha[u]=_}h/=_,we.tempVec4.x=t.strength_sig2_2sig2_gauss1[0]=a,we.tempVec4.y=t.strength_sig2_2sig2_gauss1[1]=l,we.tempVec4.z=t.strength_sig2_2sig2_gauss1[2]=o,we.tempVec4.w=t.strength_sig2_2sig2_gauss1[3]=h,s.strength_sig2_2sig2_gauss1=we.tempVec4}}_a.blurinfo=new Me;class ua extends It{constructor(e=4){super(),this.strength_sig2_2sig2_gauss1=[],this.strength=e,this._glRender=new _a}get type(){return It.BLUR}getStrenth_sig2_2sig2_native(){this.strength_sig2_native||(this.strength_sig2_native=new Float32Array(4));var e=this.strength/3,t=e*e;return this.strength_sig2_native[0]=this.strength,this.strength_sig2_native[1]=t,this.strength_sig2_native[2]=2*t,this.strength_sig2_native[3]=1/(2*Math.PI*t),this.strength_sig2_native}}class da{setShaderInfo(e,t,r,i){e.defines.addDefine(i.typeDefine);var s=e;we.tempVec4.setValue(i._sv_blurInfo1[0],i._sv_blurInfo1[1],i._sv_blurInfo1[2],i._sv_blurInfo1[3]),s.u_blurInfo1=we.tempVec4;var a=i._sv_blurInfo2;a[0]=t,a[1]=r,we.tempVec4.setValue(a[0],a[1],a[2],a[3]),s.u_blurInfo2=we.tempVec4;var n=i.getColor();we.tempVec4.setValue(n[0],n[1],n[2],n[3]),s.color=we.tempVec4}render(t,r,i,s,a){var n=i,l=s,o=Dt.create(e.RenderSpriteData.Texture2D);this.setShaderInfo(o,n,l,a);var h=Dt.create(e.RenderSpriteData.Texture2D),_=p.TEMP.identity();r.drawTarget(t,0,0,n,l,_,o),r.drawTarget(t,0,0,n,l,_,h,null,9)}}class ca extends It{constructor(e,t=4,r=6,i=6){super(),this._elements=new Float32Array(9),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._color=new Bt(e||"#000"),this.blur=Math.min(t,20),this.offX=r,this.offY=i,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=this.blur,this._sv_blurInfo1[2]=r,this._sv_blurInfo1[3]=-i,this._glRender=new da}get type(){return ua.GLOW}get typeDefine(){return ct.FILTERGLOW}get offY(){return this._elements[6]}set offY(e){this._elements[6]=e,this._sv_blurInfo1[3]=-e}get offX(){return this._elements[5]}set offX(e){this._elements[5]=e,this._sv_blurInfo1[2]=e}get color(){return this._color.strColor}set color(e){this._color=new Bt(e)}getColor(){return this._color.arrColor}get blur(){return this._elements[4]}set blur(e){this._elements[4]=e,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e}getColorNative(){this._color_native||(this._color_native=new Float32Array(4));var e=this.getColor();return this._color_native[0]=e[0],this._color_native[1]=e[1],this._color_native[2]=e[2],this._color_native[3]=e[3],this._color_native}getBlurInfo1Native(){return this._blurInof1_native||(this._blurInof1_native=new Float32Array(4)),this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur,this._blurInof1_native[2]=this.offX,this._blurInof1_native[3]=this.offY,this._blurInof1_native}getBlurInfo2Native(){return this._blurInof2_native||(this._blurInof2_native=new Float32Array(4)),this._blurInof2_native[2]=1,this._blurInof2_native}}class pa extends v{constructor(){super(...arguments),this.isStopped=!1}set volume(e){}get volume(){return 1}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(e){e&&e.runWith(!0)}}class fa extends pa{constructor(e){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),e.addEventListener("ended",this._onEnd),this._audio=e,this._src=e.src}__onEnd(e){if(1==this.loops)return this.completeHandler&&(n.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(E.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,bt.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(E.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=xa.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}if(xa.addChannel(this),bt.container.appendChild(this._audio),"play"in this._audio){let e=this._audio.play();e&&e.catch((e=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,xa.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&l.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),n.Browser.onIE||this._audio!=ga._musicAudio&&o.recover("audio:"+this.url,this._audio),bt.removeElement(this._audio),this._audio=null,xa.autoReleaseSound&&xa.disposeSoundLater(this.url))}pause(){this.isStopped=!0,xa.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),xa.autoReleaseSound&&xa.disposeSoundLater(this.url))}resume(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this._src,e.addEventListener("canplay",this._resumePlay),e.load()),xa.addChannel(this),"play"in e&&e.play())}set volume(e){this._audio&&(this._audio.volume=e)}get volume(){return this._audio?this._audio.volume:1}}class ga extends v{constructor(){super(...arguments),this.loaded=!1}dispose(){var e=ga._audioCache[this.url];o.clearBySign("audio:"+this.url),e&&(l.isConch||(e.src=""),delete ga._audioCache[this.url])}static _initMusicAudio(){ga._musicAudio||(ga._musicAudio||(ga._musicAudio=bt.createElement("audio")),l.isConch||bt.document.addEventListener("mousedown",ga._makeMusicOK))}static _makeMusicOK(){bt.document.removeEventListener("mousedown",ga._makeMusicOK),ga._musicAudio.src?ga._musicAudio.play():(ga._musicAudio.src="",ga._musicAudio.load())}load(e){var t;if(this.url=e,e==xa._bgMusic?(ga._initMusicAudio(),(t=ga._musicAudio).originalUrl!=e&&(delete ga._audioCache[t.originalUrl],t=null)):t=ga._audioCache[e],t&&t.readyState>=2)this.event(E.COMPLETE);else{t||(e==xa._bgMusic?(ga._initMusicAudio(),t=ga._musicAudio):t=bt.createElement("audio"),ga._audioCache[e]=t,ue.inst.resolveURL(e,(e=>{t.src=de.postFormatURL(de.formatURL(e))}))),t.originalUrl=e,t.addEventListener("canplaythrough",onLoaded),t.addEventListener("error",onErr);var r=this;this.audio=t,t.load?t.load():onErr()}function onLoaded(){offs(),r.loaded=!0,r.event(E.COMPLETE)}function onErr(){t.load=null,offs(),r.event(E.ERROR)}function offs(){t.removeEventListener("canplaythrough",onLoaded),t.removeEventListener("error",onErr)}}play(e=0,t=0){if(!this.url)return null;var r,i;if(this.url==xa._bgMusic?""!=(r=ga._musicAudio).src&&r.originalUrl!=this.url&&(delete ga._audioCache[r.originalUrl],ga._audioCache[this.url]=r):r=ga._audioCache[this.url],!r)return null;i=o.getItem("audio:"+this.url),l.isConch?i||(i=bt.createElement("audio"),ue.inst.resolveURL(this.url,(e=>{i.src=de.postFormatURL(de.formatURL(e))}))):this.url==xa._bgMusic?(ga._initMusicAudio(),i=ga._musicAudio,ue.inst.resolveURL(this.url,(e=>{i.src=de.postFormatURL(de.formatURL(e))}))):i=i||r.cloneNode(!0),i.originalUrl=this.url;var s=new fa(i);return s.url=this.url,s.loops=t,s.startTime=e,s.play(),xa.addChannel(s),s}get duration(){var e;return(e=ga._audioCache[this.url])?e.duration:0}}ga._audioCache={};class ma extends pa{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=Ta.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(xa.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var e=this.context,t=this.gain,r=e.createBufferSource();this.bufferSource=r,r.buffer=this.audioBuffer,r.connect(t),t&&t.disconnect(),t.connect(e.destination),r.onended=this._onPlayEnd,this._startTime=bt.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,ma.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(r.loop=!0),r.playbackRate.setTargetAtTime?r.playbackRate.setTargetAtTime(xa.playbackRate,this.context.currentTime,ma.SetTargetDelay):r.playbackRate.value=xa.playbackRate,r.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(n.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(E.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(bt.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,ma._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}_tryClearBuffer(e){try{e.buffer=null}catch(e){ma._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,xa.removeChannel(this),this.completeHandler=null,xa.autoReleaseSound&&xa.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,xa.removeChannel(this),xa.autoReleaseSound&&xa.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}set volume(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,ma.SetTargetDelay):this.gain.gain.value=e)}get volume(){return this._volume}}ma._tryCleanFailed=!1,ma.SetTargetDelay=.001;class Ta extends v{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=Ta.ctx){var e=Ta.ctx.createBufferSource();e.buffer=Ta._miniBuffer,e.connect(Ta.ctx.destination),e.start(0,0,0)}}static _unlock(){Ta._unlocked||(Ta._playEmptySound(),"running"==Ta.ctx.state&&(window.document.removeEventListener("mousedown",Ta._unlock,!0),window.document.removeEventListener("touchend",Ta._unlock,!0),window.document.removeEventListener("touchstart",Ta._unlock,!0),Ta._unlocked=!0))}static initWebAudio(){Ta.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=Ta.ctx.state&&(Ta._unlock(),window.document.addEventListener("mousedown",Ta._unlock,!0),window.document.addEventListener("touchend",Ta._unlock,!0),window.document.addEventListener("touchstart",Ta._unlock,!0))}load(e){this.url=e,this.audioBuffer=n.loader.getRes(e),this.audioBuffer?this._loaded(this.audioBuffer):n.loader.load(e,Ki.SOUND).then((e=>this._loaded(e)))}_loaded(e){this._disposed||(this.audioBuffer=e,this.loaded=!0,this.event(E.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var e,t,r,i;for(t=(r=this.__toPlays).length,e=0;e<t;e++)(i=r[e])[2]&&!i[2].isStopped&&this.play(i[0],i[1],i[2]);this.__toPlays.length=0}}play(e=0,t=0,r=null){return r=r||new ma,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,r]),this.once(E.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),r.url=this.url,r.loops=t,r.audioBuffer=this.audioBuffer,r.startTime=e,r.play(),xa.addChannel(r),r}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(n.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}Ta._miniBuffer=Ta.ctx?Ta.ctx.createBuffer(1,1,22050):void 0,Ta._unlocked=!1;class xa{static __init__(){var e=n.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&Ta.initWebAudio(),xa._soundClass=t?Ta:ga,bt.onTBMiniGame||ga._initMusicAudio(),xa._musicClass=ga,t}static addChannel(e){xa._channels.indexOf(e)>=0||xa._channels.push(e)}static removeChannel(e){for(let t=xa._channels.length-1;t>=0;t--)xa._channels[t]==e&&xa._channels.splice(t,1)}static disposeSoundLater(e){xa._lastSoundUsedTimeDic[e]=n.Browser.now(),xa._isCheckingDispose||(xa._isCheckingDispose=!0,n.timer.loop(5e3,null,xa._checkDisposeSound))}static _checkDisposeSound(){let e=n.Browser.now(),t=!1;for(let r in xa._lastSoundUsedTimeDic)e-xa._lastSoundUsedTimeDic[r]>3e4?(delete xa._lastSoundUsedTimeDic[r],xa.disposeSoundIfNotUsed(r)):t=!0;t||(xa._isCheckingDispose=!1,n.timer.clear(null,xa._checkDisposeSound))}static disposeSoundIfNotUsed(e){for(let t=xa._channels.length-1;t>=0;t--)if(xa._channels[t].url==e)return;xa.destroySound(e)}static set autoStopMusic(e){n.stage.off(E.BLUR,null,xa._stageOnBlur),n.stage.off(E.FOCUS,null,xa._stageOnFocus),n.stage.off(E.VISIBILITY_CHANGE,null,xa._visibilityChange),xa._autoStopMusic=e,e&&(n.stage.on(E.BLUR,null,xa._stageOnBlur),n.stage.on(E.FOCUS,null,xa._stageOnFocus),n.stage.on(E.VISIBILITY_CHANGE,null,xa._visibilityChange))}static get autoStopMusic(){return xa._autoStopMusic}static _visibilityChange(){n.stage.isVisibility?xa._stageOnFocus():xa._stageOnBlur()}static _stageOnBlur(){xa._isActive=!1,xa._musicChannel&&(xa._musicChannel.isStopped||(xa._blurPaused=!0,xa._musicChannel.pause())),xa.stopAllSound(),n.stage.once(E.MOUSE_DOWN,null,xa._stageOnFocus)}static _recoverWebAudio(){Ta.ctx&&"running"!=Ta.ctx.state&&Ta.ctx.resume&&Ta.ctx.resume()}static _stageOnFocus(){xa._isActive=!0,xa._recoverWebAudio(),n.stage.off(E.MOUSE_DOWN,null,xa._stageOnFocus),xa._blurPaused&&xa._musicChannel&&xa._musicChannel.isStopped&&(xa._blurPaused=!1,xa._musicChannel.resume())}static set muted(e){e!=xa._muted&&(e&&xa.stopAllSound(),xa.musicMuted=e,xa._muted=e)}static get muted(){return xa._muted}static set soundMuted(e){xa._soundMuted=e}static get soundMuted(){return xa._soundMuted}static set musicMuted(e){e!=xa._musicMuted&&(e?(xa._bgMusic&&xa._musicChannel&&!xa._musicChannel.isStopped?l.isConch?xa._musicChannel._audio&&(xa._musicChannel._audio.muted=!0):xa._musicChannel.pause():xa._musicChannel=null,xa._musicMuted=e):(xa._musicMuted=e,xa._bgMusic&&xa._musicChannel&&(l.isConch?xa._musicChannel._audio&&(xa._musicChannel._audio.muted=!1):xa._musicChannel.resume())))}static get musicMuted(){return xa._musicMuted}static get useAudioMusic(){return xa._useAudioMusic}static set useAudioMusic(e){xa._useAudioMusic=e,xa._musicClass=e?ga:null}static playSound(e,t=1,r=null,i=null,s=0){if(!xa._isActive||!e)return null;if(xa._muted)return null;if(xa._recoverWebAudio(),e==xa._bgMusic){if(xa._musicMuted)return null}else if(xa._soundMuted)return null;let a;bt._isMiniGame||(a=xa._soundCache[e]),i||(i=xa._soundClass),a||(a=new i,a.load(e),bt._isMiniGame||(xa._soundCache[e]=a));let n=a.play(s,t);return n?(n.url=e,n.volume=e==xa._bgMusic?xa.musicVolume:xa.soundVolume,n.completeHandler=r,n):null}static destroySound(e){let t=xa._soundCache[e];t&&(delete xa._soundCache[e],t.dispose())}static playMusic(e,t=0,r=null,i=0){return xa._bgMusic=e,xa._musicChannel&&xa._musicChannel.stop(),xa._musicChannel=xa.playSound(e,t,r,xa._musicClass,i)}static stopSound(e){for(let t=xa._channels.length-1;t>=0;t--){let r=xa._channels[t];r.url==e&&r.stop()}}static stopAll(){var e;for(xa._bgMusic=null,e=xa._channels.length-1;e>=0;e--)xa._channels[e].stop()}static stopAllSound(){for(let e=xa._channels.length-1;e>=0;e--){let t=xa._channels[e];t.url!=xa._bgMusic&&t.stop()}}static stopMusic(){xa._musicChannel&&xa._musicChannel.stop(),xa._bgMusic=null}static setSoundVolume(e,t=null){if(t)xa._setVolume(t,e);else{xa.soundVolume=e;for(let t=xa._channels.length-1;t>=0;t--){let r=xa._channels[t];r.url!=xa._bgMusic&&(r.volume=e)}}}static setMusicVolume(e){xa.musicVolume=e,xa._setVolume(xa._bgMusic,e)}static _setVolume(e,t){for(let r=xa._channels.length-1;r>=0;r--){let i=xa._channels[r];i.url==e&&(i.volume=t)}}}xa.musicVolume=1,xa.soundVolume=1,xa.playbackRate=1,xa._useAudioMusic=!0,xa._muted=!1,xa._soundMuted=!1,xa._musicMuted=!1,xa._bgMusic=null,xa._musicChannel=null,xa._channels=[],xa._blurPaused=!1,xa._isActive=!0,xa._lastSoundUsedTimeDic={},xa._isCheckingDispose=!1,xa._soundCache={},xa.autoReleaseSound=!0;class ya extends Li{constructor(){super(),this._loop=1,this.on(E.ADDED,this,this._onParentChange),this.on(E.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(e){this._source=e,e?this._autoPlay&&(!this._channel||this._channel.isStopped)&&l.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,e&&this._source&&(!this._channel||this._channel.isStopped)&&l.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(e,t){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=xa.playMusic(this._source,e,t):this._channel=xa.playSound(this._source,e,t))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,r,i=!0){this[r]&&e&&(i?e.on(t,this,this[r]):e.off(t,this,this[r]))}_setPlayActions(e,t,r,i=!0){if(!e)return;if(!t)return;let s=t.split(","),a=s.length;for(let t=0;t<a;t++)this._setPlayAction(e,s[t],r,i)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}class Ea extends I{constructor(){let t=n.Browser.createElement("video");super(t.videoWidth,t.videoHeight,e.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=t,this._listeningEvents={},this._dimension=e.TextureDimension.Tex2D;var r=this.element.style;if(r.position="absolute",r.top="0px",r.left="0px",t.setAttribute("crossorigin","anonymous"),n.Browser.onMobile&&(t["x5-playsInline"]=!0,t["x5-playsinline"]=!0,t.x5PlaysInline=!0,t.playsInline=!0,t["webkit-playsInline"]=!0,t["webkit-playsinline"]=!0,t.webkitPlaysInline=!0,t.playsinline=!0,t.style.playsInline=!0,t.crossOrigin="anonymous",t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true")),t.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in t){const i=this;function updateVideo(){i._needUpdate=!0,t.requestVideoFrameCallback(updateVideo)}t.requestVideoFrameCallback(updateVideo),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,bt.onLayaRuntime?this._texture=x.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=x.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,x.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(E.READY,this))}get source(){return this._source}get gammaCorrection(){return 2.2}set source(e){this._source=e,e&&ue.inst.resolveURL(e,(e=>{for(;this.element.childElementCount;)this.element.firstChild.remove();e.startsWith("blob:")?this.element.src=e:this.appendSource(e)}))}appendSource(e){var t=n.Browser.createElement("source");t.src=de.postFormatURL(de.formatURL(e));let r=d.getFileExtension(e);t.type="m3u8"==r?"application/vnd.apple.mpegurl":"video/"+r,this.element.appendChild(t)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||bt.onLayaRuntime)&&(x.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1)}set frameRender(e){this._frameRender&&!e&&n.timer.clear(this,this.render),!this._frameRender&&e&&n.timer.frameLoop(1,this,this.render),this._frameRender=e}get frameRender(){return this._frameRender}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&n.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return Y.whiteTexture}pause(){this.element.pause(),this._frameRender&&n.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(e){return e="m3u8"==e?"application/vnd.apple.mpegurl":"video/"+e,this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(e){this.element&&(this.element.currentTime=e,this.render())}set volume(e){this.element&&(this.element.volume=e)}get volume(){return this.element.volume}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(e){this.element&&(this.element.loop=e)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get muted(){return this.element.muted}set muted(e){this.element&&(this.element.muted=e)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(e){this.element&&(this.element.preload=e)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(e){if(Sa.has(e)){let t=this._listeningEvents[e];t||(t=this._listeningEvents[e]=()=>{this.event(e)}),this.element.addEventListener(e,t)}}destroy(){if(l.isConch,this.element)if(l.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();n.timer.clear(this,this.render),super.destroy()}}const Sa=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class ba extends Li{constructor(){if(super(),this.texture=this._internalTex=new ae,l.isPlaying&&n.Browser.onMobile&&!l.isConch){let func=()=>{n.Browser.document.removeEventListener("touchend",func),this._videoTexture&&(bt.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};n.Browser.document.addEventListener("touchend",func)}}get videoTexture(){return this._videoTexture}set videoTexture(e){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(E.READY,this,this.onVideoMetaLoaded)),this._videoTexture=e,e?(this._videoTexture._addReference(),this._videoTexture.on(E.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null)}get source(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.source}set source(e){e?(this._videoTexture||(this.videoTexture=new Ea),this._videoTexture.source=e):this._videoTexture&&(this._videoTexture.source=e)}load(e){this.source=e}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(e){return this._videoTexture||(this.videoTexture=new Ea),this._videoTexture.canPlayType(e)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.buffered}get currentSrc(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentSrc}get currentTime(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentTime}set currentTime(e){this._videoTexture&&(this._videoTexture.currentTime=e)}set volume(e){this._videoTexture&&(this._videoTexture.volume=e)}get volume(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.volume}get readyState(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.readyState}get videoWidth(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.ended}get error(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.error}get loop(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.loop}set loop(e){this._videoTexture&&(this._videoTexture.loop=e)}get playbackRate(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.playbackRate}set playbackRate(e){this._videoTexture&&(this._videoTexture.playbackRate=e)}get muted(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.muted}set muted(e){this._videoTexture&&(this._videoTexture.muted=e)}get paused(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.paused}get preload(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.preload}set preload(e){this._videoTexture&&(this._videoTexture.preload=e)}get seekable(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seekable}get seeking(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seeking}_setX(e){if(super._setX(e),this._videoTexture&&l.isConch){var t=Bi.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=t.x}}_setY(e){if(super._setY(e),this._videoTexture&&l.isConch){var t=Bi.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=t.y}}set_width(e){if(super.set_width(e),this._videoTexture)if(l.isConch){var t=Bi.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=e*t.scaleX}else this._videoTexture.element.width=this.width/n.Browser.pixelRatio}set_height(e){if(super.set_height(e),this._videoTexture)if(l.isConch){var t=Bi.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=e*t.scaleY}else this._videoTexture.element.height=this.height/n.Browser.pixelRatio}destroy(e=!0){this.videoTexture=null,super.destroy(e)}}class va{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var r=this._elapsedTime/t%1;this._normalizedPlayTime=r<0?r+1:r,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._parentPlayTime=this._parentPlayTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class Ra{constructor(e){this._referenceCount=0,this._playStateInfo=new va,this._crossPlayStateInfo=new va,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=Ra.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get states(){return this._states}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,r){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw"AnimatorControllerLayer:this stat's name has exist.";this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,r=-1,i=0,s=t.length;i<s;i++)if(t[i]===e){r=i;break}-1!=r&&this._removeClip(t,r,e)}clone(){var e=new Ra(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var Aa,Ca,Da,Ma,wa,Ia;Ra.BLENDINGMODE_OVERRIDE=0,Ra.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(Aa=e.AniParmType||(e.AniParmType={}))[Aa.Float=0]="Float",Aa[Aa.Bool=1]="Bool",Aa[Aa.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(Ca=e.AniStateConditionType||(e.AniStateConditionType={}))[Ca.Number=0]="Number",Ca[Ca.Bool=1]="Bool",Ca[Ca.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(Da=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[Da.Less=0]="Less",Da[Da.Greater=1]="Greater";class Pa{static parse(e){let t=e,r=t.controllerLayers;null==r&&(r=[]);let i=[];for(let e=r.length-1;e>=0;e--){let s=r[e],a=s.states;a||(a=[],s.states=a),s.defaultStateName=null;let n=this.checkStates(a,i,t);n?s.defaultStateName=n.enterName:r.splice(e,1)}return{ret:t,clipsID:i}}static checkStates(e,t,r){let i=null,s=null;for(let a=e.length-1;a>=0;a--){let n=e[a];n.states?null==this.checkStates(n.states,t,r)?e.splice(a,1):(null==i&&(i=[]),i.push(n)):"-1"==n.id?s=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(a,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,r),null==i&&(i=[]),i.push(n)))}let a=null;if(i&&s){let e=this.checkDefault(s,i);null!=e&&(a={states:i,enterName:e})}return a}static checkNext(e,t,r){let i=e.soloTransitions;if(i)for(let e=i.length-1;e>=0;e--){let s=i[e],a=this.getStateByID(t,s.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?i.splice(e,1):(s.name=a.name,s.conditions=this.checkConditions(s.conditions,r))}}static checkConditions(t,r){if(!t||0==t.length||null==r.animatorParams||0==r.animatorParams.length)return[];let i=r.animatorParams;for(let r=t.length-1;r>=0;r--){let s=t[r],a=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==s.id){a=i[e];break}if(null==a)t.splice(r,1);else if(s.name=a.name,a.type==e.AniParmType.Float){let e=Number(s.checkValue);isNaN(e)&&(s.checkValue=0),e=Number(s.type),isNaN(e)&&(s.type=0)}}return t}static checkDefault(e,t){let r=e.soloTransitions,i=null;r&&0<r.length&&(i=r[0].id);let s=null;if(null!=i&&(s=this.getStateByID(t,i)),null!=s&&(null!=s.clip||null!=s.states))return s.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let r=e.length-1;r>=0;r--)if(e[r].id==t)return e[r];return null}}e.AnimatorUpdateMode=void 0,(Ma=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[Ma.Normal=0]="Normal",Ma[Ma.LowFrame=1]="LowFrame",Ma[Ma.UnScaleTime=2]="UnScaleTime";class Ba extends c{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}set controller(e){this._controller=e,e&&e.updateTo(this)}get controller(){return this._controller}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set speed(e){this._speed=e}get speed(){return this._speed}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&e._eventExit()}_setClipDatasToNode(e,t,r,i=null){for(var s=e._realtimeDatas,a=e._clip._nodes,n=0,l=a.count;n<l;n++)if(null!=s[n]){var o=a.getNodeByIndex(n),h=this.getOwner(o);h&&this._applyFloat(h,t,r,s[n])}}_applyFloat(e,t,r,i){var s=e.pro;s&&s.ower&&(s.ower[s.key]=t&&"number"==typeof i?s.defVal+r*i:"number"==typeof i?r*i:i)}getOwner(e){var r;if(this._ownerMap&&(r=this._ownerMap.get(e)))return r;for(var i=this.owner,s=0,a=e.ownerPathCount;s<a;s++){var n=e.getOwnerPathByIndex(s);if(""!=n&&!(i=i.getChildByName(n)))break}if(r={ower:i},i){var l=i,o=e.propertyCount;if(1==o){var h=e.getPropertyByIndex(0);r.pro={ower:i,key:h,defVal:i[h]}}else for(var _=0;_<o;_++){h=e.getPropertyByIndex(_);if(_==o-1||null==l){r.pro={ower:l,key:h,defVal:l?l[h]:null};break}if(null==l[h]&&i==l){l=null;var u=t.getClass(h);u&&(l=i.getComponent(u))}else l=l[h]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,r),r}_updateClipDatas(e,t,r){var i=e._clip,s=i._duration,a=e.clipStart*s+r._normalizedPlayTime*r._duration,n=e._currentFrameIndices;i._evaluateClipDatasRealTime(a,n,t,!0,e._realtimeDatas)}_updatePlayer(e,t,r,i,s){let a=!1;var n=e._clip._duration*(e.clipEnd-e.clipStart),l=t._elapsedTime;let o=t._playAllTime;t._playAllTime+=Math.abs(r),r=l+r,t._lastElapsedTime=l,t._elapsedTime=r;var h=r/n;let _=1;e.yoyo&&(_=2);let u=t._playAllTime/(n*_);Math.floor(o/(n*_))<Math.floor(u)&&(a=!0);var d=h%1;let c=d<0?d+1:d;if(t._normalizedPlayTime=c,t._duration=n,1!=_&&(c=(d=(h=t._playAllTime/(n*_))%1)<0?d+1:d,e.yoyo&&(.5>c?t._frontPlay||(0>e.speed?(t._elapsedTime=e.clipEnd*o,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*o,t._normalizedPlayTime=e.clipStart),t._frontPlay=!0):t._frontPlay&&(t._frontPlay=!1,0>e.speed?(t._elapsedTime=e.clipStart*o,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*o,t._normalizedPlayTime=e.clipEnd)))),e._eventStateUpdate(c),!this._applyTransition(s,e._eventtransition(c,this.parameters,a))&&a){let r=t._playAllTime/(n*_);if(0<i&&i<=r)return t._finish=!0,void(0>e.speed?e.yoyo?(t._elapsedTime=e.clipEnd*o,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*o,t._normalizedPlayTime=e.clipStart):e.yoyo?(t._elapsedTime=e.clipStart*o,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*o,t._normalizedPlayTime=e.clipEnd));e._eventLoop()}}_updateEventScript(e,t){let r=e._clip,i=r._animationEvents;if(!i||0==i.length)return;let s=r._duration,a=t._normalizedPlayTime*s,n=t._frontPlay,l=t._parentPlayTime,o=t._parentPlayTime;null==o&&(o=n?s*t.animatorState.clipStart:s*t.animatorState.clipEnd),n?a<o&&(this._eventScript(i,o,s*t.animatorState.clipEnd,n),o=s*t.animatorState.clipStart):a>o&&(this._eventScript(i,o,s*t.animatorState.clipStart,n),o=s*t.animatorState.clipEnd),this._eventScript(i,o,a,n),l==t._parentPlayTime&&(t._parentPlayTime=a)}_eventScript(e,t,r,i){let s=this.owner.components;if(i)for(let i=0,a=e.length;i<a;i++){let a=e[i];if(a.time>t&&a.time<=r)for(let e=0,t=s.length;e<t;e++){let t=s[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time>r)break}else for(let i=e.length-1;i>=0;i--){let a=e[i];if(a.time<t&&a.time>=r)for(let e=0,t=s.length;e<t;e++){let t=s[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time<r)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,t.transduration,e,t.transstartoffset)}_applyUpdateMode(t){let r;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:r=t;break;case e.AnimatorUpdateMode.LowFrame:r=Xt.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:r=0}return r}gotoAndStopByFrame(e,t,r){var i=this._controllerLayers[t];if(i){var s=i.getStateByName(e);if(!s||!s._clip)return;let a=r/(s._clip._duration*s._clip._frameRate);1<a&&(a=1),this.gotoAndStop(e,t,a)}}gotoAndStop(e,t,r){var i=this._controllerLayers[t];if(i){var s=i.getStateByName(e);if(!s||!s._clip)return;var a=i._playStateInfo,n=a._currentState,l=s._clip._duration,o=s._clip._duration*(s.clipEnd-s.clipStart);a._resetPlayState(l*r,o),a._normalizedPlayTime=r,i._playType=0,n!==s&&(a._currentState=s),s._eventStart(this,t);let h=i.blendingMode!=Ra.BLENDINGMODE_OVERRIDE;this._updateClipDatas(s,h,a),this._setClipDatasToNode(s,h,i.defaultWeight,i),this.stop()}}play(e,t=0,r=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var i=this._controllerLayers[t];if(i){var s=i.defaultState;if(!e&&!s)throw new Error("Animator:must have default clip value,please set clip property.");var a=i._playStateInfo,n=a._currentState,l=e?i.getStateByName(e):s;if(!l._clip)return;var o=l._clip._duration,h=l._clip._duration*(l.clipEnd-l.clipStart);n!==l?(r!==Number.NEGATIVE_INFINITY?a._resetPlayState(o*r,h):a._resetPlayState(0,h),i._playType=0,a._currentState=l):r!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(o*r,h),i._playType=0),l._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let r=this._checkEnterIndex[t];if(this._controllerLayers[r]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(r);this.play(null,r,e.cycleOffset)}}var t=this.owner.timer._delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var r=0,i=this._controllerLayers.length;r<i;r++){var s=this._controllerLayers[r];if(s.enable){var a=s._playStateInfo,n=s.blendingMode!=Ra.BLENDINGMODE_OVERRIDE;if(0===s._playType){var l=a._currentState,o=this._speed*l.speed,h=a._finish,_=l.loop;-1>=_&&(_=l._clip.islooping?0:1);let e=1;a._frontPlay||(e=-1),h||this._updatePlayer(l,a,t*o*e,_,r),l=(a=s._playStateInfo)._currentState,this._updateClipDatas(l,n,a),h||(this._setClipDatasToNode(l,n,s.defaultWeight,s),this._updateEventScript(l,a)),h||this._updateStateFinish(l,a)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t,r=0,i=Number.NEGATIVE_INFINITY){var s=this._controllerLayers[r];if(s){if(s.getStateByName(e))return this.play(e,r,i),!0;console.warn("Invalid layerIndex "+r+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var r=this.getDefaultState(e);if(r){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,r.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,r.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}setParamsBool(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class La extends v{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(La.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,r=this._scripts.length;t<r;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(La.EVENT_OnStateEnter),this._scripts)for(var r=0,i=this._scripts.length;r<i;r++)this._scripts[r].setPlayScriptInfo(e,t,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(La.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventLoop(){if(this.event(La.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t,r){let i=this.soloTransitions.length;if(i>0){for(var s=0;s<i;s++)if(this.soloTransitions[s].check(e,t,r))return this.soloTransitions[s];return null}let a=this.transitions.length;for(s=0;s<a;s++)if(this.transitions[s].check(e,t,r))return this.transitions[s];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}getScripts(e){var t=null;if(this._scripts)for(var r=0,i=this._scripts.length;r<i;r++){var s=this._scripts[r];s instanceof e&&(t=t||[]).push(s)}return t}clone(){var e=new La;return this.cloneTo(e),e}cloneTo(e){var t=e;t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}La.EVENT_OnStateEnter="OnStartEnter",La.EVENT_OnStateUpdate="OnStateUpdate",La.EVENT_OnStateExit="OnStateExit",La.EVENT_OnStateLoop="OnStateLoop";class Fa{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class Oa{clone(){var e=new Oa;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}Oa.defaultWeight=.33333;class Na{constructor(){}}class Ua{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.getUint16(),t=this._BLOCK.blockStarts=[],r=this._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(this._reader.getUint32()),r.push(this._reader.getUint32())}static READ_STRINGS(){var e=this._reader.getUint32(),t=this._reader.getUint16(),r=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var i=0;i<t;i++)this._strings[i]=this._reader.readUTFString();this._reader.pos=r}static parse(e,t,r){this._clip=e,this._reader=t,this._version=r,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var i=0,s=this._BLOCK.count;i<s;i++){var a=t.getUint16(),n=this._strings[a],l=this["READ_"+n];if(!l)throw new Error("model file err,no this function:"+a+" "+n);l.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static READ_ANIMATIONS2D(){var e,t,r,i=this._reader,s=this._clip,a=[],n=i.getUint16();for(a.length=n,e=0;e<n;e++)a[e]=i.getFloat32();s._duration=a[i.getInt16()],s.islooping=!!i.getByte(),s._frameRate=i.getInt16();var l=i.getInt16(),o=s._nodes;o.count=l;var h=s._nodesMap={},_=s._nodesDic={};for(e=0;e<l;e++){r=new Fa,o.setNodeByIndex(e,r),r._indexInList=e;var u=i.getUint16();for(r._setOwnerPathCount(u),t=0;t<u;t++)r._setOwnerPathByIndex(t,this._strings[i.getUint16()]);var d=r._joinOwnerPath("/"),c=h[d];c||(h[d]=c=[]),c.push(r);var p=i.getUint16();for(r._setPropertyCount(p),t=0;t<p;t++)r._setPropertyByIndex(t,this._strings[i.getUint16()]);var f=d+"."+r._joinProperty(".");_[f]=r,r.fullPath=f,r.nodePath=d;var g=i.getUint16();for(t=0;t<g;t++){var m=new Oa;m.time=a[i.getUint16()],m.data={f:this.timeToFrame(m.time,s._frameRate),val:0},1==i.getByte()&&(m.data.tweenType=this._strings[i.getUint16()]),1==i.getByte()&&(m.data.tweenInfo={},m.data.tweenInfo.inTangent=a[i.getUint16()],m.data.tweenInfo.outTangent=a[i.getUint16()],1==i.getByte()&&(m.data.tweenInfo.inWeight=a[i.getUint16()]),1==i.getByte()&&(m.data.tweenInfo.outWeight=a[i.getUint16()]));var T=i.getByte();if(0==T?m.data.val=a[i.getUint16()]:1==T?m.data.val=this._strings[i.getUint16()]:2==T&&(m.data.val=!!i.getByte()),1==i.getByte())try{m.data.extend=JSON.parse(this._strings[i.getUint16()])}catch(e){}r._keyFrames.push(m)}}var x=i.getUint16();for(e=0;e<x;e++){var y=new Na;y.time=a[i.getUint16()],y.eventName=this._strings[i.getUint16()];var E=[],S=i.getUint16();for(S>0&&(y.params=E=[]),t=0;t<S;t++){switch(i.getByte()){case 0:E.push(!!i.getByte());break;case 1:E.push(i.getInt32());break;case 2:E.push(a[i.getUint16()]);break;case 3:E.push(this._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(y)}}}Ua._strings=[],Ua._DATA={offset:0,size:0},Ua._BLOCK={count:0};class Ga{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class ka extends w{static _parse(e){var t=new ka,r=new P(e),i=r.readUTFString();if("LAYAANIMATION2D:01"!==i)throw"unknown animationClip version.";return Ua.parse(t,r,i),t}constructor(){super(),this._nodes=new Ga,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,r,i,s){for(var a=this._nodes,n=0,l=a.count;n<l;n++){var o,h=a.getNodeByIndex(n)._keyFrames,_=h.length;if(0!=_){var u=t[n];if(i)for(-1!=u&&e<h[u].time&&(u=-1,t[n]=u),o=u+1;o<_&&!(h[o].time>e);)u++,o++,t[n]=u;else for((o=u+1)!=_&&e>h[o].time&&(u=_-1,t[n]=u),o=u+1;u>-1&&!(h[u].time<e);)u--,o--,t[n]=u;var d=o==_;if(-1!=u){var c=h[u];if(d)s[n]=c.data.val;else{var p,f=h[o],g=f.time-c.time;p=0!==g?(e-c.time)/g:0,s[n]=this._getTweenVal(c,f,p,g)}}else s[n]=h[0].data.val;r&&"number"==typeof h[0].data.val&&(s[n]=s[n]-h[0].data.val)}}}_getTweenVal(e,t,r,i){var s=e.data,a=t.data;if("number"!=typeof s.val||"number"!=typeof a.val)return s.val;var n=ka.tween[s.tweenType],l=s.val,o=a.val;if(null!=n)return n(r,l,o-l,1);var h=0,_=0,u=NaN,d=NaN;return null!=s.tweenInfo&&(h=s.tweenInfo.outTangent,u=s.tweenInfo.outWeight),null!=a.tweenInfo&&(_=a.tweenInfo.inTangent,d=a.tweenInfo.inWeight),(isNaN(u)||0>=u)&&(u=Oa.defaultWeight),(isNaN(d)||0>=d)&&(d=Oa.defaultWeight),isNaN(h)&&(h=0),isNaN(_)&&(_=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(_)==Number.MAX_VALUE&&(_=0>_?-1/0:1/0),!s.tweenInfo&&!a.tweenInfo||Oa.defaultWeight==d&&Oa.defaultWeight==u?ka.tween.hermiteInterpolate(h,_,l,o,r,i):this.hermiteCurveSplineWeight(l,e.time,u,h,o,t.time,d,_,r)}_binarySearchEventIndex(e){for(var t,r=0,i=this._animationEvents.length-1;r<=i;){t=r+i>>1;var s=this._animationEvents[t].time;if(s==e)return t;s>e?i=t-1:r=t+1}return r}hermiteCurveSplineWeight(e,t,r,i,s,a,n,l,o){let h=222e-18,_=o,u=e,d=r,c=n,p=a-t,f=s-u;f=Math.max(Math.abs(f),h)*(f<0?-1:1);let g=i,m=l;if(!Number.isFinite(g)||!Number.isFinite(m))return e;g=g*p/f,m=m*p/f;let T=1-c,x=.5,y=0;if(Math.abs(d-.33333334)<1e-4&&Math.abs(c-.33333334)<1e-4)x=_,y=1-x;else for(;;){y=1-x;let e=3*y*y*x*d+3*y*x*x*T+x*x*x-_;if(Math.abs(e)<=2.5*h)break;let t=3*y*y*d+6*y*x*(T-d)+3*x*x*(1-T),r=6*y*(T-2*d)+6*x*(1-2*T+d);x-=(6*e*t*t-3*e*e*r)/(6*t*t*t-6*e*t*r+e*e*(18*d-18*T+6))}return(3*y*y*x*d*g+3*y*x*x*(1-c*m)+x*x*x)*f+u}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}ka.tween={Linear:function(e,t,r,i){return r*e/i+t},Quad_EaseIn:function(e,t,r,i){return r*(e/=i)*e+t},Quad_EaseOut:function(e,t,r,i){return-r*(e/=i)*(e-2)+t},Quad_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t},Cubic_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e+t},Cubic_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t},Cubic_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},Quart_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e+t},Quart_EaseOut:function(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t},Quart_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e+t:-r/2*((e-=2)*e*e*e-2)+t},Quint_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e*e+t},Quint_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t},Quint_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e*e+t:r/2*((e-=2)*e*e*e*e+2)+t},Sine_EaseIn:function(e,t,r,i){return-r*Math.cos(e/i*(Math.PI/2))+r+t},Sine_EaseOut:function(e,t,r,i){return r*Math.sin(e/i*(Math.PI/2))+t},Sine_EaseInOut:function(e,t,r,i){return-r/2*(Math.cos(Math.PI*e/i)-1)+t},Expo_EaseIn:function(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t},Expo_EaseOut:function(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t},Expo_EaseInOut:function(e,t,r,i){return 0==e?t:e==i?t+r:(e/=i/2)<1?r/2*Math.pow(2,10*(e-1))+t:r/2*(2-Math.pow(2,-10*--e))+t},Circ_EaseIn:function(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t},Circ_EaseOut:function(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t},Circ_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?-r/2*(Math.sqrt(1-e*e)-1)+t:r/2*(Math.sqrt(1-(e-=2)*e)+1)+t},Elastic_EaseIn:function(e,t,r,i,s,a){if(0==e)return t;if(1==(e/=i))return t+r;if(a||(a=.3*i),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return-s*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/a)+t},Elastic_EaseOut:function(e,t,r,i,s,a){if(0==e)return t;if(1==(e/=i))return t+r;if(a||(a=.3*i),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return s*Math.pow(2,-10*e)*Math.sin((e*i-n)*(2*Math.PI)/a)+r+t},Elastic_EaseInOut:function(e,t,r,i,s,a){if(0==e)return t;if(2==(e/=i/2))return t+r;if(a||(a=i*(.3*1.5)),!s||s<Math.abs(r)){s=r;var n=a/4}else n=a/(2*Math.PI)*Math.asin(r/s);return e<1?s*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/a)*-.5+t:s*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/a)*.5+r+t},Back_EaseIn:function(e,t,r,i,s=void 0){return null==s&&(s=1.70158),r*(e/=i)*e*((s+1)*e-s)+t},Back_EaseOut:function(e,t,r,i,s=void 0){return null==s&&(s=1.70158),r*((e=e/i-1)*e*((s+1)*e+s)+1)+t},Back_EaseInOut:function(e,t,r,i,s=void 0){return null==s&&(s=1.70158),(e/=i/2)<1?r/2*(e*e*((1+(s*=1.525))*e-s))+t:r/2*((e-=2)*e*((1+(s*=1.525))*e+s)+2)+t},Bounce_EaseIn:function(e,t,r,i){return r-ka.tween.Bounce_EaseOut(i-e,0,r,i)+t},Bounce_EaseOut:function(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t},Bounce_EaseInOut:function(e,t,r,i){return e<i/2?.5*ka.tween.Bounce_EaseIn(2*e,0,r,i)+t:.5*ka.tween.Bounce_EaseOut(2*e-i,0,r,i)+.5*r+t},hermiteInterpolate:function(e,t,r,i,s,a){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return r;var n=s*s,l=n*s;return(2*l-3*n+1)*r+(l-2*n+s)*e*a+(l-n)*t*a+(-2*l+3*n)*i}};class Va{}e.AniConditionType=void 0,(wa=e.AniConditionType||(e.AniConditionType={}))[wa.Greater=0]="Greater",wa[wa.Less=1]="Less",wa[wa.Equals=2]="Equals",wa[wa.NotEqual=3]="NotEqual";class Wa{}class Ha{static conditionNameToID(e){if(null!=Ha._conditionNameMap[e])return Ha._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}constructor(e=null){e&&(this._id=Ha.conditionNameToID(e),this._name=e)}get id(){return this._id}get name(){return this._name}set name(e){this._id=Ha.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}Ha._conditionNameMap={},Ha._propertyNameCounter=0;class Xa extends Ha{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class Ya extends Ha{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class za extends Ha{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class ja{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,r,i){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!i)return!1;if(null==this.conditions||0==this.conditions.length)return!0;for(var s=0;s<this.conditions.length;s++){let t=this.conditions[s];if(t.checkState(r[t.name].value))return t.type==e.AniStateConditionType.Trigger&&(r[t.name].value=!1),!0}return!1}}class qa extends w{constructor(e){super();let t=Pa.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let r=e.length-1;r>=0;r--){let i=e[r],s=new Ra(i.name);t.unshift(s);for(let e in i)if("name"!=e&&"states"!=e&&null!=i[e])try{s[e]=i[e]}catch(e){}this.getState(i.states,s,this.data)}return t}createState(e,r,i){if(!e)return null;let s={},a=null;for(let n=e.length-1;n>=0;n--){let l=e[n],o=l.states;if(o){let e=this.createState(o,r,i);e&&(r[l.id]=e.states[e.id]);continue}if(0>Number(l.id)){if("-1"==l.id){let e=l.soloTransitions;e&&0<e.length&&(a=e[0].id)}continue}let h=new La;r[l.id]=h,s[l.id]=h;for(let e in l)try{if("scripts"==e){let r=l[e];if(r&&Array.isArray(r))for(let e=r.length-1;e>=0;e--){let i=r[e];i&&0==i.indexOf("res://")&&(i=i.substring(6));let s=t.getClass(i);s&&h.addScript(s)}continue}if("soloTransitions"==e)continue;null!=l[e]&&(h[e]=l[e])}catch(e){}i.addState(h)}return{id:a,states:s}}getState(e,t,r){if(e){let i={};this.createState(e,i,t),this.setTransitions(e,i,t,r)}}setExitTransition(e,t,r,i,s){for(let a in e){let n=r[a];if(n){let l=n.transitions,o=n.soloTransitions,h=e[a];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=h.length-1;e>=0;e--){let t=h[e],s=new ja;s.destState=r[n.id],n.conditions&&this.addConditions(n.conditions,s,i),t.conditions&&this.addConditions(t.conditions,s,i);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(s[e]=n[e]);n.solo?o.unshift(s):l.unshift(s)}else null==s[a]&&(s[a]=[]),s[a].push(n)}}}}_getAnimatorTransition2D(e,t,r){let i=new ja;t[e.id]&&(i.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,i,r);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(i[t]=e[t]);return i}setTransitions(e,t,r,i,s){if(!e)return null;let a={};for(let s=e.length-1;s>=0;s--){let n=e[s];if(n.states){let e=this.setTransitions(n.states,t,r,i,n);if(e){let r=n.soloTransitions;r&&this.setExitTransition(e,r,t,i,a)}}}for(let n=e.length-1;n>=0;n--){let l=e[n];if(l.states)continue;if("-1"==l.id){if(l.soloTransitions&&0<l.soloTransitions.length){null==s?(r.defaultState=t[l.soloTransitions[0].id],r._enterTransition=this._getAnimatorTransition2D(l.soloTransitions[0],t,i)):t[s.id]=t[l.soloTransitions[0].id];continue}}else{if("-2"==l.id){let e=l.soloTransitions;if(e)for(let r=e.length-1;r>=0;r--){let s=e[r];if(t[s.id])for(let e in t){let r=t[e],a=this._getAnimatorTransition2D(s,t,i);s.solo?r.soloTransitions.unshift(a):r.transitions.unshift(a)}}continue}if("-3"==l.id)continue}let o=l.soloTransitions;if(o&&t[l.id]){let e=t[l.id].transitions,r=t[l.id].soloTransitions;for(let s=o.length-1;s>=0;s--){let n=o[s];if("-3"==n.id){null==a[l.id]&&(a[l.id]=[]),a[l.id].push(n);continue}let h=this._getAnimatorTransition2D(n,t,i);n.solo?r.unshift(h):e.unshift(h)}}}return a}addConditions(t,r,i){let s=i.animatorParams;if(null!=s&&0!=s.length)for(let i=0,a=t.length;i<a;i++){let a,n=t[i],l=null;for(let e=s.length-1;e>=0;e--)if(s[e].id==n.id){l=s[e];break}if(null==l)return;if(l.type==e.AniParmType.Bool){let e=new Ya(l.name);e.compareFlag=Boolean(n.checkValue),a=e}else if(l.type==e.AniParmType.Float){let e=new Xa(l.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,a=e}else if(l.type==e.AniParmType.Trigger){a=new za(l.name)}r.addCondition(a)}}updateTo(e){let t=e._controllerLayers;for(let e=0,r=t.length;e<r;e++)t[e].destroy();t.length=0;let r=this.getLayers();for(let t=0,i=r.length;t<i;t++)e.addControllerLayer(r[t]);let i=this.data.animatorParams;if(i){let t={};for(let e=i.length-1;e>=0;e--){let r=i[e],s=new Va;s.name=r.name,s.type=r.type,s.value=r.val,t[r.name]=s}e.parameters=t}}}class Ka extends c{_isScript(){return!0}setupScript(){let e,t=this.owner;this.onTriggerEnter!=Ka.prototype.onTriggerEnter&&t.on(E.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!=Ka.prototype.onTriggerStay&&t.on(E.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!=Ka.prototype.onTriggerExit&&t.on(E.TRIGGER_EXIT,this,this.onTriggerExit),this.onCollisionEnter!=Ka.prototype.onCollisionEnter&&t.on(E.COLLISION_ENTER,this,this.onCollisionEnter),this.onCollisionStay!=Ka.prototype.onCollisionStay&&t.on(E.COLLISION_STAY,this,this.onCollisionStay),this.onCollisionExit!=Ka.prototype.onCollisionExit&&t.on(E.COLLISION_EXIT,this,this.onCollisionExit),(e=this.onJointBreak)&&t.on(E.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(E.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(E.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(E.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(E.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(E.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(E.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(E.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(E.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(E.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(E.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(E.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(E.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&n.stage.on(E.KEY_DOWN,this,e),(e=this.onKeyPress)&&n.stage.on(E.KEY_PRESS,this,e),(e=this.onKeyUp)&&n.stage.on(E.KEY_UP,this,e),t.event(E._Add_Script)}}e.TextResourceFormat=void 0,(Ia=e.TextResourceFormat||(e.TextResourceFormat={}))[Ia.Buffer=0]="Buffer",Ia[Ia.Plain=1]="Plain",Ia[Ia.JSON=2]="JSON",Ia[Ia.XML=3]="XML";class $a extends w{constructor(e,t){super(),this.data=e,this.format=t}}Ki.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then((t=>t?new $a(t,e.TextResourceFormat.Plain):null))}},Ki.TEXT),Ki.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?new $a(t,e.TextResourceFormat.Buffer):null))}},Ki.BUFFER),Ki.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((t=>t?new $a(t,e.TextResourceFormat.JSON):null))}},Ki.JSON),Ki.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then((t=>t?new $a(t,e.TextResourceFormat.XML):null))}},Ki.XML);Ki.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{if(!t)return null;let r=[];if(t.meta&&t.meta.image){let i="",s=e.url.lastIndexOf("/");-1!=s&&(i=e.url.substring(0,s+1));let a="";s=e.url.lastIndexOf("?"),-1!=s&&(a=e.url.substring(s));let n=t.meta.image.split(",");for(let t of n)r.push(e.loader.load(i+t+a,null,e.progress.createCallback()))}else r.push(e.loader.load(d.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(r).then((r=>{let i=e.options.baseUrl||"",s=t.frames,a=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],l=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(l=parseFloat(t.meta.scale));for(let e of r)e&&(e._addReference(),e.scaleRate=l);for(let t in s){let l=s[t],o=r[l.frame.idx?l.frame.idx:0];if(!o)continue;let h=i+a+(l.filename||t),_=ae.create(o,l.frame.x,l.frame.y,l.frame.w,l.frame.h,l.spriteSourceSize.x,l.spriteSourceSize.y,l.sourceSize.w,l.sourceSize.h);_.lock=!0,_._sizeGrid=l.sizeGrid,_._stateNum=l.stateNum,e.loader.cacheRes(h,_),_.url=h,n.push(_)}return new Ui(a,r,n)}))}))}},Ki.ATLAS);const Za=[];class Qa{static parse(e,r,i){i=i||Za;let s,a,n,l,o,h,_,u={},d=[],c=[],p=[];function createChildren(e,t){for(let r of e._$child)if(r._$child){let e=createNode(r,t);createChildren(r,r._$prefab?e:t),d.push(r),c.push(e)}else{let e=createNode(r,t);d.push(r),c.push(e)}}function createNode(e,r,s){let a,l;if(l=e._$override){if(r&&n)if(Array.isArray(l)){a=r;for(let e=0,t=l.length;e<t;e++){let t=n.get(a);if(a=null==t?void 0:t[l[e]],!a)break}}else{let t=n.get(r);t&&(a=t[e._$override])}}else{if(l=e._$prefab){let t=Ki.getRes(de.getResURLByUUID(l),Ki.HIERARCHY);if(t){n||(n=new Map);let r=[],s=e._$id;if(o)for(let e=0,t=o.length;e<t;e++){let i=o[e];i&&i.length>0?r[e]=i.filter((r=>{let i=r._$override||r._$parent;return Array.isArray(i)&&i.length>t-e&&i[t-e-1]==s})):r[e]=i}r.push(e._$child),a=t.create({inPrefab:!0,prefabNodeDict:n,overrideData:r},i)}}else if(l=e._$type){let e=t.getClass(s||l);if(e)try{a=new e,null==s||a instanceof Ri||(i.push(new Error(`runtime class invalid - '${s}', must derive from Node`)),a=null)}catch(e){i.push(e)}else i.push(new Error(`unknown type '${s||l}'`))}a&&(u[e._$id]=a)}return a}function findNodeInPrefab(e,t,r=0){if(!t)return e;let i=null==n?void 0:n.get(e);if(!i)return null;if(Array.isArray(t)){let e;for(let s=r,a=t.length;s<a;s++){if(!i)return null;if(e=i[t[s]],!e)break;i=n.get(e)}return e}return i[t]}if(r&&(a=r.inPrefab,a&&(n=r.prefabNodeDict),l=r.skinBaseUrl,o=r.overrideData),e._$type||e._$prefab){_=e._$runtime,_&&_.startsWith("res://")&&(_=_.substring(6));let t=createNode(e,null,_);t&&(e._$child&&createChildren(e,e._$prefab?t:null),d.push(e),c.push(t),t instanceof ea&&(s=t))}else e._$child&&createChildren(e,null);let f=d.length,g=0,m=[];for(let e=0;e<f;e++){let t=d[e],r=c[e],i=t._$child;if(i){let e=i.length;if(r)if(t._$prefab)for(let t=0;t<e;t++){let i=g-e+t,s=p[i];if(s&&!s.parent){let e=m[i],t=findNodeInPrefab(r,e._$parent);if(t){let r=e._$index;null!=r&&r<t.numChildren?t.addChildAt(s,r):t.addChild(s)}else r.addChildAt(s,0)}}else for(let t=0;t<e;t++){let i=p[g-e+t];i&&(r===s&&i._is3D?s._scene3D=i:r.addChild(i))}g-=e}p[g]=r,m[g]=t,g++}p.length=g,p=p.filter((e=>null!=e));let T=p[0],x=[];for(let e=0;e<f;e++){let r=d[e]._$comp;if(!r)continue;let s=c[e];if(s)for(let e of r){let r;if(e._$override){let i=t.getClass(e._$override);i&&(r=s.getComponent(i))}else{let a=t.getClass(e._$type);if(a&&(r=s.getComponent(a),!r))try{r=s.addComponent(a)}catch(e){i.push(e)}}r&&x.push(e,r)}}const y={outErrors:i,getNodeByRef:function(e){if(Array.isArray(e)){let t=u[e[0]];return t&&e.length>1?findNodeInPrefab(t,e,1):t}return u[e]},getNodeData:function(e){e.visible=!1;let t=c.indexOf(e),r=d[t];return o?(void 0===h&&(h=Gs.bakeOverrideData(o)),h?Gs.applyOverrideData(r,h):r):r}};for(let e=0;e<f;e++){let t=d[e],r=c[e];if(r&&(null!=l&&r instanceof Li&&(r._skinBaseUrl=l),Gs.decodeObj(t,r,y),_&&t._$var&&r.name))try{T[r.name]=r}catch(e){i.push(e)}}f=x.length;for(let e=0;e<f;e+=2)Gs.decodeObj(x[e],x[e+1],y);return a&&n&&T&&n.set(T,u),i==Za&&(Za.length=0),p}static collectResourceLinks(e,t){let r={},i=[];function addInnerUrl(e,s){if(!e)return"";let a=r[e];if(void 0===a){let n;n=e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:de.join(t,e),i.push({url:n,type:s}),r[e]=a=[n,s]}else-1==a.indexOf(s,1)&&(a.push(s),i.push({url:a[0],type:s}));return a[0]}if(function check(e){for(let t in e){let r=e[t];if(null!=r)if(Array.isArray(r))for(let e of r)null!=e&&"object"==typeof e&&(null!=e._$uuid?e._$uuid=addInnerUrl(e._$uuid,Gs.getLoadTypeByEngineType(e._$type)):null!=e._$prefab?(e._$prefab=addInnerUrl(e._$prefab,Ki.HIERARCHY),check(e)):check(e));else"object"==typeof r&&(null!=r._$uuid?r._$uuid=addInnerUrl(r._$uuid,Gs.getLoadTypeByEngineType(r._$type)):null!=r._$prefab?(r._$prefab=addInnerUrl(r._$prefab,Ki.HIERARCHY),check(r)):check(r))}}(e),e._$preloads)for(let t of e._$preloads)i.push(t);return i}}class Ja{load(e){let t=e.url;return("gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext)&&(t=ue.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then((t=>t?null!=t._$ver?this._load(Ja.v3,e,t,3):"ls"==e.ext||"lh"==e.ext?this._load(Ja.v2,e,t,2):"scene"==e.ext||"prefab"==e.ext?this._load(Ja.legacySceneOrPrefab,e,t,2):null:null))}_load(e,t,r,i){let s=de.getPath(t.url),a=e.collectResourceLinks(r,s),n=Object.assign({},t.options);return n.initiator=t,delete n.cache,delete n.ignoreCache,t.loader.load(a,n,t.progress.createCallback()).then((t=>{let s=new $s(e,r,i);return s.addDeps(t),s}))}}Ja.v3=Qa,Ja.v2=null,Ja.legacySceneOrPrefab=Zs,Ki.registerLoader(["lh","ls","scene","prefab"],Ja,Ki.HIERARCHY);class en{static _parseHDRTexture(e,t=null,r=null){let i=en.getHDRInfo(e),s=new Y(i.width,i.height,i.format,!1,!1,!1);return s.setHDRData(i),t&&(null!=t.wrapModeU&&(s.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(s.wrapModeV=t.wrapModeV),null!=t.filterMode&&(s.filterMode=t.filterMode),null!=t.anisoLevel&&(s.anisoLevel=t.anisoLevel)),s}static getHDRInfo(t){let r=new Uint8Array(t),i=0;const readLine=()=>{let e=en.getLineString(r,i);return i+=e.length+1,e};if("#?RADIANCE"!=readLine())throw"HDR image: identifier wrong.";let s=new Map,a="";do{if(a=readLine(),"#"!=a[0]){let e=a.split("=");s.set(e[0],e[1])}}while(""!=a);if("32-bit_rle_rgbe"!=s.get("FORMAT"))throw"HDR image: unsupported format.";let n=readLine().split(" "),l="-Y"==n[0],o="-X"==n[2],h=parseInt(n[1]),_=parseInt(n[3]);return new en(t,i,o,l,_,h,e.TextureFormat.R32G32B32A32)}static getLineString(e,t){let r=e.length,i=t,s="",a="";for(;i<r&&"\n"!=a;)s=`${s}${a}`,a=String.fromCharCode(e[i]),i++;return s}constructor(e,t,r,i,s,a,n){this.source=e,this.byteOffset=t,this.decreaseX=r,this.decreaseY=i,this.width=s,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let r=new Uint8Array(this.source,this.byteOffset),i=0,s=new ArrayBuffer(4*e),a=new Uint8Array(s),n=new ArrayBuffer(e*t*4*3),l=new Float32Array(n);for(let s=t;s>0;s--){r[i++],r[i++];let n=r[i++]<<8|r[i++];if(n!=e)throw"HDR info: scanlineLength wrong.";let o=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;o<t;){let e=r[i++],s=r[i++];if(e>128){let r=e-128;if(r>t-o)throw"HDR info: ??";for(;r-- >0;)a[o++]=s}else{let n=e;if(0==n||n>t-o)throw"HDR info: ??";if(a[o++]=s,--n>0)for(let e=0;e<n;e++)a[o++]=r[i++]}}}for(let e=0;e<n;e++){let r=a[e],i=a[e+n],o=a[e+2*n],h=a[e+3*n],_=(t-s)*n*3+3*e;const Ldexp=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(h>0){let e=Ldexp(1,h-136);l[_]=r*e,l[_+1]=i*e,l[_+2]=o*e}else l[_]=0,l[_+1]=0,l[_+2]=0}}return l}readScanLine(){let t=this.width,r=this.height,i=this.decreaseX,s=this.decreaseY,a=3;this.format==e.TextureFormat.R32G32B32A32&&(a=4);let n=new Float32Array(t*r*a),l=new Uint8Array(4*t),o=new Uint8Array(this.source,this.byteOffset),h=o.length,_=0;const getc=()=>{if(_>=h)throw"HDR info: data wrong.";return o[_++]},wrong=()=>{throw"HDR info: data wrong."};for(let e=r-1;e>=0;e--){this.readcolors(l,getc,wrong);for(let o=0;o<t;o++){let h=4*o,_=l[h],u=l[h+1],d=l[h+2],c=l[h+3],p=e,f=o;s&&(p=r-1-e),i&&(f=t-1-o);let g=p*t*a+f*a;if(0==c)n[g]=0,n[g+1]=0,n[g+2]=0,4==a&&(n[g+3]=1);else{let e=ldexp(1,c-136);n[g]=(_+.5)*e,n[g+1]=(u+.5)*e,n[g+2]=(d+.5)*e,4==a&&(n[g+3]=1)}}}return n}readcolors(e,t,r){const setScanLineData=(t,r,i)=>{e[4*t+r]=i};let i=this.width,s=t(),a=t(),n=t(),l=t();if(i<8||i>32767)this.olddreadcolors(e,t,s,a,n,l);else if(2!=s||2!=a||128&n)this.olddreadcolors(e,t,s,a,n,l);else{(n<<8|l)!=i&&r();for(let e=0;e<4;e++)for(let s=0;s<i;){let a=t();if(a>128){a&=127;let n=t();for(s+a>i&&r();a--;)setScanLineData(s++,e,n)}else for(s+a>i&&r();a--;){setScanLineData(s++,e,t())}}}}olddreadcolors(e,t,r,i,s,a){let n=0,l=this.width;e[0]=r,e[1]=i,e[2]=s,e[3]=a;for(let r=1;r<l;r++){let i=t(),s=t(),a=t(),l=t(),o=4*r;if(e[o]=i,e[o+1]=s,e[o+2]=a,e[o+3]=l,1==i&&1==s&&1==a){let t=o-4;for(let r=l<<n;r>0;r--)e[o]=e[t],e[o+1]=e[t+1],e[o+2]=e[t+2],e[o+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let r=0;0==t.w?e.x=e.y=e.z=0:(r=ldexp(1,t.w-136),e.x=t.x*r,e.y=t.y*r,e.z=t.z*r)}}function ldexp(e,t){return e*Math.pow(2,t)}var tn;en.HDRTEXTURE="HDRTEXTURE";class rn{constructor(){tn||(tn={"WhiteTexture.png":Y.whiteTexture,"BlackTexture.png":Y.blackTexture,"GrayTexture.png":Y.grayTexture,"NormalTexture.png":Y.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=tn[d.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=ue.inst.metaMap[e.url],t||!l.isPreview)?this.load2(e,t):ue.inst.getMeta(e.url,e.uuid).then((t=>this.load2(e,t)))}load2(r,i){var s,a,n;let l,o,h=r.ext,_=r.url;if(i){let e=bt.platform,t=(null===(s=i.platforms)||void 0===s?void 0:s[e])||0,u=(null===(a=i.files)||void 0===a?void 0:a[t])||{};u.file&&(_=ue.inst.getSubAssetURL(_,r.uuid,u.file,u.ext),h=u.ext),l=[0,0,null!==(n=u.format)&&void 0!==n?n:1,i.mipmap,i.readWrite,i.sRGB],o={wrapModeU:i.wrapMode,wrapModeV:i.wrapMode,filterMode:i.filterMode,anisoLevel:i.anisoLevel,premultiplyAlpha:!!i.pma,hdrEncodeFormat:i.hdrEncodeFormat}}else l=r.options.constructParams,o=r.options.propertyParams;let u=-1!=hn.indexOf(h)?h:null;if(null!=u)return r.loader.fetch(_,"arraybuffer",r.progress.createCallback(),r.options).then((s=>{if(!s)return null;let a;switch(u){case"dds":a=Y._parseDDS(s,o,l);break;case"ktx":let r=X.getKTXTextureInfo(s);if(r.dimension==e.TextureDimension.Cube){let e=t.getClass("TextureCube");if(!e)return null;{let t=new e(r.width,r.format,r.mipmapCount>1,r.sRGB);t.setKTXData(r),a=t}}else r.dimension==e.TextureDimension.Tex2D&&(a=Y._parseKTX(s,o,l));break;case"pvr":a=Y._parsePVR(s,o,l);break;case"hdr":a=en._parseHDRTexture(s,o,l);break;case"lanit.ls":a=Y._SimpleAnimatorTextureParse(s,o,l)}let n=r.obsoluteInst;return n&&Object.getPrototypeOf(n)==Object.getPrototypeOf(a)&&(a=this.move(n,a)),o&&o.hdrEncodeFormat&&(a.hdrEncodeFormat=o.hdrEncodeFormat),i&&(a._sizeGrid=i.sizeGrid,a._stateNum=i.stateNum),a}));{let e=r.options,t=o&&o.premultiplyAlpha?"premultiply":"none";return e.useWorkerLoader&&"none"===t&&(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:t}},e)),r.loader.fetch(_,"image",r.progress.createCallback(),e).then((r=>x.textureContext.needBitmap?r instanceof ImageBitmap?r:createImageBitmap(r,e.workerLoaderOptions||{premultiplyAlpha:t}):r)).then((e=>{if(!e)return null;let t=Y._parseImage(e,o,l),s=r.obsoluteInst;return s&&Object.getPrototypeOf(s)==Object.getPrototypeOf(t)&&(t=this.move(s,t)),i&&(t._sizeGrid=i.sizeGrid,t._stateNum=i.stateNum),t}))}}move(e,t){return e._texture=t._texture,e._format=t.format,e.width=t.width,e.height=t.height,e.obsolute=!1,delete w._idResourcesMap[t.id],e}}class sn{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=e.obsoluteInst;return r?r.recreate(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB):r=new Br(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB),null!=t.anisoLevel&&(r.anisoLevel=t.anisoLevel),null!=t.filterMode&&(r.filterMode=t.filterMode),null!=t.wrapModeU&&(r.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(r.wrapModeV=t.wrapModeV),r}))}}class an{load(e){let t=e.obsoluteInst||new Ea;return t.source=e.url,Promise.resolve(t)}}const nn={premultiplyAlpha:!0},ln=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];class on{wrapTex2D(e,t){if(!t)return null;let r=e.obsoluteInst;return r?(r.setTo(t),r.obsolute=!1,r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum,r.event("reload"),r._clipCache&&r._clipCache.forEach((e=>{e.event("reload"),e._sizeGrid=r._sizeGrid,e._stateNum=r._stateNum}))):(r=new ae(t),r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum),r}load(e){let t=e.loader.getRes(e.url,Ki.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Ki.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},nn,e.options.propertyParams)):t.propertyParams=nn,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],ln,e.options.constructParams)):t.constructParams=ln,e.loader.load(t,e.options,e.progress.createCallback()).then((t=>this.wrapTex2D(e,t)))}return Promise.resolve(this.wrapTex2D(e,t))}}const hn=["ktx","pvr","dds","hdr","lanit.ls"],_n=["mp4","webm"];Ki.registerLoader(["tga","tif","tiff","png","jpg","jpeg","rendertexture",..._n,...hn],on,Ki.IMAGE),Ki.registerLoader([],rn,Ki.TEXTURE2D),Ki.registerLoader(["rendertexture"],sn,Ki.TEXTURE2D),Ki.registerLoader(_n,an,Ki.TEXTURE2D);Ki.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?ka._parse(e):null))}});Ki.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let r=new qa(t);if(r.data&&r.data.controllerLayers){let t=r.data.controllerLayers,i=[];for(let r=t.length-1;r>=0;r--){let s=t[r].states;this.loadStates(s,i,e)}return Promise.all(i).then((()=>r))}return r}))}loadStates(e,t,r){let i=de.getPath(r.url);for(let s=e.length-1;s>=0;s--){if(e[s].clip&&e[s].clip._$uuid){let a=de.getResURLByUUID(e[s].clip._$uuid);a.startsWith("res://")||(a=de.join(i,a)),t.push(r.loader.load(a).then((t=>{e[s].clip=t})))}e[s].states&&this.loadStates(e[s].states,t,r)}}});class un{load(e){return Promise.resolve(null)}}Ki.registerLoader(["lighting"],un);Ki.registerLoader(["fnt"],class{load(e){let t=d.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then((([e,t])=>{if(!e||!t)return null;let r=new ss;return r.parseFont(e,t),r}))}},Ki.FONT);const dn="LayaTTFFont";Ki.registerLoader(["ttf","woff","woff2","otf"],class{load(e){let t=d.replaceFileExtension(d.getBaseName(e.url),"");if(l.isConch)return e.loader.fetch(e.url,"arraybuffer").then((e=>(e&&window.conch.registerFont(t,e),{family:t})));if(window.FontFace){let r=new window.FontFace(t,"url('"+de.postFormatURL(de.formatURL(e.url))+"')");return document.fonts.add(r),r.load().then((()=>r))}{let r="40px "+t,i=bt.measureText(dn,r).width,s=bt.createElement("style");return s.type="text/css",document.body.appendChild(s),s.textContent="@font-face { font-family:'"+t+"'; src:url('"+de.postFormatURL(de.formatURL(e.url))+"');}",new Promise((e=>{let checkComplete=()=>{bt.measureText(dn,r).width!=i&&complete()},complete=()=>{n.systemTimer.clear(this,checkComplete),n.systemTimer.clear(this,complete),e({family:t})};n.systemTimer.once(1e4,this,complete),n.systemTimer.loop(20,this,checkComplete)}))}}},Ki.TTF);class cn{constructor(){this.cull=cn.CULL_BACK,this.blend=cn.BLEND_DISABLE,this.srcBlend=cn.BLENDPARAM_ONE,this.dstBlend=cn.BLENDPARAM_ZERO,this.srcBlendRGB=cn.BLENDPARAM_ONE,this.dstBlendRGB=cn.BLENDPARAM_ZERO,this.srcBlendAlpha=cn.BLENDPARAM_ONE,this.dstBlendAlpha=cn.BLENDPARAM_ZERO,this.blendEquation=cn.BLENDEQUATION_ADD,this.blendEquationRGB=cn.BLENDEQUATION_ADD,this.blendEquationAlpha=cn.BLENDEQUATION_ADD,this.depthTest=cn.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=cn.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Ie(cn.STENCILOP_KEEP,cn.STENCILOP_KEEP,cn.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp)}clone(){var e=new cn;return this.cloneTo(e),e}}cn.CULL_NONE=e.CullMode.Off,cn.CULL_FRONT=e.CullMode.Front,cn.CULL_BACK=e.CullMode.Back,cn.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,cn.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,cn.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,cn.BLENDPARAM_ZERO=e.BlendFactor.Zero,cn.BLENDPARAM_ONE=e.BlendFactor.One,cn.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,cn.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,cn.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,cn.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,cn.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,cn.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,cn.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,cn.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,cn.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,cn.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,cn.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,cn.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,cn.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,cn.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,cn.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,cn.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,cn.DEPTHTEST_OFF=e.CompareFunction.Off,cn.DEPTHTEST_NEVER=e.CompareFunction.Never,cn.DEPTHTEST_LESS=e.CompareFunction.Less,cn.DEPTHTEST_EQUAL=e.CompareFunction.Equal,cn.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,cn.DEPTHTEST_GREATER=e.CompareFunction.Greater,cn.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,cn.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,cn.DEPTHTEST_ALWAYS=e.CompareFunction.Always,cn.STENCILTEST_OFF=e.CompareFunction.Off,cn.STENCILTEST_NEVER=e.CompareFunction.Never,cn.STENCILTEST_LESS=e.CompareFunction.Less,cn.STENCILTEST_EQUAL=e.CompareFunction.Equal,cn.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,cn.STENCILTEST_GREATER=e.CompareFunction.Greater,cn.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,cn.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,cn.STENCILTEST_ALWAYS=e.CompareFunction.Always,cn.STENCILOP_KEEP=e.StencilOperation.Keep,cn.STENCILOP_ZERO=e.StencilOperation.Zero,cn.STENCILOP_REPLACE=e.StencilOperation.Replace,cn.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,cn.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,cn.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,cn.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,cn.STENCILOP_INVERT=e.StencilOperation.Invert,cn.Default=new cn;class pn{constructor(e,t,r){this._mapArray=[],this._blockName=e,this._singgle=r,this._glPointerID=t}add(e){-1==this._mapArray.indexOf(e)&&this._mapArray.push(e)}splitBuffer(e){let t=this._mapArray.indexOf(e);-1!=t&&this._mapArray.splice(t,1)}}class fn extends qt{static create(e,t,r,i=!1){fn._Map.get(e)||fn._Map.set(e,new pn(e,x.renderEngine.getUBOPointer(e),i));let s=fn._Map.get(e);if(s._singgle&&s._mapArray.length>0)return null;{let a=x.renderOBJCreate.createUniformBufferObject(s._glPointerID,e,t,r,i);return s._singgle&&s.add(a),a}}static getBuffer(e,t){let r=fn._Map.get(e);return r?r._mapArray[t]:null}constructor(t,r,i,s,a){super(e.BufferTargetType.UNIFORM_BUFFER,i),this._isSingle=!1,this._glPointer=t,this.byteLength=s,this._name=r,this._isSingle=a,this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(e,t){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,e,t)}_reset(e){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this._byteLength=this.byteLength=e,this._glBuffer=x.renderEngine.createBuffer(this._bufferType,this._bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(e,t=0,r=Number.MAX_SAFE_INTEGER){if(!(r<0))if(this.bind(),!(0==t&&r==this.byteLength)){var i=new Uint8Array(e.buffer,t,r);this._glBuffer.setData(i,t)}else this._glBuffer.setDataEx(e,t,e.length)}setDataByUniformBufferData(e){this._updateDataInfo==e?(this.setData(e._buffer,4*e._updateFlag.x,4*(e._updateFlag.y-e._updateFlag.x)),e._resetUpdateFlag()):(this.setData(e._buffer,0,this.byteLength),e._resetUpdateFlag(),this._updateDataInfo=e)}setDataByByUniformBufferDataOffset(e,t){let r=e.getbyteLength(),i=e._realByte;e._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(e._buffer,t*r,i/4)}destroy(){super.destroy()}}var gn,mn;fn.UBONAME_SCENE="SceneUniformBlock",fn.UBONAME_CAMERA="CameraUniformBlock",fn.UBONAME_SPRITE3D="SpriteUniformBlock",fn.UBONAME_SHADOW="ShadowUniformBlock",fn.commonMap=["CameraUniformBlock","SceneUniformBlock","SpriteUniformBlock","ShadowUniformBlock"],fn._Map=new Map,e.MaterialRenderMode=void 0,(gn=e.MaterialRenderMode||(e.MaterialRenderMode={}))[gn.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",gn[gn.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",gn[gn.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",gn[gn.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",gn[gn.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",gn[gn.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Tn extends w{static load(e,t){n.loader.load(e,t,null,Ki.MATERIAL)}static __initDefine__(){Tn.SHADERDEFINE_ALPHATEST=dt.getDefineByName("ALPHATEST"),Tn.SHADERDEFINE_MAINTEXTURE=dt.getDefineByName("MAINTEXTURE"),Tn.SHADERDEFINE_ADDTIVEFOG=dt.getDefineByName("ADDTIVEFOG"),Tn.ALPHATESTVALUE=dt.propertyNameToID("u_AlphaTestValue"),dt.CULL=dt.propertyNameToID("s_Cull"),dt.BLEND=dt.propertyNameToID("s_Blend"),dt.BLEND_SRC=dt.propertyNameToID("s_BlendSrc"),dt.BLEND_DST=dt.propertyNameToID("s_BlendDst"),dt.BLEND_SRC_RGB=dt.propertyNameToID("s_BlendSrcRGB"),dt.BLEND_DST_RGB=dt.propertyNameToID("s_BlendDstRGB"),dt.BLEND_SRC_ALPHA=dt.propertyNameToID("s_BlendSrcAlpha"),dt.BLEND_DST_ALPHA=dt.propertyNameToID("s_BlendDstAlpha"),dt.BLEND_EQUATION=dt.propertyNameToID("s_BlendEquation"),dt.BLEND_EQUATION_RGB=dt.propertyNameToID("s_BlendEquationRGB"),dt.BLEND_EQUATION_ALPHA=dt.propertyNameToID("s_BlendEquationAlpha"),dt.DEPTH_TEST=dt.propertyNameToID("s_DepthTest"),dt.DEPTH_WRITE=dt.propertyNameToID("s_DepthWrite"),dt.STENCIL_Ref=dt.propertyNameToID("s_StencilRef"),dt.STENCIL_TEST=dt.propertyNameToID("s_StencilTest"),dt.STENCIL_WRITE=dt.propertyNameToID("s_StencilWrite"),dt.STENCIL_Op=dt.propertyNameToID("s_StencilOp")}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Tn.ALPHATESTVALUE)}set alphaTestValue(e){this._shaderValues.setNumber(Tn.ALPHATESTVALUE,e)}get alphaTest(){return this.shaderData.hasDefine(Tn.SHADERDEFINE_ALPHATEST)}set alphaTest(e){e?this._shaderValues.addDefine(Tn.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Tn.SHADERDEFINE_ALPHATEST)}addDefine(e){this._shaderValues.addDefine(e)}removeDefine(e){this._shaderValues.removeDefine(e)}setDefine(e,t){t?this._shaderValues.addDefine(e):this._shaderValues.removeDefine(e)}hasDefine(e){return this._shaderValues.hasDefine(e)}get depthWrite(){return this._shaderValues.getBool(dt.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(dt.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(dt.CULL)}set cull(e){this._shaderValues.setInt(dt.CULL,e)}get blend(){return this._shaderValues.getInt(dt.BLEND)}set blend(e){this._shaderValues.setInt(dt.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(dt.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(dt.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(dt.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(dt.BLEND_DST,e)}get blendSrcAlpha(){return this._shaderValues.getInt(dt.BLEND_SRC_ALPHA)}set blendSrcAlpha(e){this._shaderValues.setInt(dt.BLEND_SRC_ALPHA,e)}get blendSrcRGB(){return this._shaderValues.getInt(dt.BLEND_SRC_RGB)}set blendSrcRGB(e){this._shaderValues.setInt(dt.BLEND_SRC_RGB,e)}get blendDstRGB(){return this._shaderValues.getInt(dt.BLEND_DST_RGB)}set blendDstRGB(e){this._shaderValues.setInt(dt.BLEND_DST_RGB,e)}get blendDstAlpha(){return this._shaderValues.getInt(dt.BLEND_DST_ALPHA)}set blendDstAlpha(e){this._shaderValues.setInt(dt.BLEND_DST_ALPHA,e)}get blendEquation(){return this._shaderValues.getInt(dt.BLEND_EQUATION)}set blendEquation(e){this._shaderValues.setInt(dt.BLEND_EQUATION,e)}get blendEquationRGB(){return this._shaderValues.getInt(dt.BLEND_EQUATION_RGB)}set blendEquationRGB(e){this._shaderValues.setInt(dt.BLEND_EQUATION_RGB,e)}get blendEquationAlpha(){return this._shaderValues.getInt(dt.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(e){this._shaderValues.setInt(dt.BLEND_EQUATION_ALPHA,e)}get depthTest(){return this._shaderValues.getInt(dt.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(dt.DEPTH_TEST,e)}get stencilTest(){return this._shaderValues.getInt(dt.STENCIL_TEST)}set stencilTest(e){this._shaderValues.setInt(dt.STENCIL_TEST,e)}get stencilWrite(){return this._shaderValues.getBool(dt.STENCIL_WRITE)}set stencilWrite(e){this._shaderValues.setBool(dt.STENCIL_WRITE,e)}set stencilRef(e){this._shaderValues.setInt(dt.STENCIL_Ref,e)}get stencilRef(){return this._shaderValues.getInt(dt.STENCIL_Ref)}set stencilOp(e){this._shaderValues.setVector3(dt.STENCIL_Op,e)}get stencilOp(){return this._shaderValues.getVector3(dt.STENCIL_Op)}get MaterialProperty(){let e={};var t=this._shaderValues.getData();for(let r in t)e[x.renderEngine.propertyIDToName(parseInt(r))]=t[r];return e}get MaterialDefine(){let e=new Array,t=this._shaderValues._defineDatas;return dt._getNamesByDefineData(t,e),e}set materialRenderMode(t){switch(this._matRenderNode=t,t){case e.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Tn.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=cn.BLEND_DISABLE,this.depthTest=cn.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Tn.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=cn.BLEND_DISABLE,this.depthTest=cn.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Tn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=cn.BLEND_ENABLE_ALL,this.blendSrc=cn.BLENDPARAM_SRC_ALPHA,this.blendDst=cn.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=cn.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Tn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=cn.BLEND_ENABLE_ALL,this.blendSrc=cn.BLENDPARAM_SRC_ALPHA,this.blendDst=cn.BLENDPARAM_ONE,this.depthTest=cn.DEPTHTEST_LESS,this._shaderValues.addDefine(Tn.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Tn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=cn.BLEND_ENABLE_ALL,this.blendSrc=cn.BLENDPARAM_SRC_ALPHA,this.blendDst=cn.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=cn.DEPTHTEST_LESS,this._shaderValues.removeDefine(Tn.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${t}).`)}}get materialRenderMode(){return this._matRenderNode}constructor(){super(),this._shaderValues=x.renderOBJCreate.createShaderData(this),this.renderQueue=Tn.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=cn.CULL_BACK,this.blend=cn.BLEND_DISABLE,this.blendSrc=cn.BLENDPARAM_ONE,this.blendDst=cn.BLENDPARAM_ZERO,this.blendSrcRGB=cn.BLENDPARAM_ONE,this.blendDstRGB=cn.BLENDPARAM_ZERO,this.blendSrcAlpha=cn.BLENDPARAM_ONE,this.blendDstAlpha=cn.BLENDPARAM_ZERO,this.blendEquation=cn.BLENDEQUATION_ADD,this.blendEquationRGB=cn.BLENDEQUATION_ADD,this.blendEquationAlpha=cn.BLENDEQUATION_ADD,this.depthTest=cn.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=cn.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Ie(cn.STENCILOP_KEEP,cn.STENCILOP_KEEP,cn.STENCILOP_REPLACE),this.destroyedImmediately=r.destroyResourceImmediatelyDefault}_bindShaderInfo(t){let r=t.getSubShaderAt(0)._uniformBufferDataMap;if(r)for(let t of r.keys()){let i=r.get(t).clone(),s=fn.create(t,e.BufferUsage.Dynamic,i.getbyteLength(),!1);this._shaderValues.setUniformBuffer(dt.propertyNameToID(t),s),this._shaderValues._addCheckUBO(t,s,i)}}_releaseUBOData(){if(this._shaderValues.uniformBufferDatas){for(let e of this._shaderValues.uniformBufferDatas.values())e.ubo._updateDataInfo.destroy(),e.ubo.destroy(),e.ubo._updateDataInfo=null;this._shaderValues.uniformBufferDatas.clear(),this._shaderValues.uniformBuffersMap.clear()}}_disposeResource(){this._releaseUBOData(),this._shaderValues.destroy(),this._shaderValues=null}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformTypeMap}setShaderName(e){this._shader=dt.find(e),this._shader||(console.warn(`Material: unknown shader name '${e}'`),this._shader=dt.find("BLINNPHONG")),Pr._uniformBlock&&(this._releaseUBOData(),this._bindShaderInfo(this._shader));let t=this._shader.getSubShaderAt(0),r=t._uniformDefaultValue,i=t._uniformTypeMap;this.applyUniformDefaultValue(i,r)}applyUniformDefaultValue(e,t){e.forEach(((e,r)=>{if(t&&null!=t[r]){let i=t[r];this.setShaderData(r,e,i)}else this.setShaderData(r,e,ShaderDataDefaultValue(e))}))}getBoolByIndex(e){return this.shaderData.getBool(e)}setBoolByIndex(e,t){this.shaderData.setBool(e,t)}getBool(e){let t=dt.propertyNameToID(e);return this.getBoolByIndex(t)}setBool(e,t){let r=dt.propertyNameToID(e);this.setBoolByIndex(r,t)}getFloatByIndex(e){return this.shaderData.getNumber(e)}setFloatByIndex(e,t){this.shaderData.setNumber(e,t)}getFloat(e){let t=dt.propertyNameToID(e);return this.getFloatByIndex(t)}setFloat(e,t){let r=dt.propertyNameToID(e);this.setFloatByIndex(r,t)}getIntByIndex(e){return this.shaderData.getInt(e)}setIntByIndex(e,t){this.shaderData.setInt(e,t)}getInt(e){let t=dt.propertyNameToID(e);return this.getIntByIndex(t)}setInt(e,t){let r=dt.propertyNameToID(e);this.setIntByIndex(r,t)}getVector2ByIndex(e){return this.shaderData.getVector2(e)}setVector2ByIndex(e,t){this.shaderData.setVector2(e,t)}getVector2(e){let t=dt.propertyNameToID(e);return this.getVector2ByIndex(t)}setVector2(e,t){let r=dt.propertyNameToID(e);this.setVector2ByIndex(r,t)}getVector3ByIndex(e){return this.shaderData.getVector3(e)}setVector3ByIndex(e,t){this.shaderData.setVector3(e,t)}getVector3(e){let t=dt.propertyNameToID(e);return this.getVector3ByIndex(t)}setVector3(e,t){let r=dt.propertyNameToID(e);this.setVector3ByIndex(r,t)}setVector4ByIndex(e,t){this.shaderData.setVector(e,t)}getVector4ByIndex(e){return this.shaderData.getVector(e)}setVector4(e,t){let r=dt.propertyNameToID(e);this.setVector4ByIndex(r,t)}getVector4(e){let t=dt.propertyNameToID(e);return this.getVector4ByIndex(t)}getColorByIndex(e){return this.shaderData.getColor(e)}setColorByIndex(e,t){this.shaderData.setColor(e,t)}getColor(e){let t=dt.propertyNameToID(e);return this.shaderData.getColor(t)}setColor(e,t){let r=dt.propertyNameToID(e);this.setColorByIndex(r,t)}getMatrix4x4ByIndex(e){return this.shaderData.getMatrix4x4(e)}setMatrix4x4ByIndex(e,t){this.shaderData.setMatrix4x4(e,t)}getMatrix4x4(e){let t=dt.propertyNameToID(e);return this.getMatrix4x4ByIndex(t)}setMatrix4x4(e,t){let r=dt.propertyNameToID(e);this.setMatrix4x4ByIndex(r,t)}getMatrix3x3ByIndex(e){return this.shaderData.getMatrix3x3(e)}setMatrix3x3ByIndex(e,t){this.shaderData.setMatrix3x3(e,t)}getMatrix3x3(e){let t=dt.propertyNameToID(e);return this.getMatrix3x3ByIndex(t)}setMatrix3x3(e,t){let r=dt.propertyNameToID(e);this.setMatrix3x3ByIndex(r,t)}setTextureByIndex(e,t){this.shaderData.setTexture(e,t),t&&!t._texture&&t.once(E.READY,this,this.reSetTexture)}reSetTexture(e){let t=this.shaderData.getSourceIndex(e);-1!=t&&this.setTextureByIndex(t,e)}getTextureByIndex(e){return this.shaderData.getTexture(e)}setTexture(e,t){let r=dt.propertyNameToID(e);this.setTextureByIndex(r,t)}getTexture(e){let t=dt.propertyNameToID(e);return this.getTextureByIndex(t)}getBufferByIndex(e){return this.shaderData.getBuffer(e)}setBufferByIndex(e,t){this.shaderData.setBuffer(e,t)}getBuffer(e){let t=dt.propertyNameToID(e);return this.getBufferByIndex(t)}setBuffer(e,t){let r=dt.propertyNameToID(e);this.setBufferByIndex(r,t)}setShaderDataByIndex(e,t,r){this.shaderData.setShaderData(e,t,r)}setShaderData(e,t,r){let i=dt.propertyNameToID(e);this.setShaderDataByIndex(i,t,r)}getShaderData(e,t){let r=dt.propertyNameToID(e);return this.getShaderDataByIndex(r,t)}getShaderDataByIndex(e,t){return this._shaderValues.getShaderData(e,t)}cloneTo(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,t.setShaderName(this._shader._name),this._shaderValues.cloneTo(t._shaderValues)}clone(){var e=new Tn;return this.cloneTo(e),e}setShaderPropertyValue(e,t){let r=dt.propertyNameToID(e);this.shaderData.setValueData(r,t)}getShaderPropertyValue(e){return this.shaderData.getValueData(dt.propertyNameToID(e))}get _defineDatas(){return this._shaderValues._defineDatas}oldparseEndEvent(){}}Tn.RENDERQUEUE_OPAQUE=2e3,Tn.RENDERQUEUE_ALPHATEST=2450,Tn.RENDERQUEUE_TRANSPARENT=3e3;class xn{static parse(e){let t=e.props;switch(e.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let t=xn.parseLegacy(e);return t.oldparseEndEvent(),t;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${e.version}`)}let r,i=new Tn;i.setShaderName(t.type);for(let e in t)switch(e){case"type":case"name":break;case"defines":let a=t[e];for(let e=0,t=a.length;e<t;e++){let t=dt.getDefineByName(a[e]);i._shaderValues.addDefine(t)}break;case"textures":let n=t[e];for(let e=0,t=n.length;e<t;e++){let t=n[e],r=t.path;r&&i._shaderValues.setTexture(dt.propertyNameToID(t.name),Ki.getBaseTexture(r))}break;case"renderQueue":r=t[e];break;case"alphaTest":i.alphaTest=t[e];break;case"materialRenderMode":i.materialRenderMode=t[e];break;default:let l=t[e],o=dt.propertyNameToID(e);switch(o){case dt.CULL:i.cull=l;break;case dt.BLEND:i.blend=l;break;case dt.BLEND_SRC:i.blendSrc=l;break;case dt.BLEND_DST:i.blendDst=l;break;case dt.BLEND_DST_ALPHA:i.blendDstAlpha=l;break;case dt.BLEND_SRC_ALPHA:i.blendSrcAlpha=l;break;case dt.BLEND_SRC_RGB:i.blendSrcRGB=l;break;case dt.BLEND_SRC_RGB:i.blendDstRGB=l;break;case dt.DEPTH_TEST:i.depthTest=l;break;case dt.DEPTH_WRITE:i.depthWrite=!!t[e];break;case dt.STENCIL_TEST:i.stencilTest=l;break;case dt.STENCIL_Op:i.stencilOp=l;break;case dt.STENCIL_Ref:i.stencilRef=l;break;case dt.STENCIL_WRITE:i.stencilWrite=l;break;default:if(l.length){var s=l;switch(s.length){case 2:i._shaderValues.setVector2(o,new Me(s[0],s[1]));break;case 3:i._shaderValues.setVector3(o,new Ie(s[0],s[1],s[2]));break;case 4:i._shaderValues.getColor(o)?i._shaderValues.setColor(o,new Z(s[0],s[1],s[2],s[3])):i._shaderValues.setVector(o,new we(s[0],s[1],s[2],s[3]));break;case 9:let e=new Oe;e.elements=new Float32Array(s),i._shaderValues.setMatrix3x3(o,e);break;case 16:let t=new qe;t.elements=new Float32Array(s),i._shaderValues.setMatrix4x4(o,t);break;default:i._shaderValues.setBuffer(o,s)}}else i._shaderValues.setNumber(o,t[e])}}return null!=r&&(i.renderQueue=r),i}static collectLinks(e,t){var r;let i=[],s=null===(r=e.props)||void 0===r?void 0:r.textures;if(s)for(let e=0,r=s.length;e<r;e++){let r=s[e],a=r.path;a&&(r.path=de.join(t,a),i.push({url:r.path,type:Ki.TEXTURE2D,constructParams:r.constructParams,propertyParams:r.propertyParams}))}return i}static parseLegacy(e){let r,i=e,s=i.props,a=s.type,n=t.getClass(a);switch(!n&&a&&a.startsWith("Laya.")&&(n=t.getClass(a.substring(5))),n?r=new n:(r=new Tn,r.setShaderName(a)),i.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let e in s)switch(e){case"type":break;case"vectors":let t=s[e];for(let e=0,i=t.length;e<i;e++){let i=t[e],s=i.value;switch(s.length){case 2:r[i.name]=new Me(s[0],s[1]);break;case 3:r[i.name]instanceof Z?r[i.name]=new Z(s[0],s[1],s[2],1):r[i.name]=new Ie(s[0],s[1],s[2]);break;case 4:r[i.name]instanceof Z?r[i.name]=new Z(s[0],s[1],s[2],s[3]):r[i.name]=new we(s[0],s[1],s[2],s[3]);break;default:throw new Error("unkonwn material color length: "+s.length)}}break;case"colors":let i=s[e];for(let e=0,t=i.length;e<t;e++){let t=i[e],s=t.value;r[t.name]=new Z(s[0],s[1],s[2],s[3])}break;case"textures":let a=s[e];for(let e=0,t=a.length;e<t;e++){let t=a[e],i=t.path;i&&(r[t.name]=Ki.getBaseTexture(i))}break;case"defines":let n=s[e];for(let e=0,t=n.length;e<t;e++){let t=dt.getDefineByName(n[e]);r._shaderValues.addDefine(t)}break;case"renderStates":let l=s[e][0];r.blend=l.blend,r.cull=this._getRenderStateParams(l.cull),r.depthTest=this._getRenderStateParams(l.depthTest),r.depthWrite=l.depthWrite,r.blendSrc=this._getRenderStateParams(l.srcBlend),r.blendDst=this._getRenderStateParams(l.dstBlend);break;case"cull":r.cull=this._getRenderStateParams(s[e]);break;case"blend":r.blend=this._getRenderStateParams(s[e]);break;case"depthWrite":r.depthWrite=!!s[e];break;case"srcBlend":case"blendSrc":r.blendSrc=this._getRenderStateParams(s[e]);break;case"dstBlend":case"blendDst":r.blendDst=this._getRenderStateParams(s[e]);break;case"depthTest":r.depthTest=this._getRenderStateParams(s[e]);break;default:r[e]=s[e]}break;case"LAYAMATERIAL:03":for(let e in s)switch(e){case"type":case"name":break;case"defines":let t=s[e];for(let e=0,i=t.length;e<i;e++){let i=dt.getDefineByName(t[e]);r._shaderValues.addDefine(i)}break;case"textures":let i=s[e];for(let e=0,t=i.length;e<t;e++){let t=i[e],s=t.path;s&&r._shaderValues.setTexture(dt.propertyNameToID(t.name),Ki.getBaseTexture(s))}break;case"renderQueue":r.renderQueue=s[e];break;default:let a=s[e],n=dt.propertyNameToID(e);switch(n){case dt.CULL:r.cull=this._getRenderStateParams(a);break;case dt.BLEND:r.blend=this._getRenderStateParams(a);break;case dt.BLEND_SRC:r.blendSrc=this._getRenderStateParams(a);break;case dt.BLEND_DST:r.blendDst=this._getRenderStateParams(a);break;case dt.DEPTH_TEST:r.depthTest=this._getRenderStateParams(a);break;case dt.DEPTH_WRITE:r.depthWrite=!!s[e];break;default:if(a.length){var l=a;switch(l.length){case 2:r._shaderValues.setVector2(n,new Me(l[0],l[1]));break;case 3:r._shaderValues.setVector3(n,new Ie(l[0],l[1],l[2]));break;case 4:r._shaderValues.getColor(n)?r._shaderValues.setColor(n,new Z(l[0],l[1],l[2],l[3])):r._shaderValues.setVector(n,new we(l[0],l[1],l[2],l[3]));break;default:throw new Error("unkonwn material color length: "+l.length)}}else r._shaderValues.setNumber(n,s[e])}}break;default:throw new Error("unkonwn material version: "+i.version)}return r}static _getRenderStateParams(t){switch(t){case 768:return e.BlendFactor.SourceColor;case 769:return e.BlendFactor.OneMinusSourceColor;case 774:return e.BlendFactor.DestinationColor;case 775:return e.BlendFactor.OneMinusDestinationColor;case 770:return e.BlendFactor.SourceAlpha;case 771:return e.BlendFactor.OneMinusSourceAlpha;case 772:return e.BlendFactor.DestinationAlpha;case 773:return e.BlendFactor.OneMinusDestinationAlpha;case 776:return e.BlendFactor.SourceAlphaSaturate;case 32774:return e.BlendEquationSeparate.ADD;case 32778:return e.BlendEquationSeparate.SUBTRACT;case 32779:return e.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return e.CompareFunction.Never;case 513:return e.CompareFunction.Less;case 514:return e.CompareFunction.Equal;case 515:return e.CompareFunction.LessEqual;case 516:return e.CompareFunction.Greater;case 517:return e.CompareFunction.NotEqual;case 518:return e.CompareFunction.GreaterEqual;case 519:return e.CompareFunction.Always;default:return t}}}class yn{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.3),e.options).then((t=>{if(!t)return null;let r=de.getPath(e.url),i=xn.collectLinks(t,r);if("LAYAMATERIAL:04"===t.version){let s=t.props.type;if(!dt.find(s)){let a=ue.inst.shaderName_to_URL(s);if(!a)return ue.inst.shaderName_to_URL_async(s).then((a=>(a?i.push(a):t.props.shaderPath?i.push(de.join(r,t.props.shaderPath)):Ki.warn(`unknown shaderName: ${s}`),this.load2(e,t,i))));i.push(a)}}return this.load2(e,t,i)}))}load2(e,t,r){if(0==r.length){let r=xn.parse(t),i=e.obsoluteInst;return i&&(r=this.move(i,r)),Promise.resolve(r)}let i=Object.assign({},e.options);return i.initiator=e,delete i.cache,delete i.ignoreCache,e.loader.load(r,i,e.progress.createCallback()).then((()=>{let r=xn.parse(t),i=e.obsoluteInst;return e.obsoluteInst&&(r=this.move(i,r)),r}))}move(e,t){return e._shaderValues.reset(),e.setShaderName(t._shader.name),t._shaderValues.cloneTo(e._shaderValues),e.renderQueue=t.renderQueue,e.materialRenderMode=t.materialRenderMode,e.obsolute=!1,t.destroy(),e}}Ki.registerLoader(["lmat"],yn,Ki.MATERIAL);class En{static parse(e){return this.parseStart(e)}static findIndex(e,t,r,i){var s=e.indexOf(r,t+1);return 0>s&&(s=i),{str:e.substring(t+1,s),i:s}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var e=this.currArr.pop();if(this.cobj.k)if(Array.isArray(e.val)){if(null!=this.cobj.k){var t={};t[this.cobj.k]=this.cobj.val,e.val.push(t)}}else e.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(e.val)?e.val.push(this.cobj.val):e.val=this.cobj.val);return e}static formatVal(e){if(null==e)return null;var t=Number(e);return isNaN(t)?"false"!=e.toLowerCase()&&("true"==e.toLowerCase()||("null"==e?null:e)):t}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(e){this.len=e.length;var t=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;t<this.len;){var r=e.charAt(t);if("/"==r){if(t+1<this.len){t+=1;var i=e.charAt(t),s=null;if("/"==i?s="\n":"*"==i&&(s="*/"),null!=s){this.finCurrStr();var a=e.indexOf(s,t);0>a?(console.log("没有找到注释结尾，应该是一直注释到最后了"),t=this.len):t=a+s.length-1}}}else if("}"==r)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==r)this.currStr="",this.type=1;else if("'"==r||'"'==r||"‘"==r||"“"==r){"‘"==r?r="’":"“"==r&&(r="”");var n=this.findIndex(e,t,r,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),t=n.i}else if(";"==r||","==r||"\n"==r)this.finCurrStr();else if("]"==r)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==r)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==r){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var l=this.cobj;this.cobj={val:{}},l.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=r);t++}return this.ret}}e.TextureCubeFace=void 0,(mn=e.TextureCubeFace||(e.TextureCubeFace={}))[mn.PositiveX=0]="PositiveX",mn[mn.NegativeX=1]="NegativeX",mn[mn.PositiveY=2]="PositiveY",mn[mn.NegativeY=3]="NegativeY",mn[mn.PositiveZ=4]="PositiveZ",mn[mn.NegativeZ=5]="NegativeZ";const Sn=new Uint8Array(4);class bn extends I{static get blackTexture(){return bn._blackTexture}static get grayTexture(){return bn._grayTexture}static get whiteTexture(){return bn._whiteTexture}static get errorTexture(){return bn._errorTexture}static __init__(){var t=new bn(1,e.TextureFormat.R8G8B8A8,!1),r=new bn(1,e.TextureFormat.R8G8B8A8,!1),i=new bn(1,e.TextureFormat.R8G8B8A8,!1),s=Sn;s[0]=0,s[1]=0,s[2]=0,s[3]=255,t.setPixelsData([s,s,s,s,s,s],!1,!1),t.lock=!0,s[0]=128,s[1]=128,s[2]=128,s[3]=255,r.setPixelsData([s,s,s,s,s,s],!1,!1),r.lock=!0,s[0]=255,s[1]=255,s[2]=255,s[3]=255,i.setPixelsData([s,s,s,s,s,s],!1,!1),i.lock=!0,bn._grayTexture=r,bn._blackTexture=t,bn._whiteTexture=i,bn._errorTexture=i}constructor(t,r,i=!0,s=!1,a=!1){super(t,t,r),this._dimension=e.TextureDimension.Cube,this._texture=x.textureContext.createTextureInternal(this._dimension,t,t,r,i,s,a)}setImageData(e,t,r){let i=!1,s=e.findIndex((e=>null!=e));if(-1!=s){let t=e[s];e.every((e=>null!=e&&e.width==t.width&&e.height==t.height))||(i=!0)}else i=!0;let a=this._texture;if(i){let e=Sn;x.textureContext.setCubePixelsData(a,[e,e,e,e,e,e],t,r)}else x.textureContext.setCubeImageData(a,e,t,r)}setPixelsData(e,t,r){let i=this._texture;x.textureContext.setCubePixelsData(i,e,t,r)}updateSubPixelsData(e,t,r,i,s,a,n,l,o){let h=this._texture;x.textureContext.setCubeSubPixelData(h,e,a,n,t,r,i,s,l,o)}setDDSData(e){let t=this._texture;x.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;x.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return bn.grayTexture}}const vn=["GLSL Start","GLSL End"],Rn=["#defineGLSL","#endGLSL"],An=["Shader3D Start","Shader3D End"],Cn={Color:e.ShaderDataType.Color,Int:e.ShaderDataType.Int,Bool:e.ShaderDataType.Bool,Float:e.ShaderDataType.Float,Vector2:e.ShaderDataType.Vector2,Vector3:e.ShaderDataType.Vector3,Vector4:e.ShaderDataType.Vector4,Matrix4x4:e.ShaderDataType.Matrix4x4,Matrix3x3:e.ShaderDataType.Matrix3x3,Texture2D:e.ShaderDataType.Texture2D,TextureCube:e.ShaderDataType.TextureCube,Texture2DArray:e.ShaderDataType.Texture2DArray,Texture3D:e.ShaderDataType.Texture3D};class Dn{static parse(e,t){let r=Dn.getShaderBlock(e),i=Dn.getCGBlock(e);return Dn.bindCG(r,i),dt.parse(r,t)}static compileToTree(e,t,r){if(r==e.length)return[t];let i=e[r],s=t.split(i);if(1==s.length)return s;let a=[];for(let t=0,n=s.length;t<n;t++)a=a.concat(Dn.compileToTree(e,s[t],r+1)),t!=n-1&&a.push(i);return a}static getMapKey(e){let t=e.indexOf("\n");return e=(e=(e=e.slice(0,t).replace("\r","")).slice(0,t).replace(" ","")).trim()}static getShaderBlock(e){let t=null;try{let r=e.indexOf(An[0]);if(-1==r)throw new Error(`no '${An[0]}' tag`);let i=e.indexOf(An[1]);if(-1==i)throw new Error(`no '${An[1]}' tag`);let s=e.substring(r+An[0].length,i);t=En.parse(s)}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static getCGBlock(e){let t={};try{let r=e.indexOf(vn[0]);if(-1==r)throw new Error(`no '${An[0]}' tag`);let i=e.indexOf(vn[1]);if(-1==i)throw new Error(`no '${An[1]}' tag`);let s=e.substring(r,i),a=Dn.compileToTree(Rn,s,0);for(let e=0,r=a.length;e<r;e++){if(a[e]==Rn[0]){e+=1;let r=a[e];t[Dn.getMapKey(r)]=r.slice(r.indexOf("\n"),r.length-1)}}}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static bindCG(e,t){let r=e.shaderPass;r&&r.forEach((e=>{e.VS&&(e.VS=t[e.VS]),e.FS&&(e.FS=t[e.FS])}));let i=e.attributeMap;if(i){let t=0;for(let r in i)if(i[r]instanceof Array){let t=i[r],s=Dn.getShaderDataType(t[0]);if(null==s){console.warn(`${e.name}: unkown attribute type '${t[0]}'`);continue}i[r]=[t[1],s]}else{let s=Dn.getShaderDataType(i[r]);if(null==s){console.warn(`${e.name}: unkown attribute type '${i[r]}'`);continue}i[r]=[t,s],t++}}let s=e.uniformMap;if(s){let t={};e.defaultValue=t;let r={};e.uniformMap=r;for(let i in s){let a=s[i];if(!1===a.serializable)continue;let n=Dn.getShaderDataType(a.type);if(null!=n)if(null!=a.default&&(t[i]=Dn.getDefaultData(n,a.default)),a.block){let e=r[a.block];e||(r[a.block]=e={}),e[i]=n}else r[i]=n;else console.warn(`${e.name}: unkown uniform type '${a.type}'`)}}}static getShaderDataType(e){return Cn[e]}static getDefaultData(t,r){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Bool:return r;case e.ShaderDataType.Vector2:return new Me(r[0],r[1]);case e.ShaderDataType.Vector3:return new Ie(r[0],r[1],r[2]);case e.ShaderDataType.Vector4:return new we(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Color:return new Z(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Matrix4x4:let t=new qe;return t.cloneByArray(r),t;case e.ShaderDataType.Matrix3x3:let i=new Oe;return i.cloneByArray(r),i;case e.ShaderDataType.Texture2D:let s=null;return"white"==r?s=Y.whiteTexture:"black"==r?s=Y.blackTexture:"gray"==r?s=Y.grayTexture:"normal"==r&&(s=Y.normalTexture),s;case e.ShaderDataType.TextureCube:let a=bn.grayTexture;return"white"==r?a=bn.whiteTexture:"black"==r?a=bn.blackTexture:"gray"==r&&(a=bn.grayTexture),a}}}Ki.registerLoader(["shader","bps"],class{load(e){let t=e.url;return"bps"===e.ext&&(t=ue.inst.getSubAssetURL(t,e.uuid,"0","shader")),e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=Dn.getShaderBlock(t),i=Dn.getCGBlock(t);if(Dn.bindCG(r,i),!r.name||!r.uniformMap)return null;let s=de.getPath(e.url),a=r.shaderPass;return Promise.all(a.map((e=>be.compileAsync(e.VS,e.FS,s)))).then((t=>{var i;if(-1!=t.findIndex((e=>null==e)))return Ki.warn("some pass null "+e.url),null;let s=dt.add(r.name,r.enableInstancing,r.supportReflectionProbe);s._surportVolumetricGI=r.surportVolumetricGI;let n=new ut(r.attributeMap?r.attributeMap:ut.DefaultAttributeMap,r.uniformMap,r.defaultValue);s.addSubShader(n);for(let e in a){let r=n._addShaderPass(t[e],a[e].pipeline);r.statefirst=null!==(i=a[e].statefirst)&&void 0!==i&&i,be.getRenderState(a[e].renderState,r.renderState)}return s}))}))}});Ki.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?Ta.ctx.decodeAudioData(e):null))}},Ki.SOUND);let Mn=t.regClass;Mn("Record",Object),Mn("Node",Ri),Mn("Sprite",Li),Mn("Widget",Vs),Mn("Text",gs),Mn("Input",ks),Mn("AnimationBase",Fi),Mn("Animation",is),Mn("FrameAnimation",es),Mn("EffectAnimation",as),Mn("SoundNode",ya),Mn("VideoNode",ba),Mn("Scene",ea),Mn("Stage",oa),Mn("Component",c),Mn("Script",Ka),Mn("BitmapFont",ss),Mn("BlurFilter",ua),Mn("ColorFilter",Nt),Mn("GlowFilter",ca),Mn("Point",f),Mn("Rectangle",g),Mn("Texture",ae),Mn("Texture2D",Y),Mn("Prefab",zs),Mn("Animator2D",Ba),Mn("AnimatorControllerLayer2D",Ra),Mn("AnimatorState2D",La),Mn("AnimationClip2D",ka),Mn("AnimatorController2D",qa),Mn("Animation2DParm",Va),Mn("Animation2DCondition",Wa),Mn("Vector2",Me),Mn("Vector3",Ie),Mn("Vector4",we),Mn("Quaternion",We),Mn("Color",Z),Mn("Matrix",p),Mn("Matrix3x3",Oe),Mn("Matrix4x4",qe);class wn{static __init__(){return wn._baseClass||(wn._baseClass=In,In.init()),wn.items=wn._baseClass.items,wn.support=wn._baseClass.support,wn.support}static setItem(e,t){wn._baseClass.setItem(e,t)}static getItem(e){return wn._baseClass.getItem(e)}static setJSON(e,t){wn._baseClass.setJSON(e,t)}static getJSON(e){return wn._baseClass.getJSON(e)}static removeItem(e){wn._baseClass.removeItem(e)}static clear(){wn._baseClass.clear()}}wn.support=!1;class In{static init(){try{In.support=!0,In.items=window.localStorage,In.setItem("laya","1"),In.removeItem("laya")}catch(e){In.support=!1}In.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(e,t){try{In.support&&In.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}static getItem(e){return In.support?In.items.getItem(e):null}static setJSON(e,t){try{In.support&&In.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}static getJSON(e){try{return JSON.parse(In.support?In.items.getItem(e):null)}catch(t){return In.items.getItem(e)}}static removeItem(e){In.support&&In.items.removeItem(e)}static clear(){In.support&&In.items.clear()}}In.support=!1;class Pn extends Dt{constructor(){super(e.RenderSpriteData.Primitive),this._defaultShader=dt.find("Sprite2DPrimitive")}}class Bn extends Dt{get blurInfo(){return this.defines.getVector2(ct.UNIFORM_BLURINFO)}set blurInfo(e){this.defines.setVector2(ct.UNIFORM_BLURINFO,e)}get u_blurInfo1(){return this.defines.getVector(ct.UNIFORM_BLURINFO1)}set u_blurInfo1(e){this.defines.setVector(ct.UNIFORM_BLURINFO1,e)}get u_blurInfo2(){return this.defines.getVector(ct.UNIFORM_BLURINFO2)}set u_blurInfo2(e){this.defines.setVector(ct.UNIFORM_BLURINFO2,e)}get u_TexRange(){return this.defines.getVector(ct.UNIFORM_TEXRANGE)}set u_TexRange(e){this.defines.setVector(ct.UNIFORM_TEXRANGE,e)}get colorMat(){return this.defines.getMatrix4x4(ct.UNIFORM_COLORMAT)}set colorMat(e){this.defines.setMatrix4x4(ct.UNIFORM_COLORMAT,e)}get colorAlpha(){return this.defines.getVector(ct.UNIFORM_COLORALPHA)}set colorAlpha(e){this.defines.setVector(ct.UNIFORM_COLORALPHA,e)}get strength_sig2_2sig2_gauss1(){return this.defines.getVector(ct.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(e){this.defines.setVector(ct.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,e)}constructor(){super(e.RenderSpriteData.Texture2D),this.strength=0,this._blurInfo=new Me,this._u_blurInfo1=new we,this._u_blurInfo2=new we,this._u_TexRange=new we,this._colorMat=new qe,this._colorAlpha=new we,this._strength_sig2_2sig2_gauss1=new we,this._defaultShader=dt.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}clear(){this.texture=null,this.defines._defineDatas.clear()}}class Ln{static set cursor(e){Ln._style.cursor=e}static get cursor(){return Ln._style.cursor}static __init__(){Ln._style=bt.document.body.style}static hide(){"none"!=Ln.cursor&&(Ln._preCursor=Ln.cursor,Ln.cursor="none")}static show(){"none"==Ln.cursor&&(Ln._preCursor?Ln.cursor=Ln._preCursor:Ln.cursor="auto")}}class Fn extends er{static __init__(){const t=x.renderEngine.getParams(e.RenderParams.FLOAT);Fn._fixattriInfo=[t,4,0,t,3,16,t,3,28,t,4,40,t,4,56,t,3,72,t,2,84,t,4,92,t,1,108,t,1,112]}constructor(e){super(Fn.const_stride,4*e*Fn.const_stride,4),this.canReuse=!0,this.setAttributes(Fn._fixattriInfo),this.createQuadIB(e),this._quadNum=e,Fn.vertexDeclaration||(Fn.vertexDeclaration=new ht(116,[new lt(0,ot.Vector4,0),new lt(16,ot.Vector3,1),new lt(28,ot.Vector3,2),new lt(40,ot.Vector4,3),new lt(56,ot.Vector4,4),new lt(72,ot.Vector3,5),new lt(84,ot.Vector2,6),new lt(92,ot.Vector4,7),new lt(108,ot.Single,8),new lt(112,ot.Single,9)])),this._vb.vertexDeclaration=Fn.vertexDeclaration}setMaxParticleNum(e){this._vb.buffer2D._resizeBuffer(4*e*Fn.const_stride,!1),this.createQuadIB(e)}static getAMesh(e){if(Fn._POOL.length){var t=Fn._POOL.pop();return t.setMaxParticleNum(e),t}return new Fn(e)}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,Fn._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._vb.deleteBuffer()}}Fn.const_stride=116,Fn._POOL=[],Fn.vertexDeclaration=null;class On{static init(...t){if(On._inited)return Promise.resolve();if(On._inited=!0,!aa.enable())throw new Error("Must support webGL!");let r;r="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],bt.__init__(),de.__init__();let i=window.Laya3D;i&&(na.changeWebGLSize=i._changeWebGLSize,Ls.is3DMode=!0);let s=bt.mainCanvas=new Ur(!0);On._setStyleInfo(s),bt.onKGMiniGame||bt.onAlipayMiniGame||bt.onTBMiniGame||bt.container.appendChild(s.source),bt.canvas=new Ur(!0),bt.context=bt.canvas.getContext("2d"),bt.supportWebAudio=xa.__init__(),bt.supportLocalStorage=wn.__init__(),e.systemTimer=new ta(!1),e.physicsTimer=new ta(!1),e.timer=new ta(!1),e.loader=new Ki,On.systemTimer=ta.gSysTimer=e.systemTimer,On.timer=e.timer,On.physicsTimer=e.physicsTimer,On.loader=e.loader,n.systemTimer=e.systemTimer,n.physicsTimer=e.physicsTimer,n.timer=e.timer,n.loader=e.loader,Ys.__init__(),Ln.__init__(),l.isConch&&On.enableNative(),xi.beginCheck();let a=[];l.beforeInit&&a.push((()=>l.beforeInit(r))),a.push((()=>Promise.all(On._beforeInitCallbacks.map((e=>e(r)))))),a.push((()=>x.renderOBJCreate.createEngine(null,bt.mainCanvas))),a.push((()=>On.initRender2D(r))),i&&a.push((()=>i.__init__())),a.push((()=>Promise.all(On._initCallbacks.map((e=>e()))))),a.push((()=>Promise.all(On._afterInitCallbacks.map((e=>e()))))),l.afterInit&&a.push((()=>l.afterInit()));let o=Promise.resolve();for(let e of a)o=o.then(e);return o}static _setStyleInfo(e){let t=e.source.style;t.position="absolute",t.top=t.left="0px",t.background="#000000"}static initRender2D(t){e.stage=window.stage=n.stage=On.stage=new oa,dt.init(),tr.__int__(),ir.__init__(),rr.__init__(),On.render=On.createRender(),e.render=On.render,e.stage.size(t.designWidth,t.designHeight),t.scaleMode&&(e.stage.scaleMode=t.scaleMode),t.screenMode&&(e.stage.screenMode=t.screenMode),t.alignV&&(e.stage.alignV=t.alignV),t.alignH&&(e.stage.alignH=t.alignH),r.isAlpha?e.stage.bgColor=null:t.backgroundColor&&(e.stage.bgColor=t.backgroundColor),l.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(e.stage.setGlobalRepaint.bind(e.stage)),te.__init__(),Fn.__init__(),or.__init__(),Tn.__initDefine__(),Is.__init__(e.stage,Ls.canvas),window.conch&&"conchUseWXAdapter"in bt.window&&(ks.isAppUseNewInput=!0),ks.__init__(),xa.autoStopMusic=!0,Dt._initone(e.RenderSpriteData.Texture2D,Bn),Dt._initone(e.RenderSpriteData.Primitive,Pn)}static createRender(){return new Ls(0,0,bt.mainCanvas)}static alertGlobalError(e){var t=0;bt.window.onerror=e?function(e,r,i,s,a){t++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+a.stack)}:null}static _runScript(e){return bt.window[On._evcode](e)}static enableDebugPanel(e="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var t=bt.createElement("script");t.onload=function(){window.Laya.DebugPanel.enable()},t.src=e,bt.document.body.appendChild(t)}}static enableNative(){On.isNativeRender_enable||(On.isNativeRender_enable=!0,j.width=bt.window.innerWidth,j.height=bt.window.innerHeight,oa.clear=function(t){Or.set2DRenderConfig();var r=Bt.create(t).arrColor;x.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,new Z(r[0],r[1],r[2],r[3]),1),j.clear()},Li.drawToCanvas=function(e,t,r,i,s,a){s-=e.x,a-=e.y,s|=0,a|=0,r|=0,i|=0;var n=new Ur(!1),l=n.getContext("2d");return n.size(r,i),l.asBitmap=!0,l._targets.start(),or.renders[t]._fun(e,l,s,a),l.flush(),l._targets.end(),l._targets.restore(),n},Object.defineProperty(J.prototype,"uv",{get:function(){return this._uv},set:function(e){this._uv=e}}),Ur.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=J.flipyuv,this._texture.bitmap=this._texture),this._texture})}static addInitCallback(e){On._initCallbacks.push(e)}static addBeforeInitCallback(e){On._beforeInitCallbacks.push(e)}static addAfterInitCallback(e){On._afterInitCallbacks.push(e)}}On.stage=null,On.systemTimer=null,On.physicsTimer=null,On.timer=null,On.loader=null,On._inited=!1,On._initCallbacks=[],On._beforeInitCallbacks=[],On._afterInitCallbacks=[],On._evcode="eval",On.isNativeRender_enable=!1,n.Laya=On,n.Loader=Ki,n.Context=Or,n.Browser=bt;var Nn=On.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0,e.render=void 0;var Un,Gn,kn,Vn,Wn,Hn=On.alertGlobalError,Xn=On.enableDebugPanel,Yn=On.addInitCallback,zn=On.addBeforeInitCallback,jn=On.addAfterInitCallback;class qn{static create(e,t,r){}constructor(e){this.blendType=0}}qn._blend_All_pool={},qn._blend_seperate_pool={};class Kn{static getHash(e,t,r){return e+(t<<3)+(r<<7)}static getBlendComponent(e,t,r){let i=Kn.getHash(e,t,r);return Kn._pool[i]||(Kn._pool[i]=new Kn(e,t,r,i)),Kn._pool[i]}constructor(e,t,r,i){this._hashIndex=0,this._hashIndex=i,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=r}}Kn._pool={};class $n{constructor(e){this._idata={},this._stateName=e}hasPtrID(e){return!(null==this._idata[e])}getMap(){return this._idata}addShaderUniform(e,t,r,i=null){this._idata[e]={uniformtype:r,propertyName:t,block:i}}addShaderBlockUniform(e,t,r){this._idata[e]={propertyName:t,blockProperty:r},r.forEach((e=>{this.addShaderUniform(e.id,e.propertyName,e.uniformtype,t)}))}}class Zn{constructor(){this.cmdArray=new Map}addCMD(e,t){this.cmdArray.set(e,t)}applyCMD(){x.renderEngine.applyRenderStateCMD(this)}clear(){this.cmdArray.clear()}}class Qn extends c{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=wi.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class Jn{}Jn.NUMBER_0=48,Jn.NUMBER_1=49,Jn.NUMBER_2=50,Jn.NUMBER_3=51,Jn.NUMBER_4=52,Jn.NUMBER_5=53,Jn.NUMBER_6=54,Jn.NUMBER_7=55,Jn.NUMBER_8=56,Jn.NUMBER_9=57,Jn.A=65,Jn.B=66,Jn.C=67,Jn.D=68,Jn.E=69,Jn.F=70,Jn.G=71,Jn.H=72,Jn.I=73,Jn.J=74,Jn.K=75,Jn.L=76,Jn.M=77,Jn.N=78,Jn.O=79,Jn.P=80,Jn.Q=81,Jn.R=82,Jn.S=83,Jn.T=84,Jn.U=85,Jn.V=86,Jn.W=87,Jn.X=88,Jn.Y=89,Jn.Z=90,Jn.F1=112,Jn.F2=113,Jn.F3=114,Jn.F4=115,Jn.F5=116,Jn.F6=117,Jn.F7=118,Jn.F8=119,Jn.F9=120,Jn.F10=121,Jn.F11=122,Jn.F12=123,Jn.F13=124,Jn.F14=125,Jn.F15=126,Jn.NUMPAD=21,Jn.NUMPAD_0=96,Jn.NUMPAD_1=97,Jn.NUMPAD_2=98,Jn.NUMPAD_3=99,Jn.NUMPAD_4=100,Jn.NUMPAD_5=101,Jn.NUMPAD_6=102,Jn.NUMPAD_7=103,Jn.NUMPAD_8=104,Jn.NUMPAD_9=105,Jn.NUMPAD_ADD=107,Jn.NUMPAD_DECIMAL=110,Jn.NUMPAD_DIVIDE=111,Jn.NUMPAD_ENTER=108,Jn.NUMPAD_MULTIPLY=106,Jn.NUMPAD_SUBTRACT=109,Jn.SEMICOLON=186,Jn.EQUAL=187,Jn.COMMA=188,Jn.MINUS=189,Jn.PERIOD=190,Jn.SLASH=191,Jn.BACKQUOTE=192,Jn.LEFTBRACKET=219,Jn.BACKSLASH=220,Jn.RIGHTBRACKET=221,Jn.QUOTE=222,Jn.ALTERNATE=18,Jn.BACKSPACE=8,Jn.CAPS_LOCK=20,Jn.COMMAND=15,Jn.CONTROL=17,Jn.DELETE=46,Jn.ENTER=13,Jn.ESCAPE=27,Jn.PAGE_UP=33,Jn.PAGE_DOWN=34,Jn.END=35,Jn.HOME=36,Jn.LEFT=37,Jn.UP=38,Jn.RIGHT=39,Jn.DOWN=40,Jn.SHIFT=16,Jn.SPACE=32,Jn.TAB=9,Jn.INSERT=45;class el{}el.STANDARD=0,el.LEFT=1,el.RIGHT=2,el.NUM_PAD=3;class tl{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}}class rl{static getMCDName(e){return rl._typeToNameDic[e]}static showRenderTypeInfo(e,t=!1){if(t||!rl.showedDic[e]){if(rl.showedDic[e]=!0,!rl._rendertypeToStrDic[e]){var r,i=[];for(r=1;r<=e;)r&e&&i.push(rl.getMCDName(r&e)),r<<=1;rl._rendertypeToStrDic[e]=i.join(",")}console.log("cmd:",rl._rendertypeToStrDic[e])}}static __init__(){rl._typeToNameDic[Gt.ALPHA]="ALPHA",rl._typeToNameDic[Gt.TRANSFORM]="TRANSFORM",rl._typeToNameDic[Gt.TEXTURE]="TEXTURE",rl._typeToNameDic[Gt.GRAPHICS]="GRAPHICS",rl._typeToNameDic[Gt.ONECHILD]="ONECHILD",rl._typeToNameDic[Gt.CHILDS]="CHILDS",rl._typeToNameDic[Gt.TRANSFORM|Gt.ALPHA]="TRANSFORM|ALPHA",rl._typeToNameDic[Gt.CANVAS]="CANVAS",rl._typeToNameDic[Gt.BLEND]="BLEND",rl._typeToNameDic[Gt.FILTERS]="FILTERS",rl._typeToNameDic[Gt.MASK]="MASK",rl._typeToNameDic[Gt.CLIP]="CLIP",rl._typeToNameDic[Gt.LAYAGL3D]="LAYAGL3D"}constructor(){}render(e,t,r){rl._addType(this._renderType),rl.showRenderTypeInfo(this._renderType),or.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}_stageRender(e,t,r){rl._countStart(),rl._PreStageRender.call(n.stage,e,t,r),rl._countEnd()}static _countStart(){var e;for(e in rl._countDic)rl._countDic[e]=0}static _countEnd(){rl._i++,rl._i>60&&(rl.showCountInfo(),rl._i=0)}static _addType(e){rl._countDic[e]?rl._countDic[e]+=1:rl._countDic[e]=1}static showCountInfo(){var e;for(e in console.log("==================="),rl._countDic)console.log("count:"+rl._countDic[e]),rl.showRenderTypeInfo(e,!0)}static enableQuickTest(){rl.__init__(),Li.prototype.render=rl.prototype.render,rl._PreStageRender=oa.prototype.render,oa.prototype.render=rl.prototype._stageRender}}rl.showedDic={},rl._rendertypeToStrDic={},rl._typeToNameDic={},rl._countDic={},rl._i=0;class il extends v{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}constructor(e=null,t=0,r=null,i=null,s=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=r||P,this.protocols=i,this.endian=il.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,s)}connect(e,t,r=!1){this.connectByUrl(`${r?"wss":"ws"}://${e}:${t}`)}connectByUrl(e){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new bt.window.WebSocket(e,this.protocols):this._socket=new bt.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=e=>{this._onOpen(e)},this._socket.onmessage=e=>{this._onMessage(e)},this._socket.onclose=e=>{this._onClose(e)},this._socket.onerror=e=>{this._onError(e)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(e){}}_onOpen(e){this._connected=!0,this.event(E.OPEN,e)}_onMessage(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(E.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var r=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=r),this.event(E.MESSAGE,t)}}}_onClose(e){this._connected=!1,this.event(E.CLOSE,e)}_onError(e){this.event(E.ERROR,e)}send(e){this._socket.send(e)}flush(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(E.ERROR,e)}}}il.LITTLE_ENDIAN="littleEndian",il.BIG_ENDIAN="bigEndian",e.DrawType=void 0,(Un=e.DrawType||(e.DrawType={}))[Un.DrawArray=0]="DrawArray",Un[Un.DrawArrayInstance=1]="DrawArrayInstance",Un[Un.DrawElement=2]="DrawElement",Un[Un.DrawElementInstance=3]="DrawElementInstance",e.RenderDrawMode=void 0,(Gn=e.RenderDrawMode||(e.RenderDrawMode={}))[Gn.TRIANGLES=0]="TRIANGLES",Gn[Gn.POINTS=1]="POINTS",Gn[Gn.LINES=2]="LINES",e.RenderIndexMode=void 0,(kn=e.RenderIndexMode||(e.RenderIndexMode={}))[kn.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",kn[kn.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",kn[kn.UNSIGNED_INT=2]="UNSIGNED_INT",e.TextureCompareMode=void 0,(Vn=e.TextureCompareMode||(e.TextureCompareMode={}))[Vn.None=0]="None",Vn[Vn.LEQUAL=1]="LEQUAL",Vn[Vn.GEQUAL=2]="GEQUAL",Vn[Vn.LESS=3]="LESS",Vn[Vn.GREATER=4]="GREATER",Vn[Vn.EQUAL=5]="EQUAL",Vn[Vn.NOTEQUAL=6]="NOTEQUAL",Vn[Vn.ALWAYS=7]="ALWAYS",Vn[Vn.NEVER=8]="NEVER",e.TextureDecodeFormat=void 0,(Wn=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[Wn.Normal=0]="Normal",Wn[Wn.RGBM=1]="RGBM";class sl{static glslAttributeString(e){let t="";for(const r in e){let i=getAttributeType(e[r][1]);""!=i&&(t=`${t}attribute ${i} ${r};\n`)}return t}static glslUniformString(e,t){if(t){let t="",r="";for(const i in e)if("object"==typeof e[i]){let r=e[i];t+=`uniform ${i} {\n`;for(const e in r){let i=getAttributeType(r[e]);""!=i&&(t+=`${i} ${e};\n`)}t+="};\n"}else{let t=getAttributeType(e[i]);""!=t&&(r+=`uniform ${t} ${i};\n`)}return t+r}{let t="";for(const r in e)if("object"==typeof e[r]){let i=e[r];for(const e in i){let r=getAttributeType(i[e]);""!=r&&(t+=`uniform ${r} ${e};\n`)}}else{let i=getAttributeType(e[r]);""!=i&&(t+=`uniform ${i} ${r};\n`)}return t}}}function getAttributeType(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Matrix3x3:return"mat3";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";case e.ShaderDataType.Texture2DArray:return x.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler2DArray":"";case e.ShaderDataType.Texture3D:return x.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class al{constructor(e,t){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,this._webGLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps),this._renderShaderInstance._complete&&(this._shaderPass=t,e.is2D?this._create2D():this._create())}get complete(){return this._renderShaderInstance._complete}_webGLShaderLanguageProcess3D(t,r,i,s,a){var n,l,o=Pr.lightClusterCount,h={},_="";let u=Pr._uniformBlock,d=sl.glslAttributeString(r),c=sl.glslUniformString(i,u);x.renderEngine.isWebGL2?(t.push("GRAPHICS_API_GLES3"),n=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${d}\n${c}\n`,l=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${c}`):(n=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${d}\n${c}`,l=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define textureCubeLodEXT textureCube\n#endif\n${c}`),_+="#define MAX_LIGHT_COUNT "+Pr.maxLightCount+"\n",_+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+Pr._maxAreaLightCountPerClusterAverage+"\n",_+="#define CLUSTER_X_COUNT "+o.x+"\n",_+="#define CLUSTER_Y_COUNT "+o.y+"\n",_+="#define CLUSTER_Z_COUNT "+o.z+"\n",_+="#define MORPH_MAX_COUNT "+Pr.maxMorphTargetCount+"\n",_+="#define SHADER_CAPAILITY_LEVEL "+x.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var p=0,f=t.length;p<f;p++){var g=t[p];_+="#define "+g+"\n",h[g]=!0}var m=s.toscript(h,[]),T="";0==m[0].indexOf("#version")&&(T=m[0]+"\n",m.shift());var y=a.toscript(h,[]),E="";0==y[0].indexOf("#version")&&(E=y[0]+"\n",y.shift());let S=T+n+_+m.join("\n"),b=E+l+_+y.join("\n");this._renderShaderInstance=x.renderEngine.createShaderInstance(S,b,r)}_webGLShaderLanguageProcess2D(e,t,r,i,s){var a,n,l={},o="";x.renderEngine.isWebGL2?(a="#version 300 es\n\n                #define attribute in\n                #define varying out\n                #define textureCube texture\n                #define texture2D texture\n",n="#version 300 es\n\n                #define varying in\n                out highp vec4 pc_fragColor;\n                #define gl_FragColor pc_fragColor\n                #define gl_FragDepthEXT gl_FragDepth\n                #define texture2D texture\n                #define textureCube texture\n                #define texture2DProj textureProj\n                #define texture2DLodEXT textureLod\n                #define texture2DProjLodEXT textureProjLod\n                #define textureCubeLodEXT textureLod\n                #define texture2DGradEXT textureGrad\n                #define texture2DProjGradEXT textureProjGrad\n                #define textureCubeGradEXT textureGrad\n"):(a="",n="#ifdef GL_EXT_shader_texture_lod\n                    #extension GL_EXT_shader_texture_lod : enable\n                #endif\n                #if !defined(GL_EXT_shader_texture_lod)\n                    #define texture1DLodEXT texture1D\n                    #define texture2DLodEXT texture2D\n                    #define texture2DProjLodEXT texture2DProj\n                    #define texture3DLodEXT texture3D\n                    #define textureCubeLodEXT textureCube\n                #endif\n");for(var h=0,_=e.length;h<_;h++){var u=e[h];o+="#define "+u+"\n",l[u]=!0}var d=i.toscript(l,[]),c="";0==d[0].indexOf("#version")&&(c=d[0]+"\n",d.shift());var p=s.toscript(l,[]),f="";0==p[0].indexOf("#version")&&(f=p[0]+"\n",p.shift());let g=c+a+o+d.join("\n"),m=f+n+o+p.join("\n");this._renderShaderInstance=x.renderEngine.createShaderInstance(g,m,t)}_create(){this._sceneUniformParamsMap=new tl,this._cameraUniformParamsMap=new tl,this._spriteUniformParamsMap=new tl,this._materialUniformParamsMap=new tl;const e=x.renderOBJCreate.createGlobalUniformMap("Scene3D"),t=x.renderOBJCreate.createGlobalUniformMap("BaseCamera"),r=x.renderOBJCreate.createGlobalUniformMap("Custom");let i,s,a=this._renderShaderInstance.getUniformMap();for(i=0,s=a.length;i<s;i++){let s=a[i];e.hasPtrID(s.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(s):t.hasPtrID(s.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(s):this.hasSpritePtrID(s.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(s):r.hasPtrID(s.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[s.dataOffset]=s):this._materialUniformParamsMap.addShaderUniform(s)}}_create2D(){this._sprite2DUniformParamsMap=new tl,this._materialUniformParamsMap=new tl,this._sceneUniformParamsMap=new tl;const e=x.renderOBJCreate.createGlobalUniformMap("Sprite2D"),t=x.renderOBJCreate.createGlobalUniformMap("Sprite2DGlobal");let r,i,s=this._renderShaderInstance.getUniformMap();for(r=0,i=s.length;r<i;r++){let i=s[r];e.hasPtrID(i.dataOffset)?this._sprite2DUniformParamsMap.addShaderUniform(i):t.hasPtrID(i.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(i):this._materialUniformParamsMap.addShaderUniform(i)}}hasSpritePtrID(e){let t=this._shaderPass.nodeCommonMap;if(t){for(let r=0,i=t.length;r<i;r++)if(x.renderOBJCreate.createGlobalUniformMap(t[r]).hasPtrID(e))return!0;return!1}return!1}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,t,r){Xt.uploadUniform+=x.renderEngine.uploadUniforms(this._renderShaderInstance,e,t,r)}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var t,r,i,s,a,n,l,o,h,_,u,d,c,p,f,g,m,T,x,y,E,S,b,v,R,A,C,D,M,w,I,P,B=e.getData(),L=this._shaderPass.renderState,F=null!==(r=null!==(t=L.depthWrite)&&void 0!==t?t:B[dt.DEPTH_WRITE])&&void 0!==r?r:cn.Default.depthWrite;te.setDepthMask(F);var O=null!==(s=null!==(i=L.depthTest)&&void 0!==i?i:B[dt.DEPTH_TEST])&&void 0!==s?s:cn.Default.depthTest;O==cn.DEPTHTEST_OFF?te.setDepthTest(!1):(te.setDepthTest(!0),te.setDepthFunc(O));var N=null!==(n=null!==(a=L.stencilWrite)&&void 0!==a?a:B[dt.STENCIL_WRITE])&&void 0!==n?n:cn.Default.stencilWrite,U=null!==(o=null!==(l=L.stencilTest)&&void 0!==l?l:B[dt.STENCIL_TEST])&&void 0!==o?o:cn.Default.stencilTest;if(te.setStencilMask(N),N){var G=null!==(_=null!==(h=L.stencilOp)&&void 0!==h?h:B[dt.STENCIL_Op])&&void 0!==_?_:cn.Default.stencilOp;te.setstencilOp(G.x,G.y,G.z)}if(U==cn.STENCILTEST_OFF)te.setStencilTest(!1);else{var k=null!==(d=null!==(u=L.stencilRef)&&void 0!==u?u:B[dt.STENCIL_Ref])&&void 0!==d?d:cn.Default.stencilRef;te.setStencilTest(!0),te.setStencilFunc(U,k)}switch(null!==(p=null!==(c=L.blend)&&void 0!==c?c:B[dt.BLEND])&&void 0!==p?p:cn.Default.blend){case cn.BLEND_DISABLE:te.setBlend(!1);break;case cn.BLEND_ENABLE_ALL:var V=null!==(g=null!==(f=L.blendEquation)&&void 0!==f?f:B[dt.BLEND_EQUATION])&&void 0!==g?g:cn.Default.blendEquation,W=null!==(T=null!==(m=L.srcBlend)&&void 0!==m?m:B[dt.BLEND_SRC])&&void 0!==T?T:cn.Default.srcBlend,H=null!==(y=null!==(x=L.dstBlend)&&void 0!==x?x:B[dt.BLEND_DST])&&void 0!==y?y:cn.Default.dstBlend;te.setBlend(!0),te.setBlendEquation(V),te.setBlendFunc(W,H);break;case cn.BLEND_ENABLE_SEPERATE:var X=null!==(S=null!==(E=L.blendEquationRGB)&&void 0!==E?E:B[dt.BLEND_EQUATION_RGB])&&void 0!==S?S:cn.Default.blendEquationRGB,Y=null!==(v=null!==(b=L.blendEquationAlpha)&&void 0!==b?b:B[dt.BLEND_EQUATION_ALPHA])&&void 0!==v?v:cn.Default.blendEquationAlpha,z=null!==(A=null!==(R=L.srcBlendRGB)&&void 0!==R?R:B[dt.BLEND_SRC_RGB])&&void 0!==A?A:cn.Default.srcBlendRGB,j=null!==(D=null!==(C=L.dstBlendRGB)&&void 0!==C?C:B[dt.BLEND_DST_RGB])&&void 0!==D?D:cn.Default.dstBlendRGB,q=null!==(w=null!==(M=L.srcBlendAlpha)&&void 0!==M?M:B[dt.BLEND_SRC_ALPHA])&&void 0!==w?w:cn.Default.srcBlendAlpha,K=null!==(P=null!==(I=L.dstBlendAlpha)&&void 0!==I?I:B[dt.BLEND_DST_ALPHA])&&void 0!==P?P:cn.Default.dstBlendAlpha;te.setBlend(!0),te.setBlendEquationSeparate(X,Y),te.setBlendFuncSeperate(z,j,q,K)}}uploadRenderStateBlendDepthByMaterial(e){var t=e.getData(),r=t[dt.DEPTH_WRITE];r=null!=r?r:cn.Default.depthWrite,te.setDepthMask(r);var i=t[dt.DEPTH_TEST];(i=null!=i?i:cn.Default.depthTest)===cn.DEPTHTEST_OFF?te.setDepthTest(!1):(te.setDepthTest(!0),te.setDepthFunc(i));var s=t[dt.STENCIL_WRITE];if(s=null!=s?s:cn.Default.stencilWrite,te.setStencilMask(s),s){var a=t[dt.STENCIL_Op];a=null!=a?a:cn.Default.stencilOp,te.setstencilOp(a.x,a.y,a.z)}var n=t[dt.STENCIL_TEST];if((n=null!=n?n:cn.Default.stencilTest)==cn.STENCILTEST_OFF)te.setStencilTest(!1);else{var l=t[dt.STENCIL_Ref];l=null!=l?l:cn.Default.stencilRef,te.setStencilTest(!0),te.setStencilFunc(n,l)}var o=t[dt.BLEND];switch(o=null!=o?o:cn.Default.blend){case cn.BLEND_ENABLE_ALL:var h=t[dt.BLEND_EQUATION];h=null!=h?h:cn.Default.blendEquation;var _=t[dt.BLEND_SRC];_=null!=_?_:cn.Default.srcBlend;var u=t[dt.BLEND_DST];u=null!=u?u:cn.Default.dstBlend,te.setBlend(!0),te.setBlendEquation(h),te.setBlendFunc(_,u);break;case cn.BLEND_ENABLE_SEPERATE:var d=t[dt.BLEND_EQUATION_RGB];d=null!=d?d:cn.Default.blendEquationRGB;var c=t[dt.BLEND_EQUATION_ALPHA];c=null!=c?c:cn.Default.blendEquationAlpha;var p=t[dt.BLEND_SRC_RGB];p=null!=p?p:cn.Default.srcBlendRGB;var f=t[dt.BLEND_DST_RGB];f=null!=f?f:cn.Default.dstBlendRGB;var g=t[dt.BLEND_SRC_ALPHA];g=null!=g?g:cn.Default.srcBlendAlpha;var m=t[dt.BLEND_DST_ALPHA];m=null!=m?m:cn.Default.dstBlendAlpha,te.setBlend(!0),te.setBlendEquationSeparate(d,c),te.setBlendFuncSeperate(p,f,g,m);break;case cn.BLEND_DISABLE:default:te.setBlend(!1)}}uploadRenderStateFrontFace(t,r,i){var s,a,n=this._shaderPass.renderState,l=t.getData()[dt.CULL];switch(this._shaderPass.statefirst&&(l=null!==(s=n.cull)&&void 0!==s?s:l),l=null!=l?l:cn.Default.cull){case cn.CULL_NONE:te.setCullFace(!1),a=r!=i?e.CullMode.Front:e.CullMode.Back,te.setFrontFace(a);break;case cn.CULL_FRONT:te.setCullFace(!0),a=r==i?e.CullMode.Front:e.CullMode.Back,te.setFrontFace(a);break;case cn.CULL_BACK:default:te.setCullFace(!0),a=r!=i?e.CullMode.Front:e.CullMode.Back,te.setFrontFace(a)}}uploadCustomUniform(e,t){x.renderEngine.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,e,t)}}class nl{constructor(){this.onID=nl.pointID++,this.textureID=-1}}nl.pointID=0;class ll extends I{static get defaultTexture(){return this._defaultTexture}static __init__(){x.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new ll(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(t,r,i,s,a=!0,n=!1){super(t,r,s),this._dimension=e.TextureDimension.Tex3D,this.depth=i,this._gammaSpace=n;let l=x.textureContext;this._texture=l.createTexture3DInternal(this._dimension,t,r,i,s,a,n,!1)}setPixelsData(e){let t=this._texture;x.textureContext.setTexture3DPixelsData(t,e,this.depth,!1,!1)}setSubPixelsData(e,t,r,i,s,a,n,l,o){let h=this._texture;x.textureContext.setTexture3DSubPixelsData(h,n,l,o,e,t,r,i,s,a,!1,!1)}}class ol{static init(){if(!ol.lookup){ol.lookup=new Uint8Array(256);for(var e=0;e<ol.chars.length;e++)ol.lookup[ol.chars.charCodeAt(e)]=e}}static isBase64String(e){return ol.reg.test(e)}static encode(e){var t,r=new Uint8Array(e),i=r.length,s="";for(t=0;t<i;t+=3)s+=ol.chars[r[t]>>2],s+=ol.chars[(3&r[t])<<4|r[t+1]>>4],s+=ol.chars[(15&r[t+1])<<2|r[t+2]>>6],s+=ol.chars[63&r[t+2]];return i%3==2?s=s.substring(0,s.length-1)+"=":i%3==1&&(s=s.substring(0,s.length-2)+"=="),s}static decode(e){ol.init();var t,r,i,s,a,n=.75*e.length,l=e.length,o=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var h=new ArrayBuffer(n),_=new Uint8Array(h);for(t=0;t<l;t+=4)r=ol.lookup[e.charCodeAt(t)],i=ol.lookup[e.charCodeAt(t+1)],s=ol.lookup[e.charCodeAt(t+2)],a=ol.lookup[e.charCodeAt(t+3)],o+1>n||(_[o++]=r<<2|i>>4,o+1>n||(_[o++]=(15&i)<<4|s>>2,o+1>n||(_[o++]=(3&s)<<6|63&a)));return h}}ol.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ol.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,ol.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,ol.lookup=null,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var r=new Uint8Array(this,e,t-e),i=new Uint8Array(r.length);return i.set(r),i.buffer}),Float32Array.prototype.slice||(Float32Array.prototype.slice=function(){for(var e=this.length,t=new Float32Array(this.length),r=0;r<e;r++)t[r]=this[r];return t}),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=function(...e){var t,r,i;if(0===e.length)for(t=this.length,r=new Uint16Array(t),i=0;i<t;i++)r[i]=this[i];else if(2===e.length){var s=e[0],a=e[1];if(a>s)for(t=a-s,r=new Uint16Array(t),i=s;i<a;i++)r[i-s]=this[i];else r=new Uint16Array(0)}return r}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(){for(var e=this.length,t=new Uint8Array(this.length),r=0;r<e;r++)t[r]=this[r];return t});class hl{static enable(){hl._logdiv||(hl._logdiv=bt.createElement("div"),hl._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",bt.document.body.appendChild(hl._logdiv),hl._btn=bt.createElement("button"),hl._btn.innerText="Hide",hl._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",hl._btn.onclick=hl.toggle,bt.document.body.appendChild(hl._btn))}static toggle(){var e=hl._logdiv.style;""===e.display?(hl._btn.innerText="Show",e.display="none"):(hl._btn.innerText="Hide",e.display="")}static print(e){hl._logdiv&&(hl._count>=hl.maxCount&&hl.clear(),hl._count++,hl._logdiv.innerText+=e+"\n",hl.autoScrollToBottom&&hl._logdiv.scrollHeight-hl._logdiv.scrollTop-hl._logdiv.clientHeight<50&&(hl._logdiv.scrollTop=hl._logdiv.scrollHeight))}static clear(){hl._logdiv.innerText="",hl._count=0}}hl._count=0,hl.maxCount=50,hl.autoScrollToBottom=!0;class _l{constructor(e,t,r,i){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=e,this.color=t,this.name=r,this.scale=i}addData(e){this.datas[this.datapos]=e,this.datapos++,this.datapos%=300}}class ul extends Li{constructor(){super(),this.datas=[],this.xdata=new Array(ul.DATANUM),this.ydata=new Array(ul.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,ul.inst=this,this._renderType|=Gt.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),ul._now=performance?performance.now.bind(performance):Date.now}now(){return ul._now()}start(){this.sttm=ul._now()}end(e){var t=ul._now()-this.sttm;this.updateValue(e,t)}config(e,t){this.hud_width=e,this.hud_height=t}addDataDef(e,t,r,i){this.datas[e]=new _l(e,t,r,i)}updateValue(e,t){this.datas[e].addData(t)}v2y(e){return this._y,this.hud_height,this.gMinV,this.gMaxV,this._y+this.hud_height*(1-(e-this.gMinV)/this.gMaxV)}drawHLine(e,t,r,i){var s=this._x;this._x,this.hud_width;var a=this.v2y(t);e.fillText(i,s,a-6,null,"green",null),s+=this.textSpace,e.fillStyle=r,e.fillRect(s,a,this._x+this.hud_width,1,null)}customRender(e,t,r){var i=performance.now();ul._lastTm<=0&&(ul._lastTm=i),this.updateValue(0,i-ul._lastTm),ul._lastTm=i,e.save(),e.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),e.globalAlpha=.9,this.drawHLine(e,0,"green","    0"),this.drawHLine(e,10,"green","  10"),this.drawHLine(e,16.667,"red"," "),this.drawHLine(e,20,"green","50|20"),this.drawHLine(e,33.334,"yellow",""),this.drawHLine(e,16.667*3,"yellow",""),this.drawHLine(e,66.668,"yellow",""),this.drawHLine(e,50,"green","20|50"),this.drawHLine(e,100,"green","10|100");for(var s=0,a=this.datas.length;s<a;s++){var n=this.datas[s];if(n){var l=n.datas.length,o=(this.hud_width-this.textSpace)/l,h=n.datapos,_=this._x+this.textSpace;e.fillStyle=n.color;for(var u=l;h<u;h++){var d=this.v2y(n.datas[h]*n.scale);e.fillRect(_,d,o,this.hud_height+this._y-d,null),_+=o}for(h=0;h<n.datapos;h++)d=this.v2y(n.datas[h]*n.scale),e.fillRect(_,d,o,this.hud_height+this._y-d,null),_+=o}}e.restore()}}ul._lastTm=0,ul._now=null,ul.DATANUM=300,ul.drawTexTm=0;class dl{constructor(){this.maxCount=1e3}getCacheList(){return o.getPoolBySign(this.sign)}tryDispose(e){var t;(t=o.getPoolBySign(this.sign)).length>this.maxCount&&t.splice(this.maxCount,t.length-this.maxCount)}static addPoolCacheManager(e,t=100){var r;(r=new dl).sign=e,r.maxCount=t,xi.regCacheByFunction(r.tryDispose.bind(r),r.getCacheList.bind(r))}}class cl{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){let t=this.elements.indexOf(e);"number"!=typeof e&&-1!=t&&t<this.length||(this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++)}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}}class pl extends v{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,r,i=null,s=0){return(new pl).to(e,t,r,i,s)}static from(e,t,r,i=null,s=0){return(new pl).from(e,t,r,i,s)}to(e,t,r,i=null,s=0){return this._create(e,t,r,i,s,!0)}from(e,t,r,i=null,s=0){return this._create(e,t,r,i,s,!1)}_create(e,t,r,i,s,a){var n=o.getItemByClass("tweenData",fl);return n.isTo=a,n.type=0,n.target=e,n.duration=r,n.data=t,n.startTime=this._startTime+s,n.endTime=n.startTime+n.duration,n.ease=i,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var r=o.getItemByClass("tweenData",fl);return r.type=1,r.data=e,r.endTime=r.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=r,this._tweenDataList.push(r),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var r=this._tweenDataList.indexOf(t);r>-1&&this._tweenDataList.splice(r,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var t,r,i,s;for(var a in this._firstTweenDic)if(r=this._firstTweenDic[a])for(var n in r)n in r.diyTarget&&(r.diyTarget[n]=r[n]);for(a in this._tweenDic)(t=this._tweenDic[a]).clear(),delete this._tweenDic[a];if(this._index=0,this._gidIndex=0,this._currTime=e,this._lastTime=bt.now(),null==this._endTweenDataList||this._endTimeSort){function Compare(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=i=this._tweenDataList.concat(),i.sort(Compare)}else i=this._endTweenDataList;for(var l=0,h=i.length;l<h;l++)if(0==(s=i[l]).type){if(!(e>=s.endTime))break;this._index=Math.max(this._index,l+1);var _=s.data;if(s.isTo)for(var u in _)s.target[u]=_[u]}for(l=0,h=this._tweenDataList.length;l<h;l++)0==(s=this._tweenDataList[l]).type&&e>=s.startTime&&e<s.endTime&&(this._index=Math.max(this._index,l+1),this._gidIndex++,(t=o.getItemByClass("tween",Ii))._create(s.target,s.data,s.duration,s.ease,wi.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),t.setStartTime(this._currTime-(e-s.startTime)),t._updateEase(this._currTime),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t)}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){n.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function Compare(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var r=0,i=this._tweenDataList.length;r<i;r++){var s=this._tweenDataList[r];if(null!=s&&0==s.type){var a=s.target,l=a.$_GID||(a.$_GID=d.getGID()),o=null;for(var h in null==this._firstTweenDic[l]?((o={}).diyTarget=a,this._firstTweenDic[l]=o):o=this._firstTweenDic[l],s.data)null==o[h]&&(o[h]=a[h])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=bt.now(),n.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var e in this._tweenDic)(t=this._tweenDic[e]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var t,r=bt.now(),i=r-this._lastTime,s=this._currTime+=i*this.scale;for(e in this._lastTime=r,this._tweenDic)(t=this._tweenDic[e])._updateEase(s);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var a=this._tweenDataList[this._index];s>=a.startTime&&(this._index++,0==a.type?(this._gidIndex++,(t=o.getItemByClass("tween",Ii))._create(a.target,a.data,a.duration,a.ease,wi.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),t.setStartTime(s),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t,t._updateEase(s)):this.event(E.LABEL,a.data))}}_animComplete(e){this._tweenDic[e]&&delete this._tweenDic[e]}_complete(){this.event(E.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,r;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(e in this._tweenDic)this._tweenDic[e].clear(),delete this._tweenDic[e];for(e in this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(r=this._tweenDataList.length,t=0;t<r;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,n.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class fl{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,o.recover("tweenData",this)}}class gl{static create(e){var t=o.getItemByClass("DrawParticleCmd",gl);return t._templ=e,t}recover(){this._templ=null,o.recover("DrawParticleCmd",this)}run(e,t,r){e.drawParticle(t,r,this._templ)}get cmdID(){return gl.ID}}gl.ID="DrawParticleCmd";class ml extends $n{constructor(e,t){super(t),this._nativeObj=e}hasPtrID(e){return this._nativeObj.hasPtrID(e)}getMap(){return this._idata}addShaderUniform(e,t){this._nativeObj.addShaderUniform(e,t)}}class Tl{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}setResourceManager(){}destroy(){this._destroyed||(this._destroyed=!0)}}class xl extends Tl{constructor(e,t){super(e),this._native=t,this.needBitmap=!1}createTextureInternal(e,t,r,i,s,a){return this._native.createTextureInternal(e,t,r,i,s,a)}setTextureImageData(e,t,r,i){this._native.setTextureImageData(e,t._nativeObj.conchImgId,r,i)}setTexturePixelsData(e,t,r,i){this._native.setTexturePixelsData(e,t,r,i)}initVideoTextureData(e){this._native.initVideoTextureData(e)}setTextureSubPixelsData(e,t,r,i,s,a,n,l,o,h){this._native.setTextureSubPixelsData(e,t,r,i,s,a,n,l,o,h)}setTextureSubImageData(e,t,r,i,s,a){throw new Error("setTextureSubImageData Method not implemented.")}setTexture3DImageData(e,t,r,i,s){this._native.setTexture3DImageData(e,t.map((function(e){return e._nativeObj})),r,i,s)}setTexture3DPixlesData(e,t,r,i,s){this._native.setTexture3DPixlesData(e,t,r,i,s)}setTexture3DSubPixelsData(e,t,r,i,s,a,n,l,o,h,_,u){this._native.setTexture3DSubPixelsData(e,t,r,i,s,a,n,l,o,h,_,u)}setTextureHDRData(e,t){throw t.readScanLine(),new Error("setTextureHDRData Method not implemented.")}setTextureDDSData(e,t){this._native.setTextureKTXData(e,t)}setTextureKTXData(e,t){this._native.setTextureKTXData(e,t)}setCubeImageData(e,t,r,i){var s=[],a=t.length;for(let e=0;e<a;e++)s.push(t[e]._nativeObj);this._native.setCubeImageData(e,s,r,i)}setCubePixelsData(e,t,r,i){this._native.setCubePixelsData(e,t,r,i)}setCubeSubPixelData(e,t,r,i,s,a,n,l,o,h){this._native.setCubeSubPixelData(e,t,r,i,s,a,n,l,o,h)}setCubeDDSData(e,t){this._native.setCubeDDSData(e,t)}setCubeKTXData(e,t){this._native.setCubeKTXData(e,t)}setTextureCompareMode(e,t){return this._native.setTextureCompareMode(e,t)}bindRenderTarget(e,t=0){this._native.bindRenderTarget(e,t)}bindoutScreenTarget(){this._native.bindoutScreenTarget()}unbindRenderTarget(e){this._native.unbindRenderTarget(e)}createRenderTextureInternal(e,t,r,i,s,a){return this._native.createRenderTextureInternal(e,t,r,i,s,a)}createRenderTargetInternal(t,r,i,s,a,n,l){return this._native.createRenderTargetInternal(t,r,i,s||e.RenderTargetFormat.None,a,n,l)}createRenderTargetCubeInternal(e,t,r,i,s,a){return this._native.createRenderTargetCubeInternal(e,t,r,i,s,a)}createRenderTextureCubeInternal(e,t,r,i,s){throw new Error("createRenderTextureCubeInternal Method not implemented.")}setupRendertargetTextureAttachment(e,t){this._native.setupRendertargetTextureAttachment(e,t)}readRenderTargetPixelData(e,t,r,i,s,a){return this._native.readRenderTargetPixelData(e,t,r,i,s,a)}updateVideoTexture(e,t,r,i){this._native.updateVideoTexture(e,t._nativeObj.conchImgId,r,i)}getRenderTextureData(e,t,r,i,s){return this._native.getRenderTextureData(e,t,r,i,s)}}class yl extends xl{constructor(e,t){super(e,t)}}class El extends Tl{constructor(e){super(e),this._nativeObj=new window.conchGLRenderDrawContext(e._nativeObj)}drawElementsInstanced(e,t,r,i,s){this._nativeObj.drawElementsInstanced(e,t,r,i,s)}drawArraysInstanced(e,t,r,i){this._nativeObj.drawArraysInstanced(e,t,r,i)}drawArrays(e,t,r){this._nativeObj.drawArrays(e,t,r)}drawElements(e,t,r,i){this._nativeObj.drawElements(e,t,r,i)}drawElements2DTemp(e,t,r,i){}drawGeometryElement(e){this._nativeObj.drawGeometryElement(e._nativeObj)}}class Sl extends Zn{constructor(){super(),this._nativeObj=new window.conchRenderStateCommand}addCMD(t,r){switch(t){case e.RenderStateType.DepthTest:case e.RenderStateType.DepthMask:case e.RenderStateType.DepthFunc:case e.RenderStateType.StencilTest:case e.RenderStateType.StencilMask:case e.RenderStateType.BlendEquation:case e.RenderStateType.CullFace:case e.RenderStateType.FrontFace:this._nativeObj.addCMDInt1(t,r);break;case e.RenderStateType.StencilFunc:case e.RenderStateType.BlendFunc:case e.RenderStateType.BlendEquationSeparate:this._nativeObj.addCMDInt2(t,r[0],r[1]);break;case e.RenderStateType.StencilOp:this._nativeObj.addCMDInt3(t,r[0],r[1],r[2]);break;case e.RenderStateType.BlendType:this._nativeObj.addCMDInt1(t,r!=e.BlendType.BLEND_DISABLE?1:0);break;case e.RenderStateType.BlendFuncSeperate:this._nativeObj.addCMDInt4(t,r[0],r[1],r[2],r[3]);break;default:throw"unknow type of renderStateType"}}applyCMD(){x.renderEngine.applyRenderStateCMD(this)}clear(){this._nativeObj.clear()}}class bl{set cull(e){this._nativeObj.cull=e}get cull(){return this._nativeObj.cull}set blend(e){this._nativeObj.blend=e}get blend(){return this._nativeObj.blend}set srcBlend(e){this._nativeObj.srcBlend=e}get srcBlend(){return this._nativeObj.srcBlend}set dstBlend(e){this._nativeObj.dstBlend=e}get dstBlend(){return this._nativeObj.dstBlend}set srcBlendRGB(e){this._nativeObj.srcBlendRGB=e}get srcBlendRGB(){return this._nativeObj.srcBlendRGB}set dstBlendRGB(e){this._nativeObj.dstBlendRGB=e}get dstBlendRGB(){return this._nativeObj.dstBlendRGB}set srcBlendAlpha(e){this._nativeObj.srcBlendAlpha=e}get srcBlendAlpha(){return this._nativeObj.srcBlendAlpha}set dstBlendAlpha(e){this._nativeObj.dstBlendAlpha=e}get dstBlendAlpha(){return this._nativeObj.dstBlendAlpha}set blendEquation(e){this._nativeObj.blendEquation=e}get blendEquation(){return this._nativeObj.blendEquation}set blendEquationRGB(e){this._nativeObj.blendEquationRGB=e}get blendEquationRGB(){return this._nativeObj.blendEquationRGB}set blendEquationAlpha(e){this._nativeObj.blendEquationAlpha=e}get blendEquationAlpha(){return this._nativeObj.blendEquationAlpha}set depthTest(e){this._nativeObj.depthTest=e}get depthTest(){return this._nativeObj.depthTest}set depthWrite(e){this._nativeObj.depthWrite=e}get depthWrite(){return this._nativeObj.depthWrite}set stencilWrite(e){this._nativeObj.stencilWrite=e}get stencilWrite(){return this._nativeObj.stencilWrite}set stencilTest(e){this._nativeObj.stencilTest=e}get stencilTest(){return this._nativeObj.stencilTest}set stencilRef(e){this._nativeObj.stencilRef=e}get stencilRef(){return this._nativeObj.stencilRef}set stencilOp(e){this._nativeObj.setStencilOp(e.x,e.y,e.z)}setNull(){this._nativeObj.setNull()}constructor(){this._nativeObj=new window.conchRenderState}}var vl,Rl,Al,Cl;e.MemoryDataType=void 0,(vl=e.MemoryDataType||(e.MemoryDataType={}))[vl.ShaderData=0]="ShaderData",vl[vl.TextureData=1]="TextureData",vl[vl.VertexData=2]="VertexData",vl[vl.IndexData=3]="IndexData",vl[vl.BaseRenderData=4]="BaseRenderData";class Dl{static creatBlock(e){return new ArrayBuffer(e)}static freeMemoryBlock(e){}}class Ml{constructor(e,t){if(t){if(e>Ml._sharedBuffer.byteLength)throw new Error("NativeMemory:shared buffer not enough");this._buffer=Ml._sharedBuffer}else this._buffer=Dl.creatBlock(e);this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._f64data=new Float64Array(this._buffer),this._byteArray=new Uint8Array(this._buffer),this._byteLength=e}get float32Array(){return this._fdata}get float64Array(){return this._f64data}get uint8Array(){return this._byteArray}get int32Array(){return this._idata}destroy(){this._destroyed||(this.clear(),Dl.freeMemoryBlock(this._buffer),this._destroyed=!0)}clear(){this._idata=null,this._fdata=null,this._byteArray=null}}Ml.NativeSourceID=0,Ml._sharedBuffer=new ArrayBuffer(256);class wl extends Ml{constructor(e){super(e,!1),this._currentOffsetInByte=0}addBlockCell(e,t){e.uploadDataTOShareMemory(this,this._currentOffsetInByte)&&(this._currentOffsetInByte+=t)}check(e){return this._currentOffsetInByte+e<this._byteLength}clear(){this._currentOffsetInByte=0}}class Il{constructor(){this._dataNodeList=new cl,this._commandNums=0,this._currentBlock=new wl(Il.UploadMemorySize),this._conchUploadMemoryManager=new window.conchUploadMemoryManager}static getInstance(){return Il._instance||(Il._instance=new Il),Il._instance}_addNodeCommand(e,t){this._currentBlock.addBlockCell(e,t),this._commandNums++}static syncRenderMemory(){Il.getInstance()._serialiseData(),Il.getInstance().clear()}_serialiseData(){const e=this._dataNodeList.elements;for(let t=0;t<this._dataNodeList.length;t++){let r=e[t],i=r.getUploadMemoryLength();if(i>Il.UploadMemorySize)throw"dataSize is too large, greater than UploadMemorySize,";this._currentBlock.check(i)?(this.uploadData(),this._addNodeCommand(r,i)):this._addNodeCommand(r,i)}this.uploadData()}uploadData(){this._commandNums>0&&(this._conchUploadMemoryManager.uploadData(this._currentBlock._buffer,this._commandNums),this._commandNums=0,this._currentBlock.clear())}clear(){this._dataNodeList.length=0}}Il.UploadMemorySize=1048576,Il._instance=null,e.NativeShaderDataType=void 0,(Rl=e.NativeShaderDataType||(e.NativeShaderDataType={}))[Rl.Number32=0]="Number32",Rl[Rl.Vector2=1]="Vector2",Rl[Rl.Vector3=2]="Vector3",Rl[Rl.Vector4=3]="Vector4",Rl[Rl.Matrix4x4=4]="Matrix4x4",Rl[Rl.Number32Array=5]="Number32Array",Rl[Rl.Texture=6]="Texture",Rl[Rl.ShaderDefine=7]="ShaderDefine",Rl[Rl.UBO=8]="UBO";class Pl extends rt{constructor(t=null){super(t),this.inUploadList=!1,this.payload32bitNum=0,this._initData(),this._nativeObj=new window.conchShaderData,this._nativeObj.setApplyUBOData(this.applyUBOData.bind(this)),this.nativeObjID=this._nativeObj.nativeID,this._dataType=e.MemoryDataType.ShaderData,this.updateMap=new Map,this.updataSizeMap=new Map}getUploadMemoryLength(){return this.updataSizeMap.forEach((e=>{this.payload32bitNum+=e})),4*(this.payload32bitNum+4)}uploadDataTOShareMemory(t,r){if(!this._data)return!1;let i=t.int32Array,s=r/4;return i[s++]=e.MemoryDataType.ShaderData,i[s++]=this.nativeObjID,i[s++]=this.payload32bitNum,i[s++]=this.updateMap.size,this.updateMap.forEach(((e,r)=>{s+=e.call(this,r,t,s)})),this.clearUpload(),this.inUploadList=!1,!0}clearUpload(){this.payload32bitNum=0,this.updataSizeMap.clear(),this.updateMap.clear()}applyUBOData(){this._uniformBufferDatas&&super.applyUBOData()}compressNumber(t,r,i){return r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Number32,r.float32Array[i+2]=this._data[t],3}compressVector2(t,r,i){r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Vector2;var s=this._data[t];return r.float32Array[i+2]=s.x,r.float32Array[i+3]=s.y,4}compressVector3(t,r,i){r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Vector3;var s=this._data[t];return r.float32Array[i+2]=s.x,r.float32Array[i+3]=s.y,r.float32Array[i+4]=s.z,5}compressVector4(t,r,i){r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Vector4;var s=this._data[t];return r.float32Array[i+2]=s.x,r.float32Array[i+3]=s.y,r.float32Array[i+4]=s.z,r.float32Array[i+5]=s.w,6}compressMatrix4x4(t,r,i){r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Matrix4x4;var s=this._data[t];return r.float32Array.set(s.elements,i+2),18}compressNumberArray(t,r,i){r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Number32Array;var s=this._data[t];return r.int32Array[i+2]=s.length,r.float32Array.set(s,i+3),s.length+3}compressTexture(t,r,i){var s=this._data[t];return r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.Texture,s&&s instanceof ae?r.int32Array[i+2]=s.bitmap._texture.id:s&&s._texture?r.int32Array[i+2]=s._texture.id:r.int32Array[i+2]=Y.errorTexture._texture.id,3}compressUBO(t,r,i){var s=this._data[t];return r.int32Array[i]=t,r.int32Array[i+1]=e.NativeShaderDataType.UBO,r.int32Array[i+2]=s._conchUniformBufferObject.nativeID,3}configMotionProperty(e,t,r){this.updateMap.set(e,r),this.updataSizeMap.set(e,t),this.inUploadList||(this.inUploadList=!0,Il.getInstance()._dataNodeList.add(this))}setBool(e,t){super.setBool(e,t),this.configMotionProperty(e,3,this.compressNumber)}setInt(e,t){super.setInt(e,t),this.configMotionProperty(e,3,this.compressNumber)}setNumber(e,t){super.setNumber(e,t),this.configMotionProperty(e,3,this.compressNumber)}setVector2(e,t){super.setVector2(e,t),this.configMotionProperty(e,4,this.compressVector2)}setVector3(e,t){super.setVector3(e,t),this.configMotionProperty(e,5,this.compressVector3)}setVector(e,t){super.setVector(e,t),this.configMotionProperty(e,6,this.compressVector4)}setColor(e,t){super.setColor(e,t),this.configMotionProperty(e,6,this.compressVector4)}setMatrix4x4(e,t){super.setMatrix4x4(e,t),this.configMotionProperty(e,18,this.compressMatrix4x4)}setBuffer(e,t){super.setBuffer(e,t),this.configMotionProperty(e,3+t.length,this.compressNumberArray)}setTexture(e,t){super.setTexture(e,t),this.configMotionProperty(e,3,this.compressTexture)}setUniformBuffer(e,t){this._data[e]=t,this.configMotionProperty(e,3,this.compressUBO)}setValueData(e,t){"boolean"==typeof t?this.setBool(e,t):"number"==typeof t?this.setNumber(e,t):t instanceof Z?this.setColor(e,t):t instanceof Me?this.setVector2(e,t):t instanceof Ie?this.setVector3(e,t):t instanceof we||t instanceof We?this.setVector(e,t):t instanceof qe?this.setMatrix4x4(e,t):null!=t.ArrayBuffer?this.setBuffer(e,t):null!=t._texture&&this.setTexture(e,t)}cloneTo(e){var t=e;for(var r in this._data){var i=this._data[r];null!=i&&("boolean"==typeof i?e.setBool(r,i):"number"==typeof i?e.setNumber(r,i):i instanceof Me?e.setVector2(r,i):i instanceof Ie?e.setVector3(r,i):i instanceof we?e.setVector(r,i):i instanceof qe?e.setMatrix4x4(r,i):i instanceof I&&e.setTexture(r,i))}this._defineDatas.cloneTo(t._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())}))}clone(){var e=new Pl;return this.cloneTo(e),e}destroy(){super.destroy(),this._nativeObj.destroy(),this._nativeObj=null}}class Bl extends fn{constructor(e,t,r,i,s){super(e,t,r,i,s),this._conchUniformBufferObject=null,this._conchUniformBufferObject=new window.conchUniformBufferObject(x.renderEngine._nativeObj,e),this._conchUniformBufferObject.setGLBuffer(this._glBuffer)}}class Ll extends Tl{constructor(e){super(e),this._vertexDeclaration=[],this._nativeObj=new window.conchGLVertexState(e._nativeObj),this._nativeVertexBuffers=[]}bindVertexArray(){this._nativeObj.bindVertexArray()}unbindVertexArray(){this._nativeObj.unbindVertexArray()}applyVertexBuffer(e){this._vertexBuffers=e,this._nativeVertexBuffers.length=0,e.forEach((e=>{this._nativeVertexBuffers.push(e._conchVertexBuffer3D)})),this._nativeObj.applyVertexBuffer(this._nativeVertexBuffers)}applyIndexBuffer(e){null!=e&&(this._bindedIndexBuffer=e,this._nativeObj.applyIndexBuffer(e._conchIndexBuffer3D))}destroy(){this._vertexBuffers=null,this._nativeVertexBuffers=[],this._bindedIndexBuffer=null,super.destroy(),this._nativeObj.destroy()}}e.WebGLMode=void 0,(Al=e.WebGLMode||(e.WebGLMode={}))[Al.Auto=0]="Auto",Al[Al.WebGL2=1]="WebGL2",Al[Al.WebGL1=2]="WebGL1";e.WebGLExtension=void 0,(Cl=e.WebGLExtension||(e.WebGLExtension={}))[Cl.OES_vertex_array_object=0]="OES_vertex_array_object",Cl[Cl.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",Cl[Cl.OES_texture_half_float=2]="OES_texture_half_float",Cl[Cl.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",Cl[Cl.OES_texture_float=4]="OES_texture_float",Cl[Cl.OES_element_index_uint=5]="OES_element_index_uint",Cl[Cl.OES_texture_float_linear=6]="OES_texture_float_linear",Cl[Cl.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",Cl[Cl.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",Cl[Cl.WEBGL_depth_texture=9]="WEBGL_depth_texture",Cl[Cl.EXT_sRGB=10]="EXT_sRGB",Cl[Cl.EXT_color_buffer_float=11]="EXT_color_buffer_float",Cl[Cl.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",Cl[Cl.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",Cl[Cl.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",Cl[Cl.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",Cl[Cl.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",Cl[Cl.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",Cl[Cl.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",Cl[Cl.OES_standard_derivatives=19]="OES_standard_derivatives";class Fl{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class Ol extends Fl{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,this._gpuMemory)}constructor(t,r,i,s,a,n,l,o,h){super(t),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=i,this.height=s,this.depth=a;const isPot=e=>!(e&e-1);this.isPotSize=isPot(i)&&isPot(s),n==e.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&isPot(this.depth)),this._mipmap=l&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(i))+1,Math.ceil(Math.log2(s))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=o,this.gammaCorrection=h,this.target=r,this.filterMode=e.FilterMode.Bilinear,this.wrapU=e.WrapMode.Repeat,this.wrapV=e.WrapMode.Repeat,this.wrapW=e.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=e.TextureCompareMode.None}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,i=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,i);let s=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,s),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(t){if(this._warpW!=t&&this.resource){if(this._engine.getCapable(e.RenderCapable.Texture3D)){let e=this._gl,r=this.getWrapParam(t);this._setWrapMode(e.TEXTURE_WRAP_R,r)}this._warpW=t}}get anisoLevel(){return this._anisoLevel}set anisoLevel(t){let r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(r){this._gl;let i=this._engine.getParams(e.RenderParams.Max_AnisoLevel_Count),s=Math.max(1,Math.min(i,t));this._setTexParametexf(r.TEXTURE_MAX_ANISOTROPY_EXT,s),this._anisoLevel=s}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,i=this.target;this._engine._bindTexture(i,this.resource),r.texParameteri(i,e,t),this._engine._bindTexture(i,null)}_setTexParametexf(e,t){let r=this._gl,i=this.target;this._engine._bindTexture(i,this.resource),r.texParameterf(i,e,t),this._engine._bindTexture(i,null)}getFilteMinrParam(t,r){let i=this._gl;switch(t){case e.FilterMode.Point:return r?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;case e.FilterMode.Bilinear:return r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;case e.FilterMode.Trilinear:return r?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;default:return r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR}}getFilterMagParam(t){let r=this._gl;switch(t){case e.FilterMode.Point:return r.NEAREST;case e.FilterMode.Bilinear:case e.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(t){let r=this._gl;switch(t){case e.WrapMode.Repeat:return r.REPEAT;case e.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case e.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}dispose(){this._gl.deleteTexture(this.resource),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=0}}class Nl extends Fl{get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,this._gpuMemory)}constructor(e,t,r,i,s,a){super(e),this._gpuMemory=0,this.colorFormat=t,this.depthStencilFormat=r,this._isCube=i,this._generateMipmap=s,this._samples=a,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),a>1&&(this._msaaFramebuffer=this._gl.createFramebuffer())}dispose(){this._textures.forEach((e=>{e&&e.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,-this._gpuMemory),this._gpuMemory=0}}class Ul extends Fl{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}glTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=i.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_SHORT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=i.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=i.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(t,r){let i=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:i.DEPTH_COMPONENT16,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:i.DEPTH_STENCIL,attachment:i.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:i.DEPTH_STENCIL,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:i.STENCIL_INDEX8,attachment:i.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(t){let r=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case e.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:case e.RenderTargetFormat.R16G16B16:case e.RenderTargetFormat.R16G16B16A16:case e.RenderTargetFormat.R32G32B32:case e.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(t){let r=this._gl;switch(t){case e.TextureDimension.Tex2D:return r.TEXTURE_2D;case e.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(t){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(t){case e.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case e.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,i=0,s=0,a=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,l=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case n:case r.RGB:i=3;break;case l:case r.RGBA:i=4;break;default:i=0}switch(e.type){case r.UNSIGNED_BYTE:s=1;break;case r.UNSIGNED_SHORT_5_6_5:s=2/3;break;case r.FLOAT:s=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:s=2;break;default:s=0}return a=i*s*e.width*e.height,e.mipmap&&(a*=1.333),e.target==r.TEXTURE_CUBE_MAP?a*=6:e.target==r.TEXTURE_2D&&(a*=1),a}getGLRTTexMemory(t,r,i,s,a,n,l){let getpixelbyte=t=>{let r=0;switch(t){case e.RenderTargetFormat.R8G8B8:r=3;break;case e.RenderTargetFormat.R8G8B8A8:r=4;break;case e.RenderTargetFormat.R16G16B16A16:r=8;break;case e.RenderTargetFormat.R32G32B32:r=12;break;case e.RenderTargetFormat.R32G32B32A32:r=16;break;case e.RenderTargetFormat.R16G16B16:r=6;break;case e.RenderTargetFormat.DEPTH_16:r=2;break;case e.RenderTargetFormat.STENCIL_8:r=1;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:r=4}return r},o=getpixelbyte(i);return n>1&&(o*=2),l&&(o*=6),a&&(o*=1.333),o*t*r+getpixelbyte(s)*t*r}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(t){switch(t){case e.RenderTargetFormat.DEPTH_16:case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:case e.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(t){switch(t){case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,i,s,a,n){let l=this.isSRGBFormat(i)||a&&this.supportSRGB(i,s);n&&(l=!1);let o=1;!l&&a&&(o=2.2);let h=this.getTarget(e),_=new Ol(this._engine,h,t,r,1,e,s,l,o),u=this.glTextureParam(i,l);return _.internalFormat=u.internalFormat,_.format=u.format,_.type=u.type,_}setTextureImageData(e,t,r,i){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let s=e.target,a=e.internalFormat,n=e.format,l=e.type;e.width,e.height;let o=e._gl;r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),o.texImage2D(s,0,a,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&o.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,i,s,a){let n=e.target;e.internalFormat;let l=e.format,o=e.type;t.width,t.height;let h=e._gl;s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,i,l,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,i=e.type,s=e.width,a=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,s,a,0,r,i,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,i){let s=e.target,a=e.internalFormat,n=e.format,l=e.type,o=e.width,h=e.height,_=o%4==0&&h%4==0,u=e._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),_||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u.texImage2D(s,0,a,o,h,0,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),_||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,i,s,a,n,l,o,h){i=i&&0==r;let _=e.target;e.internalFormat;let u=e.format,d=e.type,c=n%4==0&&l%4==0,p=e._gl;o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),c||p.pixelStorei(p.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),p.texSubImage2D(_,r,s,a,n,l,u,d,t),e.mipmap&&i&&p.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!1),c||p.pixelStorei(p.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,i=e.internalFormat;e.format,e.type;let s=e.width,a=e.height,n=t.source,l=t.dataOffset,o=t.bpp,h=t.blockBytes,_=t.mipmapCount;e.maxMipmapLevel=_-1;let u=s%4==0&&a%4==0,d=e._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=s,p=a,f=0;for(let e=0;e<_;e++){let t=Math.max(4,c)/4*Math.max(4,p)/4*h,s=new Uint8Array(n,l,t);d.compressedTexImage2D(r,e,i,c,p,0,s),f+=s.length,l+=o?c*p*(o/8):t,c*=.5,p*=.5,c=Math.max(1,c),p=Math.max(1,p)}e.gpuMemory=f,this._engine._bindTexture(e.target,null),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,i=t.compress,s=e.target,a=e.internalFormat,n=e.format,l=e.type,o=e.mipmapCount,h=e.width,_=e.height;e.maxMipmapLevel=o-1;let u=h%4==0&&_%4==0,d=e._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=h,p=_,f=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let o=new Int32Array(r,f,1)[0];if(f+=4,i){let t=new Uint8Array(r,f,o);d.compressedTexImage2D(s,e,a,c,p,0,t),g+=t.length}else{let i=this.getFormatPixelsParams(t.format),h=o/i.typedSize,_=new i.dataTypedCons(r,f,h);d.texImage2D(s,e,a,c,p,0,n,l,_),g+=_.byteLength}f+=o,f+=3-(o+3)%4,c=Math.max(1,.5*c),p=Math.max(1,.5*p)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)i||d.texImage2D(s,r,a,c,p,0,n,l,null),c=Math.max(1,.5*c),p=Math.max(1,.5*p);e.gpuMemory=g,this._engine._bindTexture(e.target,null),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,i){let s=e._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,l=e.format,o=e.type;e.width,e.height,r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<a.length;e++){let r=a[e];s.texImage2D(r,0,n,l,o,t[e])}e.mipmap&&s.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,i){let s=e._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,l=e.format,o=e.type,h=e.width,_=e.height,u=h%4==0;if(r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),u||s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<a.length;e++){let r=a[e];s.texImage2D(r,0,n,h,_,0,l,o,t[e])}e.mipmap&&s.generateMipmap(e.target)}else{for(let e=0;e<a.length;e++){let t=a[e];s.texImage2D(t,0,n,h,_,0,l,o,null)}e.mipmap&&s.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),u||s.pixelStorei(s.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,i,s,a,n,l,o,h){i=i&&0==r;let _=e._gl;const u=[_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_Z,_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let d=e.format,c=e.type,p=n%4==0;o&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),p||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<u.length;e++){let i=u[e];_.texSubImage2D(i,r,s,a,n,l,d,c,t[e])}e.mipmap&&i&&_.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),p||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setCubeDDSData(t,r){let i=t.internalFormat,s=t.format,a=t.type,n=t.width,l=t.height,o=r.source,h=r.dataOffset,_=r.bpp,u=r.blockBytes,d=r.mipmapCount;t.maxMipmapLevel=d-1;let c=n%4==0&&l%4==0;c=!0;let p=t._gl;this._engine._bindTexture(t.target,t.resource);const f=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];let g=this.getFormatPixelsParams(r.format),m=g.bytesPerPixel/g.channels,T=r.format==e.TextureFormat.R32G32B32A32?Float32Array:Uint16Array,x=0;if(r.compressed)for(let e=0;e<6;e++){let r=f[e],s=n,a=l;for(let e=0;e<d;e++){let n=Math.max(4,s)/4*Math.max(4,a)/4*u,l=new Uint8Array(o,h,n);(t.mipmap||0==e)&&p.compressedTexImage2D(r,e,i,s,a,0,l),x+=l.byteLength,h+=_?s*a*(_/8):n,s*=.5,a*=.5,s=Math.max(1,s),a=Math.max(1,a)}}else for(let e=0;e<6;e++){let t=f[e],r=n,_=l;for(let e=0;e<d;e++){let n=r*_*g.channels,l=new T(o,h,n);p.texImage2D(t,e,i,r,_,0,s,a,l),x+=l.byteLength,h+=n*m,r*=.5,_*=.5,r=Math.max(1,r),_=Math.max(1,_)}}t.gpuMemory=x,this._engine._bindTexture(t.target,null)}setCubeKTXData(e,t){let r=t.source,i=t.compress,s=e.internalFormat,a=e.format,n=e.type,l=t.mipmapCount,o=e.width,h=e.height;e.maxMipmapLevel=l-1;let _=o%4==0&&h%4==0,u=e._gl;const d=[u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Y,u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_Z];_||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=o,p=h,f=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let l=new Int32Array(r,f,1)[0];f+=4;for(let o=0;o<6;o++){let h=d[o];if(i){let t=new Uint8Array(r,f,l);u.compressedTexImage2D(h,e,s,c,p,0,t),g+=t.byteLength}else{let i=this.getFormatPixelsParams(t.format),o=l/i.typedSize,_=new i.dataTypedCons(r,f,o);u.texImage2D(h,e,s,c,p,0,a,n,_),g+=_.byteLength}f+=l,f+=3-(l+3)%4}c=Math.max(1,.5*c),p=Math.max(1,.5*p)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=d[e];i||u.texImage2D(t,r,s,c,p,0,a,n,null)}c=Math.max(1,.5*c),p=Math.max(1,.5*p)}this._engine._bindTexture(e.target,null),e.gpuMemory=g,_||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){return e.TextureCompareMode.None}bindRenderTarget(e,t=0){let r=this._gl,i=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,i),e._isCube){let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}}bindoutScreenTarget(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}unbindRenderTarget(e){let t=e._gl;e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}createRenderTextureInternal(t,r,i,s,a,n){let l=!1;a=a&&this.supportGenerateMipmap(s);let o=this.getTarget(t),h=new Ol(this._engine,o,r,i,1,t,a,l,1),_=this.glRenderTextureParam(s,l);h.internalFormat=_.internalFormat,h.format=_.format,h.type=_.type;let u=h.internalFormat,d=h.format,c=h.type,p=h._gl;return this._engine._bindTexture(h.target,h.resource),p.texImage2D(o,0,u,r,i,0,d,c,null),this._engine._bindTexture(h.target,null),s!=e.RenderTargetFormat.DEPTH_16&&s!=e.RenderTargetFormat.DEPTH_32&&s!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=e.FilterMode.Point),h}createRenderTextureCubeInternal(t,r,i,s,a){let n=!1;s=s&&this.supportGenerateMipmap(i);let l=this.getTarget(t),o=new Ol(this._engine,l,r,r,1,t,s,n,1),h=this.glRenderTextureParam(i,n);o.internalFormat=h.internalFormat,o.format=h.format,o.type=h.type;let _=o.internalFormat,u=o.format,d=o.type,c=o._gl;const p=[c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z,c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(o.target,o.resource);for(let e=0;e<p.length;e++){let t=p[e];c.texImage2D(t,0,_,r,r,0,u,d,null)}return this._engine._bindTexture(o.target,null),i!=e.RenderTargetFormat.DEPTH_16&&i!=e.RenderTargetFormat.DEPTH_32&&i!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(o.filterMode=e.FilterMode.Point),o}createRenderTargetInternal(t,r,i,s,a,n,l){let o=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,i,a,n),h=new Nl(this._engine,i,s,!1,o.mipmap,1);h.gpuMemory=this.getGLRTTexMemory(t,r,i,s,a,1,!1),h.colorFormat=i,h.depthStencilFormat=s,h._textures.push(o);let _=h._framebuffer,u=h._gl;u.bindFramebuffer(u.FRAMEBUFFER,_);let d=this.glRenderTargetAttachment(i);u.framebufferTexture2D(u.FRAMEBUFFER,d,u.TEXTURE_2D,o.resource,0);let c=this.glRenderBufferParam(s,!1);if(c){let e=this.createRenderbuffer(t,r,c.internalFormat,h._samples);h._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,c.attachment,u.RENDERBUFFER,e)}return u.bindFramebuffer(u.FRAMEBUFFER,null),h}createRenderTargetCubeInternal(t,r,i,s,a,n){let l=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,s,a),o=new Nl(this._engine,r,i,!0,l.mipmap,1);o.gpuMemory=this.getGLRTTexMemory(t,t,r,i,s,1,!0),o._textures.push(l);let h=o._framebuffer,_=o._gl;_.bindFramebuffer(_.FRAMEBUFFER,h);let u=this.glRenderBufferParam(i,!1);if(u){let e=this.createRenderbuffer(t,t,u.internalFormat,o._samples);o._depthbuffer=e,_.framebufferRenderbuffer(_.FRAMEBUFFER,u.attachment,_.RENDERBUFFER,e)}return _.bindFramebuffer(_.FRAMEBUFFER,null),o}createRenderbuffer(e,t,r,i){let s=this._gl,a=s.createRenderbuffer();return s.bindRenderbuffer(s.RENDERBUFFER,a),s.renderbufferStorage(s.RENDERBUFFER,r,e,t),s.bindRenderbuffer(s.RENDERBUFFER,null),a}setupRendertargetTextureAttachment(e,t){let r=e._gl;e._depthTexture=t;let i=e._depthbuffer;i&&r.deleteRenderbuffer(i),e._depthbuffer=null;let s=this.glRenderTargetAttachment(e.depthStencilFormat),a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a),r.framebufferTexture2D(r.FRAMEBUFFER,s,r.TEXTURE_2D,t.resource,0),r.bindFramebuffer(r.FRAMEBUFFER,null)}readRenderTargetPixelData(t,r,i,s,a,n){let l=t._gl;if(this.bindRenderTarget(t),!(l.checkFramebufferStatus(l.FRAMEBUFFER)==l.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(t),null;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:l.readPixels(r,i,s,a,l.RGB,l.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R8G8B8A8:l.readPixels(r,i,s,a,l.RGBA,l.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R16G16B16:l.readPixels(r,i,s,a,l.RGB,l.FLOAT,n);break;case e.RenderTargetFormat.R16G16B16A16:l.readPixels(r,i,s,a,l.RGBA,l.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32:l.readPixels(r,i,s,a,l.RGB,l.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32A32:l.readPixels(r,i,s,a,l.RGBA,l.FLOAT,n)}return this.unbindRenderTarget(t),n}updateVideoTexture(e,t,r,i){let s=e._gl,a=e.target,n=e.internalFormat,l=e.format,o=e.type;e.width,e.height,r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),s.texImage2D(a,0,n,l,o,t),this._engine._bindTexture(e.target,null),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.pixelStorei(s.UNPACK_ALIGNMENT,4)}getRenderTextureData(t,r,i,s,a){if(t.colorFormat==e.RenderTargetFormat.None)return null;let n=t._gl;if(n.bindFramebuffer(n.FRAMEBUFFER,t._framebuffer),!(n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE))return n.bindFramebuffer(n.FRAMEBUFFER,null),null;let l,o,h=s*a;var _;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:l=n.RGB,o=n.UNSIGNED_BYTE,_=new Uint8Array(3*h);break;case e.RenderTargetFormat.R8G8B8A8:l=n.RGBA,o=n.UNSIGNED_BYTE,_=new Uint8Array(4*h);break;case e.RenderTargetFormat.R16G16B16:l=n.RGB,o=n.UNSIGNED_SHORT_4_4_4_4,_=new Uint16Array(3*h);break;case e.RenderTargetFormat.R16G16B16A16:l=n.RGBA,o=n.UNSIGNED_SHORT_4_4_4_4,_=new Uint16Array(4*h);break;case e.RenderTargetFormat.R32G32B32:l=n.RGB,o=n.FLOAT,_=new Float32Array(3*h);break;case e.RenderTargetFormat.R32G32B32A32:l=n.RGBA,o=n.FLOAT,_=new Float32Array(4*h);break;default:return null}return n.readPixels(r,i,s,a,l,o,_),n.bindFramebuffer(n.FRAMEBUFFER,null),_}}class Gl extends Ul{constructor(e){super(e)}getTarget(t){let r=-1;switch(t){case e.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case e.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case e.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case e.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?i.SRGB8:i.RGB8,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?i.SRGB8_ALPHA8:i.RGBA8,this._glParam.format=i.RGBA,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=i.RGB565,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA32F,this._glParam.format=i.RGBA,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=i.RGB32F,this._glParam.format=i.RGB,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=i.RGB16F,this._glParam.format=i.RGB,this._glParam.type=i.HALF_FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA16F,this._glParam.format=i.RGBA,this._glParam.type=i.HALF_FLOAT;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(t,r){let i=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:i.DEPTH_COMPONENT16,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:i.DEPTH24_STENCIL8,attachment:i.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:i.DEPTH_COMPONENT32F,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:i.STENCIL_INDEX8,attachment:i.STENCIL_ATTACHMENT};case e.RenderTargetFormat.R8G8B8:return{internalFormat:r?i.SRGB8:i.RGB8,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?i.SRGB8_ALPHA8:i.RGBA8,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16:return{internalFormat:i.RGB16F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16A16:return{internalFormat:i.RGBA16F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32:return{internalFormat:i.RGB32F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32A32:return{internalFormat:i.RGBA32F,attachment:i.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?i.SRGB8:i.RGB8,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?i.SRGB8_ALPHA8:i.RGBA8,this._glParam.format=i.RGBA,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=i.RGB16F,this._glParam.format=i.RGB,this._glParam.type=i.HALF_FLOAT;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA16F,this._glParam.format=i.RGBA,this._glParam.type=i.HALF_FLOAT;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=i.RGB32F,this._glParam.format=i.RGB,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA32F,this._glParam.format=i.RGBA,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=i.DEPTH_COMPONENT16,this._glParam.format=i.DEPTH_COMPONENT,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=i.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT_24_8;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=i.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,i=0,s=0,a=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:i=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:i=4;break;default:i=0}switch(e.type){case r.UNSIGNED_BYTE:s=1;break;case r.UNSIGNED_SHORT_5_6_5:s=2/3;break;case r.FLOAT:s=4;break;case r.HALF_FLOAT:s=2;break;default:s=0}return a=i*s*e.width*e.height,e.mipmap&&(a*=1.333),e.target==r.TEXTURE_CUBE_MAP?a*=6:e.target==r.TEXTURE_2D?a*=1:e.target==r.TEXTURE_2D_ARRAY&&(a*=t),a}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB);case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,i){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let s=e.target,a=e.internalFormat,n=e.format,l=e.type,o=e.width,h=e.height,_=e.mipmapCount,u=this._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),u.texStorage2D(s,_,a,o,h),u.texSubImage2D(s,0,0,0,o,h,n,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,i,s,a){let n=e.target;e.internalFormat;let l=e.format,o=e.type;e.width,e.height,e.mipmapCount;let h=this._gl;s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,i,t.width,t.height,l,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,i){let s=e.target,a=e.internalFormat,n=e.format,l=e.type,o=e.width,h=e.height,_=e.mipmapCount,u=o%4==0&&h%4==0,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(s,_,a,o,h),e.gpuMemory=this.getGLtexMemory(e),t&&(d.texSubImage2D(s,0,0,0,o,h,n,l,t),e.mipmap&&d.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,i,s,a,n,l){let o=this.isSRGBFormat(s)||n&&this.supportSRGB(s,a);l&&(o=!1);let h=1;!o&&n&&(h=2.2);let _=this.getTarget(e),u=new Ol(this._engine,_,t,r,i,e,a,o,h),d=this.glTextureParam(s,o);return u.internalFormat=d.internalFormat,u.format=d.format,u.type=d.type,u}setTexture3DImageData(e,t,r,i,s){let a=e.target,n=e.internalFormat,l=e.format,o=e.type,h=e.width,_=e.height,u=e.mipmapCount,d=this._gl;i&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage3D(a,u,n,h,_,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)d.texSubImage3D(a,0,0,0,e,h,_,1,l,o,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,i,s){let a=e.target,n=e.internalFormat,l=e.format,o=e.type,h=e.width,_=e.height,u=e.mipmapCount,d=h%4==0&&_%4==0,c=this._gl;i&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),d||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),c.texStorage3D(a,u,n,h,_,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(c.texSubImage3D(a,0,0,0,0,h,_,r,l,o,t),e.mipmap&&c.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),i&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),d||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,i,s,a,n,l,o,h,_,u){i=i&&0==r;let d=e.target;e.internalFormat;let c=e.format,p=e.type,f=l%4==0&&o%4==0,g=this._gl;_&&g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u&&g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!0),f||g.pixelStorei(g.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),g.texSubImage3D(d,r,s,a,n,l,o,h,c,p,t),e.mipmap&&i&&g.generateMipmap(e.target),this._engine._bindTexture(e.target,null),_&&g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u&&g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!1),f||g.pixelStorei(g.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,i=e.internalFormat,s=e.format,a=e.type,n=e.mipmapCount,l=e.width,o=e.height;e.maxMipmapLevel=n-1;let h=t.source,_=t.compress,u=l%4==0&&o%4==0,d=this._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),_||d.texStorage2D(r,t.mipmapCount,i,l,o);let c=l,p=o,f=t.headerOffset+t.bytesOfKeyValueData,g=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(h,f,1)[0];if(f+=4,_){let t=new Uint8Array(h,f,n);d.compressedTexImage2D(r,e,i,c,p,0,t),g+=t.length}else{let i=this.getFormatPixelsParams(t.format),l=n/i.typedSize,o=new i.dataTypedCons(h,f,l);d.texSubImage2D(r,e,0,0,c,p,s,a,o),g+=o.length}f+=n,f+=3-(n+3)%4,c=Math.max(1,.5*c),p=Math.max(1,.5*p)}this._engine._bindTexture(e.target,null),e.gpuMemory=g,u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,i){let s=this._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,l=e.internalFormat,o=e.format,h=e.type,_=e.width,u=e.height,d=e.mipmapCount;r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),s.texStorage2D(n,d,l,_,u),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<a.length;e++){let r=a[e];s.texSubImage2D(r,0,0,0,o,h,t[e])}e.mipmap&&s.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,i){let s=this._gl;const a=[s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z,s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,l=e.internalFormat,o=e.format,h=e.type,_=e.width,u=e.height,d=e.mipmapCount,c=_%4==0;if(r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),c||s.pixelStorei(s.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),s.texStorage2D(n,d,l,_,u),t){for(let e=0;e<a.length;e++){let r=a[e];s.texSubImage2D(r,0,0,0,_,u,o,h,t[e])}e.mipmap&&s.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),c||s.pixelStorei(s.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let s=e.target,a=e.internalFormat,n=e.format,l=e.type;e.mipmapCount;let o=e.width,h=e.height;e.maxMipmapLevel=t.mipmapCount-1;let _=t.source,u=t.compress,d=o,c=h,p=t.headerOffset+t.bytesOfKeyValueData,f=o%4==0&&h%4==0;f||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||r.texStorage2D(s,t.mipmapCount,a,o,h);let g=0;for(let e=0;e<t.mipmapCount;e++){let s=new Int32Array(_,p,1)[0];p+=4;for(let o=0;o<6;o++){let h=i[o];if(u){let t=new Uint8Array(_,p,s);r.compressedTexImage2D(h,e,a,d,c,0,t),g+=t.byteLength}else{let i=this.getFormatPixelsParams(t.format),a=s/i.typedSize,o=new i.dataTypedCons(_,p,a);r.texSubImage2D(h,e,0,0,d,c,n,l,o),g+=o.byteLength}p+=s,p+=3-(s+3)%4}d=Math.max(1,.5*d),c=Math.max(1,.5*c)}e.gpuMemory=g,this._engine._bindTexture(e.target,null),f||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let s=e.target,a=e.internalFormat,n=e.format,l=e.type,o=e.mipmapCount,h=e.width,_=e.height;e.maxMipmapLevel=o-1;let u=t.source,d=t.compress,c=h,p=_,f=t.headerOffset+t.bytesOfKeyValueData,g=h%4==0&&_%4==0;g||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(s,t.mipmapCount,a,h,_);let m=0;for(let e=0;e<t.mipmapCount;e++){let s=new Int32Array(u,f,1)[0];f+=4;for(let a=0;a<6;a++){let o=i[a],h=this.getFormatPixelsParams(t.format),_=s/h.typedSize,d=new h.dataTypedCons(u,f,_);r.texSubImage2D(o,e,0,0,c,p,n,l,d),m+=d.byteLength}f+=s,f+=3-(s+3)%4}c=Math.max(1,.5*c),p=Math.max(1,.5*p),e.gpuMemory=m,this._engine._bindTexture(e.target,null),g||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){let i=this._gl;switch(r){case e.TextureCompareMode.LEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.GEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.LESS:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LESS),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GREATER:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.GREATER),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.EQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.EQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NOTEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.NOTEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.ALWAYS:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.ALWAYS),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NEVER:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.NEVER),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.None:default:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.NONE)}return r}createRenderbuffer(e,t,r,i){let s=this._gl,a=s.createRenderbuffer();return s.bindRenderbuffer(s.RENDERBUFFER,a),i>1?s.renderbufferStorageMultisample(s.RENDERBUFFER,i,r,e,t):s.renderbufferStorage(s.RENDERBUFFER,r,e,t),s.bindRenderbuffer(s.RENDERBUFFER,null),a}createRenderTextureInternal(t,r,i,s,a,n){a=a&&this.supportGenerateMipmap(s);let l=this.isSRGBFormat(s)||n&&this.supportSRGB(s,a),o=this.getTarget(t),h=new Ol(this._engine,o,r,i,1,t,a,l,1),_=this.glRenderTextureParam(s,l);h.internalFormat=_.internalFormat,h.format=_.format,h.type=_.type;let u=h.internalFormat;h.format,h.type;let d=this._gl;return this._engine._bindTexture(h.target,h.resource),d.texStorage2D(o,h.mipmapCount,u,r,i),this._engine._bindTexture(h.target,null),s!=e.RenderTargetFormat.DEPTH_16&&s!=e.RenderTargetFormat.DEPTH_32&&s!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=e.FilterMode.Point),h}createRenderTargetInternal(t,r,i,s,a,n,l){let o=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,i,a,n),h=new Nl(this._engine,i,s,!1,o.mipmap,l);h.gpuMemory=this.getGLRTTexMemory(t,r,i,s,a,l,!1),h._textures.push(o);let _=h._gl;if(h._samples>1){let e=h._msaaFramebuffer,a=this.glRenderBufferParam(i,n),l=h._msaaRenderbuffer=this.createRenderbuffer(t,r,a.internalFormat,h._samples);_.bindFramebuffer(_.FRAMEBUFFER,e),_.framebufferRenderbuffer(_.FRAMEBUFFER,a.attachment,_.RENDERBUFFER,l);let u=this.glRenderBufferParam(s,!1);if(u){let e=this.createRenderbuffer(t,r,u.internalFormat,h._samples);h._depthbuffer=e,_.framebufferRenderbuffer(_.FRAMEBUFFER,u.attachment,_.RENDERBUFFER,e)}_.bindFramebuffer(_.FRAMEBUFFER,null);let d=h._framebuffer;_.bindFramebuffer(_.FRAMEBUFFER,d);let c=this.glRenderTargetAttachment(i);_.framebufferTexture2D(_.FRAMEBUFFER,c,_.TEXTURE_2D,o.resource,0),_.bindFramebuffer(_.FRAMEBUFFER,null)}else{let e=h._framebuffer;_.bindFramebuffer(_.FRAMEBUFFER,e);let a=this.glRenderTargetAttachment(i);_.framebufferTexture2D(_.FRAMEBUFFER,a,_.TEXTURE_2D,o.resource,0);let n=this.glRenderBufferParam(s,!1);if(n){let e=this.createRenderbuffer(t,r,n.internalFormat,h._samples);h._depthbuffer=e,_.framebufferRenderbuffer(_.FRAMEBUFFER,n.attachment,_.RENDERBUFFER,e)}_.bindFramebuffer(_.FRAMEBUFFER,null)}return h}createRenderTargetCubeInternal(t,r,i,s,a,n){let l=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,s,a),o=new Nl(this._engine,r,i,!0,l.mipmap,n);o.gpuMemory=this.getGLRTTexMemory(t,t,r,i,s,n,!0),o.colorFormat=r,o.depthStencilFormat=i,o._textures.push(l),o.isSRGB=a;let h=o._gl;if(o._samples>1){let e=o._msaaFramebuffer,s=this.glRenderBufferParam(r,!1),a=o._msaaRenderbuffer=this.createRenderbuffer(t,t,s.internalFormat,o._samples);h.bindFramebuffer(h.FRAMEBUFFER,e),h.framebufferRenderbuffer(h.FRAMEBUFFER,s.attachment,h.RENDERBUFFER,a);let n=this.glRenderBufferParam(i,!1);if(n){let e=this.createRenderbuffer(t,t,n.internalFormat,o._samples);o._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}else{let e=o._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,e);let r=this.glRenderBufferParam(i,!1);if(r){let e=this.createRenderbuffer(t,t,r.internalFormat,o._samples);o._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}return o}createRenderTextureCubeInternal(e,t,r,i,s){i=i&&this.supportGenerateMipmap(r);let a=this.isSRGBFormat(r)||s&&this.supportSRGB(r,i),n=this.getTarget(e),l=new Ol(this._engine,n,t,t,1,e,i,a,1),o=this.glRenderTextureParam(r,a);l.internalFormat=o.internalFormat,l.format=o.format,l.type=o.type;let h=l.internalFormat;l.format,l.type;let _=this._gl;return this._engine._bindTexture(l.target,l.resource),_.texStorage2D(n,l.mipmapCount,h,t,t),this._engine._bindTexture(l.target,null),l}bindRenderTarget(e,t=0){let r=this._gl;if(e._isCube){let i=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,i);let s=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,s.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}}unbindRenderTarget(e){let t=this._gl;if(e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],i=t.COLOR_BUFFER_BIT;e._depthTexture&&(i|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,i,t.NEAREST)}e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}}class kl extends Fl{constructor(e,t,r){super(e),this._byteLength=0,this._glTargetType=t,this._glBufferUsageType=r,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer()}_getGLUsage(t){switch(t){case e.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case e.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case e.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(t){switch(t){case e.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case e.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case e.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.BufferMemory,t),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,t)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(-this._byteLength),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer(),this._memorychange(this._byteLength)}setData(e,t){let r=this._gl;this.bindBuffer(),r.bufferSubData(this._glTarget,t,e),this.unbindBuffer()}setDataEx(e,t,r){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,t,e,0,r),this.unbindBuffer()}bindBufferBase(e){if(this._engine._getBindUBOBuffer(e)!=this){this._gl.bindBufferBase(this._glTarget,e,this._glBuffer),this._engine._setBindUBOBuffer(e,this)}}bindBufferRange(e,t,r){this._gl.bindBufferRange(this._glTarget,e,this._glBuffer,t,r)}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();this._gl.deleteBuffer(this._glBuffer),this._memorychange(-this._byteLength),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}!function(){var e={};function synthesizeGLError(t,r){var i;e[t]=!0,void 0!==r&&(i=r,window.console&&window.console.error&&window.console.error(i))}var t=function WebGLVertexArrayObjectOES(e){var t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var r=0;r<this.attribs.length;r++){var i=new WebGLVertexArrayObjectOES.VertexAttrib(t);this.attribs[r]=i}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var i;do{(i=r.apply(t))!=t.NO_ERROR&&(e[i]=!0)}while(i!=t.NO_ERROR);for(var s in e)if(e[s])return delete e[s],parseInt(s);return t.NO_ERROR}}(t);var i=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:i.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,s){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=s;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=s}return i.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,s){var a=r.currentVertexArrayObject.attribs[e];switch(s){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return a.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return a.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return a.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return a.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return a.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return a.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,s,a,n,l){var o=r.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var h=o.attribs[e];return h.buffer=r.currentArrayBuffer,h.size=t,h.type=s,h.normalized=a,h.stride=n,h.offset=l,h.recache(),i.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var r=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var s=this.currentVertexArrayObject;if(i!=s){i&&s.elementArrayBuffer==i.elementArrayBuffer||r.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);for(var a=this.currentArrayBuffer,n=Math.max(i?i.maxAttrib:0,s.maxAttrib),l=0;l<=n;l++){var o=s.attribs[l],h=i?i.attribs[l]:null;if(i&&o.enabled==h.enabled||(o.enabled?r.enableVertexAttribArray.call(t,l):r.disableVertexAttribArray.call(t,l)),o.enabled){var _=!1;i&&o.buffer==h.buffer||(a!=o.buffer&&(r.bindBuffer.call(t,t.ARRAY_BUFFER,o.buffer),a=o.buffer),_=!0),(_||o.cached!=h.cached)&&r.vertexAttribPointer.call(t,l,o.size,o.type,o.normalized,o.stride,o.offset)}}this.currentArrayBuffer!=a&&r.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();class Vl{constructor(e){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(t){this._capabilityMap=new Map;let r=t||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(e.RenderCapable.Element_Index_Uint32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R32G32B32A32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R16G16B16A16,r),r=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(e.RenderCapable.Texture_anisotropic,r),r=t?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_R16G16B16A16,r),r=t?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_R32G32B32A32,r),r=t||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_Depth,r),r=t,this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_ShadowMap,r),r=t||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(e.RenderCapable.Vertex_VAO,r),r=t||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(e.RenderCapable.DrawElement_Instance,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(e.RenderCapable.Shader_TextureLod,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_PVRTC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC1,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ASTC,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(e.RenderCapable.Texture_SRGB,r),r=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_FloatLinearFiltering,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_HalfFloatLinearFiltering,r),r=t,this._capabilityMap.set(e.RenderCapable.MSAA,r),this._capabilityMap.set(e.RenderCapable.UnifromBufferObject,r),this._capabilityMap.set(e.RenderCapable.Texture3D,r)}initExtension(t){this._extensionMap=new Map;const setExtensionMap=(e,t,r)=>{t&&r.set(e,t)},r=this._getExtension("EXT_texture_filter_anisotropic");setExtensionMap(e.WebGLExtension.EXT_texture_filter_anisotropic,r,this._extensionMap);const i=this._getExtension("WEBGL_compressed_texture_s3tc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc,i,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,s,this._extensionMap);const a=this._getExtension("WEBGL_compressed_texture_pvrtc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,a,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_etc1");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc1,n,this._extensionMap);const l=this._getExtension("WEBGL_compressed_texture_etc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc,l,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_astc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_astc,o,this._extensionMap);const h=this._getExtension("OES_texture_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_float_linear,h,this._extensionMap);const _=this._getExtension("EXT_color_buffer_half_float");if(setExtensionMap(e.WebGLExtension.EXT_color_buffer_half_float,_,this._extensionMap),t){const t=this._getExtension("EXT_color_buffer_float");setExtensionMap(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=this._getExtension("OES_vertex_array_object");setExtensionMap(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const r=this._getExtension("ANGLE_instanced_arrays");setExtensionMap(e.WebGLExtension.ANGLE_instanced_arrays,r,this._extensionMap);const i=this._getExtension("OES_texture_half_float");setExtensionMap(e.WebGLExtension.OES_texture_half_float,i,this._extensionMap);const s=this._getExtension("OES_texture_half_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_half_float_linear,s,this._extensionMap);const a=this._getExtension("OES_texture_float");setExtensionMap(e.WebGLExtension.OES_texture_float,a,this._extensionMap);const n=this._getExtension("OES_element_index_uint");setExtensionMap(e.WebGLExtension.OES_element_index_uint,n,this._extensionMap);const l=this._getExtension("EXT_shader_texture_lod");setExtensionMap(e.WebGLExtension.EXT_shader_texture_lod,l,this._extensionMap);const o=this._getExtension("WEBGL_depth_texture");setExtensionMap(e.WebGLExtension.WEBGL_depth_texture,o,this._extensionMap);const h=this._getExtension("EXT_sRGB");setExtensionMap(e.WebGLExtension.EXT_sRGB,h,this._extensionMap);const _=this._getExtension("OES_standard_derivatives");setExtensionMap(e.WebGLExtension.OES_standard_derivatives,_,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.has(e)?this._extensionMap.get(e):null}_getExtension(e){const t=this._extentionVendorPrefixes;for(const i in t){var r=this._gl.getExtension(t[i]+e);if(r)return r}return null}}class Wl{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const t=this._gl;this._glParamsData=new Map,this._glParamsData.set(e.RenderParams.Max_Active_Texture_Count,t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const r=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),i=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(e.RenderParams.Max_Uniform_Count,Math.min(r,i)),this._glParamsData.set(e.RenderParams.MAX_Texture_Size,t.getParameter(t.MAX_TEXTURE_SIZE)),this._glParamsData.set(e.RenderParams.MAX_Texture_Image_Uint,t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(e.RenderCapable.Texture_anisotropic)){const r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(e.RenderParams.Max_AnisoLevel_Count,t.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(e.RenderParams.FLOAT,t.FLOAT),this._glParamsData.set(e.RenderParams.UNSIGNED_BYTE,t.UNSIGNED_BYTE),this._glParamsData.set(e.RenderParams.UNSIGNED_SHORT,t.UNSIGNED_SHORT),this._glParamsData.set(e.RenderParams.BYTE,t.BYTE)}getParams(e){return this._glParamsData.get(e)}}class Hl extends Fl{constructor(e){super(e)}activeTexture(e){this._engine._activedTextureID!==e&&(this._gl.activeTexture(e),this._engine._activedTextureID=e)}bindTexture(e,t){this._engine._bindTexture(e,t)}bindUseProgram(e){return this.cacheShaderProgram!=e&&(this._gl.useProgram(e),this._engine._glUseProgram=null,!0)}}class Xl extends Fl{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(t){switch(t){case e.MeshTopology.Points:return this._gl.POINTS;case e.MeshTopology.Lines:return this._gl.LINES;case e.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case e.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case e.MeshTopology.Triangles:return this._gl.TRIANGLES;case e.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case e.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(t){switch(t){case e.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(t,r,i,s,a){this._engine.isWebGL2?this._gl.drawElementsInstanced(t,r,i,s,a):this._angleInstancedArrays.drawElementsInstancedANGLE(t,r,i,s,a),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3*a)}drawArraysInstanced(t,r,i,s){this._engine.isWebGL2?this._gl.drawArraysInstanced(t,r,i,s):this._angleInstancedArrays.drawArraysInstancedANGLE(t,r,i,s),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,(i-2)*s)}drawArrays(t,r,i){this._gl.drawArrays(t,r,i),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,i-2)}drawElements(t,r,i,s){this._gl.drawElements(t,r,i,s),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3)}drawElements2DTemp(t,r,i,s){t=this.getMeshTopology(t),i=this.getIndexType(i),this._gl.drawElements(t,r,i,s),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3)}drawGeometryElement(t){t.bufferState.bind();let r=t.drawParams.elements,i=t.drawParams.length;switch(t.drawType){case e.DrawType.DrawArray:for(let e=0;e<i;e+=2)this.drawArrays(t._glmode,r[e],r[e+1]);break;case e.DrawType.DrawElement:for(let e=0;e<i;e+=2)this.drawElements(t._glmode,r[e+1],t._glindexFormat,r[e]);break;case e.DrawType.DrawArrayInstance:for(let e=0;e<i;e+=2)this.drawArraysInstanced(t._glmode,r[e],r[e+1],t.instanceCount);break;case e.DrawType.DrawElementInstance:for(let e=0;e<i;e+=2)this.drawElementsInstanced(t._glmode,r[e+1],t._glindexFormat,r[e],t.instanceCount)}}}class Yl{constructor(e){this._depthTest=!0,this._depthMask=!0,this._stencilTest=!1,this._blend=!1,this._cullFace=!1,this._engine=e,this._gl=this._engine.gl,this._initState()}_initState(){this._gl,this.setDepthFunc(e.CompareFunction.Less),this.setBlendEquationSeparate(e.BlendEquationSeparate.ADD,e.BlendEquationSeparate.ADD),this._blendEquation=e.BlendEquationSeparate.ADD,this._sFactor=e.BlendFactor.One,this._dFactor=e.BlendFactor.Zero,this._sFactorAlpha=e.BlendFactor.One,this._dFactorAlpha=e.BlendFactor.One}_getBlendFactor(t){const r=this._gl;switch(t){case e.BlendFactor.Zero:return r.ZERO;case e.BlendFactor.One:return r.ONE;case e.BlendFactor.SourceColor:return r.SRC_COLOR;case e.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case e.BlendFactor.DestinationColor:return r.DST_COLOR;case e.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case e.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case e.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case e.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case e.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case e.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case e.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case e.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(t){const r=this._gl;switch(t){case e.BlendEquationSeparate.ADD:return r.FUNC_ADD;case e.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case e.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(t){const r=this._gl;switch(t){case e.CompareFunction.Never:return r.NEVER;case e.CompareFunction.Less:return r.LESS;case e.CompareFunction.Equal:return r.EQUAL;case e.CompareFunction.LessEqual:return r.LEQUAL;case e.CompareFunction.Greater:return r.GREATER;case e.CompareFunction.NotEqual:return r.NOTEQUAL;case e.CompareFunction.GreaterEqual:return r.GEQUAL;case e.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(t){const r=this._gl;switch(t){case e.StencilOperation.Keep:return r.KEEP;case e.StencilOperation.Zero:return r.ZERO;case e.StencilOperation.Replace:return r.REPLACE;case e.StencilOperation.IncrementSaturate:return r.INCR;case e.StencilOperation.DecrementSaturate:return r.DECR;case e.StencilOperation.Invert:return r.INVERT;case e.StencilOperation.IncrementWrap:return r.INCR_WRAP;case e.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(t){return t==e.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(e){e!==this._stencilMask&&(this._stencilMask=e,e?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(e,t){e==this._stencilFunc&&t==this._stencilRef||(this._stencilFunc=e,this._stencilRef=t,this._gl.stencilFunc(this._getGLCompareFunction(e),t,255))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,i){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&i===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=i,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(i)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}applyRenderStateCommand(t){t.cmdArray.forEach(((t,r)=>{switch(r){case e.RenderStateType.DepthTest:this.setDepthTest(t);break;case e.RenderStateType.DepthMask:this.setDepthMask(t);break;case e.RenderStateType.DepthFunc:this.setDepthFunc(t);break;case e.RenderStateType.StencilTest:this.setStencilTest(t);break;case e.RenderStateType.StencilMask:this.setStencilMask(t);break;case e.RenderStateType.StencilFunc:this.setStencilFunc(t[0],t[1]);break;case e.RenderStateType.StencilOp:this.setstencilOp(t[0],t[1],t[2]);break;case e.RenderStateType.BlendType:this.setBlend(t!=e.BlendType.BLEND_DISABLE);break;case e.RenderStateType.BlendEquation:this.setBlendEquation(t);break;case e.RenderStateType.BlendEquationSeparate:this.setBlendEquationSeparate(t[0],t[1]);break;case e.RenderStateType.BlendFunc:this.setBlendFunc(t[0],t[1]);break;case e.RenderStateType.BlendFuncSeperate:this.setBlendFuncSeperate(t[0],t[1],t[2],t[3]);break;case e.RenderStateType.CullFace:this.setCullFace(t);break;case e.RenderStateType.FrontFace:this.setFrontFace(t);break;default:throw"unknow type of renderStateType"}}))}}class zl extends Fl{constructor(e,t,r,i){super(e),this._complete=!0,this._vs=t,this._ps=r,this._attributeMap=i,this._uniformMap=[],this._create()}_create(){const e=this._gl;for(var t in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[t][0],t);e.linkProgram(this._program);if(!e.getProgramParameter(this._program,e.LINK_STATUS)){var r=e.getProgramInfoLog(this._program);return console.error(new Error("Could not compile WebGL program. \n\n"+r)),void(this._complete=!1)}const i=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);let s,a;for(this.useProgram(),this._curActTexIndex=0,a=0;a<i;a++){var n=e.getActiveUniform(this._program,a),l=n.name;let t=e.getUniformLocation(this._program,l);(t||0==t)&&(s=new nl,s.location=t,l.indexOf("[0]")>0?(s.name=l=l.substr(0,l.length-3),s.isArray=!0):(s.name=l,s.isArray=!1),s.type=n.type,this._addShaderUnifiormFun(s),this._uniformMap.push(s),s.dataOffset=this._engine.propertyNameToID(l))}if(this._engine.isWebGL2){this._uniformObjectMap={};var o=e.getProgramParameter(this._program,e.ACTIVE_UNIFORM_BLOCKS);for(a=0;a<o;a++){let t=e;var h=t.getActiveUniformBlockName(this._program,a);s=new nl,s.name=h,s.isArray=!1,s.type=e.UNIFORM_BUFFER,s.dataOffset=this._engine.propertyNameToID(h);let r=s.location=t.getUniformBlockIndex(this._program,h);t.uniformBlockBinding(this._program,r,this._engine.getUBOPointer(h)),this._uniformObjectMap[s.name]=s,this._uniformMap.push(s),this._addShaderUnifiormFun(s)}}}_legalUBObyteLength(e){return 16*Math.ceil(e/16)}_createShader(e,t,r){var i=e.createShader(r);return e.shaderSource(i,t),e.compileShader(i),this._engine._isShaderDebugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS)&&(l.isPlaying?console.error(e.getShaderInfoLog(i)):console.warn(e.getShaderInfoLog(i))),i}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:throw new Error("compile shader err!")}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3fv(e,t){let r=t.elements;return this._gl.uniformMatrix3fv(e.location,!1,r),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,t){var r=t?t._getSource():Y.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,r),0}_uniform_sampler2DArray(e,t){var r=t?t._getSource():Y.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,r),0}_uniform_sampler3D(e,t){var r=t?t._getSource():Y.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,r),0}_uniform_samplerCube(e,t){var r=t?t._getSource():bn.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,r),0}_uniform_UniformBuffer(e,t){return t._bindUniformBufferBase(),1}_bindTexture(e,t,r){const i=this._gl;this._engine._activedTextureID!==e&&(i.activeTexture(e),this._engine._activedTextureID=e);const s=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[s]!==r&&(i.bindTexture(t,r),this._engine._activeTextures[s]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class jl extends Fl{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach((e=>{var r=e.vertexDeclaration;this._vertexDeclaration[t++]=e.vertexDeclaration;var i=r._shaderValues;for(var s in e.bind(),i){var a=parseInt(s),n=i[s];this._gl.enableVertexAttribArray(a),this._gl.vertexAttribPointer(a,n[0],n[1],!!n[2],n[3],n[4]),e.instanceBuffer&&this.vertexAttribDivisor(a,1)}}))}clearVAO(){for(let i=0,s=this._vertexDeclaration.length;i<s;i++){var e=this._vertexDeclaration[i]._shaderValues;for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e.bind(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}class ql{constructor(t,r=e.WebGLMode.Auto){this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._curUBOPointer=0,this._GLUBOPointerMap=new Map,this._GLBindPointerUBOMap=new Map,this._lastClearColor=new Z,this._lastClearDepth=1,this._GLStatisticsInfo=new Map,this._config=t,this._isWebGL2=!1,this._lastViewport=new we(0,0,0,0),this._lastClearColor=new Z(0,0,0,0),this._lastScissor=new we(0,0,0,0),this._webglMode=r,this._initStatisticsInfo()}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){this._GLStatisticsInfo.set(e.RenderStatisticsInfo.DrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.InstanceDrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.Triangle,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.UniformUpload,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.TextureMemeory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.GPUMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.RenderTextureMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.BufferMemory,0)}_addStatisticsInfo(e,t){this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(e){this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}_getBindUBOBuffer(e){return this._GLBindPointerUBOMap.get(e)}_setBindUBOBuffer(e,t){this._GLBindPointerUBOMap.set(e,t)}initRenderEngine(t){let r,i;switch(this._webglMode){case e.WebGLMode.Auto:r=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:r=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:r=["webgl2","experimental-webgl2"]}for(var s=0;s<r.length;s++){try{i=t.getContext(r[s],this._config)}catch(e){}if(i){"webgl2"!==r[s]&&"experimental-webgl2"!==r[s]||(this._isWebGL2=!0);break}}this._context=i,this._initBindBufferMap(),this._supportCapatable=new Vl(this),this._GLParams=new Wl(this),this._GLRenderState=new Yl(this),this._glTextureIDParams=[i.TEXTURE0,i.TEXTURE1,i.TEXTURE2,i.TEXTURE3,i.TEXTURE4,i.TEXTURE5,i.TEXTURE6,i.TEXTURE7,i.TEXTURE8,i.TEXTURE9,i.TEXTURE10,i.TEXTURE11,i.TEXTURE12,i.TEXTURE13,i.TEXTURE14,i.TEXTURE15,i.TEXTURE16,i.TEXTURE17,i.TEXTURE18,i.TEXTURE19,i.TEXTURE20,i.TEXTURE21,i.TEXTURE22,i.TEXTURE23,i.TEXTURE24,i.TEXTURE25,i.TEXTURE26,i.TEXTURE27,i.TEXTURE28,i.TEXTURE29,i.TEXTURE30,i.TEXTURE31],this._activedTextureID=i.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new Gl(this):new Ul(this),this._GLRenderDrawContext=new Xl(this),this._GL2DRenderContext=new Hl(this)}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[e.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}bindTexture(e){this._bindTexture(e._texture.target,e._getSource())}applyRenderStateCMD(e){this._GLRenderState.applyRenderStateCommand(e)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,t,r,i){const s=this._context,a=this._lastViewport;l.isConch?s.viewport(e,t,r,i):e===a.x&&t===a.y&&r===a.z&&i===a.w||(s.viewport(e,t,r,i),a.setValue(e,t,r,i))}scissor(e,t,r,i){const s=this._context,a=this._lastScissor;l.isConch?s.scissor(e,t,r,i):e===a.x&&t===a.y&&r===a.z&&i===a.w||(s.scissor(e,t,r,i),a.setValue(e,t,r,i))}scissorTest(e){e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST)}clearRenderTexture(t,r=null,i=1){var s;t&e.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),s|=this.gl.COLOR_BUFFER_BIT),t&e.RenderClearFlag.Depth&&(this._lastClearDepth!=i&&(this._context.clearDepth(i),this._lastClearDepth=i),this._GLRenderState.setDepthMask(!0),s|=this._context.DEPTH_BUFFER_BIT),t&e.RenderClearFlag.Stencil&&(this._context.clearStencil(0),this._GLRenderState.setStencilMask(!0),s|=this._context.STENCIL_BUFFER_BIT),s&&this._context.clear(s)}copySubFrameBuffertoTex(e,t,r,i,s,a,n,l){this._bindTexture(e._texture.target,e._getSource()),this._context.copyTexSubImage2D(e._texture.target,t,r,i,s,a,n,l)}colorMask(e,t,r,i){this._context.colorMask(e,t,r,i)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new kl(this,e,t)}createShaderInstance(e,t,r){return new zl(this,e,t,r)}createVertexState(){return new jl(this)}getUBOPointer(e){return this._GLUBOPointerMap.has(e)||this._GLUBOPointerMap.set(e,this._curUBOPointer++),this._GLUBOPointerMap.get(e)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}uploadUniforms(e,t,r,i){r.applyUBO&&r.applyUBOData();for(var s=r._data,a=t.getArrayData(),n=0,l=0,o=a.length;l<o;l++){var h=a[l];if(i||-1!==h.textureID){var _=s[h.dataOffset];null!=_&&(n+=h.fun.call(h.caller,h,_))}}return n}uploadCustomUniforms(e,t,r,i){e.bind();var s=0,a=t[r];return a&&null!=i&&(s+=a.fun.call(a.caller,a,i)),s}createRenderStateComand(){return new Zn}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}class Kl{characterMapContains(e){for(var t=0;t<Kl.charsMap.length;++t)if(Kl.charsMap[t][0]===e)return!0;return!1}getCharRep(e){for(var t=0;t<Kl.charsMap.length;++t)if(Kl.charsMap[t][0]===e)return Kl.charsMap[t];return!1}getCombCharRep(e,t){for(var r=0;r<Kl.combCharsMap.length;++r)if(Kl.combCharsMap[r][0][0]===e&&Kl.combCharsMap[r][0][1]===t)return Kl.combCharsMap[r];return!1}isTransparent(e){for(var t=0;t<Kl.transChars.length;++t)if(Kl.transChars[t]===e)return!0;return!1}getOriginalCharsFromCode(e){var t;for(t=0;t<Kl.charsMap.length;++t)if(Kl.charsMap[t].indexOf(e)>-1)return String.fromCharCode(Kl.charsMap[t][0]);for(t=0;t<Kl.combCharsMap.length;++t)if(Kl.combCharsMap[t].indexOf(e)>-1)return String.fromCharCode(Kl.combCharsMap[t][0][0])+String.fromCharCode(Kl.combCharsMap[t][0][1]);return String.fromCharCode(e)}convertArabic(e){for(var t,r,i="",s=0;s<e.length;++s){var a=e.charCodeAt(s);if(this.characterMapContains(a)){for(var n=null,l=null,o=s-1,h=s+1;o>=0&&this.isTransparent(e.charCodeAt(o));--o);for((!(t=!!(n=o>=0?e.charCodeAt(o):null)&&this.getCharRep(n))||null==t[2]&&null==t[3])&&(n=null);h<e.length&&this.isTransparent(e.charCodeAt(h));++h);if((!(t=!!(l=h<e.length?e.charCodeAt(h):null)&&this.getCharRep(l))||null==t[3]&&null==t[4])&&(l=null),1604===a&&null!=l&&(1570===l||1571===l||1573===l||1575===l)){r=this.getCombCharRep(a,l),i+=null!=n?String.fromCharCode(r[4]):String.fromCharCode(r[1]),++s;continue}if(t=this.getCharRep(a),null!=n&&null!=l&&null!=t[3]){i+=String.fromCharCode(t[3]);continue}if(null!=n&&null!=t[4]){i+=String.fromCharCode(t[4]);continue}if(null!=l&&null!=t[2]){i+=String.fromCharCode(t[2]);continue}i+=String.fromCharCode(t[1])}else i+=String.fromCharCode(a)}return i}convertArabicBack(e){var t,r,i="";for(r=0;r<e.length;++r)t=e.charCodeAt(r),i+=this.getOriginalCharsFromCode(t);return i}}Kl.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],Kl.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],Kl.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class $l{static ArrayMul(e,t,r){if(e)if(t)for(var i,s,a,n,l=0;l<4;l++)i=e[l],s=e[l+4],a=e[l+8],n=e[l+12],r[l]=i*t[0]+s*t[1]+a*t[2]+n*t[3],r[l+4]=i*t[4]+s*t[5]+a*t[6]+n*t[7],r[l+8]=i*t[8]+s*t[9]+a*t[10]+n*t[11],r[l+12]=i*t[12]+s*t[13]+a*t[14]+n*t[15];else $l.copyArray(e,r);else $l.copyArray(t,r)}static copyArray(e,t){if(e&&t)for(var r=0;r<e.length;r++)t[r]=e[r]}}return e.AlphaCmd=Wr,e.Animation=is,e.Animation2DCondition=Wa,e.Animation2DEvent=Na,e.Animation2DParm=Va,e.AnimationBase=Fi,e.AnimationClip2D=ka,e.AnimationClip2DParse01=Ua,e.Animator2D=Ba,e.AnimatorController2D=qa,e.AnimatorControllerLayer2D=Ra,e.AnimatorControllerParse=Pa,e.AnimatorPlayState2D=va,e.AnimatorState2D=La,e.AnimatorState2DScript=class{setPlayScriptInfo(e,t,r){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=r}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateLoop(){}},e.AnimatorStateBoolCondition=Ya,e.AnimatorStateCondition=Ha,e.AnimatorStateNumberCondition=Xa,e.AnimatorStateTriggerCondition=za,e.AnimatorTransition2D=ja,e.ArabicReshaper=Kl,e.AssetDb=ue,e.AtlasGrid=ft,e.AtlasInfoManager=Oi,e.AtlasResource=Ui,e.AudioSound=ga,e.AudioSoundChannel=fa,e.Base64Tool=ol,e.BasePoly=Sr,e.BaseShader=z,e.BaseTexture=I,e.BatchProgress=Gi,e.Bezier=hr,e.BitmapFont=ss,e.BlendComponent=Kn,e.BlendMode=re,e.BlendState=qn,e.BlurFilter=ua,e.BlurFilterGLRender=_a,e.BoundsStyle=Gr,e.Browser=bt,e.Buffer=qt,e.Buffer2D=$t,e.BufferState=jt,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(E.MOUSE_DOWN,this,this.toChangedState),e.on(E.MOUSE_UP,this,this.toInitState),e.on(E.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Ii.clear(this._curTween),this._curTween=Ii.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Mi[this.effectEase],wi.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Ii.clear(this._curTween),this._curState=2,this._curTween=Ii.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Mi[this.backEase],wi.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=P,e.CacheManger=xi,e.CacheStyle=kr,e.CallLater=ia,e.CharRenderInfo=Et,e.CharRender_Canvas=vt,e.CharSubmitCache=Ir,e.ClassUtils=t,e.ClipRectCmd=gi,e.Color=Z,e.ColorFilter=Nt,e.ColorUtils=Bt,e.CommandEncoder=tl,e.CommandUniformMap=$n,e.CommonMemoryAllocater=Dl,e.Component=c,e.ComponentDriver=la,e.Config=r,e.Config3D=Pr,e.Const=i,e.Context=Or,e.DDSTextureInfo=G,e.DefineDatas=ve,e.Delegate=y,e.DepthState=class{},e.Downloader=zi,e.Dragging=Pi,e.Draw9GridTextureCmd=hi,e.DrawCircleCmd=Hr,e.DrawCurvesCmd=Xr,e.DrawEllipseCmd=Ei,e.DrawImageCmd=Yr,e.DrawLineCmd=zr,e.DrawLinesCmd=qr,e.DrawParticleCmd=gl,e.DrawPathCmd=Kr,e.DrawPieCmd=Zr,e.DrawPolyCmd=Jr,e.DrawRectCmd=ei,e.DrawRoundRectCmd=Si,e.DrawStyle=ur,e.DrawTextureCmd=ti,e.DrawTexturesCmd=mi,e.DrawTrianglesCmd=oi,e.Earcut=vr,e.EarcutNode=br,e.Ease=Mi,e.EffectAnimation=as,e.EffectBase=Qn,e.Event=E,e.EventDispatcher=v,e.FadeIn=class extends Qn{_doTween(){return this.target.alpha=0,Ii.to(this.target,{alpha:1},this.duration,Mi[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends Qn{_doTween(){return this.target.alpha=1,Ii.to(this.target,{alpha:0},this.duration,Mi[this.ease],this._comlete,this.delay)}},e.FastSinglelist=class extends cl{add(e){this._add(e),this.length++}},e.FillTextCmd=Ti,e.FillTextureCmd=ri,e.Filter=It,e.FontInfo=gt,e.FrameAnimation=es,e.GL2TextureContext=Gl,e.GLBuffer=kl,e.GLObject=Fl,e.GLParams=Wl,e.GLRender2DContext=Hl,e.GLRenderDrawContext=Xl,e.GLRenderState=Yl,e.GLSLCodeGenerator=sl,e.GLShaderInstance=zl,e.GLTextureContext=Ul,e.GLVertexState=jl,e.GlCapable=Vl,e.GlowFilter=ca,e.GlowFilterGLRender=da,e.GrahamScan=Ut,e.GraphicAnimation=ts,e.Graphics=bi,e.GraphicsBounds=fi,e.HDRTextureInfo=en,e.HTMLCanvas=Ur,e.HalfFloatUtils=B,e.Handler=wi,e.HideFlags=a,e.HierarchyLoader=Ja,e.HierarchyParser=Qa,e.HierarchyResource=Ks,e.HitArea=Xs,e.HtmlElement=os,e.HtmlImage=hs,e.HtmlLink=_s,e.HtmlParseOptions=us,e.HtmlParser=ps,e.HttpRequest=Yi,e.ICharRender=St,e.ILaya=n,e.ImgUtils=ki,e.IncludeFile=ce,e.IndexBuffer=Kt,e.IndexBuffer2D=Zt,e.Input=ks,e.InputManager=Is,e.KTXTextureInfo=X,e.KeyLocation=el,e.Keyboard=Jn,e.Keyframe2D=Oa,e.KeyframeNode2D=Fa,e.KeyframeNodeList2D=Ga,e.Laya=On,e.LayaEnv=l,e.LayaGL=x,e.LayaGLQuickRunner=nr,e.LegacyUIParser=Zs,e.Loader=Ki,e.LocalStorage=wn,e.Log=hl,e.Material=Tn,e.MaterialLoader=yn,e.MaterialParser=xn,e.MathUtil=Ji,e.MathUtils3D=De,e.MatirxArray=$l,e.Matrix=p,e.Matrix3x3=Oe,e.Matrix4x4=qe,e.Mesh2D=er,e.MeshParticle2D=Fn,e.MeshQuadTexture=tr,e.MeshTexture=rr,e.MeshVG=ir,e.Mouse=Ln,e.NativeCommandUniformMap=ml,e.NativeContext=Lr,e.NativeFilter=lr,e.NativeGL2TextureContext=yl,e.NativeGLObject=Tl,e.NativeGLRender2DContext=class extends Tl{constructor(e){super(e)}activeTexture(e){}bindTexture(e,t){}bindUseProgram(e){return!0}},e.NativeGLRenderDrawContext=El,e.NativeGLRenderEngineFactory=class{createShaderData(){return new Pl}createShaderInstance(e,t){return null}createRenderStateComand(){return new Sl}createRenderState(){return new bl}createUniformBufferObject(e,t,r,i,s){return new Bl(e,t,r,i,s)}createGlobalUniformMap(e){return new ml(window.conchCommandUniformMap.createGlobalUniformMap(e),e)}createEngine(e,t){return Promise.resolve()}},e.NativeGLTextureContext=xl,e.NativeGLVertexState=Ll,e.NativeMemory=Ml,e.NativeRenderState=bl,e.NativeRenderStateCommand=Sl,e.NativeRenderTexture2D=Q,e.NativeShaderData=Pl,e.NativeUniformBufferObject=Bl,e.NativeWebGLCacheAsNormalCanvas=sr,e.NativeWebGLEngine=class{constructor(t,r=e.WebGLMode.Auto){this._isShaderDebugMode=!0,this._nativeObj=new window.conchWebGLEngine(r)}createRenderStateComand(){return new Sl}getUBOPointer(e){return this._nativeObj.getUBOPointer(e)}_addStatisticsInfo(e,t){this._nativeObj.addStatisticsInfo(e,t)}clearStatisticsInfo(e){this._nativeObj.clearStatisticsInfo(e)}getStatisticsInfo(e){return this._nativeObj.getStatisticsInfo(e)}get gl(){return this._context}get isWebGL2(){return this._nativeObj.isWebGL2}get webglConfig(){return this._config}initRenderEngine(e){this._nativeObj.initRenderEngine(),this._GLRenderDrawContext=new El(this),this.isWebGL2?this._GLTextureContext=new yl(this,new window.conchGL2TextureContext(this._nativeObj)):this._GLTextureContext=new xl(this,new window.conchGLTextureContext(this._nativeObj))}bindTexture(e){throw new Error("Method not implemented.")}applyRenderStateCMD(e){this._nativeObj.applyRenderStateCommand(e._nativeObj)}getCapable(e){return this._nativeObj.getCapable(e)}viewport(e,t,r,i){this._nativeObj.viewport(e,t,r,i)}scissor(e,t,r,i){this._nativeObj.scissor(e,t,r,i)}scissorTest(e){this._nativeObj.scissorTest(e)}clearRenderTexture(e,t=null,r=1){t?this._nativeObj.clearRenderTexture(e,!0,t.r,t.g,t.b,t.a,r):this._nativeObj.clearRenderTexture(e,!1,Z.BLACK.r,Z.BLACK.g,Z.BLACK.b,Z.BLACK.a,r)}copySubFrameBuffertoTex(e,t,r,i,s,a,n,l){this._nativeObj.copySubFrameBuffertoTex(e._texture,t,r,i,s,a,n,l)}colorMask(e,t,r,i){this._nativeObj.colorMask(e,t,r,i)}getParams(e){return this._nativeObj.getParams(e)}createBuffer(e,t){return new window.conchGLBuffer(this._nativeObj,e,t)}createShaderInstance(e,t,r){throw new Error("Method not implemented.")}createVertexState(){return new Ll(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){return this._nativeObj.propertyNameToID(e)}propertyIDToName(e){throw new Error("Method not implemented.")}uploadUniforms(e,t,r,i){throw new Error("Method not implemented.")}uploadCustomUniforms(e,t,r,i){throw new Error("Method not implemented.")}unbindVertexState(){this._nativeObj.unbindVertexState&&this._nativeObj.unbindVertexState()}},e.Node=Ri,e.NodeFlags=s,e.NullLoader=un,e.ParseJSON=En,e.Path=dr,e.PerfData=_l,e.PerfHUD=ul,e.Point=f,e.Pool=o,e.PoolCache=dl,e.Prefab=zs,e.PrefabImpl=$s,e.PrimitiveSV=Pn,e.Quaternion=We,e.QuickTestTool=rl,e.Rectangle=g,e.Render=Ls,e.RenderInfo=pt,e.RenderSprite=or,e.RenderState=cn,e.RenderState2D=j,e.RenderStateCommand=Zn,e.RenderStateContext=te,e.RenderTexture=Br,e.RenderTexture2D=J,e.RenderTextureCube=class extends Br{constructor(e,t,r,i,s){super(e,e,t,r,i,s),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=x.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}_start(){Br._configInstance.invertY=this._isCameraTarget,Br._currentActive!=this&&(Br._currentActive&&Br._currentActive._end(),Br._currentActive=this,x.textureContext.bindRenderTarget(this._renderTarget,this.faceIndex))}},e.RenderTextureLoader=sn,e.Resource=w,e.RestoreCmd=ii,e.RotateCmd=si,e.RunDriver=na,e.SaveBase=pr,e.SaveClipRect=fr,e.SaveCmd=ui,e.SaveMark=gr,e.SaveTransform=mr,e.SaveTranslate=Tr,e.ScaleCmd=ai,e.Scene=ea,e.Script=Ka,e.SerializeUtil=Gs,e.Shader2D=xr,e.Shader3D=dt,e.ShaderCompile=be,e.ShaderCompileDefineBase=at,e.ShaderData=rt,e.ShaderDataDefaultValue=ShaderDataDefaultValue,e.ShaderDefine=Re,e.ShaderDefines2D=ct,e.ShaderInstance=al,e.ShaderNode=pe,e.ShaderParser=Dn,e.ShaderPass=nt,e.ShaderProcessInfo=st,e.ShaderVariable=nl,e.ShaderVariant=Ae,e.ShaderVariantCollection=Ce,e.SingletonList=cl,e.SkinMeshBuffer=yr,e.Socket=il,e.Sound=class extends v{load(e){}play(e=0,t=0){return null}get duration(){return 0}dispose(){}},e.SoundChannel=pa,e.SoundManager=xa,e.SoundNode=ya,e.Sprite=Li,e.SpriteConst=Gt,e.SpriteStyle=Vr,e.SpriteUtils=Bi,e.Stage=oa,e.Stat=Xt,e.StencilState=class{},e.StringKey=class{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(e){var t=this._strsToID[e];return null!=t?t:(this._idToStrs[this._length]=e,this._strsToID[e]=this._length++)}getID(e){var t=this._strsToID[e];return null==t?-1:t}getName(e){var t=this._idToStrs[e];return null==t?void 0:t}},e.SubShader=ut,e.SubUniformBufferData=class extends it{constructor(e,t){super(e),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=t,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},e.Submit=Cr,e.SubmitBase=Yt,e.SubmitCMD=wt,e.SubmitCanvas=Dr,e.SubmitKey=Mt,e.SubmitTarget=Mr,e.SubmitTexture=wr,e.System=class{static changeDefinition(e,t){window.Laya[e]=t;var r=e+"=classObj";window.eval(r)}},e.Text=gs,e.TextAtlas=At,e.TextRender=Rt,e.TextResource=$a,e.TextStyle=ns,e.TextTexture=Ct,e.Texture=ae,e.Texture2D=Y,e.Texture2DArray=$e,e.Texture2DLoader=rn,e.Texture3D=ll,e.TextureCube=bn,e.TextureLoader=on,e.TextureSV=Bn,e.TimeLine=pl,e.Timer=ta,e.TransformCmd=ni,e.TranslateCmd=li,e.Tween=Ii,e.TypedArrayClasses=Fs,e.UBBParser=fs,e.URL=de,e.UniformBufferBase=pn,e.UniformBufferObject=fn,e.UnifromBufferData=it,e.UploadMemory=wl,e.UploadMemoryManager=Il,e.Utils=d,e.Value2D=Dt,e.Vector2=Me,e.Vector3=Ie,e.Vector4=we,e.VectorGraphManager=yi,e.VertexArrayObject=class{constructor(){}},e.VertexAttributeLayout=zt,e.VertexBuffer=Qt,e.VertexBuffer2D=Jt,e.VertexDeclaration=ht,e.VertexElement=lt,e.VertexElementFormat=ot,e.VertexMesh=_t,e.VideoNode=ba,e.VideoTexture=Ea,e.VideoTextureLoader=an,e.WeakObject=Ys,e.WebAudioSound=Ta,e.WebAudioSoundChannel=ma,e.WebGL=aa,e.WebGLCacheAsNormalCanvas=ar,e.WebGLEngine=ql,e.WebGLInternalRT=Nl,e.WebGLInternalTex=Ol,e.WebGLRTMgr=ee,e.WebGLRenderEngineFactory=class{constructor(){this.globalBlockMap={}}createShaderData(){return new rt}createShaderInstance(e,t){return new al(e,t)}createRenderStateComand(){return new Zn}createRenderState(){return new cn}createUniformBufferObject(e,t,r,i,s){return new fn(e,t,r,i,s)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new $n(e)),t}createEngine(t,i){let s,a={stencil:r.isStencil,alpha:r.isAlpha,antialias:r.isAntialias,premultipliedAlpha:r.premultipliedAlpha,preserveDrawingBuffer:r.preserveDrawingBuffer,depth:r.isDepth,failIfMajorPerformanceCaveat:r.isfailIfMajorPerformanceCaveat,powerPreference:r.powerPreference};const n=r.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;s=new ql(a,n),s.initRenderEngine(i._source);var l=s._context;return r.printWebglOrder&&this._replaceWebglcall(l),x.renderEngine=s,x.textureContext=s.getTextureContext(),x.renderDrawContext=s.getDrawContext(),x.render2DContext=s.get2DRenderContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let i=[];for(let e=0;e<arguments.length;e++)i.push(arguments[e]);let s=t[r].apply(e,i);e.getError();return s})}},e.WebGlConfig=class{},e.Widget=Vs,e.WordText=yt,e.WorkerLoader=Ni,e.XML=Xi,e.XMLIterator=Hi,e.XMLUtils=Vi,e.addAfterInitCallback=jn,e.addBeforeInitCallback=zn,e.addInitCallback=Yn,e.alertGlobalError=Hn,e.classInfo=function(e){return dummy},e.enableDebugPanel=Xn,e.init=Nn,e.property=function(e){return dummy},e.regClass=function(e){return function(r){t.regClass(e,r)}},e.runInEditor=function(e){},e}({});